{"version":3,"names":["Cart","require","User","Product","EventEmitter","CartService","constructor","connectionPool","Map","notifyCartUpdate","sessionId","userId","cartData","eventData","cart","timestamp","Date","emit","getCartWithPerformanceOptimization","req","startTime","now","result","getOrCreateCart","endTime","duration","console","warn","error","user","findById","_id","items","updatedAt","save","type","sessionID","Math","random","toString","substr","findOneAndUpdate","$setOnInsert","$set","lastAccessed","new","upsert","lean","mergeCartsWithConflictResolution","guestCartItems","Error","mergedItems","conflicts","Array","isArray","guestItem","mergeCartItem","merged","guestCarts","find","guestCart","length","deleteResult","deleteMany","log","deletedCount","startsWith","sessionParts","split","parseInt","isNaN","timeWindow","orphanedCarts","$regex","$ne","createdAt","$gte","$lte","$size","$in","map","c","success","cleanupPerformed","productId","product","quantity","isActive","reason","existingItemIndex","findIndex","item","currentQuantity","newQuantity","push","current","attempted","resolved","addedAt","min","price","message","updateCartOptimistically","operation","data","rollbackData","JSON","parse","stringify","addItemOptimistically","updateItemOptimistically","removeItemOptimistically","performance","addItem","updatedCart","findByIdAndUpdate","itemIndex","splice","updateItem","removeItem","cleanupExpiredCarts","expiresAt","$lt","cartService","module","exports"],"sources":["cartService.js"],"sourcesContent":["const Cart = require('../models/Cart');\nconst User = require('../models/User');\nconst Product = require('../models/Product');\nconst EventEmitter = require('events');\n\nclass CartService extends EventEmitter {\n  constructor() {\n    super();\n    this.connectionPool = new Map(); // Simple connection tracking\n  }\n\n  // Event-driven cart synchronization\n  async notifyCartUpdate(sessionId, userId, cartData) {\n    const eventData = {\n      sessionId,\n      userId,\n      cart: cartData,\n      timestamp: new Date()\n    };\n\n    // Emit event for real-time synchronization across browser tabs\n    this.emit('cartUpdated', eventData);\n    \n    return eventData;\n  }\n\n  // Optimized cart retrieval with caching consideration\n  async getCartWithPerformanceOptimization(req) {\n    const startTime = Date.now();\n    \n    try {\n      const result = await this.getOrCreateCart(req);\n      \n      const endTime = Date.now();\n      const duration = endTime - startTime;\n      \n      // Log performance (should be under 100ms target)\n      if (duration > 100) {\n        console.warn(`Cart retrieval took ${duration}ms - exceeds 100ms target`);\n      }\n      \n      return result;\n    } catch (error) {\n      console.error('Cart performance optimization error:', error);\n      throw error;\n    }\n  }\n\n  // Enhanced cart retrieval with connection pooling awareness\n  async getOrCreateCart(req) {\n    if (req.user) {\n      // For authenticated users, use user's cart with optimistic loading\n      const user = await User.findById(req.user._id);\n      if (!user.cart) {\n        // Create cart optimistically\n        user.cart = { items: [], updatedAt: new Date() };\n        await user.save();\n        return { type: 'user', cart: user.cart, user };\n      }\n      return { type: 'user', cart: user.cart, user };\n    } else {\n      // For guests, use session-based cart with database storage\n      const sessionId = req.sessionID || `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      \n      // Use findOneAndUpdate for atomic operation\n      let cart = await Cart.findOneAndUpdate(\n        { sessionId },\n        { \n          $setOnInsert: { sessionId, items: [] },\n          $set: { lastAccessed: new Date() }\n        },\n        { \n          new: true, \n          upsert: true,\n          lean: true\n        }\n      );\n      \n      return { type: 'guest', cart, sessionId };\n    }\n  }\n\n  // Enhanced cart merging with conflict resolution\n  async mergeCartsWithConflictResolution(userId, guestCartItems, sessionId) {\n    const startTime = Date.now();\n    \n    try {\n      const user = await User.findById(userId);\n      if (!user) {\n        throw new Error('User not found');\n      }\n      if (!user.cart) {\n        user.cart = { items: [], updatedAt: new Date() };\n      }\n\n      let mergedItems = 0;\n      const conflicts = [];\n\n      // Process guest cart items with conflict detection\n      if (guestCartItems && Array.isArray(guestCartItems)) {\n        for (const guestItem of guestCartItems) {\n          const result = await this.mergeCartItem(user, guestItem, conflicts);\n          if (result.merged) mergedItems++;\n        }\n      }\n\n      // Process session-based cart and clean up more thoroughly\n      if (sessionId) {\n        // Find and process all guest carts with this session ID (in case of duplicates)\n        const guestCarts = await Cart.find({ sessionId });\n        \n        for (const guestCart of guestCarts) {\n          if (guestCart && guestCart.items.length > 0) {\n            for (const guestItem of guestCart.items) {\n              const result = await this.mergeCartItem(user, guestItem, conflicts);\n              if (result.merged) mergedItems++;\n            }\n          }\n        }\n        \n        // Clean up ALL guest carts with this session ID (not just one)\n        const deleteResult = await Cart.deleteMany({ sessionId });\n        console.log(`Cleaned up ${deleteResult.deletedCount} guest cart(s) for session ${sessionId} during merge`);\n      }\n\n      // Also clean up any guest carts that might have the same session pattern\n      // This helps with the edge case where session IDs might get corrupted\n      if (sessionId && sessionId.startsWith('guest_')) {\n        // Extract timestamp from session ID and clean up other carts from similar timeframe\n        const sessionParts = sessionId.split('_');\n        if (sessionParts.length >= 2) {\n          const timestamp = parseInt(sessionParts[1]);\n          if (!isNaN(timestamp)) {\n            // Clean up carts within 1 hour of this session timestamp that might be orphaned\n            const timeWindow = 60 * 60 * 1000; // 1 hour in milliseconds\n            const startTime = timestamp - timeWindow;\n            const endTime = timestamp + timeWindow;\n            \n            const orphanedCarts = await Cart.find({\n              sessionId: { \n                $regex: `^guest_`, \n                $ne: sessionId \n              },\n              createdAt: {\n                $gte: new Date(startTime),\n                $lte: new Date(endTime)\n              },\n              items: { $size: 0 } // Only delete empty orphaned carts\n            });\n            \n            if (orphanedCarts.length > 0) {\n              await Cart.deleteMany({\n                _id: { $in: orphanedCarts.map(c => c._id) }\n              });\n              console.log(`Cleaned up ${orphanedCarts.length} empty orphaned guest carts during merge`);\n            }\n          }\n        }\n      }\n\n      user.cart.updatedAt = new Date();\n      await user.save();\n\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      // Emit cart update event\n      await this.notifyCartUpdate(sessionId, userId, user.cart);\n\n      return {\n        mergedItems,\n        conflicts,\n        duration,\n        success: true,\n        cleanupPerformed: true\n      };\n\n    } catch (error) {\n      console.error('Cart merge error:', error);\n      throw error;\n    }\n  }\n\n  // Helper method to merge individual cart items\n  async mergeCartItem(user, guestItem, conflicts = []) {\n    try {\n      const productId = guestItem.productId || guestItem.product;\n      const quantity = guestItem.quantity || 1;\n\n      // Validate product\n      const product = await Product.findById(productId).lean();\n      if (!product || !product.isActive) {\n        return { merged: false, reason: 'invalid_product' };\n      }\n\n      // Check for existing item\n      const existingItemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (existingItemIndex >= 0) {\n        const currentQuantity = user.cart.items[existingItemIndex].quantity;\n        const newQuantity = currentQuantity + quantity;\n        \n        // Check for quantity conflicts\n        if (newQuantity > 99) {\n          conflicts.push({\n            productId,\n            type: 'quantity_limit',\n            current: currentQuantity,\n            attempted: quantity,\n            resolved: 99\n          });\n          user.cart.items[existingItemIndex].quantity = 99;\n        } else {\n          user.cart.items[existingItemIndex].quantity = newQuantity;\n        }\n        \n        user.cart.items[existingItemIndex].addedAt = new Date();\n      } else {\n        // Add new item\n        user.cart.items.push({\n          product: productId,\n          quantity: Math.min(quantity, 99),\n          price: product.price,\n          addedAt: new Date()\n        });\n      }\n\n      return { merged: true };\n    } catch (error) {\n      console.error('Error merging cart item:', error);\n      return { merged: false, reason: 'merge_error', error: error.message };\n    }\n  }\n\n  // Optimistic cart update with rollback capability\n  async updateCartOptimistically(req, operation, data) {\n    const startTime = Date.now();\n    let rollbackData = null;\n    \n    try {\n      const { type, cart, user } = await this.getOrCreateCart(req);\n      \n      // Store rollback data\n      if (type === 'user') {\n        rollbackData = JSON.parse(JSON.stringify(user.cart));\n      } else {\n        rollbackData = JSON.parse(JSON.stringify(cart));\n      }\n\n      // Perform operation\n      let result;\n      switch (operation) {\n        case 'add':\n          result = await this.addItemOptimistically(type, cart, user, data);\n          break;\n        case 'update':\n          result = await this.updateItemOptimistically(type, cart, user, data);\n          break;\n        case 'remove':\n          result = await this.removeItemOptimistically(type, cart, user, data);\n          break;\n        default:\n          throw new Error(`Unknown operation: ${operation}`);\n      }\n\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      // Performance monitoring\n      if (duration > 200) {\n        console.warn(`Cart ${operation} took ${duration}ms - exceeds 200ms target`);\n      }\n\n      // Emit update event\n      const sessionId = type === 'guest' ? cart.sessionId : null;\n      const userId = type === 'user' ? user._id : null;\n      await this.notifyCartUpdate(sessionId, userId, result.cart);\n\n      return {\n        ...result,\n        duration,\n        performance: duration <= 200 ? 'good' : 'needs_optimization'\n      };\n\n    } catch (error) {\n      console.error(`Cart ${operation} error:`, error);\n      \n      // Implement rollback if needed\n      if (rollbackData) {\n        console.log('Rolling back cart changes...');\n        // Rollback implementation would go here\n      }\n      \n      throw error;\n    }\n  }\n\n  // Optimistic add item operation\n  async addItemOptimistically(type, cart, user, { productId, quantity }) {\n    const product = await Product.findById(productId).lean();\n    if (!product || !product.isActive) {\n      throw new Error('Product not found or inactive');\n    }\n\n    if (type === 'user') {\n      const existingItemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (existingItemIndex >= 0) {\n        const newQuantity = user.cart.items[existingItemIndex].quantity + quantity;\n        if (newQuantity > 99) {\n          user.cart.items[existingItemIndex].quantity = 99;\n        } else {\n          user.cart.items[existingItemIndex].quantity = newQuantity;\n        }\n        user.cart.items[existingItemIndex].addedAt = new Date();\n      } else {\n        user.cart.items.push({\n          product: productId,\n          quantity,\n          price: product.price,\n          addedAt: new Date()\n        });\n      }\n      \n      user.cart.updatedAt = new Date();\n      await user.save();\n      return { cart: user.cart };\n    } else {\n      // Check if cart has addItem method, otherwise manually add\n      if (cart.addItem && typeof cart.addItem === 'function') {\n        cart.addItem(productId, quantity, product.price);\n      } else {\n        // Manually add to cart items\n        const existingItemIndex = cart.items.findIndex(item => \n          item.product.toString() === productId.toString()\n        );\n\n        if (existingItemIndex >= 0) {\n          const newQuantity = cart.items[existingItemIndex].quantity + quantity;\n          if (newQuantity > 99) {\n            cart.items[existingItemIndex].quantity = 99;\n          } else {\n            cart.items[existingItemIndex].quantity = newQuantity;\n          }\n          cart.items[existingItemIndex].addedAt = new Date();\n        } else {\n          cart.items.push({\n            product: productId,\n            quantity,\n            price: product.price,\n            addedAt: new Date()\n          });\n        }\n        cart.updatedAt = new Date();\n      }\n      \n      // Use findByIdAndUpdate instead of save() for lean objects\n      const updatedCart = await Cart.findByIdAndUpdate(\n        cart._id,\n        { items: cart.items, updatedAt: cart.updatedAt },\n        { new: true, lean: true }\n      );\n      return { cart: updatedCart };\n    }\n  }\n\n  // Optimistic update item operation\n  async updateItemOptimistically(type, cart, user, { productId, quantity }) {\n    if (type === 'user') {\n      const itemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (itemIndex >= 0) {\n        if (quantity === 0) {\n          user.cart.items.splice(itemIndex, 1);\n        } else {\n          user.cart.items[itemIndex].quantity = quantity;\n          user.cart.items[itemIndex].addedAt = new Date();\n        }\n        user.cart.updatedAt = new Date();\n        await user.save();\n      }\n      return { cart: user.cart };\n    } else {\n      // Check if cart has updateItem method, otherwise manually update\n      if (cart.updateItem && typeof cart.updateItem === 'function') {\n        cart.updateItem(productId, quantity);\n      } else {\n        // Manually update cart items\n        const itemIndex = cart.items.findIndex(item => \n          item.product.toString() === productId.toString()\n        );\n\n        if (itemIndex >= 0) {\n          if (quantity === 0) {\n            cart.items.splice(itemIndex, 1);\n          } else {\n            cart.items[itemIndex].quantity = quantity;\n            cart.items[itemIndex].addedAt = new Date();\n          }\n          cart.updatedAt = new Date();\n        }\n      }\n      \n      // Use findByIdAndUpdate instead of save() for lean objects\n      const updatedCart = await Cart.findByIdAndUpdate(\n        cart._id,\n        { items: cart.items, updatedAt: cart.updatedAt },\n        { new: true, lean: true }\n      );\n      return { cart: updatedCart };\n    }\n  }\n\n  // Optimistic remove item operation\n  async removeItemOptimistically(type, cart, user, { productId }) {\n    if (type === 'user') {\n      const itemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (itemIndex >= 0) {\n        user.cart.items.splice(itemIndex, 1);\n        user.cart.updatedAt = new Date();\n        await user.save();\n      }\n      return { cart: user.cart };\n    } else {\n      // Check if cart has removeItem method, otherwise manually remove\n      if (cart.removeItem && typeof cart.removeItem === 'function') {\n        cart.removeItem(productId);\n      } else {\n        // Manually remove from cart items\n        const itemIndex = cart.items.findIndex(item => \n          item.product.toString() === productId.toString()\n        );\n\n        if (itemIndex >= 0) {\n          cart.items.splice(itemIndex, 1);\n          cart.updatedAt = new Date();\n        }\n      }\n      \n      // Use findByIdAndUpdate instead of save() for lean objects\n      const updatedCart = await Cart.findByIdAndUpdate(\n        cart._id,\n        { items: cart.items, updatedAt: cart.updatedAt },\n        { new: true, lean: true }\n      );\n      return { cart: updatedCart };\n    }\n  }\n\n  // Cleanup expired guest carts (for scheduled maintenance)\n  async cleanupExpiredCarts() {\n    try {\n      const result = await Cart.deleteMany({\n        expiresAt: { $lt: new Date() }\n      });\n      \n      console.log(`Cleaned up ${result.deletedCount} expired guest carts`);\n      return result.deletedCount;\n    } catch (error) {\n      console.error('Error cleaning up expired carts:', error);\n      throw error;\n    }\n  }\n}\n\n// Export singleton instance\nconst cartService = new CartService();\nmodule.exports = cartService;"],"mappings":"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","ignoreList":[]}