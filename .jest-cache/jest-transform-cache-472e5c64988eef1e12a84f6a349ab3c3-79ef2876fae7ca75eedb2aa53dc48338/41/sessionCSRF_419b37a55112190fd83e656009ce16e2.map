{"version":3,"names":["crypto","require","generateCSRFToken","req","res","next","session","csrfToken","randomBytes","toString","validateCSRFToken","method","path","includes","token","headers","body","_csrf","console","error","provided","match","status","json","success","code","message","createSessionConfig","mongoUrl","secret","process","env","SESSION_SECRET","resave","saveUninitialized","store","create","touchAfter","cookie","secure","NODE_ENV","httpOnly","maxAge","sameSite","name","proxy","enhanceGuestSession","guestId","user","cart","items","updatedAt","Date","cleanupGuestSession","module","exports"],"sources":["sessionCSRF.js"],"sourcesContent":["const crypto = require('crypto');\n\n// Unified CSRF token management\nconst generateCSRFToken = (req, res, next) => {\n  if (!req.session.csrfToken) {\n    req.session.csrfToken = crypto.randomBytes(32).toString('hex');\n  }\n  next();\n};\n\n// CSRF validation middleware\nconst validateCSRFToken = (req, res, next) => {\n  // Skip CSRF for GET requests and API testing\n  if (req.method === 'GET' || req.path.includes('/test')) {\n    return next();\n  }\n\n  const token = req.headers['x-csrf-token'] || req.body._csrf;\n  \n  // Debug only on mismatch\n  // console.log('CSRF Debug:', {\n  //   method: req.method,\n  //   path: req.path,\n  //   'x-csrf-token': req.headers['x-csrf-token'],\n  //   sessionCSRF: req.session?.csrfToken\n  // });\n  \n  if (!token || token !== req.session.csrfToken) {\n    console.error('CSRF token mismatch:', {\n      provided: token ? 'yes' : 'no',\n      session: req.session.csrfToken ? 'yes' : 'no',\n      match: token === req.session.csrfToken\n    });\n    return res.status(403).json({\n      success: false,\n      error: {\n        code: 'CSRF_TOKEN_MISMATCH',\n        message: 'Invalid CSRF token'\n      }\n    });\n  }\n  \n  next();\n};\n\n// Session configuration factory\nconst createSessionConfig = (mongoUrl) => ({\n  secret: process.env.SESSION_SECRET || 'holistic-store-session-secret',\n  resave: false,\n  saveUninitialized: true, // Important for guest carts and CSRF\n  store: require('connect-mongo').create({\n    mongoUrl,\n    touchAfter: 24 * 3600 // lazy session update\n  }),\n  cookie: {\n    secure: process.env.NODE_ENV === 'production',\n    httpOnly: true,\n    maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days\n    sameSite: process.env.NODE_ENV === 'production' ? 'strict' : 'lax',\n    path: '/'\n  },\n  name: 'holistic.sid', // Custom session name\n  proxy: process.env.NODE_ENV === 'production' // Trust proxy in production\n});\n\n// Guest session enhancement\nconst enhanceGuestSession = (req, res, next) => {\n  if (!req.session.guestId && !req.user) {\n    req.session.guestId = crypto.randomBytes(16).toString('hex');\n  }\n  \n  // Ensure cart exists in session\n  if (!req.session.cart) {\n    req.session.cart = {\n      items: [],\n      updatedAt: new Date()\n    };\n  }\n  \n  next();\n};\n\n// Session cleanup for authenticated users\nconst cleanupGuestSession = (req, res, next) => {\n  if (req.user && req.session.guestId) {\n    // User is now authenticated, clean up guest data\n    delete req.session.guestId;\n    // Cart migration should happen in auth flow\n  }\n  next();\n};\n\nmodule.exports = {\n  generateCSRFToken,\n  validateCSRFToken,\n  createSessionConfig,\n  enhanceGuestSession,\n  cleanupGuestSession\n};"],"mappings":"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","ignoreList":[]}