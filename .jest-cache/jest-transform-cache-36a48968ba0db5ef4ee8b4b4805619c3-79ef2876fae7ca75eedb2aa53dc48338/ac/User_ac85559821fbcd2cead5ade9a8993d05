7501353c6322f36954c3317672e23c1f
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const userSchema = new mongoose.Schema({
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    trim: true
  },
  password: {
    type: String,
    required: true,
    minlength: 6
  },
  firstName: {
    type: String,
    required: true,
    trim: true
  },
  lastName: {
    type: String,
    required: true,
    trim: true
  },
  phone: {
    type: String,
    trim: true
  },
  addresses: [{
    type: {
      type: String,
      enum: ['shipping', 'billing'],
      required: true
    },
    firstName: {
      type: String,
      required: true
    },
    lastName: {
      type: String,
      required: true
    },
    street: {
      type: String,
      required: true
    },
    city: {
      type: String,
      required: true
    },
    state: {
      type: String,
      required: true
    },
    zipCode: {
      type: String,
      required: true
    },
    country: {
      type: String,
      required: true,
      default: 'US'
    },
    phone: String,
    isDefault: {
      type: Boolean,
      default: false
    }
  }],
  isActive: {
    type: Boolean,
    default: true
  },
  isAdmin: {
    type: Boolean,
    default: false
  },
  lastLogin: Date,
  passwordResetToken: String,
  passwordResetExpiry: Date,
  version: {
    type: Number,
    default: 0
  },
  preferences: {
    newsletter: {
      type: Boolean,
      default: false
    },
    notifications: {
      type: Boolean,
      default: true
    },
    emailPreferences: {
      orderConfirmations: {
        type: Boolean,
        default: true
      },
      paymentReceipts: {
        type: Boolean,
        default: true
      },
      orderUpdates: {
        type: Boolean,
        default: true
      },
      promotionalEmails: {
        type: Boolean,
        default: false
      },
      welcomeEmails: {
        type: Boolean,
        default: true
      }
    }
  },
  cart: {
    items: [{
      product: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Product',
        required: true
      },
      quantity: {
        type: Number,
        required: true,
        min: 1,
        max: 99
      },
      price: {
        type: Number,
        required: true
      },
      addedAt: {
        type: Date,
        default: Date.now
      }
    }],
    updatedAt: {
      type: Date,
      default: Date.now
    }
  }
}, {
  timestamps: true
});

// Indexes for performance
userSchema.index({
  email: 1
}, {
  unique: true
});
userSchema.index({
  isActive: 1
});
userSchema.index({
  lastLogin: -1
});

// Pre-save middleware
userSchema.pre('save', async function (next) {
  if (!this.isModified('password')) {
    return next();
  }
  this.password = await bcrypt.hash(this.password, 12);
  next();
});

// Authentication method
userSchema.methods.comparePassword = async function (candidatePassword) {
  return bcrypt.compare(candidatePassword, this.password);
};

// Method to get default shipping address
userSchema.methods.getDefaultShippingAddress = function () {
  return this.addresses.find(addr => addr.type === 'shipping' && addr.isDefault) || this.addresses.find(addr => addr.type === 'shipping');
};

// Method to get default billing address
userSchema.methods.getDefaultBillingAddress = function () {
  return this.addresses.find(addr => addr.type === 'billing' && addr.isDefault) || this.addresses.find(addr => addr.type === 'billing') || this.getDefaultShippingAddress(); // Fallback to shipping if no billing
};

// Method to add or update address
userSchema.methods.addAddress = function (addressData) {
  // If this is set as default, unset other defaults of the same type
  if (addressData.isDefault) {
    this.addresses.forEach(addr => {
      if (addr.type === addressData.type) {
        addr.isDefault = false;
      }
    });
  }
  this.addresses.push(addressData);
  return this.save();
};

// Method to update address
userSchema.methods.updateAddress = function (addressId, updateData) {
  const address = this.addresses.id(addressId);
  if (!address) {
    return null;
  }

  // If setting as default, unset other defaults of the same type
  if (updateData.isDefault) {
    this.addresses.forEach(addr => {
      if (addr.type === address.type && addr._id.toString() !== addressId) {
        addr.isDefault = false;
      }
    });
  }
  Object.assign(address, updateData);
  return this.save();
};

// Method to remove address
userSchema.methods.removeAddress = function (addressId) {
  this.addresses.pull(addressId);
  return this.save();
};

// Method to set default address
userSchema.methods.setDefaultAddress = function (addressId) {
  const address = this.addresses.id(addressId);
  if (!address) {
    return null;
  }

  // Unset other defaults of the same type
  this.addresses.forEach(addr => {
    if (addr.type === address.type && addr._id.toString() !== addressId) {
      addr.isDefault = false;
    }
  });

  // Set this address as default
  address.isDefault = true;
  return this.save();
};

// Method to update email preferences
userSchema.methods.updateEmailPreferences = function (preferences) {
  Object.assign(this.preferences.emailPreferences, preferences);
  return this.save();
};

// Method to check if user wants specific email type
userSchema.methods.wantsEmail = function (emailType) {
  if (!this.preferences.notifications) {
    return false;
  }
  return this.preferences.emailPreferences[emailType] !== false;
};

// Method to get public user data (excludes sensitive info)
userSchema.methods.toPublicJSON = function () {
  return {
    _id: this._id,
    email: this.email,
    firstName: this.firstName,
    lastName: this.lastName,
    phone: this.phone,
    addresses: this.addresses,
    preferences: this.preferences,
    createdAt: this.createdAt,
    updatedAt: this.updatedAt
  };
};
module.exports = mongoose.model('User', userSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJiY3J5cHQiLCJ1c2VyU2NoZW1hIiwiU2NoZW1hIiwiZW1haWwiLCJ0eXBlIiwiU3RyaW5nIiwicmVxdWlyZWQiLCJ1bmlxdWUiLCJsb3dlcmNhc2UiLCJ0cmltIiwicGFzc3dvcmQiLCJtaW5sZW5ndGgiLCJmaXJzdE5hbWUiLCJsYXN0TmFtZSIsInBob25lIiwiYWRkcmVzc2VzIiwiZW51bSIsInN0cmVldCIsImNpdHkiLCJzdGF0ZSIsInppcENvZGUiLCJjb3VudHJ5IiwiZGVmYXVsdCIsImlzRGVmYXVsdCIsIkJvb2xlYW4iLCJpc0FjdGl2ZSIsImlzQWRtaW4iLCJsYXN0TG9naW4iLCJEYXRlIiwicGFzc3dvcmRSZXNldFRva2VuIiwicGFzc3dvcmRSZXNldEV4cGlyeSIsInZlcnNpb24iLCJOdW1iZXIiLCJwcmVmZXJlbmNlcyIsIm5ld3NsZXR0ZXIiLCJub3RpZmljYXRpb25zIiwiZW1haWxQcmVmZXJlbmNlcyIsIm9yZGVyQ29uZmlybWF0aW9ucyIsInBheW1lbnRSZWNlaXB0cyIsIm9yZGVyVXBkYXRlcyIsInByb21vdGlvbmFsRW1haWxzIiwid2VsY29tZUVtYWlscyIsImNhcnQiLCJpdGVtcyIsInByb2R1Y3QiLCJUeXBlcyIsIk9iamVjdElkIiwicmVmIiwicXVhbnRpdHkiLCJtaW4iLCJtYXgiLCJwcmljZSIsImFkZGVkQXQiLCJub3ciLCJ1cGRhdGVkQXQiLCJ0aW1lc3RhbXBzIiwiaW5kZXgiLCJwcmUiLCJuZXh0IiwiaXNNb2RpZmllZCIsImhhc2giLCJtZXRob2RzIiwiY29tcGFyZVBhc3N3b3JkIiwiY2FuZGlkYXRlUGFzc3dvcmQiLCJjb21wYXJlIiwiZ2V0RGVmYXVsdFNoaXBwaW5nQWRkcmVzcyIsImZpbmQiLCJhZGRyIiwiZ2V0RGVmYXVsdEJpbGxpbmdBZGRyZXNzIiwiYWRkQWRkcmVzcyIsImFkZHJlc3NEYXRhIiwiZm9yRWFjaCIsInB1c2giLCJzYXZlIiwidXBkYXRlQWRkcmVzcyIsImFkZHJlc3NJZCIsInVwZGF0ZURhdGEiLCJhZGRyZXNzIiwiaWQiLCJfaWQiLCJ0b1N0cmluZyIsIk9iamVjdCIsImFzc2lnbiIsInJlbW92ZUFkZHJlc3MiLCJwdWxsIiwic2V0RGVmYXVsdEFkZHJlc3MiLCJ1cGRhdGVFbWFpbFByZWZlcmVuY2VzIiwid2FudHNFbWFpbCIsImVtYWlsVHlwZSIsInRvUHVibGljSlNPTiIsImNyZWF0ZWRBdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJtb2RlbCJdLCJzb3VyY2VzIjpbIlVzZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbW9uZ29vc2UgPSByZXF1aXJlKCdtb25nb29zZScpO1xuY29uc3QgYmNyeXB0ID0gcmVxdWlyZSgnYmNyeXB0anMnKTtcblxuY29uc3QgdXNlclNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xuICBlbWFpbDoge1xuICAgIHR5cGU6IFN0cmluZyxcbiAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICB1bmlxdWU6IHRydWUsXG4gICAgbG93ZXJjYXNlOiB0cnVlLFxuICAgIHRyaW06IHRydWVcbiAgfSxcbiAgcGFzc3dvcmQ6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgbWlubGVuZ3RoOiA2XG4gIH0sXG4gIGZpcnN0TmFtZToge1xuICAgIHR5cGU6IFN0cmluZyxcbiAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICB0cmltOiB0cnVlXG4gIH0sXG4gIGxhc3ROYW1lOiB7XG4gICAgdHlwZTogU3RyaW5nLFxuICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIHRyaW06IHRydWVcbiAgfSxcbiAgcGhvbmU6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgdHJpbTogdHJ1ZVxuICB9LFxuICBhZGRyZXNzZXM6IFt7XG4gICAgdHlwZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZW51bTogWydzaGlwcGluZycsICdiaWxsaW5nJ10sXG4gICAgICByZXF1aXJlZDogdHJ1ZVxuICAgIH0sXG4gICAgZmlyc3ROYW1lOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBsYXN0TmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgc3RyZWV0OiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBjaXR5OiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBzdGF0ZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgemlwQ29kZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgY291bnRyeTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlLCBkZWZhdWx0OiAnVVMnIH0sXG4gICAgcGhvbmU6IFN0cmluZyxcbiAgICBpc0RlZmF1bHQ6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfVxuICB9XSxcbiAgaXNBY3RpdmU6IHtcbiAgICB0eXBlOiBCb29sZWFuLFxuICAgIGRlZmF1bHQ6IHRydWVcbiAgfSxcbiAgaXNBZG1pbjoge1xuICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgZGVmYXVsdDogZmFsc2VcbiAgfSxcbiAgbGFzdExvZ2luOiBEYXRlLFxuICBwYXNzd29yZFJlc2V0VG9rZW46IFN0cmluZyxcbiAgcGFzc3dvcmRSZXNldEV4cGlyeTogRGF0ZSxcbiAgdmVyc2lvbjoge1xuICAgIHR5cGU6IE51bWJlcixcbiAgICBkZWZhdWx0OiAwXG4gIH0sXG4gIHByZWZlcmVuY2VzOiB7XG4gICAgbmV3c2xldHRlcjogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LFxuICAgIG5vdGlmaWNhdGlvbnM6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogdHJ1ZSB9LFxuICAgIGVtYWlsUHJlZmVyZW5jZXM6IHtcbiAgICAgIG9yZGVyQ29uZmlybWF0aW9uczogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiB0cnVlIH0sXG4gICAgICBwYXltZW50UmVjZWlwdHM6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogdHJ1ZSB9LFxuICAgICAgb3JkZXJVcGRhdGVzOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IHRydWUgfSxcbiAgICAgIHByb21vdGlvbmFsRW1haWxzOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sXG4gICAgICB3ZWxjb21lRW1haWxzOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IHRydWUgfVxuICAgIH1cbiAgfSxcbiAgY2FydDoge1xuICAgIGl0ZW1zOiBbe1xuICAgICAgcHJvZHVjdDoge1xuICAgICAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgICAgIHJlZjogJ1Byb2R1Y3QnLFxuICAgICAgICByZXF1aXJlZDogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHF1YW50aXR5OiB7XG4gICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgIG1pbjogMSxcbiAgICAgICAgbWF4OiA5OVxuICAgICAgfSxcbiAgICAgIHByaWNlOiB7XG4gICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICAgIH0sXG4gICAgICBhZGRlZEF0OiB7XG4gICAgICAgIHR5cGU6IERhdGUsXG4gICAgICAgIGRlZmF1bHQ6IERhdGUubm93XG4gICAgICB9XG4gICAgfV0sXG4gICAgdXBkYXRlZEF0OiB7XG4gICAgICB0eXBlOiBEYXRlLFxuICAgICAgZGVmYXVsdDogRGF0ZS5ub3dcbiAgICB9XG4gIH1cbn0sIHtcbiAgdGltZXN0YW1wczogdHJ1ZVxufSk7XG5cbi8vIEluZGV4ZXMgZm9yIHBlcmZvcm1hbmNlXG51c2VyU2NoZW1hLmluZGV4KHsgZW1haWw6IDEgfSwgeyB1bmlxdWU6IHRydWUgfSk7XG51c2VyU2NoZW1hLmluZGV4KHsgaXNBY3RpdmU6IDEgfSk7XG51c2VyU2NoZW1hLmluZGV4KHsgbGFzdExvZ2luOiAtMSB9KTtcblxuLy8gUHJlLXNhdmUgbWlkZGxld2FyZVxudXNlclNjaGVtYS5wcmUoJ3NhdmUnLCBhc3luYyBmdW5jdGlvbiAobmV4dCkge1xuICBpZiAoIXRoaXMuaXNNb2RpZmllZCgncGFzc3dvcmQnKSkge3JldHVybiBuZXh0KCk7fVxuICB0aGlzLnBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2godGhpcy5wYXNzd29yZCwgMTIpO1xuICBuZXh0KCk7XG59KTtcblxuLy8gQXV0aGVudGljYXRpb24gbWV0aG9kXG51c2VyU2NoZW1hLm1ldGhvZHMuY29tcGFyZVBhc3N3b3JkID0gYXN5bmMgZnVuY3Rpb24gKGNhbmRpZGF0ZVBhc3N3b3JkKSB7XG4gIHJldHVybiBiY3J5cHQuY29tcGFyZShjYW5kaWRhdGVQYXNzd29yZCwgdGhpcy5wYXNzd29yZCk7XG59O1xuXG4vLyBNZXRob2QgdG8gZ2V0IGRlZmF1bHQgc2hpcHBpbmcgYWRkcmVzc1xudXNlclNjaGVtYS5tZXRob2RzLmdldERlZmF1bHRTaGlwcGluZ0FkZHJlc3MgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB0aGlzLmFkZHJlc3Nlcy5maW5kKGFkZHIgPT4gYWRkci50eXBlID09PSAnc2hpcHBpbmcnICYmIGFkZHIuaXNEZWZhdWx0KSB8fFxuICAgICAgICAgdGhpcy5hZGRyZXNzZXMuZmluZChhZGRyID0+IGFkZHIudHlwZSA9PT0gJ3NoaXBwaW5nJyk7XG59O1xuXG4vLyBNZXRob2QgdG8gZ2V0IGRlZmF1bHQgYmlsbGluZyBhZGRyZXNzXG51c2VyU2NoZW1hLm1ldGhvZHMuZ2V0RGVmYXVsdEJpbGxpbmdBZGRyZXNzID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gdGhpcy5hZGRyZXNzZXMuZmluZChhZGRyID0+IGFkZHIudHlwZSA9PT0gJ2JpbGxpbmcnICYmIGFkZHIuaXNEZWZhdWx0KSB8fFxuICAgICAgICAgdGhpcy5hZGRyZXNzZXMuZmluZChhZGRyID0+IGFkZHIudHlwZSA9PT0gJ2JpbGxpbmcnKSB8fFxuICAgICAgICAgdGhpcy5nZXREZWZhdWx0U2hpcHBpbmdBZGRyZXNzKCk7IC8vIEZhbGxiYWNrIHRvIHNoaXBwaW5nIGlmIG5vIGJpbGxpbmdcbn07XG5cbi8vIE1ldGhvZCB0byBhZGQgb3IgdXBkYXRlIGFkZHJlc3NcbnVzZXJTY2hlbWEubWV0aG9kcy5hZGRBZGRyZXNzID0gZnVuY3Rpb24gKGFkZHJlc3NEYXRhKSB7XG4gIC8vIElmIHRoaXMgaXMgc2V0IGFzIGRlZmF1bHQsIHVuc2V0IG90aGVyIGRlZmF1bHRzIG9mIHRoZSBzYW1lIHR5cGVcbiAgaWYgKGFkZHJlc3NEYXRhLmlzRGVmYXVsdCkge1xuICAgIHRoaXMuYWRkcmVzc2VzLmZvckVhY2goYWRkciA9PiB7XG4gICAgICBpZiAoYWRkci50eXBlID09PSBhZGRyZXNzRGF0YS50eXBlKSB7XG4gICAgICAgIGFkZHIuaXNEZWZhdWx0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgXG4gIHRoaXMuYWRkcmVzc2VzLnB1c2goYWRkcmVzc0RhdGEpO1xuICByZXR1cm4gdGhpcy5zYXZlKCk7XG59O1xuXG4vLyBNZXRob2QgdG8gdXBkYXRlIGFkZHJlc3NcbnVzZXJTY2hlbWEubWV0aG9kcy51cGRhdGVBZGRyZXNzID0gZnVuY3Rpb24gKGFkZHJlc3NJZCwgdXBkYXRlRGF0YSkge1xuICBjb25zdCBhZGRyZXNzID0gdGhpcy5hZGRyZXNzZXMuaWQoYWRkcmVzc0lkKTtcbiAgaWYgKCFhZGRyZXNzKSB7cmV0dXJuIG51bGw7fVxuICBcbiAgLy8gSWYgc2V0dGluZyBhcyBkZWZhdWx0LCB1bnNldCBvdGhlciBkZWZhdWx0cyBvZiB0aGUgc2FtZSB0eXBlXG4gIGlmICh1cGRhdGVEYXRhLmlzRGVmYXVsdCkge1xuICAgIHRoaXMuYWRkcmVzc2VzLmZvckVhY2goYWRkciA9PiB7XG4gICAgICBpZiAoYWRkci50eXBlID09PSBhZGRyZXNzLnR5cGUgJiYgYWRkci5faWQudG9TdHJpbmcoKSAhPT0gYWRkcmVzc0lkKSB7XG4gICAgICAgIGFkZHIuaXNEZWZhdWx0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgXG4gIE9iamVjdC5hc3NpZ24oYWRkcmVzcywgdXBkYXRlRGF0YSk7XG4gIHJldHVybiB0aGlzLnNhdmUoKTtcbn07XG5cbi8vIE1ldGhvZCB0byByZW1vdmUgYWRkcmVzc1xudXNlclNjaGVtYS5tZXRob2RzLnJlbW92ZUFkZHJlc3MgPSBmdW5jdGlvbiAoYWRkcmVzc0lkKSB7XG4gIHRoaXMuYWRkcmVzc2VzLnB1bGwoYWRkcmVzc0lkKTtcbiAgcmV0dXJuIHRoaXMuc2F2ZSgpO1xufTtcblxuLy8gTWV0aG9kIHRvIHNldCBkZWZhdWx0IGFkZHJlc3NcbnVzZXJTY2hlbWEubWV0aG9kcy5zZXREZWZhdWx0QWRkcmVzcyA9IGZ1bmN0aW9uIChhZGRyZXNzSWQpIHtcbiAgY29uc3QgYWRkcmVzcyA9IHRoaXMuYWRkcmVzc2VzLmlkKGFkZHJlc3NJZCk7XG4gIGlmICghYWRkcmVzcykge3JldHVybiBudWxsO31cbiAgXG4gIC8vIFVuc2V0IG90aGVyIGRlZmF1bHRzIG9mIHRoZSBzYW1lIHR5cGVcbiAgdGhpcy5hZGRyZXNzZXMuZm9yRWFjaChhZGRyID0+IHtcbiAgICBpZiAoYWRkci50eXBlID09PSBhZGRyZXNzLnR5cGUgJiYgYWRkci5faWQudG9TdHJpbmcoKSAhPT0gYWRkcmVzc0lkKSB7XG4gICAgICBhZGRyLmlzRGVmYXVsdCA9IGZhbHNlO1xuICAgIH1cbiAgfSk7XG4gIFxuICAvLyBTZXQgdGhpcyBhZGRyZXNzIGFzIGRlZmF1bHRcbiAgYWRkcmVzcy5pc0RlZmF1bHQgPSB0cnVlO1xuICByZXR1cm4gdGhpcy5zYXZlKCk7XG59O1xuXG4vLyBNZXRob2QgdG8gdXBkYXRlIGVtYWlsIHByZWZlcmVuY2VzXG51c2VyU2NoZW1hLm1ldGhvZHMudXBkYXRlRW1haWxQcmVmZXJlbmNlcyA9IGZ1bmN0aW9uIChwcmVmZXJlbmNlcykge1xuICBPYmplY3QuYXNzaWduKHRoaXMucHJlZmVyZW5jZXMuZW1haWxQcmVmZXJlbmNlcywgcHJlZmVyZW5jZXMpO1xuICByZXR1cm4gdGhpcy5zYXZlKCk7XG59O1xuXG4vLyBNZXRob2QgdG8gY2hlY2sgaWYgdXNlciB3YW50cyBzcGVjaWZpYyBlbWFpbCB0eXBlXG51c2VyU2NoZW1hLm1ldGhvZHMud2FudHNFbWFpbCA9IGZ1bmN0aW9uIChlbWFpbFR5cGUpIHtcbiAgaWYgKCF0aGlzLnByZWZlcmVuY2VzLm5vdGlmaWNhdGlvbnMpIHtyZXR1cm4gZmFsc2U7fVxuICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlcy5lbWFpbFByZWZlcmVuY2VzW2VtYWlsVHlwZV0gIT09IGZhbHNlO1xufTtcblxuLy8gTWV0aG9kIHRvIGdldCBwdWJsaWMgdXNlciBkYXRhIChleGNsdWRlcyBzZW5zaXRpdmUgaW5mbylcbnVzZXJTY2hlbWEubWV0aG9kcy50b1B1YmxpY0pTT04gPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB7XG4gICAgX2lkOiB0aGlzLl9pZCxcbiAgICBlbWFpbDogdGhpcy5lbWFpbCxcbiAgICBmaXJzdE5hbWU6IHRoaXMuZmlyc3ROYW1lLFxuICAgIGxhc3ROYW1lOiB0aGlzLmxhc3ROYW1lLFxuICAgIHBob25lOiB0aGlzLnBob25lLFxuICAgIGFkZHJlc3NlczogdGhpcy5hZGRyZXNzZXMsXG4gICAgcHJlZmVyZW5jZXM6IHRoaXMucHJlZmVyZW5jZXMsXG4gICAgY3JlYXRlZEF0OiB0aGlzLmNyZWF0ZWRBdCxcbiAgICB1cGRhdGVkQXQ6IHRoaXMudXBkYXRlZEF0XG4gIH07XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IG1vbmdvb3NlLm1vZGVsKCdVc2VyJywgdXNlclNjaGVtYSk7Il0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDcEMsTUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsVUFBVSxDQUFDO0FBRWxDLE1BQU1FLFVBQVUsR0FBRyxJQUFJSCxRQUFRLENBQUNJLE1BQU0sQ0FBQztFQUNyQ0MsS0FBSyxF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