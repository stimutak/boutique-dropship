37e1fdfc79811fd6f478025bd44779c8
/**
 * Standardized error handling utilities for the Holistic Boutique API
 * Following CLAUDE.md constraints:
 * - Keep it simple - no event emitters or complex patterns
 * - Support internationalization for all error messages
 * - Use existing patterns from the codebase
 */

// Standard error codes used across the application
const ErrorCodes = {
  // Common errors
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  NOT_FOUND: 'NOT_FOUND',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  BAD_REQUEST: 'BAD_REQUEST',
  // Authentication errors
  INVALID_CREDENTIALS: 'INVALID_CREDENTIALS',
  USER_EXISTS: 'USER_EXISTS',
  USER_NOT_FOUND: 'USER_NOT_FOUND',
  TOKEN_INVALID: 'TOKEN_INVALID',
  TOKEN_EXPIRED: 'TOKEN_EXPIRED',
  AUTHENTICATION_REQUIRED: 'AUTHENTICATION_REQUIRED',
  REGISTRATION_ERROR: 'REGISTRATION_ERROR',
  INSUFFICIENT_PERMISSIONS: 'INSUFFICIENT_PERMISSIONS',
  ACCOUNT_DISABLED: 'ACCOUNT_DISABLED',
  LOGIN_ERROR: 'LOGIN_ERROR',
  FORGOT_PASSWORD_ERROR: 'FORGOT_PASSWORD_ERROR',
  RESET_PASSWORD_ERROR: 'RESET_PASSWORD_ERROR',
  INVALID_RESET_TOKEN: 'INVALID_RESET_TOKEN',
  VERIFICATION_ERROR: 'VERIFICATION_ERROR',
  PROFILE_FETCH_ERROR: 'PROFILE_FETCH_ERROR',
  PROFILE_UPDATE_ERROR: 'PROFILE_UPDATE_ERROR',
  EMAIL_EXISTS: 'EMAIL_EXISTS',
  EMAIL_IN_USE: 'EMAIL_IN_USE',
  DUPLICATE_EMAIL: 'DUPLICATE_EMAIL',
  INVALID_PASSWORD: 'INVALID_PASSWORD',
  PASSWORD_CHANGE_ERROR: 'PASSWORD_CHANGE_ERROR',
  LOGOUT_ERROR: 'LOGOUT_ERROR',
  ADDRESS_ADD_ERROR: 'ADDRESS_ADD_ERROR',
  ADDRESS_UPDATE_ERROR: 'ADDRESS_UPDATE_ERROR',
  ADDRESS_DELETE_ERROR: 'ADDRESS_DELETE_ERROR',
  ADDRESS_NOT_FOUND: 'ADDRESS_NOT_FOUND',
  ADDRESS_DEFAULT_ERROR: 'ADDRESS_DEFAULT_ERROR',
  MISSING_TOKEN: 'MISSING_TOKEN',
  TOKEN_REFRESH_ERROR: 'TOKEN_REFRESH_ERROR',
  // Product errors
  PRODUCT_NOT_FOUND: 'PRODUCT_NOT_FOUND',
  INVALID_PRODUCT_ID: 'INVALID_PRODUCT_ID',
  PRODUCTS_FETCH_ERROR: 'PRODUCTS_FETCH_ERROR',
  PRODUCT_CREATION_ERROR: 'PRODUCT_CREATION_ERROR',
  PRODUCT_UPDATE_ERROR: 'PRODUCT_UPDATE_ERROR',
  PRODUCT_DELETE_ERROR: 'PRODUCT_DELETE_ERROR',
  SEARCH_ERROR: 'SEARCH_ERROR',
  CATEGORIES_ERROR: 'CATEGORIES_ERROR',
  FILTERS_ERROR: 'FILTERS_ERROR',
  RECOMMENDATIONS_ERROR: 'RECOMMENDATIONS_ERROR',
  MISSING_QUERY: 'MISSING_QUERY',
  // Cart errors
  CART_ADD_ERROR: 'CART_ADD_ERROR',
  CART_UPDATE_ERROR: 'CART_UPDATE_ERROR',
  CART_REMOVE_ERROR: 'CART_REMOVE_ERROR',
  CART_CLEAR_ERROR: 'CART_CLEAR_ERROR',
  CART_MERGE_ERROR: 'CART_MERGE_ERROR',
  CART_FETCH_ERROR: 'CART_FETCH_ERROR',
  ITEM_NOT_FOUND: 'ITEM_NOT_FOUND',
  MAX_QUANTITY_EXCEEDED: 'MAX_QUANTITY_EXCEEDED',
  INVALID_QUANTITY: 'INVALID_QUANTITY',
  MISSING_PRODUCT_ID: 'MISSING_PRODUCT_ID',
  NOT_GUEST_USER: 'NOT_GUEST_USER',
  RESET_SESSION_ERROR: 'RESET_SESSION_ERROR',
  // Order errors
  ORDER_NOT_FOUND: 'ORDER_NOT_FOUND',
  ORDER_CREATE_ERROR: 'ORDER_CREATE_ERROR',
  ORDER_UPDATE_ERROR: 'ORDER_UPDATE_ERROR',
  ORDER_CANCEL_ERROR: 'ORDER_CANCEL_ERROR',
  INVALID_ORDER_STATUS: 'INVALID_ORDER_STATUS',
  EMPTY_CART: 'EMPTY_CART',
  // Payment errors
  PAYMENT_FAILED: 'PAYMENT_FAILED',
  PAYMENT_METHOD_INVALID: 'PAYMENT_METHOD_INVALID',
  INSUFFICIENT_FUNDS: 'INSUFFICIENT_FUNDS',
  PAYMENT_REQUIRED: 'PAYMENT_REQUIRED',
  PAYMENT_CREATE_ERROR: 'PAYMENT_CREATE_ERROR',
  PAYMENT_STATUS_ERROR: 'PAYMENT_STATUS_ERROR',
  // Integration errors
  MOLLIE_ERROR: 'MOLLIE_ERROR',
  WHOLESALER_ERROR: 'WHOLESALER_ERROR',
  EMAIL_ERROR: 'EMAIL_ERROR'
};

/**
 * Format error response in standardized format
 * @param {string} code - Error code from ErrorCodes
 * @param {string} message - Default error message (used if i18n key not found)
 * @param {string} field - Optional field name for validation errors
 * @param {object} additionalData - Additional data to include in error
 * @param {function} i18n - Optional i18n function for translation
 * @returns {object} Formatted error response
 */
function formatError(code, message, field = null, additionalData = null, i18n = null) {
  const error = {
    code,
    message
  };

  // Try to use i18n if available
  if (i18n && typeof i18n === 'function') {
    // The i18n function already handles the error code lookup
    const translatedMessage = i18n(code, message);
    error.message = translatedMessage;
  }
  if (field) {
    error.field = field;
  }
  if (additionalData) {
    Object.assign(error, additionalData);
  }
  return {
    success: false,
    error
  };
}

/**
 * Create validation error from express-validator result
 * @param {object} validationResult - Express validator result object
 * @returns {object} Formatted validation error
 */
function createValidationError(validationResult) {
  const errors = validationResult.array();
  return {
    success: false,
    error: {
      code: ErrorCodes.VALIDATION_ERROR,
      message: 'Invalid input data',
      details: errors.map(err => ({
        field: err.param || err.path,
        message: err.msg,
        location: err.location
      }))
    }
  };
}

/**
 * Express middleware to add error response helpers
 * Adds methods to res object for consistent error responses
 */
function errorResponse(req, res, next) {
  // Get i18n function if available (will be added when we implement backend i18n)
  const i18n = req.i18n || null;

  /**
   * Send standardized error response
   * @param {number} statusCode - HTTP status code
   * @param {string} errorCode - Error code from ErrorCodes
   * @param {string} message - Error message
   * @param {string} field - Optional field name
   * @param {object} additionalData - Additional error data
   */
  res.error = function (statusCode, errorCode, message, field = null, additionalData = null) {
    const errorData = formatError(errorCode, message, field, additionalData, req.i18n);
    return this.status(statusCode).json(errorData);
  };

  /**
   * Send validation error response
   * @param {object} validationErrors - Express validator errors
   */
  res.validationError = function (validationErrors) {
    const errorData = createValidationError(validationErrors);
    // Apply i18n to the validation error message
    if (req.i18n && errorData.error) {
      errorData.error.message = req.i18n(ErrorCodes.VALIDATION_ERROR, errorData.error.message);
    }
    return this.status(400).json(errorData);
  };
  next();
}

/**
 * Special handler for webhook endpoints that need plain text responses
 * @param {object} res - Express response object
 * @param {number} statusCode - HTTP status code
 * @param {string} message - Error message
 */
function webhookError(res, statusCode, message) {
  return res.status(statusCode).send(message);
}
module.exports = {
  ErrorCodes,
  formatError,
  createValidationError,
  errorResponse,
  webhookError
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFcnJvckNvZGVzIiwiVkFMSURBVElPTl9FUlJPUiIsIk5PVF9GT1VORCIsIlVOQVVUSE9SSVpFRCIsIkZPUkJJRERFTiIsIklOVEVSTkFMX0VSUk9SIiwiQkFEX1JFUVVFU1QiLCJJTlZBTElEX0NSRURFTlRJQUxTIiwiVVNFUl9FWElTVFMiLCJVU0VSX05PVF9GT1VORCIsIlRPS0VOX0lOVkFMSUQiLCJUT0tFTl9FWFBJUkVEIiwiQVVUSEVOVElDQVRJT05fUkVRVUlSRUQiLCJSRUdJU1RSQVRJT05fRVJST1IiLCJJTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMiLCJBQ0NPVU5UX0RJU0FCTEVEIiwiTE9HSU5fRVJST1IiLCJGT1JHT1RfUEFTU1dPUkRfRVJST1IiLCJSRVNFVF9QQVNTV09SRF9FUlJPUiIsIklOVkFMSURfUkVTRVRfVE9LRU4iLCJWRVJJRklDQVRJT05fRVJST1IiLCJQUk9GSUxFX0ZFVENIX0VSUk9SIiwiUFJPRklMRV9VUERBVEVfRVJST1IiLCJFTUFJTF9FWElTVFMiLCJFTUFJTF9JTl9VU0UiLCJEVVBMSUNBVEVfRU1BSUwiLCJJTlZBTElEX1BBU1NXT1JEIiwiUEFTU1dPUkRfQ0hBTkdFX0VSUk9SIiwiTE9HT1VUX0VSUk9SIiwiQUREUkVTU19BRERfRVJST1IiLCJBRERSRVNTX1VQREFURV9FUlJPUiIsIkFERFJFU1NfREVMRVRFX0VSUk9SIiwiQUREUkVTU19OT1RfRk9VTkQiLCJBRERSRVNTX0RFRkFVTFRfRVJST1IiLCJNSVNTSU5HX1RPS0VOIiwiVE9LRU5fUkVGUkVTSF9FUlJPUiIsIlBST0RVQ1RfTk9UX0ZPVU5EIiwiSU5WQUxJRF9QUk9EVUNUX0lEIiwiUFJPRFVDVFNfRkVUQ0hfRVJST1IiLCJQUk9EVUNUX0NSRUFUSU9OX0VSUk9SIiwiUFJPRFVDVF9VUERBVEVfRVJST1IiLCJQUk9EVUNUX0RFTEVURV9FUlJPUiIsIlNFQVJDSF9FUlJPUiIsIkNBVEVHT1JJRVNfRVJST1IiLCJGSUxURVJTX0VSUk9SIiwiUkVDT01NRU5EQVRJT05TX0VSUk9SIiwiTUlTU0lOR19RVUVSWSIsIkNBUlRfQUREX0VSUk9SIiwiQ0FSVF9VUERBVEVfRVJST1IiLCJDQVJUX1JFTU9WRV9FUlJPUiIsIkNBUlRfQ0xFQVJfRVJST1IiLCJDQVJUX01FUkdFX0VSUk9SIiwiQ0FSVF9GRVRDSF9FUlJPUiIsIklURU1fTk9UX0ZPVU5EIiwiTUFYX1FVQU5USVRZX0VYQ0VFREVEIiwiSU5WQUxJRF9RVUFOVElUWSIsIk1JU1NJTkdfUFJPRFVDVF9JRCIsIk5PVF9HVUVTVF9VU0VSIiwiUkVTRVRfU0VTU0lPTl9FUlJPUiIsIk9SREVSX05PVF9GT1VORCIsIk9SREVSX0NSRUFURV9FUlJPUiIsIk9SREVSX1VQREFURV9FUlJPUiIsIk9SREVSX0NBTkNFTF9FUlJPUiIsIklOVkFMSURfT1JERVJfU1RBVFVTIiwiRU1QVFlfQ0FSVCIsIlBBWU1FTlRfRkFJTEVEIiwiUEFZTUVOVF9NRVRIT0RfSU5WQUxJRCIsIklOU1VGRklDSUVOVF9GVU5EUyIsIlBBWU1FTlRfUkVRVUlSRUQiLCJQQVlNRU5UX0NSRUFURV9FUlJPUiIsIlBBWU1FTlRfU1RBVFVTX0VSUk9SIiwiTU9MTElFX0VSUk9SIiwiV0hPTEVTQUxFUl9FUlJPUiIsIkVNQUlMX0VSUk9SIiwiZm9ybWF0RXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsImZpZWxkIiwiYWRkaXRpb25hbERhdGEiLCJpMThuIiwiZXJyb3IiLCJ0cmFuc2xhdGVkTWVzc2FnZSIsIk9iamVjdCIsImFzc2lnbiIsInN1Y2Nlc3MiLCJjcmVhdGVWYWxpZGF0aW9uRXJyb3IiLCJ2YWxpZGF0aW9uUmVzdWx0IiwiZXJyb3JzIiwiYXJyYXkiLCJkZXRhaWxzIiwibWFwIiwiZXJyIiwicGFyYW0iLCJwYXRoIiwibXNnIiwibG9jYXRpb24iLCJlcnJvclJlc3BvbnNlIiwicmVxIiwicmVzIiwibmV4dCIsInN0YXR1c0NvZGUiLCJlcnJvckNvZGUiLCJlcnJvckRhdGEiLCJzdGF0dXMiLCJqc29uIiwidmFsaWRhdGlvbkVycm9yIiwidmFsaWRhdGlvbkVycm9ycyIsIndlYmhvb2tFcnJvciIsInNlbmQiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiZXJyb3JIYW5kbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3RhbmRhcmRpemVkIGVycm9yIGhhbmRsaW5nIHV0aWxpdGllcyBmb3IgdGhlIEhvbGlzdGljIEJvdXRpcXVlIEFQSVxuICogRm9sbG93aW5nIENMQVVERS5tZCBjb25zdHJhaW50czpcbiAqIC0gS2VlcCBpdCBzaW1wbGUgLSBubyBldmVudCBlbWl0dGVycyBvciBjb21wbGV4IHBhdHRlcm5zXG4gKiAtIFN1cHBvcnQgaW50ZXJuYXRpb25hbGl6YXRpb24gZm9yIGFsbCBlcnJvciBtZXNzYWdlc1xuICogLSBVc2UgZXhpc3RpbmcgcGF0dGVybnMgZnJvbSB0aGUgY29kZWJhc2VcbiAqL1xuXG4vLyBTdGFuZGFyZCBlcnJvciBjb2RlcyB1c2VkIGFjcm9zcyB0aGUgYXBwbGljYXRpb25cbmNvbnN0IEVycm9yQ29kZXMgPSB7XG4gIC8vIENvbW1vbiBlcnJvcnNcbiAgVkFMSURBVElPTl9FUlJPUjogJ1ZBTElEQVRJT05fRVJST1InLFxuICBOT1RfRk9VTkQ6ICdOT1RfRk9VTkQnLFxuICBVTkFVVEhPUklaRUQ6ICdVTkFVVEhPUklaRUQnLFxuICBGT1JCSURERU46ICdGT1JCSURERU4nLFxuICBJTlRFUk5BTF9FUlJPUjogJ0lOVEVSTkFMX0VSUk9SJyxcbiAgQkFEX1JFUVVFU1Q6ICdCQURfUkVRVUVTVCcsXG4gIFxuICAvLyBBdXRoZW50aWNhdGlvbiBlcnJvcnNcbiAgSU5WQUxJRF9DUkVERU5USUFMUzogJ0lOVkFMSURfQ1JFREVOVElBTFMnLFxuICBVU0VSX0VYSVNUUzogJ1VTRVJfRVhJU1RTJyxcbiAgVVNFUl9OT1RfRk9VTkQ6ICdVU0VSX05PVF9GT1VORCcsXG4gIFRPS0VOX0lOVkFMSUQ6ICdUT0tFTl9JTlZBTElEJyxcbiAgVE9LRU5fRVhQSVJFRDogJ1RPS0VOX0VYUElSRUQnLFxuICBBVVRIRU5USUNBVElPTl9SRVFVSVJFRDogJ0FVVEhFTlRJQ0FUSU9OX1JFUVVJUkVEJyxcbiAgUkVHSVNUUkFUSU9OX0VSUk9SOiAnUkVHSVNUUkFUSU9OX0VSUk9SJyxcbiAgSU5TVUZGSUNJRU5UX1BFUk1JU1NJT05TOiAnSU5TVUZGSUNJRU5UX1BFUk1JU1NJT05TJyxcbiAgQUNDT1VOVF9ESVNBQkxFRDogJ0FDQ09VTlRfRElTQUJMRUQnLFxuICBMT0dJTl9FUlJPUjogJ0xPR0lOX0VSUk9SJyxcbiAgRk9SR09UX1BBU1NXT1JEX0VSUk9SOiAnRk9SR09UX1BBU1NXT1JEX0VSUk9SJyxcbiAgUkVTRVRfUEFTU1dPUkRfRVJST1I6ICdSRVNFVF9QQVNTV09SRF9FUlJPUicsXG4gIElOVkFMSURfUkVTRVRfVE9LRU46ICdJTlZBTElEX1JFU0VUX1RPS0VOJyxcbiAgVkVSSUZJQ0FUSU9OX0VSUk9SOiAnVkVSSUZJQ0FUSU9OX0VSUk9SJyxcbiAgUFJPRklMRV9GRVRDSF9FUlJPUjogJ1BST0ZJTEVfRkVUQ0hfRVJST1InLFxuICBQUk9GSUxFX1VQREFURV9FUlJPUjogJ1BST0ZJTEVfVVBEQVRFX0VSUk9SJyxcbiAgRU1BSUxfRVhJU1RTOiAnRU1BSUxfRVhJU1RTJyxcbiAgRU1BSUxfSU5fVVNFOiAnRU1BSUxfSU5fVVNFJyxcbiAgRFVQTElDQVRFX0VNQUlMOiAnRFVQTElDQVRFX0VNQUlMJyxcbiAgSU5WQUxJRF9QQVNTV09SRDogJ0lOVkFMSURfUEFTU1dPUkQnLFxuICBQQVNTV09SRF9DSEFOR0VfRVJST1I6ICdQQVNTV09SRF9DSEFOR0VfRVJST1InLFxuICBMT0dPVVRfRVJST1I6ICdMT0dPVVRfRVJST1InLFxuICBBRERSRVNTX0FERF9FUlJPUjogJ0FERFJFU1NfQUREX0VSUk9SJyxcbiAgQUREUkVTU19VUERBVEVfRVJST1I6ICdBRERSRVNTX1VQREFURV9FUlJPUicsXG4gIEFERFJFU1NfREVMRVRFX0VSUk9SOiAnQUREUkVTU19ERUxFVEVfRVJST1InLFxuICBBRERSRVNTX05PVF9GT1VORDogJ0FERFJFU1NfTk9UX0ZPVU5EJyxcbiAgQUREUkVTU19ERUZBVUxUX0VSUk9SOiAnQUREUkVTU19ERUZBVUxUX0VSUk9SJyxcbiAgTUlTU0lOR19UT0tFTjogJ01JU1NJTkdfVE9LRU4nLFxuICBUT0tFTl9SRUZSRVNIX0VSUk9SOiAnVE9LRU5fUkVGUkVTSF9FUlJPUicsXG4gIFxuICAvLyBQcm9kdWN0IGVycm9yc1xuICBQUk9EVUNUX05PVF9GT1VORDogJ1BST0RVQ1RfTk9UX0ZPVU5EJyxcbiAgSU5WQUxJRF9QUk9EVUNUX0lEOiAnSU5WQUxJRF9QUk9EVUNUX0lEJyxcbiAgUFJPRFVDVFNfRkVUQ0hfRVJST1I6ICdQUk9EVUNUU19GRVRDSF9FUlJPUicsXG4gIFBST0RVQ1RfQ1JFQVRJT05fRVJST1I6ICdQUk9EVUNUX0NSRUFUSU9OX0VSUk9SJyxcbiAgUFJPRFVDVF9VUERBVEVfRVJST1I6ICdQUk9EVUNUX1VQREFURV9FUlJPUicsXG4gIFBST0RVQ1RfREVMRVRFX0VSUk9SOiAnUFJPRFVDVF9ERUxFVEVfRVJST1InLFxuICBTRUFSQ0hfRVJST1I6ICdTRUFSQ0hfRVJST1InLFxuICBDQVRFR09SSUVTX0VSUk9SOiAnQ0FURUdPUklFU19FUlJPUicsXG4gIEZJTFRFUlNfRVJST1I6ICdGSUxURVJTX0VSUk9SJyxcbiAgUkVDT01NRU5EQVRJT05TX0VSUk9SOiAnUkVDT01NRU5EQVRJT05TX0VSUk9SJyxcbiAgTUlTU0lOR19RVUVSWTogJ01JU1NJTkdfUVVFUlknLFxuICBcbiAgLy8gQ2FydCBlcnJvcnNcbiAgQ0FSVF9BRERfRVJST1I6ICdDQVJUX0FERF9FUlJPUicsXG4gIENBUlRfVVBEQVRFX0VSUk9SOiAnQ0FSVF9VUERBVEVfRVJST1InLFxuICBDQVJUX1JFTU9WRV9FUlJPUjogJ0NBUlRfUkVNT1ZFX0VSUk9SJyxcbiAgQ0FSVF9DTEVBUl9FUlJPUjogJ0NBUlRfQ0xFQVJfRVJST1InLFxuICBDQVJUX01FUkdFX0VSUk9SOiAnQ0FSVF9NRVJHRV9FUlJPUicsXG4gIENBUlRfRkVUQ0hfRVJST1I6ICdDQVJUX0ZFVENIX0VSUk9SJyxcbiAgSVRFTV9OT1RfRk9VTkQ6ICdJVEVNX05PVF9GT1VORCcsXG4gIE1BWF9RVUFOVElUWV9FWENFRURFRDogJ01BWF9RVUFOVElUWV9FWENFRURFRCcsXG4gIElOVkFMSURfUVVBTlRJVFk6ICdJTlZBTElEX1FVQU5USVRZJyxcbiAgTUlTU0lOR19QUk9EVUNUX0lEOiAnTUlTU0lOR19QUk9EVUNUX0lEJyxcbiAgTk9UX0dVRVNUX1VTRVI6ICdOT1RfR1VFU1RfVVNFUicsXG4gIFJFU0VUX1NFU1NJT05fRVJST1I6ICdSRVNFVF9TRVNTSU9OX0VSUk9SJyxcbiAgXG4gIC8vIE9yZGVyIGVycm9yc1xuICBPUkRFUl9OT1RfRk9VTkQ6ICdPUkRFUl9OT1RfRk9VTkQnLFxuICBPUkRFUl9DUkVBVEVfRVJST1I6ICdPUkRFUl9DUkVBVEVfRVJST1InLFxuICBPUkRFUl9VUERBVEVfRVJST1I6ICdPUkRFUl9VUERBVEVfRVJST1InLFxuICBPUkRFUl9DQU5DRUxfRVJST1I6ICdPUkRFUl9DQU5DRUxfRVJST1InLFxuICBJTlZBTElEX09SREVSX1NUQVRVUzogJ0lOVkFMSURfT1JERVJfU1RBVFVTJyxcbiAgRU1QVFlfQ0FSVDogJ0VNUFRZX0NBUlQnLFxuICBcbiAgLy8gUGF5bWVudCBlcnJvcnNcbiAgUEFZTUVOVF9GQUlMRUQ6ICdQQVlNRU5UX0ZBSUxFRCcsXG4gIFBBWU1FTlRfTUVUSE9EX0lOVkFMSUQ6ICdQQVlNRU5UX01FVEhPRF9JTlZBTElEJyxcbiAgSU5TVUZGSUNJRU5UX0ZVTkRTOiAnSU5TVUZGSUNJRU5UX0ZVTkRTJyxcbiAgUEFZTUVOVF9SRVFVSVJFRDogJ1BBWU1FTlRfUkVRVUlSRUQnLFxuICBQQVlNRU5UX0NSRUFURV9FUlJPUjogJ1BBWU1FTlRfQ1JFQVRFX0VSUk9SJyxcbiAgUEFZTUVOVF9TVEFUVVNfRVJST1I6ICdQQVlNRU5UX1NUQVRVU19FUlJPUicsXG4gIFxuICAvLyBJbnRlZ3JhdGlvbiBlcnJvcnNcbiAgTU9MTElFX0VSUk9SOiAnTU9MTElFX0VSUk9SJyxcbiAgV0hPTEVTQUxFUl9FUlJPUjogJ1dIT0xFU0FMRVJfRVJST1InLFxuICBFTUFJTF9FUlJPUjogJ0VNQUlMX0VSUk9SJ1xufTtcblxuLyoqXG4gKiBGb3JtYXQgZXJyb3IgcmVzcG9uc2UgaW4gc3RhbmRhcmRpemVkIGZvcm1hdFxuICogQHBhcmFtIHtzdHJpbmd9IGNvZGUgLSBFcnJvciBjb2RlIGZyb20gRXJyb3JDb2Rlc1xuICogQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2UgLSBEZWZhdWx0IGVycm9yIG1lc3NhZ2UgKHVzZWQgaWYgaTE4biBrZXkgbm90IGZvdW5kKVxuICogQHBhcmFtIHtzdHJpbmd9IGZpZWxkIC0gT3B0aW9uYWwgZmllbGQgbmFtZSBmb3IgdmFsaWRhdGlvbiBlcnJvcnNcbiAqIEBwYXJhbSB7b2JqZWN0fSBhZGRpdGlvbmFsRGF0YSAtIEFkZGl0aW9uYWwgZGF0YSB0byBpbmNsdWRlIGluIGVycm9yXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBpMThuIC0gT3B0aW9uYWwgaTE4biBmdW5jdGlvbiBmb3IgdHJhbnNsYXRpb25cbiAqIEByZXR1cm5zIHtvYmplY3R9IEZvcm1hdHRlZCBlcnJvciByZXNwb25zZVxuICovXG5mdW5jdGlvbiBmb3JtYXRFcnJvcihjb2RlLCBtZXNzYWdlLCBmaWVsZCA9IG51bGwsIGFkZGl0aW9uYWxEYXRhID0gbnVsbCwgaTE4biA9IG51bGwpIHtcbiAgY29uc3QgZXJyb3IgPSB7XG4gICAgY29kZSxcbiAgICBtZXNzYWdlXG4gIH07XG5cbiAgLy8gVHJ5IHRvIHVzZSBpMThuIGlmIGF2YWlsYWJsZVxuICBpZiAoaTE4biAmJiB0eXBlb2YgaTE4biA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIC8vIFRoZSBpMThuIGZ1bmN0aW9uIGFscmVhZHkgaGFuZGxlcyB0aGUgZXJyb3IgY29kZSBsb29rdXBcbiAgICBjb25zdCB0cmFuc2xhdGVkTWVzc2FnZSA9IGkxOG4oY29kZSwgbWVzc2FnZSk7XG4gICAgZXJyb3IubWVzc2FnZSA9IHRyYW5zbGF0ZWRNZXNzYWdlO1xuICB9XG5cbiAgaWYgKGZpZWxkKSB7XG4gICAgZXJyb3IuZmllbGQgPSBmaWVsZDtcbiAgfVxuXG4gIGlmIChhZGRpdGlvbmFsRGF0YSkge1xuICAgIE9iamVjdC5hc3NpZ24oZXJyb3IsIGFkZGl0aW9uYWxEYXRhKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3VjY2VzczogZmFsc2UsXG4gICAgZXJyb3JcbiAgfTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgdmFsaWRhdGlvbiBlcnJvciBmcm9tIGV4cHJlc3MtdmFsaWRhdG9yIHJlc3VsdFxuICogQHBhcmFtIHtvYmplY3R9IHZhbGlkYXRpb25SZXN1bHQgLSBFeHByZXNzIHZhbGlkYXRvciByZXN1bHQgb2JqZWN0XG4gKiBAcmV0dXJucyB7b2JqZWN0fSBGb3JtYXR0ZWQgdmFsaWRhdGlvbiBlcnJvclxuICovXG5mdW5jdGlvbiBjcmVhdGVWYWxpZGF0aW9uRXJyb3IodmFsaWRhdGlvblJlc3VsdCkge1xuICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0LmFycmF5KCk7XG4gIFxuICByZXR1cm4ge1xuICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgIGVycm9yOiB7XG4gICAgICBjb2RlOiBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXG4gICAgICBtZXNzYWdlOiAnSW52YWxpZCBpbnB1dCBkYXRhJyxcbiAgICAgIGRldGFpbHM6IGVycm9ycy5tYXAoZXJyID0+ICh7XG4gICAgICAgIGZpZWxkOiBlcnIucGFyYW0gfHwgZXJyLnBhdGgsXG4gICAgICAgIG1lc3NhZ2U6IGVyci5tc2csXG4gICAgICAgIGxvY2F0aW9uOiBlcnIubG9jYXRpb25cbiAgICAgIH0pKVxuICAgIH1cbiAgfTtcbn1cblxuLyoqXG4gKiBFeHByZXNzIG1pZGRsZXdhcmUgdG8gYWRkIGVycm9yIHJlc3BvbnNlIGhlbHBlcnNcbiAqIEFkZHMgbWV0aG9kcyB0byByZXMgb2JqZWN0IGZvciBjb25zaXN0ZW50IGVycm9yIHJlc3BvbnNlc1xuICovXG5mdW5jdGlvbiBlcnJvclJlc3BvbnNlKHJlcSwgcmVzLCBuZXh0KSB7XG4gIC8vIEdldCBpMThuIGZ1bmN0aW9uIGlmIGF2YWlsYWJsZSAod2lsbCBiZSBhZGRlZCB3aGVuIHdlIGltcGxlbWVudCBiYWNrZW5kIGkxOG4pXG4gIGNvbnN0IGkxOG4gPSByZXEuaTE4biB8fCBudWxsO1xuXG4gIC8qKlxuICAgKiBTZW5kIHN0YW5kYXJkaXplZCBlcnJvciByZXNwb25zZVxuICAgKiBAcGFyYW0ge251bWJlcn0gc3RhdHVzQ29kZSAtIEhUVFAgc3RhdHVzIGNvZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGVycm9yQ29kZSAtIEVycm9yIGNvZGUgZnJvbSBFcnJvckNvZGVzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlIC0gRXJyb3IgbWVzc2FnZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZmllbGQgLSBPcHRpb25hbCBmaWVsZCBuYW1lXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBhZGRpdGlvbmFsRGF0YSAtIEFkZGl0aW9uYWwgZXJyb3IgZGF0YVxuICAgKi9cbiAgcmVzLmVycm9yID0gZnVuY3Rpb24oc3RhdHVzQ29kZSwgZXJyb3JDb2RlLCBtZXNzYWdlLCBmaWVsZCA9IG51bGwsIGFkZGl0aW9uYWxEYXRhID0gbnVsbCkge1xuICAgIGNvbnN0IGVycm9yRGF0YSA9IGZvcm1hdEVycm9yKGVycm9yQ29kZSwgbWVzc2FnZSwgZmllbGQsIGFkZGl0aW9uYWxEYXRhLCByZXEuaTE4bik7XG4gICAgcmV0dXJuIHRoaXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24oZXJyb3JEYXRhKTtcbiAgfTtcblxuICAvKipcbiAgICogU2VuZCB2YWxpZGF0aW9uIGVycm9yIHJlc3BvbnNlXG4gICAqIEBwYXJhbSB7b2JqZWN0fSB2YWxpZGF0aW9uRXJyb3JzIC0gRXhwcmVzcyB2YWxpZGF0b3IgZXJyb3JzXG4gICAqL1xuICByZXMudmFsaWRhdGlvbkVycm9yID0gZnVuY3Rpb24odmFsaWRhdGlvbkVycm9ycykge1xuICAgIGNvbnN0IGVycm9yRGF0YSA9IGNyZWF0ZVZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uRXJyb3JzKTtcbiAgICAvLyBBcHBseSBpMThuIHRvIHRoZSB2YWxpZGF0aW9uIGVycm9yIG1lc3NhZ2VcbiAgICBpZiAocmVxLmkxOG4gJiYgZXJyb3JEYXRhLmVycm9yKSB7XG4gICAgICBlcnJvckRhdGEuZXJyb3IubWVzc2FnZSA9IHJlcS5pMThuKEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUiwgZXJyb3JEYXRhLmVycm9yLm1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zdGF0dXMoNDAwKS5qc29uKGVycm9yRGF0YSk7XG4gIH07XG5cbiAgbmV4dCgpO1xufVxuXG4vKipcbiAqIFNwZWNpYWwgaGFuZGxlciBmb3Igd2ViaG9vayBlbmRwb2ludHMgdGhhdCBuZWVkIHBsYWluIHRleHQgcmVzcG9uc2VzXG4gKiBAcGFyYW0ge29iamVjdH0gcmVzIC0gRXhwcmVzcyByZXNwb25zZSBvYmplY3RcbiAqIEBwYXJhbSB7bnVtYmVyfSBzdGF0dXNDb2RlIC0gSFRUUCBzdGF0dXMgY29kZVxuICogQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2UgLSBFcnJvciBtZXNzYWdlXG4gKi9cbmZ1bmN0aW9uIHdlYmhvb2tFcnJvcihyZXMsIHN0YXR1c0NvZGUsIG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuc2VuZChtZXNzYWdlKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIEVycm9yQ29kZXMsXG4gIGZvcm1hdEVycm9yLFxuICBjcmVhdGVWYWxpZGF0aW9uRXJyb3IsXG4gIGVycm9yUmVzcG9uc2UsXG4gIHdlYmhvb2tFcnJvclxufTsiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsTUFBTUEsVUFBVSxHQUFHO0VBQ2pCO0VBQ0FDLGdCQUFnQixF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