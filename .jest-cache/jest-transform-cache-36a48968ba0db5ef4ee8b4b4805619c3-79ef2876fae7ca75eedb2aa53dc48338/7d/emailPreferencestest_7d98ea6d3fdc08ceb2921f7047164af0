18a3e1097efc5e8aa15772a7a714f7ce
const request = require("supertest");
const express = require("express");
const User = require("../../models/User");
const jwt = require("jsonwebtoken");
const authRoutes = require("../../routes/auth");

// Create test app
const createTestApp = () => {
  const app = express();
  app.use(express.json());
  app.use("/api/auth", authRoutes);
  return app;
};
describe("Email Preferences Endpoints", () => {
  let app;
  let testUser;
  let authToken;
  beforeEach(async () => {
    app = createTestApp();
    await User.deleteMany({});
    testUser = new User({
      email: "test@example.com",
      password: "password123",
      firstName: "Test",
      lastName: "User",
      preferences: {
        emailPreferences: {
          orderConfirmations: true,
          paymentReceipts: true,
          orderUpdates: false,
          promotionalEmails: false,
          welcomeEmails: true
        }
      }
    });
    await testUser.save();
    authToken = jwt.sign({
      userId: testUser._id
    }, process.env.JWT_SECRET || "test-secret", {
      expiresIn: "24h"
    });
  });
  afterEach(async () => {
    await User.deleteMany({});
  });
  describe("GET /api/auth/email-preferences", () => {
    it("should return user email preferences when authenticated", async () => {
      const response = await request(app).get("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).expect(200);
      expect(response.body).toEqual({
        success: true,
        preferences: {
          orderConfirmations: true,
          paymentReceipts: true,
          orderUpdates: false,
          promotionalEmails: false,
          welcomeEmails: true
        }
      });
    });
    it("should return 401 when not authenticated", async () => {
      const response = await request(app).get("/api/auth/email-preferences").expect(401);
      expect(response.body.success).toBe(false);
      expect(response.body.error.code).toBe("NO_TOKEN");
    });
  });
  describe("PUT /api/auth/email-preferences", () => {
    it("should update email preferences successfully", async () => {
      const newPreferences = {
        orderConfirmations: false,
        paymentReceipts: true,
        orderUpdates: true,
        promotionalEmails: true,
        welcomeEmails: false
      };
      const response = await request(app).put("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).send({
        emailPreferences: newPreferences
      }).expect(200);
      expect(response.body).toEqual({
        success: true,
        message: "Email preferences updated successfully",
        preferences: newPreferences
      });
    });
    it("should return 400 when emailPreferences is missing", async () => {
      const response = await request(app).put("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).send({}).expect(400);
      expect(response.body).toEqual({
        success: false,
        error: {
          code: "INVALID_PREFERENCES",
          message: "Valid email preferences object is required"
        }
      });
    });
    it("should return 401 when not authenticated", async () => {
      const response = await request(app).put("/api/auth/email-preferences").send({
        emailPreferences: {
          orderConfirmations: false
        }
      }).expect(401);
      expect(response.body.success).toBe(false);
      expect(response.body.error.code).toBe("NO_TOKEN");
    });
  });
  describe("Additional Edge Cases", () => {
    it("should return 400 with invalid preference keys", async () => {
      const invalidPreferences = {
        orderConfirmations: true,
        invalidKey: true,
        anotherInvalidKey: false
      };
      const response = await request(app).put("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).send({
        emailPreferences: invalidPreferences
      }).expect(400);
      expect(response.body).toEqual({
        success: false,
        error: {
          code: "INVALID_PREFERENCE_KEYS",
          message: "Invalid preference keys: invalidKey, anotherInvalidKey"
        }
      });
    });
    it("should return 400 when emailPreferences is not an object", async () => {
      const response = await request(app).put("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).send({
        emailPreferences: "invalid"
      }).expect(400);
      expect(response.body).toEqual({
        success: false,
        error: {
          code: "INVALID_PREFERENCES",
          message: "Valid email preferences object is required"
        }
      });
    });
    it("should update partial preferences", async () => {
      const partialPreferences = {
        promotionalEmails: true,
        orderUpdates: true
      };
      const response = await request(app).put("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).send({
        emailPreferences: partialPreferences
      }).expect(200);
      expect(response.body.success).toBe(true);
      expect(response.body.preferences.promotionalEmails).toBe(true);
      expect(response.body.preferences.orderUpdates).toBe(true);
      // Other preferences should remain unchanged
      expect(response.body.preferences.orderConfirmations).toBe(true);
      expect(response.body.preferences.paymentReceipts).toBe(true);
      expect(response.body.preferences.welcomeEmails).toBe(true);
    });
    it("should handle empty preferences object", async () => {
      const response = await request(app).put("/api/auth/email-preferences").set("Authorization", `Bearer ${authToken}`).send({
        emailPreferences: {}
      });
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.message).toBe("Email preferences updated successfully");
      // Original preferences should remain unchanged
      expect(response.body.preferences.orderConfirmations).toBe(true);
    });
    it("should return 401 with invalid token", async () => {
      const response = await request(app).get("/api/auth/email-preferences").set("Authorization", "Bearer invalid-token").expect(401);
      expect(response.body.success).toBe(false);
      expect(response.body.error.code).toBe("INVALID_TOKEN");
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsImV4cHJlc3MiLCJVc2VyIiwiand0IiwiYXV0aFJvdXRlcyIsImNyZWF0ZVRlc3RBcHAiLCJhcHAiLCJ1c2UiLCJqc29uIiwiZGVzY3JpYmUiLCJ0ZXN0VXNlciIsImF1dGhUb2tlbiIsImJlZm9yZUVhY2giLCJkZWxldGVNYW55IiwiZW1haWwiLCJwYXNzd29yZCIsImZpcnN0TmFtZSIsImxhc3ROYW1lIiwicHJlZmVyZW5jZXMiLCJlbWFpbFByZWZlcmVuY2VzIiwib3JkZXJDb25maXJtYXRpb25zIiwicGF5bWVudFJlY2VpcHRzIiwib3JkZXJVcGRhdGVzIiwicHJvbW90aW9uYWxFbWFpbHMiLCJ3ZWxjb21lRW1haWxzIiwic2F2ZSIsInNpZ24iLCJ1c2VySWQiLCJfaWQiLCJwcm9jZXNzIiwiZW52IiwiSldUX1NFQ1JFVCIsImV4cGlyZXNJbiIsImFmdGVyRWFjaCIsIml0IiwicmVzcG9uc2UiLCJnZXQiLCJzZXQiLCJleHBlY3QiLCJib2R5IiwidG9FcXVhbCIsInN1Y2Nlc3MiLCJ0b0JlIiwiZXJyb3IiLCJjb2RlIiwibmV3UHJlZmVyZW5jZXMiLCJwdXQiLCJzZW5kIiwibWVzc2FnZSIsImludmFsaWRQcmVmZXJlbmNlcyIsImludmFsaWRLZXkiLCJhbm90aGVySW52YWxpZEtleSIsInBhcnRpYWxQcmVmZXJlbmNlcyIsInN0YXR1cyJdLCJzb3VyY2VzIjpbImVtYWlsUHJlZmVyZW5jZXMudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCByZXF1ZXN0ID0gcmVxdWlyZShcInN1cGVydGVzdFwiKTtcbmNvbnN0IGV4cHJlc3MgPSByZXF1aXJlKFwiZXhwcmVzc1wiKTtcbmNvbnN0IFVzZXIgPSByZXF1aXJlKFwiLi4vLi4vbW9kZWxzL1VzZXJcIik7XG5jb25zdCBqd3QgPSByZXF1aXJlKFwianNvbndlYnRva2VuXCIpO1xuY29uc3QgYXV0aFJvdXRlcyA9IHJlcXVpcmUoXCIuLi8uLi9yb3V0ZXMvYXV0aFwiKTtcblxuLy8gQ3JlYXRlIHRlc3QgYXBwXG5jb25zdCBjcmVhdGVUZXN0QXBwID0gKCkgPT4ge1xuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xuICBhcHAudXNlKFwiL2FwaS9hdXRoXCIsIGF1dGhSb3V0ZXMpO1xuICByZXR1cm4gYXBwO1xufTtcblxuZGVzY3JpYmUoXCJFbWFpbCBQcmVmZXJlbmNlcyBFbmRwb2ludHNcIiwgKCkgPT4ge1xuICBsZXQgYXBwO1xuICBsZXQgdGVzdFVzZXI7XG4gIGxldCBhdXRoVG9rZW47XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXBwID0gY3JlYXRlVGVzdEFwcCgpO1xuICAgIGF3YWl0IFVzZXIuZGVsZXRlTWFueSh7fSk7XG5cbiAgICB0ZXN0VXNlciA9IG5ldyBVc2VyKHtcbiAgICAgIGVtYWlsOiBcInRlc3RAZXhhbXBsZS5jb21cIixcbiAgICAgIHBhc3N3b3JkOiBcInBhc3N3b3JkMTIzXCIsXG4gICAgICBmaXJzdE5hbWU6IFwiVGVzdFwiLFxuICAgICAgbGFzdE5hbWU6IFwiVXNlclwiLFxuICAgICAgcHJlZmVyZW5jZXM6IHtcbiAgICAgICAgZW1haWxQcmVmZXJlbmNlczoge1xuICAgICAgICAgIG9yZGVyQ29uZmlybWF0aW9uczogdHJ1ZSxcbiAgICAgICAgICBwYXltZW50UmVjZWlwdHM6IHRydWUsXG4gICAgICAgICAgb3JkZXJVcGRhdGVzOiBmYWxzZSxcbiAgICAgICAgICBwcm9tb3Rpb25hbEVtYWlsczogZmFsc2UsXG4gICAgICAgICAgd2VsY29tZUVtYWlsczogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgYXdhaXQgdGVzdFVzZXIuc2F2ZSgpO1xuXG4gICAgYXV0aFRva2VuID0gand0LnNpZ24oXG4gICAgICB7IHVzZXJJZDogdGVzdFVzZXIuX2lkIH0sXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUIHx8IFwidGVzdC1zZWNyZXRcIixcbiAgICAgIHsgZXhwaXJlc0luOiBcIjI0aFwiIH1cbiAgICApO1xuICB9KTtcblxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IFVzZXIuZGVsZXRlTWFueSh7fSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiR0VUIC9hcGkvYXV0aC9lbWFpbC1wcmVmZXJlbmNlc1wiLCAoKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIHVzZXIgZW1haWwgcHJlZmVyZW5jZXMgd2hlbiBhdXRoZW50aWNhdGVkXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoXCIvYXBpL2F1dGgvZW1haWwtcHJlZmVyZW5jZXNcIilcbiAgICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke2F1dGhUb2tlbn1gKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0VxdWFsKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgcHJlZmVyZW5jZXM6IHtcbiAgICAgICAgICBvcmRlckNvbmZpcm1hdGlvbnM6IHRydWUsXG4gICAgICAgICAgcGF5bWVudFJlY2VpcHRzOiB0cnVlLFxuICAgICAgICAgIG9yZGVyVXBkYXRlczogZmFsc2UsXG4gICAgICAgICAgcHJvbW90aW9uYWxFbWFpbHM6IGZhbHNlLFxuICAgICAgICAgIHdlbGNvbWVFbWFpbHM6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHJldHVybiA0MDEgd2hlbiBub3QgYXV0aGVudGljYXRlZFwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KFwiL2FwaS9hdXRoL2VtYWlsLXByZWZlcmVuY2VzXCIpXG4gICAgICAgIC5leHBlY3QoNDAxKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuc3VjY2VzcykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lcnJvci5jb2RlKS50b0JlKFwiTk9fVE9LRU5cIik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiUFVUIC9hcGkvYXV0aC9lbWFpbC1wcmVmZXJlbmNlc1wiLCAoKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgdXBkYXRlIGVtYWlsIHByZWZlcmVuY2VzIHN1Y2Nlc3NmdWxseVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBuZXdQcmVmZXJlbmNlcyA9IHtcbiAgICAgICAgb3JkZXJDb25maXJtYXRpb25zOiBmYWxzZSxcbiAgICAgICAgcGF5bWVudFJlY2VpcHRzOiB0cnVlLFxuICAgICAgICBvcmRlclVwZGF0ZXM6IHRydWUsXG4gICAgICAgIHByb21vdGlvbmFsRW1haWxzOiB0cnVlLFxuICAgICAgICB3ZWxjb21lRW1haWxzOiBmYWxzZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoXCIvYXBpL2F1dGgvZW1haWwtcHJlZmVyZW5jZXNcIilcbiAgICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke2F1dGhUb2tlbn1gKVxuICAgICAgICAuc2VuZCh7IGVtYWlsUHJlZmVyZW5jZXM6IG5ld1ByZWZlcmVuY2VzIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvRXF1YWwoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBcIkVtYWlsIHByZWZlcmVuY2VzIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5XCIsXG4gICAgICAgIHByZWZlcmVuY2VzOiBuZXdQcmVmZXJlbmNlcyxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIDQwMCB3aGVuIGVtYWlsUHJlZmVyZW5jZXMgaXMgbWlzc2luZ1wiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KFwiL2FwaS9hdXRoL2VtYWlsLXByZWZlcmVuY2VzXCIpXG4gICAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHthdXRoVG9rZW59YClcbiAgICAgICAgLnNlbmQoe30pXG4gICAgICAgIC5leHBlY3QoNDAwKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvRXF1YWwoe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiBcIklOVkFMSURfUFJFRkVSRU5DRVNcIixcbiAgICAgICAgICBtZXNzYWdlOiBcIlZhbGlkIGVtYWlsIHByZWZlcmVuY2VzIG9iamVjdCBpcyByZXF1aXJlZFwiLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCByZXR1cm4gNDAxIHdoZW4gbm90IGF1dGhlbnRpY2F0ZWRcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnB1dChcIi9hcGkvYXV0aC9lbWFpbC1wcmVmZXJlbmNlc1wiKVxuICAgICAgICAuc2VuZCh7IGVtYWlsUHJlZmVyZW5jZXM6IHsgb3JkZXJDb25maXJtYXRpb25zOiBmYWxzZSB9IH0pXG4gICAgICAgIC5leHBlY3QoNDAxKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuc3VjY2VzcykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lcnJvci5jb2RlKS50b0JlKFwiTk9fVE9LRU5cIik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiQWRkaXRpb25hbCBFZGdlIENhc2VzXCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCByZXR1cm4gNDAwIHdpdGggaW52YWxpZCBwcmVmZXJlbmNlIGtleXNcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52YWxpZFByZWZlcmVuY2VzID0ge1xuICAgICAgICBvcmRlckNvbmZpcm1hdGlvbnM6IHRydWUsXG4gICAgICAgIGludmFsaWRLZXk6IHRydWUsXG4gICAgICAgIGFub3RoZXJJbnZhbGlkS2V5OiBmYWxzZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoXCIvYXBpL2F1dGgvZW1haWwtcHJlZmVyZW5jZXNcIilcbiAgICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke2F1dGhUb2tlbn1gKVxuICAgICAgICAuc2VuZCh7IGVtYWlsUHJlZmVyZW5jZXM6IGludmFsaWRQcmVmZXJlbmNlcyB9KVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0VxdWFsKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogXCJJTlZBTElEX1BSRUZFUkVOQ0VfS0VZU1wiLFxuICAgICAgICAgIG1lc3NhZ2U6IFwiSW52YWxpZCBwcmVmZXJlbmNlIGtleXM6IGludmFsaWRLZXksIGFub3RoZXJJbnZhbGlkS2V5XCIsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHJldHVybiA0MDAgd2hlbiBlbWFpbFByZWZlcmVuY2VzIGlzIG5vdCBhbiBvYmplY3RcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnB1dChcIi9hcGkvYXV0aC9lbWFpbC1wcmVmZXJlbmNlc1wiKVxuICAgICAgICAuc2V0KFwiQXV0aG9yaXphdGlvblwiLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5zZW5kKHsgZW1haWxQcmVmZXJlbmNlczogXCJpbnZhbGlkXCIgfSlcbiAgICAgICAgLmV4cGVjdCg0MDApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9FcXVhbCh7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6IFwiSU5WQUxJRF9QUkVGRVJFTkNFU1wiLFxuICAgICAgICAgIG1lc3NhZ2U6IFwiVmFsaWQgZW1haWwgcHJlZmVyZW5jZXMgb2JqZWN0IGlzIHJlcXVpcmVkXCIsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHVwZGF0ZSBwYXJ0aWFsIHByZWZlcmVuY2VzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHBhcnRpYWxQcmVmZXJlbmNlcyA9IHtcbiAgICAgICAgcHJvbW90aW9uYWxFbWFpbHM6IHRydWUsXG4gICAgICAgIG9yZGVyVXBkYXRlczogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoXCIvYXBpL2F1dGgvZW1haWwtcHJlZmVyZW5jZXNcIilcbiAgICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke2F1dGhUb2tlbn1gKVxuICAgICAgICAuc2VuZCh7IGVtYWlsUHJlZmVyZW5jZXM6IHBhcnRpYWxQcmVmZXJlbmNlcyB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5wcmVmZXJlbmNlcy5wcm9tb3Rpb25hbEVtYWlscykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnByZWZlcmVuY2VzLm9yZGVyVXBkYXRlcykudG9CZSh0cnVlKTtcbiAgICAgIC8vIE90aGVyIHByZWZlcmVuY2VzIHNob3VsZCByZW1haW4gdW5jaGFuZ2VkXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5wcmVmZXJlbmNlcy5vcmRlckNvbmZpcm1hdGlvbnMpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5wcmVmZXJlbmNlcy5wYXltZW50UmVjZWlwdHMpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5wcmVmZXJlbmNlcy53ZWxjb21lRW1haWxzKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgaGFuZGxlIGVtcHR5IHByZWZlcmVuY2VzIG9iamVjdFwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KFwiL2FwaS9hdXRoL2VtYWlsLXByZWZlcmVuY2VzXCIpXG4gICAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHthdXRoVG9rZW59YClcbiAgICAgICAgLnNlbmQoeyBlbWFpbFByZWZlcmVuY2VzOiB7fSB9KTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5Lm1lc3NhZ2UpLnRvQmUoXG4gICAgICAgIFwiRW1haWwgcHJlZmVyZW5jZXMgdXBkYXRlZCBzdWNjZXNzZnVsbHlcIlxuICAgICAgKTtcbiAgICAgIC8vIE9yaWdpbmFsIHByZWZlcmVuY2VzIHNob3VsZCByZW1haW4gdW5jaGFuZ2VkXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5wcmVmZXJlbmNlcy5vcmRlckNvbmZpcm1hdGlvbnMpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCByZXR1cm4gNDAxIHdpdGggaW52YWxpZCB0b2tlblwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KFwiL2FwaS9hdXRoL2VtYWlsLXByZWZlcmVuY2VzXCIpXG4gICAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIFwiQmVhcmVyIGludmFsaWQtdG9rZW5cIilcbiAgICAgICAgLmV4cGVjdCg0MDEpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdWNjZXNzKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmVycm9yLmNvZGUpLnRvQmUoXCJJTlZBTElEX1RPS0VOXCIpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxXQUFXLENBQUM7QUFDcEMsTUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsU0FBUyxDQUFDO0FBQ2xDLE1BQU1FLElBQUksR0FBR0YsT0FBTyxDQUFDLG1CQUFtQixDQUFDO0FBQ3pDLE1BQU1HLEdBQUcsR0FBR0gsT0FBTyxDQUFDLGNBQWMsQ0FBQztBQUNuQyxNQUFNSSxVQUFVLEdBQUdKLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQzs7QUFFL0M7QUFDQSxNQUFNSyxhQUFhLEdBQUdBLENBQUEsS0FBTTtFQUMxQixNQUFNQyxHQUFHLEdBQUdMLE9BQU8sQ0FBQyxDQUFDO0VBQ3JCSyxHQUFHLENBQUNDLEdBQUcsQ0FBQ04sT0FBTyxDQUFDTyxJQUFJLENBQUMsQ0FBQyxDQUFDO0VBQ3ZCRixHQUFHLENBQUNDLEdBQUcsQ0FBQyxXQUFXLEVBQUVILFVBQVUsQ0FBQztFQUNoQyxPQUFPRSxHQUFHO0FBQ1osQ0FBQztBQUVERyxRQUFRLENBQUMsNkJBQTZCLEVBQUUsTUFBTTtFQUM1QyxJQUFJSCxHQUFHO0VBQ1AsSUFBSUksUUFBUTtFQUNaLElBQUlDLFNBQVM7RUFFYkMsVUFBVSxDQUFDLFlBQVk7SUFDckJO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LFdBQVcsQ0FBQ0csZUFBZSxDQUFDLENBQUNxQixJQUFJLENBQUMsSUFBSSxDQUFDO01BQzVESixNQUFNLENBQUNILFFBQVEsQ0FBQ0ksSUFBSSxDQUFDckIsV0FBVyxDQUFDTSxhQUFhLENBQUMsQ0FBQ2tCLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDNUQsQ0FBQyxDQUFDO0lBRUZSLEVBQUUsQ0FBQyx3Q0FBd0MsRUFBRSxZQUFZO01BQ3ZELE1BQU1DLFFBQVEsR0FBRyxNQUFNcEMsT0FBTyxDQUFDTyxHQUFHLENBQUMsQ0FDaEN3QyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FDbENULEdBQUcsQ0FBQyxlQUFlLEVBQUUsVUFBVTFCLFNBQVMsRUFBRSxDQUFDLENBQzNDb0MsSUFBSSxDQUFDO1FBQUU1QixnQkFBZ0IsRUFBRSxDQUFDO01BQUUsQ0FBQyxDQUFDO01BRWpDbUIsTUFBTSxDQUFDSCxRQUFRLENBQUNrQixNQUFNLENBQUMsQ0FBQ1gsSUFBSSxDQUFDLEdBQUcsQ0FBQztNQUNqQ0osTUFBTSxDQUFDSCxRQUFRLENBQUNJLElBQUksQ0FBQ0UsT0FBTyxDQUFDLENBQUNDLElBQUksQ0FBQyxJQUFJLENBQUM7TUFDeENKLE1BQU0sQ0FBQ0gsUUFBUSxDQUFDSSxJQUFJLENBQUNTLE9BQU8sQ0FBQyxDQUFDTixJQUFJLENBQ2hDLHdDQUNGLENBQUM7TUFDRDtNQUNBSixNQUFNLENBQUNILFFBQVEsQ0FBQ0ksSUFBSSxDQUFDckIsV0FBVyxDQUFDRSxrQkFBa0IsQ0FBQyxDQUFDc0IsSUFBSSxDQUFDLElBQUksQ0FBQztJQUNqRSxDQUFDLENBQUM7SUFFRlIsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLFlBQVk7TUFDckQsTUFBTUMsUUFBUSxHQUFHLE1BQU1wQyxPQUFPLENBQUNPLEdBQUcsQ0FBQyxDQUNoQzhCLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQyxDQUNsQ0MsR0FBRyxDQUFDLGVBQWUsRUFBRSxzQkFBc0IsQ0FBQyxDQUM1Q0MsTUFBTSxDQUFDLEdBQUcsQ0FBQztNQUVkQSxNQUFNLENBQUNILFFBQVEsQ0FBQ0ksSUFBSSxDQUFDRSxPQUFPLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLEtBQUssQ0FBQztNQUN6Q0osTUFBTSxDQUFDSCxRQUFRLENBQUNJLElBQUksQ0FBQ0ksS0FBSyxDQUFDQyxJQUFJLENBQUMsQ0FBQ0YsSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUN4RCxDQUFDLENBQUM7RUFDSixDQUFDLENBQUM7QUFDSixDQUFDLENBQUMiLCJpZ25vcmVMaXN0IjpbXX0=