c6ad699f6fc9429f10ae783e205ae731
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const session = require('express-session');
const MongoStore = require('connect-mongo');
const cookieParser = require('cookie-parser');
const path = require('path');
require('dotenv').config();

// Debug: Log environment variables
console.log('Environment variables loaded:');
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('PORT:', process.env.PORT);
console.log('JWT_SECRET exists:', !!process.env.JWT_SECRET);
console.log('JWT_SECRET length:', process.env.JWT_SECRET ? process.env.JWT_SECRET.length : 0);

// Validate critical environment variables at startup
if (!process.env.JWT_SECRET && process.env.NODE_ENV !== 'test') {
  console.error('FATAL ERROR: JWT_SECRET environment variable is not set. This is required for secure token generation.');
  process.exit(1);
}
if (!process.env.JWT_SECRET || process.env.JWT_SECRET.length < 32) {
  if (process.env.NODE_ENV !== 'test') {
    console.error('FATAL ERROR: JWT_SECRET must be at least 32 characters long for security.');
    console.error('Current JWT_SECRET length:', process.env.JWT_SECRET ? process.env.JWT_SECRET.length : 0);
    process.exit(1);
  }
}

// Import logging and error handling
const {
  logger
} = require('./utils/logger');
const {
  globalErrorHandler
} = require('./middleware/errorHandler');
const {
  rateLimits,
  speedLimiter,
  sanitizeInput,
  securityHeaders
} = require('./middleware/security');
const app = express();

// Security middleware
app.use(helmet());
app.use(securityHeaders);
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000', 'http://localhost:3001', 'http://localhost:3003', 'http://localhost:5173'],
  credentials: true
}));

// Input sanitization
app.use(sanitizeInput);

// General rate limiting
app.use(rateLimits.general);

// Speed limiting for brute force protection
app.use(speedLimiter);

// Import unified session/CSRF management
const {
  createSessionConfig,
  generateCSRFToken,
  validateCSRFToken,
  enhanceGuestSession,
  cleanupGuestSession
} = require('./middleware/sessionCSRF');

// Session middleware with unified config
const mongoUrl = process.env.MONGODB_URI || 'mongodb://localhost:27017/holistic-store';
app.use(session(createSessionConfig(mongoUrl)));

// Session enhancement middleware
app.use(generateCSRFToken);
app.use(enhanceGuestSession);
app.use(cleanupGuestSession);

// Body parsing middleware
app.use(express.json({
  limit: '10mb'
}));
app.use(express.urlencoded({
  extended: true
}));

// Cookie parser middleware
app.use(cookieParser());

// Static files
app.use('/uploads', express.static('uploads'));
app.use(express.static('public'));

// Database connection
mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/holistic-store', {
  useNewUrlParser: true,
  useUnifiedTopology: true
}).then(() => {
  console.log('Connected to MongoDB');
}).catch(error => {
  console.warn('MongoDB connection failed:', error.message);
  console.warn('Running in development mode without database');
});

// Handle MongoDB connection events
mongoose.connection.on('error', error => {
  console.warn('MongoDB connection error:', error.message);
});
mongoose.connection.on('disconnected', () => {
  console.warn('MongoDB disconnected');
});

// Routes with specific rate limiting
app.use('/api/auth', rateLimits.auth, require('./routes/auth'));
app.use('/api/products', require('./routes/products'));
app.use('/api/cart', require('./routes/cart'));
app.use('/api/orders', require('./routes/orders'));
app.use('/api/payments', rateLimits.payment, require('./routes/payments'));
app.use('/api/wholesalers', require('./routes/wholesalers'));
app.use('/api/integration', rateLimits.integration, require('./routes/integration'));
app.use('/api/admin', rateLimits.admin, require('./routes/admin'));
app.use('/api/monitoring', require('./routes/monitoring'));

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString()
  });
});

// CSRF token endpoint
app.get('/api/csrf-token', (req, res) => {
  res.json({
    success: true,
    csrfToken: req.session.csrfToken,
    sessionInfo: {
      isGuest: !req.user && !!req.session.guestId,
      hasCart: !!req.session.cart && !!req.session.cart.items && req.session.cart.items.length > 0
    }
  });
});

// Root route for API info
app.get('/', (req, res) => {
  res.json({
    message: 'Holistic Dropship Store API',
    version: '1.0.0',
    endpoints: {
      health: '/health',
      auth: '/api/auth',
      products: '/api/products',
      cart: '/api/cart',
      orders: '/api/orders',
      payments: '/api/payments'
    },
    frontend: process.env.FRONTEND_URL || 'http://localhost:3000'
  });
});

// Global error handling middleware (must be last)
app.use(globalErrorHandler);

// Serve React app in production
if (process.env.NODE_ENV === 'production') {
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'build', 'index.html'));
  });
}
const PORT = process.env.PORT || 5001;

// Only start server if not in test mode
if (process.env.NODE_ENV !== 'test') {
  app.listen(PORT, () => {
    logger.info(`Server running on port ${PORT}`);
  });
}

// Export app for testing
module.exports = app;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsIm1vbmdvb3NlIiwiY29ycyIsImhlbG1ldCIsInJhdGVMaW1pdCIsInNlc3Npb24iLCJNb25nb1N0b3JlIiwiY29va2llUGFyc2VyIiwicGF0aCIsImNvbmZpZyIsImNvbnNvbGUiLCJsb2ciLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJQT1JUIiwiSldUX1NFQ1JFVCIsImxlbmd0aCIsImVycm9yIiwiZXhpdCIsImxvZ2dlciIsImdsb2JhbEVycm9ySGFuZGxlciIsInJhdGVMaW1pdHMiLCJzcGVlZExpbWl0ZXIiLCJzYW5pdGl6ZUlucHV0Iiwic2VjdXJpdHlIZWFkZXJzIiwiYXBwIiwidXNlIiwib3JpZ2luIiwiQUxMT1dFRF9PUklHSU5TIiwic3BsaXQiLCJjcmVkZW50aWFscyIsImdlbmVyYWwiLCJjcmVhdGVTZXNzaW9uQ29uZmlnIiwiZ2VuZXJhdGVDU1JGVG9rZW4iLCJ2YWxpZGF0ZUNTUkZUb2tlbiIsImVuaGFuY2VHdWVzdFNlc3Npb24iLCJjbGVhbnVwR3Vlc3RTZXNzaW9uIiwibW9uZ29VcmwiLCJNT05HT0RCX1VSSSIsImpzb24iLCJsaW1pdCIsInVybGVuY29kZWQiLCJleHRlbmRlZCIsInN0YXRpYyIsImNvbm5lY3QiLCJ1c2VOZXdVcmxQYXJzZXIiLCJ1c2VVbmlmaWVkVG9wb2xvZ3kiLCJ0aGVuIiwiY2F0Y2giLCJ3YXJuIiwibWVzc2FnZSIsImNvbm5lY3Rpb24iLCJvbiIsImF1dGgiLCJwYXltZW50IiwiaW50ZWdyYXRpb24iLCJhZG1pbiIsImdldCIsInJlcSIsInJlcyIsInN0YXR1cyIsInRpbWVzdGFtcCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsInN1Y2Nlc3MiLCJjc3JmVG9rZW4iLCJzZXNzaW9uSW5mbyIsImlzR3Vlc3QiLCJ1c2VyIiwiZ3Vlc3RJZCIsImhhc0NhcnQiLCJjYXJ0IiwiaXRlbXMiLCJ2ZXJzaW9uIiwiZW5kcG9pbnRzIiwiaGVhbHRoIiwicHJvZHVjdHMiLCJvcmRlcnMiLCJwYXltZW50cyIsImZyb250ZW5kIiwiRlJPTlRFTkRfVVJMIiwic2VuZEZpbGUiLCJqb2luIiwiX19kaXJuYW1lIiwibGlzdGVuIiwiaW5mbyIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJzZXJ2ZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbmNvbnN0IG1vbmdvb3NlID0gcmVxdWlyZSgnbW9uZ29vc2UnKTtcbmNvbnN0IGNvcnMgPSByZXF1aXJlKCdjb3JzJyk7XG5jb25zdCBoZWxtZXQgPSByZXF1aXJlKCdoZWxtZXQnKTtcbmNvbnN0IHJhdGVMaW1pdCA9IHJlcXVpcmUoJ2V4cHJlc3MtcmF0ZS1saW1pdCcpO1xuY29uc3Qgc2Vzc2lvbiA9IHJlcXVpcmUoJ2V4cHJlc3Mtc2Vzc2lvbicpO1xuY29uc3QgTW9uZ29TdG9yZSA9IHJlcXVpcmUoJ2Nvbm5lY3QtbW9uZ28nKTtcbmNvbnN0IGNvb2tpZVBhcnNlciA9IHJlcXVpcmUoJ2Nvb2tpZS1wYXJzZXInKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5yZXF1aXJlKCdkb3RlbnYnKS5jb25maWcoKTtcblxuLy8gRGVidWc6IExvZyBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbmNvbnNvbGUubG9nKCdFbnZpcm9ubWVudCB2YXJpYWJsZXMgbG9hZGVkOicpO1xuY29uc29sZS5sb2coJ05PREVfRU5WOicsIHByb2Nlc3MuZW52Lk5PREVfRU5WKTtcbmNvbnNvbGUubG9nKCdQT1JUOicsIHByb2Nlc3MuZW52LlBPUlQpO1xuY29uc29sZS5sb2coJ0pXVF9TRUNSRVQgZXhpc3RzOicsICEhcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCk7XG5jb25zb2xlLmxvZygnSldUX1NFQ1JFVCBsZW5ndGg6JywgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA/IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQubGVuZ3RoIDogMCk7XG5cbi8vIFZhbGlkYXRlIGNyaXRpY2FsIGVudmlyb25tZW50IHZhcmlhYmxlcyBhdCBzdGFydHVwXG5pZiAoIXByb2Nlc3MuZW52LkpXVF9TRUNSRVQgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICBjb25zb2xlLmVycm9yKCdGQVRBTCBFUlJPUjogSldUX1NFQ1JFVCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0LiBUaGlzIGlzIHJlcXVpcmVkIGZvciBzZWN1cmUgdG9rZW4gZ2VuZXJhdGlvbi4nKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG5pZiAoIXByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVC5sZW5ndGggPCAzMikge1xuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZBVEFMIEVSUk9SOiBKV1RfU0VDUkVUIG11c3QgYmUgYXQgbGVhc3QgMzIgY2hhcmFjdGVycyBsb25nIGZvciBzZWN1cml0eS4nKTtcbiAgICBjb25zb2xlLmVycm9yKCdDdXJyZW50IEpXVF9TRUNSRVQgbGVuZ3RoOicsIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPyBwcm9jZXNzLmVudi5KV1RfU0VDUkVULmxlbmd0aCA6IDApO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxufVxuXG4vLyBJbXBvcnQgbG9nZ2luZyBhbmQgZXJyb3IgaGFuZGxpbmdcbmNvbnN0IHsgbG9nZ2VyIH0gPSByZXF1aXJlKCcuL3V0aWxzL2xvZ2dlcicpO1xuY29uc3QgeyBnbG9iYWxFcnJvckhhbmRsZXIgfSA9IHJlcXVpcmUoJy4vbWlkZGxld2FyZS9lcnJvckhhbmRsZXInKTtcbmNvbnN0IHsgXG4gIHJhdGVMaW1pdHMsIFxuICBzcGVlZExpbWl0ZXIsIFxuICBzYW5pdGl6ZUlucHV0LCBcbiAgc2VjdXJpdHlIZWFkZXJzIFxufSA9IHJlcXVpcmUoJy4vbWlkZGxld2FyZS9zZWN1cml0eScpO1xuXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5cbi8vIFNlY3VyaXR5IG1pZGRsZXdhcmVcbmFwcC51c2UoaGVsbWV0KCkpO1xuYXBwLnVzZShzZWN1cml0eUhlYWRlcnMpO1xuYXBwLnVzZShjb3JzKHtcbiAgb3JpZ2luOiBwcm9jZXNzLmVudi5BTExPV0VEX09SSUdJTlM/LnNwbGl0KCcsJykgfHwgWydodHRwOi8vbG9jYWxob3N0OjMwMDAnLCAnaHR0cDovL2xvY2FsaG9zdDozMDAxJywgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMycsICdodHRwOi8vbG9jYWxob3N0OjUxNzMnXSxcbiAgY3JlZGVudGlhbHM6IHRydWVcbn0pKTtcblxuLy8gSW5wdXQgc2FuaXRpemF0aW9uXG5hcHAudXNlKHNhbml0aXplSW5wdXQpO1xuXG4vLyBHZW5lcmFsIHJhdGUgbGltaXRpbmdcbmFwcC51c2UocmF0ZUxpbWl0cy5nZW5lcmFsKTtcblxuLy8gU3BlZWQgbGltaXRpbmcgZm9yIGJydXRlIGZvcmNlIHByb3RlY3Rpb25cbmFwcC51c2Uoc3BlZWRMaW1pdGVyKTtcblxuLy8gSW1wb3J0IHVuaWZpZWQgc2Vzc2lvbi9DU1JGIG1hbmFnZW1lbnRcbmNvbnN0IHsgXG4gIGNyZWF0ZVNlc3Npb25Db25maWcsIFxuICBnZW5lcmF0ZUNTUkZUb2tlbixcbiAgdmFsaWRhdGVDU1JGVG9rZW4sXG4gIGVuaGFuY2VHdWVzdFNlc3Npb24sXG4gIGNsZWFudXBHdWVzdFNlc3Npb24gXG59ID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL3Nlc3Npb25DU1JGJyk7XG5cbi8vIFNlc3Npb24gbWlkZGxld2FyZSB3aXRoIHVuaWZpZWQgY29uZmlnXG5jb25zdCBtb25nb1VybCA9IHByb2Nlc3MuZW52Lk1PTkdPREJfVVJJIHx8ICdtb25nb2RiOi8vbG9jYWxob3N0OjI3MDE3L2hvbGlzdGljLXN0b3JlJztcbmFwcC51c2Uoc2Vzc2lvbihjcmVhdGVTZXNzaW9uQ29uZmlnKG1vbmdvVXJsKSkpO1xuXG4vLyBTZXNzaW9uIGVuaGFuY2VtZW50IG1pZGRsZXdhcmVcbmFwcC51c2UoZ2VuZXJhdGVDU1JGVG9rZW4pO1xuYXBwLnVzZShlbmhhbmNlR3Vlc3RTZXNzaW9uKTtcbmFwcC51c2UoY2xlYW51cEd1ZXN0U2Vzc2lvbik7XG5cbi8vIEJvZHkgcGFyc2luZyBtaWRkbGV3YXJlXG5hcHAudXNlKGV4cHJlc3MuanNvbih7IGxpbWl0OiAnMTBtYicgfSkpO1xuYXBwLnVzZShleHByZXNzLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XG5cbi8vIENvb2tpZSBwYXJzZXIgbWlkZGxld2FyZVxuYXBwLnVzZShjb29raWVQYXJzZXIoKSk7XG5cbi8vIFN0YXRpYyBmaWxlc1xuYXBwLnVzZSgnL3VwbG9hZHMnLCBleHByZXNzLnN0YXRpYygndXBsb2FkcycpKTtcbmFwcC51c2UoZXhwcmVzcy5zdGF0aWMoJ3B1YmxpYycpKTtcblxuLy8gRGF0YWJhc2UgY29ubmVjdGlvblxubW9uZ29vc2UuY29ubmVjdChwcm9jZXNzLmVudi5NT05HT0RCX1VSSSB8fCAnbW9uZ29kYjovL2xvY2FsaG9zdDoyNzAxNy9ob2xpc3RpYy1zdG9yZScsIHtcbiAgdXNlTmV3VXJsUGFyc2VyOiB0cnVlLFxuICB1c2VVbmlmaWVkVG9wb2xvZ3k6IHRydWUsXG59KS50aGVuKCgpID0+IHtcbiAgY29uc29sZS5sb2coJ0Nvbm5lY3RlZCB0byBNb25nb0RCJyk7XG59KS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgY29uc29sZS53YXJuKCdNb25nb0RCIGNvbm5lY3Rpb24gZmFpbGVkOicsIGVycm9yLm1lc3NhZ2UpO1xuICBjb25zb2xlLndhcm4oJ1J1bm5pbmcgaW4gZGV2ZWxvcG1lbnQgbW9kZSB3aXRob3V0IGRhdGFiYXNlJyk7XG59KTtcblxuLy8gSGFuZGxlIE1vbmdvREIgY29ubmVjdGlvbiBldmVudHNcbm1vbmdvb3NlLmNvbm5lY3Rpb24ub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XG4gIGNvbnNvbGUud2FybignTW9uZ29EQiBjb25uZWN0aW9uIGVycm9yOicsIGVycm9yLm1lc3NhZ2UpO1xufSk7XG5cbm1vbmdvb3NlLmNvbm5lY3Rpb24ub24oJ2Rpc2Nvbm5lY3RlZCcsICgpID0+IHtcbiAgY29uc29sZS53YXJuKCdNb25nb0RCIGRpc2Nvbm5lY3RlZCcpO1xufSk7XG5cbi8vIFJvdXRlcyB3aXRoIHNwZWNpZmljIHJhdGUgbGltaXRpbmdcbmFwcC51c2UoJy9hcGkvYXV0aCcsIHJhdGVMaW1pdHMuYXV0aCwgcmVxdWlyZSgnLi9yb3V0ZXMvYXV0aCcpKTtcbmFwcC51c2UoJy9hcGkvcHJvZHVjdHMnLCByZXF1aXJlKCcuL3JvdXRlcy9wcm9kdWN0cycpKTtcbmFwcC51c2UoJy9hcGkvY2FydCcsIHJlcXVpcmUoJy4vcm91dGVzL2NhcnQnKSk7XG5hcHAudXNlKCcvYXBpL29yZGVycycsIHJlcXVpcmUoJy4vcm91dGVzL29yZGVycycpKTtcbmFwcC51c2UoJy9hcGkvcGF5bWVudHMnLCByYXRlTGltaXRzLnBheW1lbnQsIHJlcXVpcmUoJy4vcm91dGVzL3BheW1lbnRzJykpO1xuYXBwLnVzZSgnL2FwaS93aG9sZXNhbGVycycsIHJlcXVpcmUoJy4vcm91dGVzL3dob2xlc2FsZXJzJykpO1xuYXBwLnVzZSgnL2FwaS9pbnRlZ3JhdGlvbicsIHJhdGVMaW1pdHMuaW50ZWdyYXRpb24sIHJlcXVpcmUoJy4vcm91dGVzL2ludGVncmF0aW9uJykpO1xuYXBwLnVzZSgnL2FwaS9hZG1pbicsIHJhdGVMaW1pdHMuYWRtaW4sIHJlcXVpcmUoJy4vcm91dGVzL2FkbWluJykpO1xuYXBwLnVzZSgnL2FwaS9tb25pdG9yaW5nJywgcmVxdWlyZSgnLi9yb3V0ZXMvbW9uaXRvcmluZycpKTtcblxuLy8gSGVhbHRoIGNoZWNrXG5hcHAuZ2V0KCcvaGVhbHRoJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5qc29uKHsgc3RhdHVzOiAnT0snLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9KTtcbn0pO1xuXG4vLyBDU1JGIHRva2VuIGVuZHBvaW50XG5hcHAuZ2V0KCcvYXBpL2NzcmYtdG9rZW4nLCAocmVxLCByZXMpID0+IHtcbiAgcmVzLmpzb24oeyBcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGNzcmZUb2tlbjogcmVxLnNlc3Npb24uY3NyZlRva2VuLFxuICAgIHNlc3Npb25JbmZvOiB7XG4gICAgICBpc0d1ZXN0OiAhcmVxLnVzZXIgJiYgISFyZXEuc2Vzc2lvbi5ndWVzdElkLFxuICAgICAgaGFzQ2FydDogISFyZXEuc2Vzc2lvbi5jYXJ0ICYmICEhcmVxLnNlc3Npb24uY2FydC5pdGVtcyAmJiByZXEuc2Vzc2lvbi5jYXJ0Lml0ZW1zLmxlbmd0aCA+IDBcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8vIFJvb3Qgcm91dGUgZm9yIEFQSSBpbmZvXG5hcHAuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5qc29uKHtcbiAgICBtZXNzYWdlOiAnSG9saXN0aWMgRHJvcHNoaXAgU3RvcmUgQVBJJyxcbiAgICB2ZXJzaW9uOiAnMS4wLjAnLFxuICAgIGVuZHBvaW50czoge1xuICAgICAgaGVhbHRoOiAnL2hlYWx0aCcsXG4gICAgICBhdXRoOiAnL2FwaS9hdXRoJyxcbiAgICAgIHByb2R1Y3RzOiAnL2FwaS9wcm9kdWN0cycsXG4gICAgICBjYXJ0OiAnL2FwaS9jYXJ0JyxcbiAgICAgIG9yZGVyczogJy9hcGkvb3JkZXJzJyxcbiAgICAgIHBheW1lbnRzOiAnL2FwaS9wYXltZW50cydcbiAgICB9LFxuICAgIGZyb250ZW5kOiBwcm9jZXNzLmVudi5GUk9OVEVORF9VUkwgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCdcbiAgfSk7XG59KTtcblxuLy8gR2xvYmFsIGVycm9yIGhhbmRsaW5nIG1pZGRsZXdhcmUgKG11c3QgYmUgbGFzdClcbmFwcC51c2UoZ2xvYmFsRXJyb3JIYW5kbGVyKTtcblxuLy8gU2VydmUgUmVhY3QgYXBwIGluIHByb2R1Y3Rpb25cbmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG4gIGFwcC5nZXQoJyonLCAocmVxLCByZXMpID0+IHtcbiAgICByZXMuc2VuZEZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2J1aWxkJywgJ2luZGV4Lmh0bWwnKSk7XG4gIH0pO1xufVxuXG5jb25zdCBQT1JUID0gcHJvY2Vzcy5lbnYuUE9SVCB8fCA1MDAxO1xuXG4vLyBPbmx5IHN0YXJ0IHNlcnZlciBpZiBub3QgaW4gdGVzdCBtb2RlXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICBhcHAubGlzdGVuKFBPUlQsICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbyhgU2VydmVyIHJ1bm5pbmcgb24gcG9ydCAke1BPUlR9YCk7XG4gIH0pO1xufVxuXG4vLyBFeHBvcnQgYXBwIGZvciB0ZXN0aW5nXG5tb2R1bGUuZXhwb3J0cyA9IGFwcDsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFNBQVMsQ0FBQztBQUNsQyxNQUFNQyxRQUFRLEdBQUdELE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDcEMsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzVCLE1BQU1HLE1BQU0sR0FBR0gsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUNoQyxNQUFNSSxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQztBQUMvQyxNQUFNSyxPQUFPLEdBQUdMLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQztBQUMxQyxNQUFNTSxVQUFVLEdBQUdOLE9BQU8sQ0FBQyxlQUFlLENBQUM7QUFDM0MsTUFBTU8sWUFBWSxHQUFHUCxPQUFPLENBQUMsZUFBZSxDQUFDO0FBQzdDLE1BQU1RLElBQUksR0FBR1IsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUM1QkEsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDUyxNQUFNLENBQUMsQ0FBQzs7QUFFMUI7QUFDQUMsT0FBTyxDQUFDQyxHQUFHLENBQUMsK0JBQStCLENBQUM7QUFDNUNELE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLFdBQVcsRUFBRUMsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFFBQVEsQ0FBQztBQUM5Q0osT0FBTyxDQUFDQyxHQUFHLENBQUMsT0FBTyxFQUFFQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0UsSUFBSSxDQUFDO0FBQ3RDTCxPQUFPLENBQUNDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUNDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRyxVQUFVLENBQUM7QUFDM0ROLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLG9CQUFvQixFQUFFQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0csVUFBVSxHQUFHSixPQUFPLENBQUNDLEdBQUcsQ0FBQ0csVUFBVSxDQUFDQyxNQUFNLEdBQUcsQ0FBQyxDQUFDOztBQUU3RjtBQUNBLElBQUksQ0FBQ0wsT0FBTyxDQUFDQyxHQUFHLENBQUNHLFVBQVUsSUFBSUosT0FBTyxDQUFDQyxHQUFHLENBQUNDLFFBQVEsS0FBSyxNQUFNLEVBQUU7RUFDOURKLE9BQU8sQ0FBQ1EsS0FBSyxDQUFDLHdHQUF3RyxDQUFDO0VBQ3ZITixPQUFPLENBQUNPLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDakI7QUFFQSxJQUFJLENBQUNQLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRyxVQUFVLElBQUlKLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRyxVQUFVLENBQUNDLE1BQU0sR0FBRyxFQUFFLEVBQUU7RUFDakUsSUFBSUwsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFFBQVEsS0FBSyxNQUFNLEVBQUU7SUFDbkNKLE9BQU8sQ0FBQ1EsS0FBSyxDQUFDLDJFQUEyRSxDQUFDO0lBQzFGUixPQUFPLENBQUNRLEtBQUssQ0FBQyw0QkFBNEIsRUFBRU4sT0FBTyxDQUFDQyxHQUFHLENBQUNHLFVBQVUsR0FBR0osT0FBTyxDQUFDQyxHQUFHLENBQUNHLFVBQVUsQ0FBQ0MsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUN2R0wsT0FBTyxDQUFDTyxJQUFJLENBQUMsQ0FBQyxDQUFDO0VBQ2pCO0FBQ0Y7O0FBRUE7QUFDQSxNQUFNO0VBQUVDO0FBQU8sQ0FBQyxHQUFHcEIsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQzVDLE1BQU07RUFBRXFCO0FBQW1CLENBQUMsR0FBR3JCLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQztBQUNuRSxNQUFNO0VBQ0pzQixVQUFVO0VBQ1ZDLFlBQVk7RUFDWkMsYUFBYTtFQUNiQztBQUNGLENBQUMsR0FBR3pCLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUVwQyxNQUFNMEIsR0FBRyxHQUFHM0IsT0FBTyxDQUFDLENBQUM7O0FBRXJCO0FBQ0EyQixHQUFHLENBQUNDLEdBQUcsQ0FBQ3hCLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDakJ1QixHQUFHLENBQUNDLEdBQUcsQ0FBQ0YsZUFBZSxDQUFDO0FBQ3hCQyxHQUFHLENBQUNDLEdBQUcsQ0FBQ3pCLElBQUksQ0FBQztFQUNYMEIsTUFBTSxFQUFFaEIsT0FBTyxDQUFDQyxHQUFHLENBQUNnQixlQUFlLEVBQUVDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLHVCQUF1QixFQUFFLHVCQUF1QixFQUFFLHVCQUF1QixDQUFDO0VBQ3ZKQyxXQUFXLEVBQUU7QUFDZixDQUFDLENBQUMsQ0FBQzs7QUFFSDtBQUNBTCxHQUFHLENBQUNDLEdBQUcsQ0FBQ0gsYUFBYSxDQUFDOztBQUV0QjtBQUNBRSxHQUFHLENBQUNDLEdBQUcsQ0FBQ0wsVUFBVSxDQUFDVSxPQUFPLENBQUM7O0FBRTNCO0FBQ0FOLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDSixZQUFZLENBQUM7O0FBRXJCO0FBQ0EsTUFBTTtFQUNKVSxtQkFBbUI7RUFDbkJDLGlCQUFpQjtFQUNqQkMsaUJBQWlCO0VBQ2pCQyxtQkFBbUI7RUFDbkJDO0FBQ0YsQ0FBQyxHQUFHckMsT0FBTyxDQUFDLDBCQUEwQixDQUFDOztBQUV2QztBQUNBLE1BQU1zQyxRQUFRLEdBQUcxQixPQUFPLENBQUNDLEdBQUcsQ0FBQzBCLFdBQVcsSUFBSSwwQ0FBMEM7QUFDdEZiLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDdEIsT0FBTyxDQUFDNEIsbUJBQW1CLENBQUNLLFFBQVEsQ0FBQyxDQUFDLENBQUM7O0FBRS9DO0FBQ0FaLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDTyxpQkFBaUIsQ0FBQztBQUMxQlIsR0FBRyxDQUFDQyxHQUFHLENBQUNTLG1CQUFtQixDQUFDO0FBQzVCVixHQUFHLENBQUNDLEdBQUcsQ0FBQ1UsbUJBQW1CLENBQUM7O0FBRTVCO0FBQ0FYLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDNUIsT0FBTyxDQUFDeUMsSUFBSSxDQUFDO0VBQUVDLEtBQUssRUFBRTtBQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ3hDZixHQUFHLENBQUNDLEdBQUcsQ0FBQzVCLE9BQU8sQ0FBQzJDLFVBQVUsQ0FBQztFQUFFQyxRQUFRLEVBQUU7QUFBSyxDQUFDLENBQUMsQ0FBQzs7QUFFL0M7QUFDQWpCLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDcEIsWUFBWSxDQUFDLENBQUMsQ0FBQzs7QUFFdkI7QUFDQW1CLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDLFVBQVUsRUFBRTVCLE9BQU8sQ0FBQzZDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM5Q2xCLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDNUIsT0FBTyxDQUFDNkMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDOztBQUVqQztBQUNBM0MsUUFBUSxDQUFDNEMsT0FBTyxDQUFDakMsT0FBTyxDQUFDQyxHQUFHLENBQUMwQixXQUFXLElBQUksMENBQTBDLEVBQUU7RUFDdEZPLGVBQWUsRUFBRSxJQUFJO0VBQ3JCQyxrQkFBa0IsRUFBRTtBQUN0QixDQUFDLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLE1BQU07RUFDWnRDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLHNCQUFzQixDQUFDO0FBQ3JDLENBQUMsQ0FBQyxDQUFDc0MsS0FBSyxDQUFFL0IsS0FBSyxJQUFLO0VBQ2xCUixPQUFPLENBQUN3QyxJQUFJLENBQUMsNEJBQTRCLEVBQUVoQyxLQUFLLENBQUNpQyxPQUFPLENBQUM7RUFDekR6QyxPQUFPLENBQUN3QyxJQUFJLENBQUMsOENBQThDLENBQUM7QUFDOUQsQ0FBQyxDQUFDOztBQUVGO0FBQ0FqRCxRQUFRLENBQUNtRCxVQUFVLENBQUNDLEVBQUUsQ0FBQyxPQUFPLEVBQUduQyxLQUFLLElBQUs7RUFDekNSLE9BQU8sQ0FBQ3dDLElBQUksQ0FBQywyQkFBMkIsRUFBRWhDLEtBQUssQ0FBQ2lDLE9BQU8sQ0FBQztBQUMxRCxDQUFDLENBQUM7QUFFRmxELFFBQVEsQ0FBQ21ELFVBQVUsQ0FBQ0MsRUFBRSxDQUFDLGNBQWMsRUFBRSxNQUFNO0VBQzNDM0MsT0FBTyxDQUFDd0MsSUFBSSxDQUFDLHNCQUFzQixDQUFDO0FBQ3RDLENBQUMsQ0FBQzs7QUFFRjtBQUNBeEIsR0FBRyxDQUFDQyxHQUFHLENBQUMsV0FBVyxFQUFFTCxVQUFVLENBQUNnQyxJQUFJLEVBQUV0RCxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDL0QwQixHQUFHLENBQUNDLEdBQUcsQ0FBQyxlQUFlLEVBQUUzQixPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUN0RDBCLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDLFdBQVcsRUFBRTNCLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM5QzBCLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDLGFBQWEsRUFBRTNCLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ2xEMEIsR0FBRyxDQUFDQyxHQUFHLENBQUMsZUFBZSxFQUFFTCxVQUFVLENBQUNpQyxPQUFPLEVBQUV2RCxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUMxRTBCLEdBQUcsQ0FBQ0MsR0FBRyxDQUFDLGtCQUFrQixFQUFFM0IsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDNUQwQixHQUFHLENBQUNDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRUwsVUFBVSxDQUFDa0MsV0FBVyxFQUFFeEQsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDcEYwQixHQUFHLENBQUNDLEdBQUcsQ0FBQyxZQUFZLEVBQUVMLFVBQVUsQ0FBQ21DLEtBQUssRUFBRXpELE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ2xFMEIsR0FBRyxDQUFDQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUzQixPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQzs7QUFFMUQ7QUFDQTBCLEdBQUcsQ0FBQ2dDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQ0MsR0FBRyxFQUFFQyxHQUFHLEtBQUs7RUFDL0JBLEdBQUcsQ0FBQ3BCLElBQUksQ0FBQztJQUFFcUIsTUFBTSxFQUFFLElBQUk7SUFBRUMsU0FBUyxFQUFFLElBQUlDLElBQUksQ0FBQyxDQUFDLENBQUNDLFdBQVcsQ0FBQztFQUFFLENBQUMsQ0FBQztBQUNqRSxDQUFDLENBQUM7O0FBRUY7QUFDQXRDLEdBQUcsQ0FBQ2dDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDQyxHQUFHLEVBQUVDLEdBQUcsS0FBSztFQUN2Q0EsR0FBRyxDQUFDcEIsSUFBSSxDQUFDO0lBQ1B5QixPQUFPLEVBQUUsSUFBSTtJQUNiQyxTQUFTLEVBQUVQLEdBQUcsQ0FBQ3RELE9BQU8sQ0FBQzZELFNBQVM7SUFDaENDLFdBQVcsRUFBRTtNQUNYQyxPQUFPLEVBQUUsQ0FBQ1QsR0FBRyxDQUFDVSxJQUFJLElBQUksQ0FBQyxDQUFDVixHQUFHLENBQUN0RCxPQUFPLENBQUNpRSxPQUFPO01BQzNDQyxPQUFPLEVBQUUsQ0FBQyxDQUFDWixHQUFHLENBQUN0RCxPQUFPLENBQUNtRSxJQUFJLElBQUksQ0FBQyxDQUFDYixHQUFHLENBQUN0RCxPQUFPLENBQUNtRSxJQUFJLENBQUNDLEtBQUssSUFBSWQsR0FBRyxDQUFDdEQsT0FBTyxDQUFDbUUsSUFBSSxDQUFDQyxLQUFLLENBQUN4RCxNQUFNLEdBQUc7SUFDN0Y7RUFDRixDQUFDLENBQUM7QUFDSixDQUFDLENBQUM7O0FBRUY7QUFDQVMsR0FBRyxDQUFDZ0MsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDQyxHQUFHLEVBQUVDLEdBQUcsS0FBSztFQUN6QkEsR0FBRyxDQUFDcEIsSUFBSSxDQUFDO0lBQ1BXLE9BQU8sRUFBRSw2QkFBNkI7SUFDdEN1QixPQUFPLEVBQUUsT0FBTztJQUNoQkMsU0FBUyxFQUFFO01BQ1RDLE1BQU0sRUFBRSxTQUFTO01BQ2pCdEIsSUFBSSxFQUFFLFdBQVc7TUFDakJ1QixRQUFRLEVBQUUsZUFBZTtNQUN6QkwsSUFBSSxFQUFFLFdBQVc7TUFDakJNLE1BQU0sRUFBRSxhQUFhO01BQ3JCQyxRQUFRLEVBQUU7SUFDWixDQUFDO0lBQ0RDLFFBQVEsRUFBRXBFLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDb0UsWUFBWSxJQUFJO0VBQ3hDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQzs7QUFFRjtBQUNBdkQsR0FBRyxDQUFDQyxHQUFHLENBQUNOLGtCQUFrQixDQUFDOztBQUUzQjtBQUNBLElBQUlULE9BQU8sQ0FBQ0MsR0FBRyxDQUFDQyxRQUFRLEtBQUssWUFBWSxFQUFFO0VBQ3pDWSxHQUFHLENBQUNnQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUNDLEdBQUcsRUFBRUMsR0FBRyxLQUFLO0lBQ3pCQSxHQUFHLENBQUNzQixRQUFRLENBQUMxRSxJQUFJLENBQUMyRSxJQUFJLENBQUNDLFNBQVMsRUFBRSxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7RUFDM0QsQ0FBQyxDQUFDO0FBQ0o7QUFFQSxNQUFNckUsSUFBSSxHQUFHSCxPQUFPLENBQUNDLEdBQUcsQ0FBQ0UsSUFBSSxJQUFJLElBQUk7O0FBRXJDO0FBQ0EsSUFBSUgsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFFBQVEsS0FBSyxNQUFNLEVBQUU7RUFDbkNZLEdBQUcsQ0FBQzJELE1BQU0sQ0FBQ3RFLElBQUksRUFBRSxNQUFNO0lBQ3JCSyxNQUFNLENBQUNrRSxJQUFJLENBQUMsMEJBQTBCdkUsSUFBSSxFQUFFLENBQUM7RUFDL0MsQ0FBQyxDQUFDO0FBQ0o7O0FBRUE7QUFDQXdFLE1BQU0sQ0FBQ0MsT0FBTyxHQUFHOUQsR0FBRyIsImlnbm9yZUxpc3QiOltdfQ==