{"version":3,"names":["Cart","require","User","Product","EventEmitter","CartService","constructor","connectionPool","Map","notifyCartUpdate","sessionId","userId","cartData","eventData","cart","timestamp","Date","emit","getCartWithPerformanceOptimization","req","startTime","now","result","getOrCreateCart","endTime","duration","console","warn","error","user","findById","_id","lean","updatedUser","findByIdAndUpdate","$set","new","type","sessionID","Math","random","toString","substr","findOneAndUpdate","$setOnInsert","items","lastAccessed","upsert","mergeCartsWithConflictResolution","guestCartItems","updatedAt","mergedItems","conflicts","Array","isArray","guestItem","mergeCartItem","merged","guestCart","findOne","length","deleteOne","save","success","productId","product","quantity","isActive","reason","existingItemIndex","findIndex","item","currentQuantity","newQuantity","push","current","attempted","resolved","addedAt","min","price","message","updateCartOptimistically","operation","data","rollbackData","JSON","parse","stringify","addItemOptimistically","updateItemOptimistically","removeItemOptimistically","Error","performance","log","addItem","itemIndex","splice","updateItem","removeItem","cleanupExpiredCarts","deleteMany","expiresAt","$lt","deletedCount","cartService","module","exports"],"sources":["cartService.js"],"sourcesContent":["const Cart = require('../models/Cart');\nconst User = require('../models/User');\nconst Product = require('../models/Product');\nconst EventEmitter = require('events');\n\nclass CartService extends EventEmitter {\n  constructor() {\n    super();\n    this.connectionPool = new Map(); // Simple connection tracking\n  }\n\n  // Event-driven cart synchronization\n  async notifyCartUpdate(sessionId, userId, cartData) {\n    const eventData = {\n      sessionId,\n      userId,\n      cart: cartData,\n      timestamp: new Date()\n    };\n\n    // Emit event for real-time synchronization across browser tabs\n    this.emit('cartUpdated', eventData);\n    \n    return eventData;\n  }\n\n  // Optimized cart retrieval with caching consideration\n  async getCartWithPerformanceOptimization(req) {\n    const startTime = Date.now();\n    \n    try {\n      const result = await this.getOrCreateCart(req);\n      \n      const endTime = Date.now();\n      const duration = endTime - startTime;\n      \n      // Log performance (should be under 100ms target)\n      if (duration > 100) {\n        console.warn(`Cart retrieval took ${duration}ms - exceeds 100ms target`);\n      }\n      \n      return result;\n    } catch (error) {\n      console.error('Cart performance optimization error:', error);\n      throw error;\n    }\n  }\n\n  // Enhanced cart retrieval with connection pooling awareness\n  async getOrCreateCart(req) {\n    if (req.user) {\n      // For authenticated users, use user's cart with optimistic loading\n      const user = await User.findById(req.user._id).lean();\n      if (!user.cart) {\n        // Create cart optimistically\n        const updatedUser = await User.findByIdAndUpdate(\n          req.user._id,\n          { \n            $set: { \n              'cart.items': [], \n              'cart.updatedAt': new Date() \n            }\n          },\n          { new: true, lean: true }\n        );\n        return { type: 'user', cart: updatedUser.cart, user: updatedUser };\n      }\n      return { type: 'user', cart: user.cart, user };\n    } else {\n      // For guests, use session-based cart with database storage\n      const sessionId = req.sessionID || `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      \n      // Use findOneAndUpdate for atomic operation\n      let cart = await Cart.findOneAndUpdate(\n        { sessionId },\n        { \n          $setOnInsert: { sessionId, items: [] },\n          $set: { lastAccessed: new Date() }\n        },\n        { \n          new: true, \n          upsert: true,\n          lean: true\n        }\n      );\n      \n      return { type: 'guest', cart, sessionId };\n    }\n  }\n\n  // Enhanced cart merging with conflict resolution\n  async mergeCartsWithConflictResolution(userId, guestCartItems, sessionId) {\n    const startTime = Date.now();\n    \n    try {\n      const user = await User.findById(userId);\n      if (!user.cart) {\n        user.cart = { items: [], updatedAt: new Date() };\n      }\n\n      let mergedItems = 0;\n      const conflicts = [];\n\n      // Process guest cart items with conflict detection\n      if (guestCartItems && Array.isArray(guestCartItems)) {\n        for (const guestItem of guestCartItems) {\n          const result = await this.mergeCartItem(user, guestItem, conflicts);\n          if (result.merged) mergedItems++;\n        }\n      }\n\n      // Process session-based cart\n      if (sessionId) {\n        const guestCart = await Cart.findOne({ sessionId });\n        if (guestCart && guestCart.items.length > 0) {\n          for (const guestItem of guestCart.items) {\n            const result = await this.mergeCartItem(user, guestItem, conflicts);\n            if (result.merged) mergedItems++;\n          }\n          \n          // Clean up guest cart\n          await Cart.deleteOne({ sessionId });\n        }\n      }\n\n      user.cart.updatedAt = new Date();\n      await user.save();\n\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      // Emit cart update event\n      await this.notifyCartUpdate(sessionId, userId, user.cart);\n\n      return {\n        mergedItems,\n        conflicts,\n        duration,\n        success: true\n      };\n\n    } catch (error) {\n      console.error('Cart merge error:', error);\n      throw error;\n    }\n  }\n\n  // Helper method to merge individual cart items\n  async mergeCartItem(user, guestItem, conflicts = []) {\n    try {\n      const productId = guestItem.productId || guestItem.product;\n      const quantity = guestItem.quantity || 1;\n\n      // Validate product\n      const product = await Product.findById(productId).lean();\n      if (!product || !product.isActive) {\n        return { merged: false, reason: 'invalid_product' };\n      }\n\n      // Check for existing item\n      const existingItemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (existingItemIndex >= 0) {\n        const currentQuantity = user.cart.items[existingItemIndex].quantity;\n        const newQuantity = currentQuantity + quantity;\n        \n        // Check for quantity conflicts\n        if (newQuantity > 99) {\n          conflicts.push({\n            productId,\n            type: 'quantity_limit',\n            current: currentQuantity,\n            attempted: quantity,\n            resolved: 99\n          });\n          user.cart.items[existingItemIndex].quantity = 99;\n        } else {\n          user.cart.items[existingItemIndex].quantity = newQuantity;\n        }\n        \n        user.cart.items[existingItemIndex].addedAt = new Date();\n      } else {\n        // Add new item\n        user.cart.items.push({\n          product: productId,\n          quantity: Math.min(quantity, 99),\n          price: product.price,\n          addedAt: new Date()\n        });\n      }\n\n      return { merged: true };\n    } catch (error) {\n      console.error('Error merging cart item:', error);\n      return { merged: false, reason: 'merge_error', error: error.message };\n    }\n  }\n\n  // Optimistic cart update with rollback capability\n  async updateCartOptimistically(req, operation, data) {\n    const startTime = Date.now();\n    let rollbackData = null;\n    \n    try {\n      const { type, cart, user } = await this.getOrCreateCart(req);\n      \n      // Store rollback data\n      if (type === 'user') {\n        rollbackData = JSON.parse(JSON.stringify(user.cart));\n      } else {\n        rollbackData = JSON.parse(JSON.stringify(cart));\n      }\n\n      // Perform operation\n      let result;\n      switch (operation) {\n        case 'add':\n          result = await this.addItemOptimistically(type, cart, user, data);\n          break;\n        case 'update':\n          result = await this.updateItemOptimistically(type, cart, user, data);\n          break;\n        case 'remove':\n          result = await this.removeItemOptimistically(type, cart, user, data);\n          break;\n        default:\n          throw new Error(`Unknown operation: ${operation}`);\n      }\n\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      // Performance monitoring\n      if (duration > 200) {\n        console.warn(`Cart ${operation} took ${duration}ms - exceeds 200ms target`);\n      }\n\n      // Emit update event\n      const sessionId = type === 'guest' ? cart.sessionId : null;\n      const userId = type === 'user' ? user._id : null;\n      await this.notifyCartUpdate(sessionId, userId, result.cart);\n\n      return {\n        ...result,\n        duration,\n        performance: duration <= 200 ? 'good' : 'needs_optimization'\n      };\n\n    } catch (error) {\n      console.error(`Cart ${operation} error:`, error);\n      \n      // Implement rollback if needed\n      if (rollbackData) {\n        console.log('Rolling back cart changes...');\n        // Rollback implementation would go here\n      }\n      \n      throw error;\n    }\n  }\n\n  // Optimistic add item operation\n  async addItemOptimistically(type, cart, user, { productId, quantity }) {\n    const product = await Product.findById(productId).lean();\n    if (!product || !product.isActive) {\n      throw new Error('Product not found or inactive');\n    }\n\n    if (type === 'user') {\n      const existingItemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (existingItemIndex >= 0) {\n        const newQuantity = user.cart.items[existingItemIndex].quantity + quantity;\n        if (newQuantity > 99) {\n          user.cart.items[existingItemIndex].quantity = 99;\n        } else {\n          user.cart.items[existingItemIndex].quantity = newQuantity;\n        }\n        user.cart.items[existingItemIndex].addedAt = new Date();\n      } else {\n        user.cart.items.push({\n          product: productId,\n          quantity,\n          price: product.price,\n          addedAt: new Date()\n        });\n      }\n      \n      user.cart.updatedAt = new Date();\n      await user.save();\n      return { cart: user.cart };\n    } else {\n      // Check if cart has addItem method, otherwise manually add\n      if (cart.addItem && typeof cart.addItem === 'function') {\n        cart.addItem(productId, quantity, product.price);\n      } else {\n        // Manually add to cart items\n        const existingItemIndex = cart.items.findIndex(item => \n          item.product.toString() === productId.toString()\n        );\n\n        if (existingItemIndex >= 0) {\n          const newQuantity = cart.items[existingItemIndex].quantity + quantity;\n          if (newQuantity > 99) {\n            cart.items[existingItemIndex].quantity = 99;\n          } else {\n            cart.items[existingItemIndex].quantity = newQuantity;\n          }\n          cart.items[existingItemIndex].addedAt = new Date();\n        } else {\n          cart.items.push({\n            product: productId,\n            quantity,\n            price: product.price,\n            addedAt: new Date()\n          });\n        }\n        cart.updatedAt = new Date();\n      }\n      await cart.save();\n      return { cart };\n    }\n  }\n\n  // Optimistic update item operation\n  async updateItemOptimistically(type, cart, user, { productId, quantity }) {\n    if (type === 'user') {\n      const itemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (itemIndex >= 0) {\n        if (quantity === 0) {\n          user.cart.items.splice(itemIndex, 1);\n        } else {\n          user.cart.items[itemIndex].quantity = quantity;\n          user.cart.items[itemIndex].addedAt = new Date();\n        }\n        user.cart.updatedAt = new Date();\n        await user.save();\n      }\n      return { cart: user.cart };\n    } else {\n      // Check if cart has updateItem method, otherwise manually update\n      if (cart.updateItem && typeof cart.updateItem === 'function') {\n        cart.updateItem(productId, quantity);\n      } else {\n        // Manually update cart items\n        const itemIndex = cart.items.findIndex(item => \n          item.product.toString() === productId.toString()\n        );\n\n        if (itemIndex >= 0) {\n          if (quantity === 0) {\n            cart.items.splice(itemIndex, 1);\n          } else {\n            cart.items[itemIndex].quantity = quantity;\n            cart.items[itemIndex].addedAt = new Date();\n          }\n          cart.updatedAt = new Date();\n        }\n      }\n      await cart.save();\n      return { cart };\n    }\n  }\n\n  // Optimistic remove item operation\n  async removeItemOptimistically(type, cart, user, { productId }) {\n    if (type === 'user') {\n      const itemIndex = user.cart.items.findIndex(item => \n        item.product.toString() === productId.toString()\n      );\n\n      if (itemIndex >= 0) {\n        user.cart.items.splice(itemIndex, 1);\n        user.cart.updatedAt = new Date();\n        await user.save();\n      }\n      return { cart: user.cart };\n    } else {\n      // Check if cart has removeItem method, otherwise manually remove\n      if (cart.removeItem && typeof cart.removeItem === 'function') {\n        cart.removeItem(productId);\n      } else {\n        // Manually remove from cart items\n        const itemIndex = cart.items.findIndex(item => \n          item.product.toString() === productId.toString()\n        );\n\n        if (itemIndex >= 0) {\n          cart.items.splice(itemIndex, 1);\n          cart.updatedAt = new Date();\n        }\n      }\n      await cart.save();\n      return { cart };\n    }\n  }\n\n  // Cleanup expired guest carts (for scheduled maintenance)\n  async cleanupExpiredCarts() {\n    try {\n      const result = await Cart.deleteMany({\n        expiresAt: { $lt: new Date() }\n      });\n      \n      console.log(`Cleaned up ${result.deletedCount} expired guest carts`);\n      return result.deletedCount;\n    } catch (error) {\n      console.error('Error cleaning up expired carts:', error);\n      throw error;\n    }\n  }\n}\n\n// Export singleton instance\nconst cartService = new CartService();\nmodule.exports = cartService;"],"mappings":"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","ignoreList":[]}