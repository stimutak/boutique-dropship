f0993eed6e4642f92316634f9a29eaa1
const crypto = require('crypto');
const mongoSanitize = require('express-mongo-sanitize');
const rateLimit = require('express-rate-limit');
const slowDown = require('express-slow-down');
const {
  body,
  validationResult
} = require('express-validator');

// CSRF Protection Middleware
const csrfProtection = (req, res, next) => {
  // Skip CSRF for GET, HEAD, OPTIONS requests
  if (['GET', 'HEAD', 'OPTIONS'].includes(req.method)) {
    return next();
  }

  // Skip CSRF for API key authenticated requests
  if (req.headers['x-api-key']) {
    return next();
  }
  const token = req.headers['x-csrf-token'] || req.body._csrf;
  const sessionToken = req.session.csrfToken;
  if (!token || !sessionToken || token !== sessionToken) {
    return res.status(403).json({
      success: false,
      error: {
        code: 'CSRF_TOKEN_MISMATCH',
        message: 'Invalid CSRF token'
      }
    });
  }
  next();
};

// Generate CSRF token
const generateCSRFToken = (req, res, next) => {
  if (!req.session.csrfToken) {
    req.session.csrfToken = crypto.randomBytes(32).toString('hex');
  }
  next();
};

// API Key Authentication
const apiKeyAuth = (req, res, next) => {
  const apiKey = req.headers['x-api-key'];
  if (!apiKey) {
    return res.status(401).json({
      success: false,
      error: {
        code: 'API_KEY_REQUIRED',
        message: 'API key is required for cross-site integration'
      }
    });
  }

  // Validate API key (in production, store these securely)
  const validApiKeys = process.env.VALID_API_KEYS?.split(',') || [];
  if (!validApiKeys.includes(apiKey)) {
    return res.status(401).json({
      success: false,
      error: {
        code: 'INVALID_API_KEY',
        message: 'Invalid API key'
      }
    });
  }
  req.apiKeyAuth = true;
  next();
};

// Enhanced Rate Limiting
const createRateLimit = (windowMs, max, message) => {
  return rateLimit({
    windowMs,
    max,
    message: {
      success: false,
      error: {
        code: 'RATE_LIMIT_EXCEEDED',
        message
      }
    },
    standardHeaders: true,
    legacyHeaders: false
  });
};

// Different rate limits for different endpoints
// More forgiving limits for development while still providing protection
const rateLimits = {
  // General API rate limit - increased for development
  general: createRateLimit(15 * 60 * 1000,
  // 15 minutes
  500,
  // 500 requests per window (was 100)
  'Too many requests, please try again later'),
  // Authentication endpoints - more forgiving for dev/testing
  auth: createRateLimit(15 * 60 * 1000,
  // 15 minutes
  50,
  // 50 requests per window (was 10)
  'Too many authentication attempts, please try again later'),
  // Payment endpoints rate limit - slightly increased
  payment: createRateLimit(60 * 60 * 1000,
  // 1 hour
  50,
  // 50 requests per hour (was 20)
  'Too many payment requests, please try again later'),
  // Admin endpoints rate limit - increased
  admin: createRateLimit(15 * 60 * 1000,
  // 15 minutes
  200,
  // 200 requests per window (was 50)
  'Too many admin requests, please try again later'),
  // Cross-site integration rate limit - increased
  integration: createRateLimit(60 * 1000,
  // 1 minute
  100,
  // 100 requests per minute (was 30)
  'Too many integration requests, please try again later')
};

// Slow down middleware for brute force protection
const speedLimiter = slowDown({
  windowMs: 15 * 60 * 1000,
  // 15 minutes
  delayAfter: 5,
  // allow 5 requests per windowMs without delay
  delayMs: () => 500,
  // add 500ms delay per request after delayAfter
  maxDelayMs: 20000,
  // max delay of 20 seconds
  validate: {
    delayMs: false
  } // disable warning
});

// Input sanitization middleware
const sanitizeInput = [mongoSanitize({
  replaceWith: '_',
  onSanitize: ({
    req,
    key
  }) => {
    console.warn(`Sanitized input: ${key} in ${req.method} ${req.path}`);
  }
})];

// Common validation rules
const validationRules = {
  email: body('email').isEmail().normalizeEmail().withMessage('Please provide a valid email address'),
  password: body('password').isLength({
    min: 8
  }).withMessage('Password must be at least 8 characters long').matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/).withMessage('Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character'),
  name: body('name').trim().isLength({
    min: 2,
    max: 50
  }).withMessage('Name must be between 2 and 50 characters').matches(/^[a-zA-Z\s'-]+$/).withMessage('Name can only contain letters, spaces, hyphens, and apostrophes'),
  phone: body('phone').optional().isMobilePhone().withMessage('Please provide a valid phone number'),
  address: body('address').optional().trim().isLength({
    max: 200
  }).withMessage('Address must not exceed 200 characters'),
  price: body('price').isFloat({
    min: 0
  }).withMessage('Price must be a positive number'),
  quantity: body('quantity').isInt({
    min: 1
  }).withMessage('Quantity must be a positive integer')
};

// Validation error handler
const handleValidationErrors = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      error: {
        code: 'VALIDATION_ERROR',
        message: 'Invalid input data',
        details: errors.array().map(error => ({
          field: error.path,
          message: error.msg,
          value: error.value
        }))
      }
    });
  }
  next();
};

// Security headers middleware
const securityHeaders = (req, res, next) => {
  // Additional security headers beyond helmet
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');

  // Remove server information
  res.removeHeader('X-Powered-By');
  next();
};
module.exports = {
  csrfProtection,
  generateCSRFToken,
  apiKeyAuth,
  rateLimits,
  speedLimiter,
  sanitizeInput,
  validationRules,
  handleValidationErrors,
  securityHeaders
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjcnlwdG8iLCJyZXF1aXJlIiwibW9uZ29TYW5pdGl6ZSIsInJhdGVMaW1pdCIsInNsb3dEb3duIiwiYm9keSIsInZhbGlkYXRpb25SZXN1bHQiLCJjc3JmUHJvdGVjdGlvbiIsInJlcSIsInJlcyIsIm5leHQiLCJpbmNsdWRlcyIsIm1ldGhvZCIsImhlYWRlcnMiLCJ0b2tlbiIsIl9jc3JmIiwic2Vzc2lvblRva2VuIiwic2Vzc2lvbiIsImNzcmZUb2tlbiIsInN0YXR1cyIsImpzb24iLCJzdWNjZXNzIiwiZXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsImdlbmVyYXRlQ1NSRlRva2VuIiwicmFuZG9tQnl0ZXMiLCJ0b1N0cmluZyIsImFwaUtleUF1dGgiLCJhcGlLZXkiLCJ2YWxpZEFwaUtleXMiLCJwcm9jZXNzIiwiZW52IiwiVkFMSURfQVBJX0tFWVMiLCJzcGxpdCIsImNyZWF0ZVJhdGVMaW1pdCIsIndpbmRvd01zIiwibWF4Iiwic3RhbmRhcmRIZWFkZXJzIiwibGVnYWN5SGVhZGVycyIsInJhdGVMaW1pdHMiLCJnZW5lcmFsIiwiYXV0aCIsInBheW1lbnQiLCJhZG1pbiIsImludGVncmF0aW9uIiwic3BlZWRMaW1pdGVyIiwiZGVsYXlBZnRlciIsImRlbGF5TXMiLCJtYXhEZWxheU1zIiwidmFsaWRhdGUiLCJzYW5pdGl6ZUlucHV0IiwicmVwbGFjZVdpdGgiLCJvblNhbml0aXplIiwia2V5IiwiY29uc29sZSIsIndhcm4iLCJwYXRoIiwidmFsaWRhdGlvblJ1bGVzIiwiZW1haWwiLCJpc0VtYWlsIiwibm9ybWFsaXplRW1haWwiLCJ3aXRoTWVzc2FnZSIsInBhc3N3b3JkIiwiaXNMZW5ndGgiLCJtaW4iLCJtYXRjaGVzIiwibmFtZSIsInRyaW0iLCJwaG9uZSIsIm9wdGlvbmFsIiwiaXNNb2JpbGVQaG9uZSIsImFkZHJlc3MiLCJwcmljZSIsImlzRmxvYXQiLCJxdWFudGl0eSIsImlzSW50IiwiaGFuZGxlVmFsaWRhdGlvbkVycm9ycyIsImVycm9ycyIsImlzRW1wdHkiLCJkZXRhaWxzIiwiYXJyYXkiLCJtYXAiLCJmaWVsZCIsIm1zZyIsInZhbHVlIiwic2VjdXJpdHlIZWFkZXJzIiwic2V0SGVhZGVyIiwicmVtb3ZlSGVhZGVyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInNlY3VyaXR5LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuY29uc3QgbW9uZ29TYW5pdGl6ZSA9IHJlcXVpcmUoJ2V4cHJlc3MtbW9uZ28tc2FuaXRpemUnKTtcbmNvbnN0IHJhdGVMaW1pdCA9IHJlcXVpcmUoJ2V4cHJlc3MtcmF0ZS1saW1pdCcpO1xuY29uc3Qgc2xvd0Rvd24gPSByZXF1aXJlKCdleHByZXNzLXNsb3ctZG93bicpO1xuY29uc3QgeyBib2R5LCB2YWxpZGF0aW9uUmVzdWx0IH0gPSByZXF1aXJlKCdleHByZXNzLXZhbGlkYXRvcicpO1xuXG4vLyBDU1JGIFByb3RlY3Rpb24gTWlkZGxld2FyZVxuY29uc3QgY3NyZlByb3RlY3Rpb24gPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgLy8gU2tpcCBDU1JGIGZvciBHRVQsIEhFQUQsIE9QVElPTlMgcmVxdWVzdHNcbiAgaWYgKFsnR0VUJywgJ0hFQUQnLCAnT1BUSU9OUyddLmluY2x1ZGVzKHJlcS5tZXRob2QpKSB7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG4gIC8vIFNraXAgQ1NSRiBmb3IgQVBJIGtleSBhdXRoZW50aWNhdGVkIHJlcXVlc3RzXG4gIGlmIChyZXEuaGVhZGVyc1sneC1hcGkta2V5J10pIHtcbiAgICByZXR1cm4gbmV4dCgpO1xuICB9XG5cbiAgY29uc3QgdG9rZW4gPSByZXEuaGVhZGVyc1sneC1jc3JmLXRva2VuJ10gfHwgcmVxLmJvZHkuX2NzcmY7XG4gIGNvbnN0IHNlc3Npb25Ub2tlbiA9IHJlcS5zZXNzaW9uLmNzcmZUb2tlbjtcblxuICBpZiAoIXRva2VuIHx8ICFzZXNzaW9uVG9rZW4gfHwgdG9rZW4gIT09IHNlc3Npb25Ub2tlbikge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6ICdDU1JGX1RPS0VOX01JU01BVENIJyxcbiAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgQ1NSRiB0b2tlbidcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIG5leHQoKTtcbn07XG5cbi8vIEdlbmVyYXRlIENTUkYgdG9rZW5cbmNvbnN0IGdlbmVyYXRlQ1NSRlRva2VuID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIGlmICghcmVxLnNlc3Npb24uY3NyZlRva2VuKSB7XG4gICAgcmVxLnNlc3Npb24uY3NyZlRva2VuID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG4gIH1cbiAgbmV4dCgpO1xufTtcblxuLy8gQVBJIEtleSBBdXRoZW50aWNhdGlvblxuY29uc3QgYXBpS2V5QXV0aCA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICBjb25zdCBhcGlLZXkgPSByZXEuaGVhZGVyc1sneC1hcGkta2V5J107XG4gIFxuICBpZiAoIWFwaUtleSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6ICdBUElfS0VZX1JFUVVJUkVEJyxcbiAgICAgICAgbWVzc2FnZTogJ0FQSSBrZXkgaXMgcmVxdWlyZWQgZm9yIGNyb3NzLXNpdGUgaW50ZWdyYXRpb24nXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSBBUEkga2V5IChpbiBwcm9kdWN0aW9uLCBzdG9yZSB0aGVzZSBzZWN1cmVseSlcbiAgY29uc3QgdmFsaWRBcGlLZXlzID0gcHJvY2Vzcy5lbnYuVkFMSURfQVBJX0tFWVM/LnNwbGl0KCcsJykgfHwgW107XG4gIFxuICBpZiAoIXZhbGlkQXBpS2V5cy5pbmNsdWRlcyhhcGlLZXkpKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogJ0lOVkFMSURfQVBJX0tFWScsXG4gICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIEFQSSBrZXknXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICByZXEuYXBpS2V5QXV0aCA9IHRydWU7XG4gIG5leHQoKTtcbn07XG5cbi8vIEVuaGFuY2VkIFJhdGUgTGltaXRpbmdcbmNvbnN0IGNyZWF0ZVJhdGVMaW1pdCA9ICh3aW5kb3dNcywgbWF4LCBtZXNzYWdlKSA9PiB7XG4gIHJldHVybiByYXRlTGltaXQoe1xuICAgIHdpbmRvd01zLFxuICAgIG1heCxcbiAgICBtZXNzYWdlOiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6ICdSQVRFX0xJTUlUX0VYQ0VFREVEJyxcbiAgICAgICAgbWVzc2FnZVxuICAgICAgfVxuICAgIH0sXG4gICAgc3RhbmRhcmRIZWFkZXJzOiB0cnVlLFxuICAgIGxlZ2FjeUhlYWRlcnM6IGZhbHNlLFxuICB9KTtcbn07XG5cbi8vIERpZmZlcmVudCByYXRlIGxpbWl0cyBmb3IgZGlmZmVyZW50IGVuZHBvaW50c1xuLy8gTW9yZSBmb3JnaXZpbmcgbGltaXRzIGZvciBkZXZlbG9wbWVudCB3aGlsZSBzdGlsbCBwcm92aWRpbmcgcHJvdGVjdGlvblxuY29uc3QgcmF0ZUxpbWl0cyA9IHtcbiAgLy8gR2VuZXJhbCBBUEkgcmF0ZSBsaW1pdCAtIGluY3JlYXNlZCBmb3IgZGV2ZWxvcG1lbnRcbiAgZ2VuZXJhbDogY3JlYXRlUmF0ZUxpbWl0KFxuICAgIDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgNTAwLCAvLyA1MDAgcmVxdWVzdHMgcGVyIHdpbmRvdyAod2FzIDEwMClcbiAgICAnVG9vIG1hbnkgcmVxdWVzdHMsIHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXInXG4gICksXG4gIFxuICAvLyBBdXRoZW50aWNhdGlvbiBlbmRwb2ludHMgLSBtb3JlIGZvcmdpdmluZyBmb3IgZGV2L3Rlc3RpbmdcbiAgYXV0aDogY3JlYXRlUmF0ZUxpbWl0KFxuICAgIDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgNTAsIC8vIDUwIHJlcXVlc3RzIHBlciB3aW5kb3cgKHdhcyAxMClcbiAgICAnVG9vIG1hbnkgYXV0aGVudGljYXRpb24gYXR0ZW1wdHMsIHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXInXG4gICksXG4gIFxuICAvLyBQYXltZW50IGVuZHBvaW50cyByYXRlIGxpbWl0IC0gc2xpZ2h0bHkgaW5jcmVhc2VkXG4gIHBheW1lbnQ6IGNyZWF0ZVJhdGVMaW1pdChcbiAgICA2MCAqIDYwICogMTAwMCwgLy8gMSBob3VyXG4gICAgNTAsIC8vIDUwIHJlcXVlc3RzIHBlciBob3VyICh3YXMgMjApXG4gICAgJ1RvbyBtYW55IHBheW1lbnQgcmVxdWVzdHMsIHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXInXG4gICksXG4gIFxuICAvLyBBZG1pbiBlbmRwb2ludHMgcmF0ZSBsaW1pdCAtIGluY3JlYXNlZFxuICBhZG1pbjogY3JlYXRlUmF0ZUxpbWl0KFxuICAgIDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgMjAwLCAvLyAyMDAgcmVxdWVzdHMgcGVyIHdpbmRvdyAod2FzIDUwKVxuICAgICdUb28gbWFueSBhZG1pbiByZXF1ZXN0cywgcGxlYXNlIHRyeSBhZ2FpbiBsYXRlcidcbiAgKSxcbiAgXG4gIC8vIENyb3NzLXNpdGUgaW50ZWdyYXRpb24gcmF0ZSBsaW1pdCAtIGluY3JlYXNlZFxuICBpbnRlZ3JhdGlvbjogY3JlYXRlUmF0ZUxpbWl0KFxuICAgIDYwICogMTAwMCwgLy8gMSBtaW51dGVcbiAgICAxMDAsIC8vIDEwMCByZXF1ZXN0cyBwZXIgbWludXRlICh3YXMgMzApXG4gICAgJ1RvbyBtYW55IGludGVncmF0aW9uIHJlcXVlc3RzLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyJ1xuICApXG59O1xuXG4vLyBTbG93IGRvd24gbWlkZGxld2FyZSBmb3IgYnJ1dGUgZm9yY2UgcHJvdGVjdGlvblxuY29uc3Qgc3BlZWRMaW1pdGVyID0gc2xvd0Rvd24oe1xuICB3aW5kb3dNczogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgZGVsYXlBZnRlcjogNSwgLy8gYWxsb3cgNSByZXF1ZXN0cyBwZXIgd2luZG93TXMgd2l0aG91dCBkZWxheVxuICBkZWxheU1zOiAoKSA9PiA1MDAsIC8vIGFkZCA1MDBtcyBkZWxheSBwZXIgcmVxdWVzdCBhZnRlciBkZWxheUFmdGVyXG4gIG1heERlbGF5TXM6IDIwMDAwLCAvLyBtYXggZGVsYXkgb2YgMjAgc2Vjb25kc1xuICB2YWxpZGF0ZTogeyBkZWxheU1zOiBmYWxzZSB9IC8vIGRpc2FibGUgd2FybmluZ1xufSk7XG5cbi8vIElucHV0IHNhbml0aXphdGlvbiBtaWRkbGV3YXJlXG5jb25zdCBzYW5pdGl6ZUlucHV0ID0gW1xuICBtb25nb1Nhbml0aXplKHtcbiAgICByZXBsYWNlV2l0aDogJ18nLFxuICAgIG9uU2FuaXRpemU6ICh7IHJlcSwga2V5IH0pID0+IHtcbiAgICAgIGNvbnNvbGUud2FybihgU2FuaXRpemVkIGlucHV0OiAke2tleX0gaW4gJHtyZXEubWV0aG9kfSAke3JlcS5wYXRofWApO1xuICAgIH0sXG4gIH0pLFxuXTtcblxuLy8gQ29tbW9uIHZhbGlkYXRpb24gcnVsZXNcbmNvbnN0IHZhbGlkYXRpb25SdWxlcyA9IHtcbiAgZW1haWw6IGJvZHkoJ2VtYWlsJylcbiAgICAuaXNFbWFpbCgpXG4gICAgLm5vcm1hbGl6ZUVtYWlsKClcbiAgICAud2l0aE1lc3NhZ2UoJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQgZW1haWwgYWRkcmVzcycpLFxuICBcbiAgcGFzc3dvcmQ6IGJvZHkoJ3Bhc3N3b3JkJylcbiAgICAuaXNMZW5ndGgoeyBtaW46IDggfSlcbiAgICAud2l0aE1lc3NhZ2UoJ1Bhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgOCBjaGFyYWN0ZXJzIGxvbmcnKVxuICAgIC5tYXRjaGVzKC9eKD89LipbYS16XSkoPz0uKltBLVpdKSg/PS4qXFxkKSg/PS4qW0AkISUqPyZdKVtBLVphLXpcXGRAJCElKj8mXS8pXG4gICAgLndpdGhNZXNzYWdlKCdQYXNzd29yZCBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIHVwcGVyY2FzZSBsZXR0ZXIsIG9uZSBsb3dlcmNhc2UgbGV0dGVyLCBvbmUgbnVtYmVyLCBhbmQgb25lIHNwZWNpYWwgY2hhcmFjdGVyJyksXG4gIFxuICBuYW1lOiBib2R5KCduYW1lJylcbiAgICAudHJpbSgpXG4gICAgLmlzTGVuZ3RoKHsgbWluOiAyLCBtYXg6IDUwIH0pXG4gICAgLndpdGhNZXNzYWdlKCdOYW1lIG11c3QgYmUgYmV0d2VlbiAyIGFuZCA1MCBjaGFyYWN0ZXJzJylcbiAgICAubWF0Y2hlcygvXlthLXpBLVpcXHMnLV0rJC8pXG4gICAgLndpdGhNZXNzYWdlKCdOYW1lIGNhbiBvbmx5IGNvbnRhaW4gbGV0dGVycywgc3BhY2VzLCBoeXBoZW5zLCBhbmQgYXBvc3Ryb3BoZXMnKSxcbiAgXG4gIHBob25lOiBib2R5KCdwaG9uZScpXG4gICAgLm9wdGlvbmFsKClcbiAgICAuaXNNb2JpbGVQaG9uZSgpXG4gICAgLndpdGhNZXNzYWdlKCdQbGVhc2UgcHJvdmlkZSBhIHZhbGlkIHBob25lIG51bWJlcicpLFxuICBcbiAgYWRkcmVzczogYm9keSgnYWRkcmVzcycpXG4gICAgLm9wdGlvbmFsKClcbiAgICAudHJpbSgpXG4gICAgLmlzTGVuZ3RoKHsgbWF4OiAyMDAgfSlcbiAgICAud2l0aE1lc3NhZ2UoJ0FkZHJlc3MgbXVzdCBub3QgZXhjZWVkIDIwMCBjaGFyYWN0ZXJzJyksXG4gIFxuICBwcmljZTogYm9keSgncHJpY2UnKVxuICAgIC5pc0Zsb2F0KHsgbWluOiAwIH0pXG4gICAgLndpdGhNZXNzYWdlKCdQcmljZSBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyksXG4gIFxuICBxdWFudGl0eTogYm9keSgncXVhbnRpdHknKVxuICAgIC5pc0ludCh7IG1pbjogMSB9KVxuICAgIC53aXRoTWVzc2FnZSgnUXVhbnRpdHkgbXVzdCBiZSBhIHBvc2l0aXZlIGludGVnZXInKSxcbn07XG5cbi8vIFZhbGlkYXRpb24gZXJyb3IgaGFuZGxlclxuY29uc3QgaGFuZGxlVmFsaWRhdGlvbkVycm9ycyA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XG4gIFxuICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjoge1xuICAgICAgICBjb2RlOiAnVkFMSURBVElPTl9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIGlucHV0IGRhdGEnLFxuICAgICAgICBkZXRhaWxzOiBlcnJvcnMuYXJyYXkoKS5tYXAoZXJyb3IgPT4gKHtcbiAgICAgICAgICBmaWVsZDogZXJyb3IucGF0aCxcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tc2csXG4gICAgICAgICAgdmFsdWU6IGVycm9yLnZhbHVlXG4gICAgICAgIH0pKVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIFxuICBuZXh0KCk7XG59O1xuXG4vLyBTZWN1cml0eSBoZWFkZXJzIG1pZGRsZXdhcmVcbmNvbnN0IHNlY3VyaXR5SGVhZGVycyA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAvLyBBZGRpdGlvbmFsIHNlY3VyaXR5IGhlYWRlcnMgYmV5b25kIGhlbG1ldFxuICByZXMuc2V0SGVhZGVyKCdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJywgJ25vc25pZmYnKTtcbiAgcmVzLnNldEhlYWRlcignWC1GcmFtZS1PcHRpb25zJywgJ0RFTlknKTtcbiAgcmVzLnNldEhlYWRlcignWC1YU1MtUHJvdGVjdGlvbicsICcxOyBtb2RlPWJsb2NrJyk7XG4gIHJlcy5zZXRIZWFkZXIoJ1JlZmVycmVyLVBvbGljeScsICdzdHJpY3Qtb3JpZ2luLXdoZW4tY3Jvc3Mtb3JpZ2luJyk7XG4gIHJlcy5zZXRIZWFkZXIoJ1Blcm1pc3Npb25zLVBvbGljeScsICdnZW9sb2NhdGlvbj0oKSwgbWljcm9waG9uZT0oKSwgY2FtZXJhPSgpJyk7XG4gIFxuICAvLyBSZW1vdmUgc2VydmVyIGluZm9ybWF0aW9uXG4gIHJlcy5yZW1vdmVIZWFkZXIoJ1gtUG93ZXJlZC1CeScpO1xuICBcbiAgbmV4dCgpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNzcmZQcm90ZWN0aW9uLFxuICBnZW5lcmF0ZUNTUkZUb2tlbixcbiAgYXBpS2V5QXV0aCxcbiAgcmF0ZUxpbWl0cyxcbiAgc3BlZWRMaW1pdGVyLFxuICBzYW5pdGl6ZUlucHV0LFxuICB2YWxpZGF0aW9uUnVsZXMsXG4gIGhhbmRsZVZhbGlkYXRpb25FcnJvcnMsXG4gIHNlY3VyaXR5SGVhZGVyc1xufTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUNoQyxNQUFNQyxhQUFhLEdBQUdELE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQztBQUN2RCxNQUFNRSxTQUFTLEdBQUdGLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQztBQUMvQyxNQUFNRyxRQUFRLEdBQUdILE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztBQUM3QyxNQUFNO0VBQUVJLElBQUk7RUFBRUM7QUFBaUIsQ0FBQyxHQUFHTCxPQUFPLENBQUMsbUJBQW1CLENBQUM7O0FBRS9EO0FBQ0EsTUFBTU0sY0FBYyxHQUFHQSxDQUFDQyxHQUFHLEVBQUVDLEdBQUcsRUFBRUMsSUFBSSxLQUFLO0VBQ3pDO0VBQ0EsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUNDLFFBQVEsQ0FBQ0gsR0FBRyxDQUFDSSxNQUFNLENBQUMsRUFBRTtJQUNuRCxPQUFP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