b03f977c025a4f2678624f80ace472b3
const Cart = require('../models/Cart');
const User = require('../models/User');
const Product = require('../models/Product');
const EventEmitter = require('events');
class CartService extends EventEmitter {
  constructor() {
    super();
    this.connectionPool = new Map(); // Simple connection tracking
  }

  // Event-driven cart synchronization
  async notifyCartUpdate(sessionId, userId, cartData) {
    const eventData = {
      sessionId,
      userId,
      cart: cartData,
      timestamp: new Date()
    };

    // Emit event for real-time synchronization across browser tabs
    this.emit('cartUpdated', eventData);
    return eventData;
  }

  // Optimized cart retrieval with caching consideration
  async getCartWithPerformanceOptimization(req) {
    const startTime = Date.now();
    try {
      const result = await this.getOrCreateCart(req);
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Log performance (should be under 100ms target)
      if (duration > 100) {
        console.warn(`Cart retrieval took ${duration}ms - exceeds 100ms target`);
      }
      return result;
    } catch (error) {
      console.error('Cart performance optimization error:', error);
      throw error;
    }
  }

  // Enhanced cart retrieval with connection pooling awareness
  async getOrCreateCart(req) {
    if (req.user) {
      // For authenticated users, use user's cart with optimistic loading
      const user = await User.findById(req.user._id).lean();
      if (!user.cart) {
        // Create cart optimistically
        const updatedUser = await User.findByIdAndUpdate(req.user._id, {
          $set: {
            'cart.items': [],
            'cart.updatedAt': new Date()
          }
        }, {
          new: true,
          lean: true
        });
        return {
          type: 'user',
          cart: updatedUser.cart,
          user: updatedUser
        };
      }
      return {
        type: 'user',
        cart: user.cart,
        user
      };
    } else {
      // For guests, use session-based cart with database storage
      const sessionId = req.sessionID || `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

      // Use findOneAndUpdate for atomic operation
      let cart = await Cart.findOneAndUpdate({
        sessionId
      }, {
        $setOnInsert: {
          sessionId,
          items: []
        },
        $set: {
          lastAccessed: new Date()
        }
      }, {
        new: true,
        upsert: true,
        lean: true
      });
      return {
        type: 'guest',
        cart,
        sessionId
      };
    }
  }

  // Enhanced cart merging with conflict resolution
  async mergeCartsWithConflictResolution(userId, guestCartItems, sessionId) {
    const startTime = Date.now();
    try {
      const user = await User.findById(userId);
      if (!user.cart) {
        user.cart = {
          items: [],
          updatedAt: new Date()
        };
      }
      let mergedItems = 0;
      const conflicts = [];

      // Process guest cart items with conflict detection
      if (guestCartItems && Array.isArray(guestCartItems)) {
        for (const guestItem of guestCartItems) {
          const result = await this.mergeCartItem(user, guestItem, conflicts);
          if (result.merged) mergedItems++;
        }
      }

      // Process session-based cart
      if (sessionId) {
        const guestCart = await Cart.findOne({
          sessionId
        });
        if (guestCart && guestCart.items.length > 0) {
          for (const guestItem of guestCart.items) {
            const result = await this.mergeCartItem(user, guestItem, conflicts);
            if (result.merged) mergedItems++;
          }

          // Clean up guest cart
          await Cart.deleteOne({
            sessionId
          });
        }
      }
      user.cart.updatedAt = new Date();
      await user.save();
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Emit cart update event
      await this.notifyCartUpdate(sessionId, userId, user.cart);
      return {
        mergedItems,
        conflicts,
        duration,
        success: true
      };
    } catch (error) {
      console.error('Cart merge error:', error);
      throw error;
    }
  }

  // Helper method to merge individual cart items
  async mergeCartItem(user, guestItem, conflicts = []) {
    try {
      const productId = guestItem.productId || guestItem.product;
      const quantity = guestItem.quantity || 1;

      // Validate product
      const product = await Product.findById(productId).lean();
      if (!product || !product.isActive) {
        return {
          merged: false,
          reason: 'invalid_product'
        };
      }

      // Check for existing item
      const existingItemIndex = user.cart.items.findIndex(item => item.product.toString() === productId.toString());
      if (existingItemIndex >= 0) {
        const currentQuantity = user.cart.items[existingItemIndex].quantity;
        const newQuantity = currentQuantity + quantity;

        // Check for quantity conflicts
        if (newQuantity > 99) {
          conflicts.push({
            productId,
            type: 'quantity_limit',
            current: currentQuantity,
            attempted: quantity,
            resolved: 99
          });
          user.cart.items[existingItemIndex].quantity = 99;
        } else {
          user.cart.items[existingItemIndex].quantity = newQuantity;
        }
        user.cart.items[existingItemIndex].addedAt = new Date();
      } else {
        // Add new item
        user.cart.items.push({
          product: productId,
          quantity: Math.min(quantity, 99),
          price: product.price,
          addedAt: new Date()
        });
      }
      return {
        merged: true
      };
    } catch (error) {
      console.error('Error merging cart item:', error);
      return {
        merged: false,
        reason: 'merge_error',
        error: error.message
      };
    }
  }

  // Optimistic cart update with rollback capability
  async updateCartOptimistically(req, operation, data) {
    const startTime = Date.now();
    let rollbackData = null;
    try {
      const {
        type,
        cart,
        user
      } = await this.getOrCreateCart(req);

      // Store rollback data
      if (type === 'user') {
        rollbackData = JSON.parse(JSON.stringify(user.cart));
      } else {
        rollbackData = JSON.parse(JSON.stringify(cart));
      }

      // Perform operation
      let result;
      switch (operation) {
        case 'add':
          result = await this.addItemOptimistically(type, cart, user, data);
          break;
        case 'update':
          result = await this.updateItemOptimistically(type, cart, user, data);
          break;
        case 'remove':
          result = await this.removeItemOptimistically(type, cart, user, data);
          break;
        default:
          throw new Error(`Unknown operation: ${operation}`);
      }
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Performance monitoring
      if (duration > 200) {
        console.warn(`Cart ${operation} took ${duration}ms - exceeds 200ms target`);
      }

      // Emit update event
      const sessionId = type === 'guest' ? cart.sessionId : null;
      const userId = type === 'user' ? user._id : null;
      await this.notifyCartUpdate(sessionId, userId, result.cart);
      return {
        ...result,
        duration,
        performance: duration <= 200 ? 'good' : 'needs_optimization'
      };
    } catch (error) {
      console.error(`Cart ${operation} error:`, error);

      // Implement rollback if needed
      if (rollbackData) {
        console.log('Rolling back cart changes...');
        // Rollback implementation would go here
      }
      throw error;
    }
  }

  // Optimistic add item operation
  async addItemOptimistically(type, cart, user, {
    productId,
    quantity
  }) {
    const product = await Product.findById(productId).lean();
    if (!product || !product.isActive) {
      throw new Error('Product not found or inactive');
    }
    if (type === 'user') {
      const existingItemIndex = user.cart.items.findIndex(item => item.product.toString() === productId.toString());
      if (existingItemIndex >= 0) {
        user.cart.items[existingItemIndex].quantity += quantity;
        user.cart.items[existingItemIndex].addedAt = new Date();
      } else {
        user.cart.items.push({
          product: productId,
          quantity,
          price: product.price,
          addedAt: new Date()
        });
      }
      user.cart.updatedAt = new Date();
      await user.save();
      return {
        cart: user.cart
      };
    } else {
      // Check if cart has addItem method, otherwise manually add
      if (cart.addItem && typeof cart.addItem === 'function') {
        cart.addItem(productId, quantity, product.price);
      } else {
        // Manually add to cart items
        const existingItemIndex = cart.items.findIndex(item => item.product.toString() === productId.toString());
        if (existingItemIndex >= 0) {
          cart.items[existingItemIndex].quantity += quantity;
          cart.items[existingItemIndex].addedAt = new Date();
        } else {
          cart.items.push({
            product: productId,
            quantity,
            price: product.price,
            addedAt: new Date()
          });
        }
        cart.updatedAt = new Date();
      }
      await cart.save();
      return {
        cart
      };
    }
  }

  // Optimistic update item operation
  async updateItemOptimistically(type, cart, user, {
    productId,
    quantity
  }) {
    if (type === 'user') {
      const itemIndex = user.cart.items.findIndex(item => item.product.toString() === productId.toString());
      if (itemIndex >= 0) {
        if (quantity === 0) {
          user.cart.items.splice(itemIndex, 1);
        } else {
          user.cart.items[itemIndex].quantity = quantity;
          user.cart.items[itemIndex].addedAt = new Date();
        }
        user.cart.updatedAt = new Date();
        await user.save();
      }
      return {
        cart: user.cart
      };
    } else {
      // Check if cart has updateItem method, otherwise manually update
      if (cart.updateItem && typeof cart.updateItem === 'function') {
        cart.updateItem(productId, quantity);
      } else {
        // Manually update cart items
        const itemIndex = cart.items.findIndex(item => item.product.toString() === productId.toString());
        if (itemIndex >= 0) {
          if (quantity === 0) {
            cart.items.splice(itemIndex, 1);
          } else {
            cart.items[itemIndex].quantity = quantity;
            cart.items[itemIndex].addedAt = new Date();
          }
          cart.updatedAt = new Date();
        }
      }
      await cart.save();
      return {
        cart
      };
    }
  }

  // Optimistic remove item operation
  async removeItemOptimistically(type, cart, user, {
    productId
  }) {
    if (type === 'user') {
      const itemIndex = user.cart.items.findIndex(item => item.product.toString() === productId.toString());
      if (itemIndex >= 0) {
        user.cart.items.splice(itemIndex, 1);
        user.cart.updatedAt = new Date();
        await user.save();
      }
      return {
        cart: user.cart
      };
    } else {
      // Check if cart has removeItem method, otherwise manually remove
      if (cart.removeItem && typeof cart.removeItem === 'function') {
        cart.removeItem(productId);
      } else {
        // Manually remove from cart items
        const itemIndex = cart.items.findIndex(item => item.product.toString() === productId.toString());
        if (itemIndex >= 0) {
          cart.items.splice(itemIndex, 1);
          cart.updatedAt = new Date();
        }
      }
      await cart.save();
      return {
        cart
      };
    }
  }

  // Cleanup expired guest carts (for scheduled maintenance)
  async cleanupExpiredCarts() {
    try {
      const result = await Cart.deleteMany({
        expiresAt: {
          $lt: new Date()
        }
      });
      console.log(`Cleaned up ${result.deletedCount} expired guest carts`);
      return result.deletedCount;
    } catch (error) {
      console.error('Error cleaning up expired carts:', error);
      throw error;
    }
  }
}

// Export singleton instance
const cartService = new CartService();
module.exports = cartService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDYXJ0IiwicmVxdWlyZSIsIlVzZXIiLCJQcm9kdWN0IiwiRXZlbnRFbWl0dGVyIiwiQ2FydFNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25Qb29sIiwiTWFwIiwibm90aWZ5Q2FydFVwZGF0ZSIsInNlc3Npb25JZCIsInVzZXJJZCIsImNhcnREYXRhIiwiZXZlbnREYXRhIiwiY2FydCIsInRpbWVzdGFtcCIsIkRhdGUiLCJlbWl0IiwiZ2V0Q2FydFdpdGhQZXJmb3JtYW5jZU9wdGltaXphdGlvbiIsInJlcSIsInN0YXJ0VGltZSIsIm5vdyIsInJlc3VsdCIsImdldE9yQ3JlYXRlQ2FydCIsImVuZFRpbWUiLCJkdXJhdGlvbiIsImNvbnNvbGUiLCJ3YXJuIiwiZXJyb3IiLCJ1c2VyIiwiZmluZEJ5SWQiLCJfaWQiLCJsZWFuIiwidXBkYXRlZFVzZXIiLCJmaW5kQnlJZEFuZFVwZGF0ZSIsIiRzZXQiLCJuZXciLCJ0eXBlIiwic2Vzc2lvbklEIiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic3Vic3RyIiwiZmluZE9uZUFuZFVwZGF0ZSIsIiRzZXRPbkluc2VydCIsIml0ZW1zIiwibGFzdEFjY2Vzc2VkIiwidXBzZXJ0IiwibWVyZ2VDYXJ0c1dpdGhDb25mbGljdFJlc29sdXRpb24iLCJndWVzdENhcnRJdGVtcyIsInVwZGF0ZWRBdCIsIm1lcmdlZEl0ZW1zIiwiY29uZmxpY3RzIiwiQXJyYXkiLCJpc0FycmF5IiwiZ3Vlc3RJdGVtIiwibWVyZ2VDYXJ0SXRlbSIsIm1lcmdlZCIsImd1ZXN0Q2FydCIsImZpbmRPbmUiLCJsZW5ndGgiLCJkZWxldGVPbmUiLCJzYXZlIiwic3VjY2VzcyIsInByb2R1Y3RJZCIsInByb2R1Y3QiLCJxdWFudGl0eSIsImlzQWN0aXZlIiwicmVhc29uIiwiZXhpc3RpbmdJdGVtSW5kZXgiLCJmaW5kSW5kZXgiLCJpdGVtIiwiY3VycmVudFF1YW50aXR5IiwibmV3UXVhbnRpdHkiLCJwdXNoIiwiY3VycmVudCIsImF0dGVtcHRlZCIsInJlc29sdmVkIiwiYWRkZWRBdCIsIm1pbiIsInByaWNlIiwibWVzc2FnZSIsInVwZGF0ZUNhcnRPcHRpbWlzdGljYWxseSIsIm9wZXJhdGlvbiIsImRhdGEiLCJyb2xsYmFja0RhdGEiLCJKU09OIiwicGFyc2UiLCJzdHJpbmdpZnkiLCJhZGRJdGVtT3B0aW1pc3RpY2FsbHkiLCJ1cGRhdGVJdGVtT3B0aW1pc3RpY2FsbHkiLCJyZW1vdmVJdGVtT3B0aW1pc3RpY2FsbHkiLCJFcnJvciIsInBlcmZvcm1hbmNlIiwibG9nIiwiYWRkSXRlbSIsIml0ZW1JbmRleCIsInNwbGljZSIsInVwZGF0ZUl0ZW0iLCJyZW1vdmVJdGVtIiwiY2xlYW51cEV4cGlyZWRDYXJ0cyIsImRlbGV0ZU1hbnkiLCJleHBpcmVzQXQiLCIkbHQiLCJkZWxldGVkQ291bnQiLCJjYXJ0U2VydmljZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJjYXJ0U2VydmljZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBDYXJ0ID0gcmVxdWlyZSgnLi4vbW9kZWxzL0NhcnQnKTtcbmNvbnN0IFVzZXIgPSByZXF1aXJlKCcuLi9tb2RlbHMvVXNlcicpO1xuY29uc3QgUHJvZHVjdCA9IHJlcXVpcmUoJy4uL21vZGVscy9Qcm9kdWN0Jyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcblxuY2xhc3MgQ2FydFNlcnZpY2UgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY29ubmVjdGlvblBvb2wgPSBuZXcgTWFwKCk7IC8vIFNpbXBsZSBjb25uZWN0aW9uIHRyYWNraW5nXG4gIH1cblxuICAvLyBFdmVudC1kcml2ZW4gY2FydCBzeW5jaHJvbml6YXRpb25cbiAgYXN5bmMgbm90aWZ5Q2FydFVwZGF0ZShzZXNzaW9uSWQsIHVzZXJJZCwgY2FydERhdGEpIHtcbiAgICBjb25zdCBldmVudERhdGEgPSB7XG4gICAgICBzZXNzaW9uSWQsXG4gICAgICB1c2VySWQsXG4gICAgICBjYXJ0OiBjYXJ0RGF0YSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgIH07XG5cbiAgICAvLyBFbWl0IGV2ZW50IGZvciByZWFsLXRpbWUgc3luY2hyb25pemF0aW9uIGFjcm9zcyBicm93c2VyIHRhYnNcbiAgICB0aGlzLmVtaXQoJ2NhcnRVcGRhdGVkJywgZXZlbnREYXRhKTtcbiAgICBcbiAgICByZXR1cm4gZXZlbnREYXRhO1xuICB9XG5cbiAgLy8gT3B0aW1pemVkIGNhcnQgcmV0cmlldmFsIHdpdGggY2FjaGluZyBjb25zaWRlcmF0aW9uXG4gIGFzeW5jIGdldENhcnRXaXRoUGVyZm9ybWFuY2VPcHRpbWl6YXRpb24ocmVxKSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRPckNyZWF0ZUNhcnQocmVxKTtcbiAgICAgIFxuICAgICAgY29uc3QgZW5kVGltZSA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IGVuZFRpbWUgLSBzdGFydFRpbWU7XG4gICAgICBcbiAgICAgIC8vIExvZyBwZXJmb3JtYW5jZSAoc2hvdWxkIGJlIHVuZGVyIDEwMG1zIHRhcmdldClcbiAgICAgIGlmIChkdXJhdGlvbiA+IDEwMCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYENhcnQgcmV0cmlldmFsIHRvb2sgJHtkdXJhdGlvbn1tcyAtIGV4Y2VlZHMgMTAwbXMgdGFyZ2V0YCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NhcnQgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uIGVycm9yOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8vIEVuaGFuY2VkIGNhcnQgcmV0cmlldmFsIHdpdGggY29ubmVjdGlvbiBwb29saW5nIGF3YXJlbmVzc1xuICBhc3luYyBnZXRPckNyZWF0ZUNhcnQocmVxKSB7XG4gICAgaWYgKHJlcS51c2VyKSB7XG4gICAgICAvLyBGb3IgYXV0aGVudGljYXRlZCB1c2VycywgdXNlIHVzZXIncyBjYXJ0IHdpdGggb3B0aW1pc3RpYyBsb2FkaW5nXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZChyZXEudXNlci5faWQpLmxlYW4oKTtcbiAgICAgIGlmICghdXNlci5jYXJ0KSB7XG4gICAgICAgIC8vIENyZWF0ZSBjYXJ0IG9wdGltaXN0aWNhbGx5XG4gICAgICAgIGNvbnN0IHVwZGF0ZWRVc2VyID0gYXdhaXQgVXNlci5maW5kQnlJZEFuZFVwZGF0ZShcbiAgICAgICAgICByZXEudXNlci5faWQsXG4gICAgICAgICAgeyBcbiAgICAgICAgICAgICRzZXQ6IHsgXG4gICAgICAgICAgICAgICdjYXJ0Lml0ZW1zJzogW10sIFxuICAgICAgICAgICAgICAnY2FydC51cGRhdGVkQXQnOiBuZXcgRGF0ZSgpIFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgeyBuZXc6IHRydWUsIGxlYW46IHRydWUgfVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4geyB0eXBlOiAndXNlcicsIGNhcnQ6IHVwZGF0ZWRVc2VyLmNhcnQsIHVzZXI6IHVwZGF0ZWRVc2VyIH07XG4gICAgICB9XG4gICAgICByZXR1cm4geyB0eXBlOiAndXNlcicsIGNhcnQ6IHVzZXIuY2FydCwgdXNlciB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBGb3IgZ3Vlc3RzLCB1c2Ugc2Vzc2lvbi1iYXNlZCBjYXJ0IHdpdGggZGF0YWJhc2Ugc3RvcmFnZVxuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gcmVxLnNlc3Npb25JRCB8fCBgZ3Vlc3RfJHtEYXRlLm5vdygpfV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gO1xuICAgICAgXG4gICAgICAvLyBVc2UgZmluZE9uZUFuZFVwZGF0ZSBmb3IgYXRvbWljIG9wZXJhdGlvblxuICAgICAgbGV0IGNhcnQgPSBhd2FpdCBDYXJ0LmZpbmRPbmVBbmRVcGRhdGUoXG4gICAgICAgIHsgc2Vzc2lvbklkIH0sXG4gICAgICAgIHsgXG4gICAgICAgICAgJHNldE9uSW5zZXJ0OiB7IHNlc3Npb25JZCwgaXRlbXM6IFtdIH0sXG4gICAgICAgICAgJHNldDogeyBsYXN0QWNjZXNzZWQ6IG5ldyBEYXRlKCkgfVxuICAgICAgICB9LFxuICAgICAgICB7IFxuICAgICAgICAgIG5ldzogdHJ1ZSwgXG4gICAgICAgICAgdXBzZXJ0OiB0cnVlLFxuICAgICAgICAgIGxlYW46IHRydWVcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHsgdHlwZTogJ2d1ZXN0JywgY2FydCwgc2Vzc2lvbklkIH07XG4gICAgfVxuICB9XG5cbiAgLy8gRW5oYW5jZWQgY2FydCBtZXJnaW5nIHdpdGggY29uZmxpY3QgcmVzb2x1dGlvblxuICBhc3luYyBtZXJnZUNhcnRzV2l0aENvbmZsaWN0UmVzb2x1dGlvbih1c2VySWQsIGd1ZXN0Q2FydEl0ZW1zLCBzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZCh1c2VySWQpO1xuICAgICAgaWYgKCF1c2VyLmNhcnQpIHtcbiAgICAgICAgdXNlci5jYXJ0ID0geyBpdGVtczogW10sIHVwZGF0ZWRBdDogbmV3IERhdGUoKSB9O1xuICAgICAgfVxuXG4gICAgICBsZXQgbWVyZ2VkSXRlbXMgPSAwO1xuICAgICAgY29uc3QgY29uZmxpY3RzID0gW107XG5cbiAgICAgIC8vIFByb2Nlc3MgZ3Vlc3QgY2FydCBpdGVtcyB3aXRoIGNvbmZsaWN0IGRldGVjdGlvblxuICAgICAgaWYgKGd1ZXN0Q2FydEl0ZW1zICYmIEFycmF5LmlzQXJyYXkoZ3Vlc3RDYXJ0SXRlbXMpKSB7XG4gICAgICAgIGZvciAoY29uc3QgZ3Vlc3RJdGVtIG9mIGd1ZXN0Q2FydEl0ZW1zKSB7XG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZXJnZUNhcnRJdGVtKHVzZXIsIGd1ZXN0SXRlbSwgY29uZmxpY3RzKTtcbiAgICAgICAgICBpZiAocmVzdWx0Lm1lcmdlZCkgbWVyZ2VkSXRlbXMrKztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBQcm9jZXNzIHNlc3Npb24tYmFzZWQgY2FydFxuICAgICAgaWYgKHNlc3Npb25JZCkge1xuICAgICAgICBjb25zdCBndWVzdENhcnQgPSBhd2FpdCBDYXJ0LmZpbmRPbmUoeyBzZXNzaW9uSWQgfSk7XG4gICAgICAgIGlmIChndWVzdENhcnQgJiYgZ3Vlc3RDYXJ0Lml0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGd1ZXN0SXRlbSBvZiBndWVzdENhcnQuaXRlbXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubWVyZ2VDYXJ0SXRlbSh1c2VyLCBndWVzdEl0ZW0sIGNvbmZsaWN0cyk7XG4gICAgICAgICAgICBpZiAocmVzdWx0Lm1lcmdlZCkgbWVyZ2VkSXRlbXMrKztcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gQ2xlYW4gdXAgZ3Vlc3QgY2FydFxuICAgICAgICAgIGF3YWl0IENhcnQuZGVsZXRlT25lKHsgc2Vzc2lvbklkIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHVzZXIuY2FydC51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG5cbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuXG4gICAgICAvLyBFbWl0IGNhcnQgdXBkYXRlIGV2ZW50XG4gICAgICBhd2FpdCB0aGlzLm5vdGlmeUNhcnRVcGRhdGUoc2Vzc2lvbklkLCB1c2VySWQsIHVzZXIuY2FydCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lcmdlZEl0ZW1zLFxuICAgICAgICBjb25mbGljdHMsXG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NhcnQgbWVyZ2UgZXJyb3I6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLy8gSGVscGVyIG1ldGhvZCB0byBtZXJnZSBpbmRpdmlkdWFsIGNhcnQgaXRlbXNcbiAgYXN5bmMgbWVyZ2VDYXJ0SXRlbSh1c2VyLCBndWVzdEl0ZW0sIGNvbmZsaWN0cyA9IFtdKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IGd1ZXN0SXRlbS5wcm9kdWN0SWQgfHwgZ3Vlc3RJdGVtLnByb2R1Y3Q7XG4gICAgICBjb25zdCBxdWFudGl0eSA9IGd1ZXN0SXRlbS5xdWFudGl0eSB8fCAxO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBwcm9kdWN0XG4gICAgICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgUHJvZHVjdC5maW5kQnlJZChwcm9kdWN0SWQpLmxlYW4oKTtcbiAgICAgIGlmICghcHJvZHVjdCB8fCAhcHJvZHVjdC5pc0FjdGl2ZSkge1xuICAgICAgICByZXR1cm4geyBtZXJnZWQ6IGZhbHNlLCByZWFzb246ICdpbnZhbGlkX3Byb2R1Y3QnIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBleGlzdGluZyBpdGVtXG4gICAgICBjb25zdCBleGlzdGluZ0l0ZW1JbmRleCA9IHVzZXIuY2FydC5pdGVtcy5maW5kSW5kZXgoaXRlbSA9PiBcbiAgICAgICAgaXRlbS5wcm9kdWN0LnRvU3RyaW5nKCkgPT09IHByb2R1Y3RJZC50b1N0cmluZygpXG4gICAgICApO1xuXG4gICAgICBpZiAoZXhpc3RpbmdJdGVtSW5kZXggPj0gMCkge1xuICAgICAgICBjb25zdCBjdXJyZW50UXVhbnRpdHkgPSB1c2VyLmNhcnQuaXRlbXNbZXhpc3RpbmdJdGVtSW5kZXhdLnF1YW50aXR5O1xuICAgICAgICBjb25zdCBuZXdRdWFudGl0eSA9IGN1cnJlbnRRdWFudGl0eSArIHF1YW50aXR5O1xuICAgICAgICBcbiAgICAgICAgLy8gQ2hlY2sgZm9yIHF1YW50aXR5IGNvbmZsaWN0c1xuICAgICAgICBpZiAobmV3UXVhbnRpdHkgPiA5OSkge1xuICAgICAgICAgIGNvbmZsaWN0cy5wdXNoKHtcbiAgICAgICAgICAgIHByb2R1Y3RJZCxcbiAgICAgICAgICAgIHR5cGU6ICdxdWFudGl0eV9saW1pdCcsXG4gICAgICAgICAgICBjdXJyZW50OiBjdXJyZW50UXVhbnRpdHksXG4gICAgICAgICAgICBhdHRlbXB0ZWQ6IHF1YW50aXR5LFxuICAgICAgICAgICAgcmVzb2x2ZWQ6IDk5XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdXNlci5jYXJ0Lml0ZW1zW2V4aXN0aW5nSXRlbUluZGV4XS5xdWFudGl0eSA9IDk5O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHVzZXIuY2FydC5pdGVtc1tleGlzdGluZ0l0ZW1JbmRleF0ucXVhbnRpdHkgPSBuZXdRdWFudGl0eTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdXNlci5jYXJ0Lml0ZW1zW2V4aXN0aW5nSXRlbUluZGV4XS5hZGRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIEFkZCBuZXcgaXRlbVxuICAgICAgICB1c2VyLmNhcnQuaXRlbXMucHVzaCh7XG4gICAgICAgICAgcHJvZHVjdDogcHJvZHVjdElkLFxuICAgICAgICAgIHF1YW50aXR5OiBNYXRoLm1pbihxdWFudGl0eSwgOTkpLFxuICAgICAgICAgIHByaWNlOiBwcm9kdWN0LnByaWNlLFxuICAgICAgICAgIGFkZGVkQXQ6IG5ldyBEYXRlKClcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7IG1lcmdlZDogdHJ1ZSB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBtZXJnaW5nIGNhcnQgaXRlbTonLCBlcnJvcik7XG4gICAgICByZXR1cm4geyBtZXJnZWQ6IGZhbHNlLCByZWFzb246ICdtZXJnZV9lcnJvcicsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XG4gICAgfVxuICB9XG5cbiAgLy8gT3B0aW1pc3RpYyBjYXJ0IHVwZGF0ZSB3aXRoIHJvbGxiYWNrIGNhcGFiaWxpdHlcbiAgYXN5bmMgdXBkYXRlQ2FydE9wdGltaXN0aWNhbGx5KHJlcSwgb3BlcmF0aW9uLCBkYXRhKSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBsZXQgcm9sbGJhY2tEYXRhID0gbnVsbDtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyB0eXBlLCBjYXJ0LCB1c2VyIH0gPSBhd2FpdCB0aGlzLmdldE9yQ3JlYXRlQ2FydChyZXEpO1xuICAgICAgXG4gICAgICAvLyBTdG9yZSByb2xsYmFjayBkYXRhXG4gICAgICBpZiAodHlwZSA9PT0gJ3VzZXInKSB7XG4gICAgICAgIHJvbGxiYWNrRGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodXNlci5jYXJ0KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByb2xsYmFja0RhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGNhcnQpKTtcbiAgICAgIH1cblxuICAgICAgLy8gUGVyZm9ybSBvcGVyYXRpb25cbiAgICAgIGxldCByZXN1bHQ7XG4gICAgICBzd2l0Y2ggKG9wZXJhdGlvbikge1xuICAgICAgICBjYXNlICdhZGQnOlxuICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuYWRkSXRlbU9wdGltaXN0aWNhbGx5KHR5cGUsIGNhcnQsIHVzZXIsIGRhdGEpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMudXBkYXRlSXRlbU9wdGltaXN0aWNhbGx5KHR5cGUsIGNhcnQsIHVzZXIsIGRhdGEpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdyZW1vdmUnOlxuICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMucmVtb3ZlSXRlbU9wdGltaXN0aWNhbGx5KHR5cGUsIGNhcnQsIHVzZXIsIGRhdGEpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBvcGVyYXRpb246ICR7b3BlcmF0aW9ufWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcblxuICAgICAgLy8gUGVyZm9ybWFuY2UgbW9uaXRvcmluZ1xuICAgICAgaWYgKGR1cmF0aW9uID4gMjAwKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihgQ2FydCAke29wZXJhdGlvbn0gdG9vayAke2R1cmF0aW9ufW1zIC0gZXhjZWVkcyAyMDBtcyB0YXJnZXRgKTtcbiAgICAgIH1cblxuICAgICAgLy8gRW1pdCB1cGRhdGUgZXZlbnRcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9IHR5cGUgPT09ICdndWVzdCcgPyBjYXJ0LnNlc3Npb25JZCA6IG51bGw7XG4gICAgICBjb25zdCB1c2VySWQgPSB0eXBlID09PSAndXNlcicgPyB1c2VyLl9pZCA6IG51bGw7XG4gICAgICBhd2FpdCB0aGlzLm5vdGlmeUNhcnRVcGRhdGUoc2Vzc2lvbklkLCB1c2VySWQsIHJlc3VsdC5jYXJ0KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4ucmVzdWx0LFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgcGVyZm9ybWFuY2U6IGR1cmF0aW9uIDw9IDIwMCA/ICdnb29kJyA6ICduZWVkc19vcHRpbWl6YXRpb24nXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYENhcnQgJHtvcGVyYXRpb259IGVycm9yOmAsIGVycm9yKTtcbiAgICAgIFxuICAgICAgLy8gSW1wbGVtZW50IHJvbGxiYWNrIGlmIG5lZWRlZFxuICAgICAgaWYgKHJvbGxiYWNrRGF0YSkge1xuICAgICAgICBjb25zb2xlLmxvZygnUm9sbGluZyBiYWNrIGNhcnQgY2hhbmdlcy4uLicpO1xuICAgICAgICAvLyBSb2xsYmFjayBpbXBsZW1lbnRhdGlvbiB3b3VsZCBnbyBoZXJlXG4gICAgICB9XG4gICAgICBcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8vIE9wdGltaXN0aWMgYWRkIGl0ZW0gb3BlcmF0aW9uXG4gIGFzeW5jIGFkZEl0ZW1PcHRpbWlzdGljYWxseSh0eXBlLCBjYXJ0LCB1c2VyLCB7IHByb2R1Y3RJZCwgcXVhbnRpdHkgfSkge1xuICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBQcm9kdWN0LmZpbmRCeUlkKHByb2R1Y3RJZCkubGVhbigpO1xuICAgIGlmICghcHJvZHVjdCB8fCAhcHJvZHVjdC5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm9kdWN0IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScpO1xuICAgIH1cblxuICAgIGlmICh0eXBlID09PSAndXNlcicpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nSXRlbUluZGV4ID0gdXNlci5jYXJ0Lml0ZW1zLmZpbmRJbmRleChpdGVtID0+IFxuICAgICAgICBpdGVtLnByb2R1Y3QudG9TdHJpbmcoKSA9PT0gcHJvZHVjdElkLnRvU3RyaW5nKClcbiAgICAgICk7XG5cbiAgICAgIGlmIChleGlzdGluZ0l0ZW1JbmRleCA+PSAwKSB7XG4gICAgICAgIHVzZXIuY2FydC5pdGVtc1tleGlzdGluZ0l0ZW1JbmRleF0ucXVhbnRpdHkgKz0gcXVhbnRpdHk7XG4gICAgICAgIHVzZXIuY2FydC5pdGVtc1tleGlzdGluZ0l0ZW1JbmRleF0uYWRkZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB1c2VyLmNhcnQuaXRlbXMucHVzaCh7XG4gICAgICAgICAgcHJvZHVjdDogcHJvZHVjdElkLFxuICAgICAgICAgIHF1YW50aXR5LFxuICAgICAgICAgIHByaWNlOiBwcm9kdWN0LnByaWNlLFxuICAgICAgICAgIGFkZGVkQXQ6IG5ldyBEYXRlKClcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHVzZXIuY2FydC51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgICByZXR1cm4geyBjYXJ0OiB1c2VyLmNhcnQgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2hlY2sgaWYgY2FydCBoYXMgYWRkSXRlbSBtZXRob2QsIG90aGVyd2lzZSBtYW51YWxseSBhZGRcbiAgICAgIGlmIChjYXJ0LmFkZEl0ZW0gJiYgdHlwZW9mIGNhcnQuYWRkSXRlbSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBjYXJ0LmFkZEl0ZW0ocHJvZHVjdElkLCBxdWFudGl0eSwgcHJvZHVjdC5wcmljZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBNYW51YWxseSBhZGQgdG8gY2FydCBpdGVtc1xuICAgICAgICBjb25zdCBleGlzdGluZ0l0ZW1JbmRleCA9IGNhcnQuaXRlbXMuZmluZEluZGV4KGl0ZW0gPT4gXG4gICAgICAgICAgaXRlbS5wcm9kdWN0LnRvU3RyaW5nKCkgPT09IHByb2R1Y3RJZC50b1N0cmluZygpXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGV4aXN0aW5nSXRlbUluZGV4ID49IDApIHtcbiAgICAgICAgICBjYXJ0Lml0ZW1zW2V4aXN0aW5nSXRlbUluZGV4XS5xdWFudGl0eSArPSBxdWFudGl0eTtcbiAgICAgICAgICBjYXJ0Lml0ZW1zW2V4aXN0aW5nSXRlbUluZGV4XS5hZGRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjYXJ0Lml0ZW1zLnB1c2goe1xuICAgICAgICAgICAgcHJvZHVjdDogcHJvZHVjdElkLFxuICAgICAgICAgICAgcXVhbnRpdHksXG4gICAgICAgICAgICBwcmljZTogcHJvZHVjdC5wcmljZSxcbiAgICAgICAgICAgIGFkZGVkQXQ6IG5ldyBEYXRlKClcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXJ0LnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgICB9XG4gICAgICBhd2FpdCBjYXJ0LnNhdmUoKTtcbiAgICAgIHJldHVybiB7IGNhcnQgfTtcbiAgICB9XG4gIH1cblxuICAvLyBPcHRpbWlzdGljIHVwZGF0ZSBpdGVtIG9wZXJhdGlvblxuICBhc3luYyB1cGRhdGVJdGVtT3B0aW1pc3RpY2FsbHkodHlwZSwgY2FydCwgdXNlciwgeyBwcm9kdWN0SWQsIHF1YW50aXR5IH0pIHtcbiAgICBpZiAodHlwZSA9PT0gJ3VzZXInKSB7XG4gICAgICBjb25zdCBpdGVtSW5kZXggPSB1c2VyLmNhcnQuaXRlbXMuZmluZEluZGV4KGl0ZW0gPT4gXG4gICAgICAgIGl0ZW0ucHJvZHVjdC50b1N0cmluZygpID09PSBwcm9kdWN0SWQudG9TdHJpbmcoKVxuICAgICAgKTtcblxuICAgICAgaWYgKGl0ZW1JbmRleCA+PSAwKSB7XG4gICAgICAgIGlmIChxdWFudGl0eSA9PT0gMCkge1xuICAgICAgICAgIHVzZXIuY2FydC5pdGVtcy5zcGxpY2UoaXRlbUluZGV4LCAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB1c2VyLmNhcnQuaXRlbXNbaXRlbUluZGV4XS5xdWFudGl0eSA9IHF1YW50aXR5O1xuICAgICAgICAgIHVzZXIuY2FydC5pdGVtc1tpdGVtSW5kZXhdLmFkZGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHVzZXIuY2FydC51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBhd2FpdCB1c2VyLnNhdmUoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7IGNhcnQ6IHVzZXIuY2FydCB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDaGVjayBpZiBjYXJ0IGhhcyB1cGRhdGVJdGVtIG1ldGhvZCwgb3RoZXJ3aXNlIG1hbnVhbGx5IHVwZGF0ZVxuICAgICAgaWYgKGNhcnQudXBkYXRlSXRlbSAmJiB0eXBlb2YgY2FydC51cGRhdGVJdGVtID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNhcnQudXBkYXRlSXRlbShwcm9kdWN0SWQsIHF1YW50aXR5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE1hbnVhbGx5IHVwZGF0ZSBjYXJ0IGl0ZW1zXG4gICAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IGNhcnQuaXRlbXMuZmluZEluZGV4KGl0ZW0gPT4gXG4gICAgICAgICAgaXRlbS5wcm9kdWN0LnRvU3RyaW5nKCkgPT09IHByb2R1Y3RJZC50b1N0cmluZygpXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGl0ZW1JbmRleCA+PSAwKSB7XG4gICAgICAgICAgaWYgKHF1YW50aXR5ID09PSAwKSB7XG4gICAgICAgICAgICBjYXJ0Lml0ZW1zLnNwbGljZShpdGVtSW5kZXgsIDEpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYXJ0Lml0ZW1zW2l0ZW1JbmRleF0ucXVhbnRpdHkgPSBxdWFudGl0eTtcbiAgICAgICAgICAgIGNhcnQuaXRlbXNbaXRlbUluZGV4XS5hZGRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FydC51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBhd2FpdCBjYXJ0LnNhdmUoKTtcbiAgICAgIHJldHVybiB7IGNhcnQgfTtcbiAgICB9XG4gIH1cblxuICAvLyBPcHRpbWlzdGljIHJlbW92ZSBpdGVtIG9wZXJhdGlvblxuICBhc3luYyByZW1vdmVJdGVtT3B0aW1pc3RpY2FsbHkodHlwZSwgY2FydCwgdXNlciwgeyBwcm9kdWN0SWQgfSkge1xuICAgIGlmICh0eXBlID09PSAndXNlcicpIHtcbiAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IHVzZXIuY2FydC5pdGVtcy5maW5kSW5kZXgoaXRlbSA9PiBcbiAgICAgICAgaXRlbS5wcm9kdWN0LnRvU3RyaW5nKCkgPT09IHByb2R1Y3RJZC50b1N0cmluZygpXG4gICAgICApO1xuXG4gICAgICBpZiAoaXRlbUluZGV4ID49IDApIHtcbiAgICAgICAgdXNlci5jYXJ0Lml0ZW1zLnNwbGljZShpdGVtSW5kZXgsIDEpO1xuICAgICAgICB1c2VyLmNhcnQudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgICB9XG4gICAgICByZXR1cm4geyBjYXJ0OiB1c2VyLmNhcnQgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2hlY2sgaWYgY2FydCBoYXMgcmVtb3ZlSXRlbSBtZXRob2QsIG90aGVyd2lzZSBtYW51YWxseSByZW1vdmVcbiAgICAgIGlmIChjYXJ0LnJlbW92ZUl0ZW0gJiYgdHlwZW9mIGNhcnQucmVtb3ZlSXRlbSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBjYXJ0LnJlbW92ZUl0ZW0ocHJvZHVjdElkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE1hbnVhbGx5IHJlbW92ZSBmcm9tIGNhcnQgaXRlbXNcbiAgICAgICAgY29uc3QgaXRlbUluZGV4ID0gY2FydC5pdGVtcy5maW5kSW5kZXgoaXRlbSA9PiBcbiAgICAgICAgICBpdGVtLnByb2R1Y3QudG9TdHJpbmcoKSA9PT0gcHJvZHVjdElkLnRvU3RyaW5nKClcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoaXRlbUluZGV4ID49IDApIHtcbiAgICAgICAgICBjYXJ0Lml0ZW1zLnNwbGljZShpdGVtSW5kZXgsIDEpO1xuICAgICAgICAgIGNhcnQudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYXdhaXQgY2FydC5zYXZlKCk7XG4gICAgICByZXR1cm4geyBjYXJ0IH07XG4gICAgfVxuICB9XG5cbiAgLy8gQ2xlYW51cCBleHBpcmVkIGd1ZXN0IGNhcnRzIChmb3Igc2NoZWR1bGVkIG1haW50ZW5hbmNlKVxuICBhc3luYyBjbGVhbnVwRXhwaXJlZENhcnRzKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBDYXJ0LmRlbGV0ZU1hbnkoe1xuICAgICAgICBleHBpcmVzQXQ6IHsgJGx0OiBuZXcgRGF0ZSgpIH1cbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBjb25zb2xlLmxvZyhgQ2xlYW5lZCB1cCAke3Jlc3VsdC5kZWxldGVkQ291bnR9IGV4cGlyZWQgZ3Vlc3QgY2FydHNgKTtcbiAgICAgIHJldHVybiByZXN1bHQuZGVsZXRlZENvdW50O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjbGVhbmluZyB1cCBleHBpcmVkIGNhcnRzOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXG5jb25zdCBjYXJ0U2VydmljZSA9IG5ldyBDYXJ0U2VydmljZSgpO1xubW9kdWxlLmV4cG9ydHMgPSBjYXJ0U2VydmljZTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQ3RDLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQ3RDLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLG1CQUFtQixDQUFDO0FBQzVDLE1BQU1HLFlBQVksR0FBR0gsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUV0QyxNQUFNSSxXQUFXLFNBQVNELFlBQVksQ0FBQztF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