{"version":3,"names":["express","require","mongoose","logger","getCircuitBreakerStatus","requireAdmin","router","Router","get","req","res","healthCheck","status","timestamp","Date","toISOString","uptime","process","environment","env","NODE_ENV","json","memory","memoryUsage","database","getDatabaseStatus","circuitBreakers","services","getServicesStatus","info","requestedBy","user","email","success","data","error","message","code","dbState","connection","readyState","states","state","host","port","name","db","admin","ping","payment","provider","metrics","system","cpu","cpuUsage","connections","collections","getCollectionStats","errors","getErrorMetrics","listCollections","toArray","stats","collection","collectionStats","count","size","avgObjSize","note","last24Hours","total","byType","byEndpoint","level","limit","query","module","exports"],"sources":["monitoring.js"],"sourcesContent":["const express = require('express');\nconst mongoose = require('mongoose');\nconst { logger } = require('../utils/logger');\nconst { getCircuitBreakerStatus } = require('../utils/errorRecovery');\nconst { requireAdmin } = require('../middleware/auth');\n\nconst router = express.Router();\n\n// Basic health check\nrouter.get('/health', (req, res) => {\n  const healthCheck = {\n    status: 'OK',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    environment: process.env.NODE_ENV || 'development'\n  };\n\n  res.json(healthCheck);\n});\n\n// Detailed system status (admin only)\nrouter.get('/status', requireAdmin, async (req, res) => {\n  try {\n    const status = {\n      timestamp: new Date().toISOString(),\n      environment: process.env.NODE_ENV || 'development',\n      uptime: process.uptime(),\n      memory: process.memoryUsage(),\n      database: await getDatabaseStatus(),\n      circuitBreakers: getCircuitBreakerStatus(),\n      services: await getServicesStatus()\n    };\n\n    logger.info('System status requested', {\n      requestedBy: req.user.email,\n      timestamp: status.timestamp\n    });\n\n    res.json({\n      success: true,\n      data: status\n    });\n  } catch (error) {\n    logger.error('Error getting system status:', {\n      error: error.message,\n      requestedBy: req.user.email\n    });\n\n    res.status(500).json({\n      success: false,\n      error: {\n        code: 'STATUS_ERROR',\n        message: 'Unable to retrieve system status'\n      }\n    });\n  }\n});\n\n// Database health check\nasync function getDatabaseStatus() {\n  try {\n    const dbState = mongoose.connection.readyState;\n    const states = {\n      0: 'disconnected',\n      1: 'connected',\n      2: 'connecting',\n      3: 'disconnecting'\n    };\n\n    const status = {\n      state: states[dbState],\n      host: mongoose.connection.host,\n      port: mongoose.connection.port,\n      name: mongoose.connection.name\n    };\n\n    // Test database connectivity\n    if (dbState === 1) {\n      await mongoose.connection.db.admin().ping();\n      status.ping = 'success';\n    }\n\n    return status;\n  } catch (error) {\n    return {\n      state: 'error',\n      error: error.message\n    };\n  }\n}\n\n// Services health check\nasync function getServicesStatus() {\n  const services = {};\n\n  // Check payment service (Mollie)\n  try {\n    // In a real implementation, you might ping Mollie's API\n    services.payment = {\n      status: 'available',\n      provider: 'mollie'\n    };\n  } catch (error) {\n    services.payment = {\n      status: 'unavailable',\n      error: error.message\n    };\n  }\n\n  // Check email service\n  try {\n    // In a real implementation, you might test SMTP connection\n    services.email = {\n      status: 'available',\n      provider: 'nodemailer'\n    };\n  } catch (error) {\n    services.email = {\n      status: 'unavailable',\n      error: error.message\n    };\n  }\n\n  return services;\n}\n\n// Metrics endpoint (admin only)\nrouter.get('/metrics', requireAdmin, async (req, res) => {\n  try {\n    const metrics = {\n      timestamp: new Date().toISOString(),\n      system: {\n        uptime: process.uptime(),\n        memory: process.memoryUsage(),\n        cpu: process.cpuUsage()\n      },\n      database: {\n        connections: mongoose.connection.readyState,\n        collections: await getCollectionStats()\n      },\n      errors: await getErrorMetrics()\n    };\n\n    res.json({\n      success: true,\n      data: metrics\n    });\n  } catch (error) {\n    logger.error('Error getting metrics:', {\n      error: error.message,\n      requestedBy: req.user.email\n    });\n\n    res.status(500).json({\n      success: false,\n      error: {\n        code: 'METRICS_ERROR',\n        message: 'Unable to retrieve metrics'\n      }\n    });\n  }\n});\n\n// Get collection statistics\nasync function getCollectionStats() {\n  try {\n    const collections = await mongoose.connection.db.listCollections().toArray();\n    const stats = {};\n\n    for (const collection of collections) {\n      try {\n        const collectionStats = await mongoose.connection.db.collection(collection.name).stats();\n        stats[collection.name] = {\n          count: collectionStats.count,\n          size: collectionStats.size,\n          avgObjSize: collectionStats.avgObjSize\n        };\n      } catch (error) {\n        stats[collection.name] = { error: error.message };\n      }\n    }\n\n    return stats;\n  } catch (error) {\n    return { error: error.message };\n  }\n}\n\n// Get error metrics (simplified - in production you'd use proper metrics storage)\nasync function getErrorMetrics() {\n  // This is a simplified implementation\n  // In production, you'd use proper metrics collection like Prometheus\n  return {\n    note: 'Error metrics would be collected from logs or metrics store',\n    last24Hours: {\n      total: 0,\n      byType: {},\n      byEndpoint: {}\n    }\n  };\n}\n\n// Logs endpoint (admin only) - recent logs\nrouter.get('/logs', requireAdmin, (req, res) => {\n  try {\n    const { level = 'info', limit = 100 } = req.query;\n    \n    // In a real implementation, you'd read from log files or log aggregation service\n    res.json({\n      success: true,\n      data: {\n        message: 'Log retrieval endpoint - would return recent logs',\n        level,\n        limit,\n        note: 'In production, this would read from log files or log aggregation service'\n      }\n    });\n  } catch (error) {\n    logger.error('Error retrieving logs:', {\n      error: error.message,\n      requestedBy: req.user.email\n    });\n\n    res.status(500).json({\n      success: false,\n      error: {\n        code: 'LOGS_ERROR',\n        message: 'Unable to retrieve logs'\n      }\n    });\n  }\n});\n\nmodule.exports = router;"],"mappings":"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","ignoreList":[]}