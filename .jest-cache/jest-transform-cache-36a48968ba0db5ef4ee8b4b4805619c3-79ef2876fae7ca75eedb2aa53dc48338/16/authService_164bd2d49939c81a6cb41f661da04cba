55eceda7279cc79504abe1e60e7d3973
const User = require('../models/User');
const jwt = require('jsonwebtoken');
const EventEmitter = require('events');
class AuthService extends EventEmitter {
  constructor() {
    super();
    this.auditLog = [];
    this.rateLimitStore = new Map(); // Simple in-memory rate limiting
  }

  // Rate limiting for profile updates (max 10 per minute)
  checkRateLimit(userId) {
    const now = Date.now();
    const windowMs = 60 * 1000; // 1 minute
    const maxRequests = 10;
    const userRequests = this.rateLimitStore.get(userId) || [];

    // Remove old requests outside the window
    const validRequests = userRequests.filter(timestamp => now - timestamp < windowMs);
    if (validRequests.length >= maxRequests) {
      return {
        allowed: false,
        retryAfter: Math.ceil((validRequests[0] + windowMs - now) / 1000)
      };
    }

    // Add current request
    validRequests.push(now);
    this.rateLimitStore.set(userId, validRequests);
    return {
      allowed: true
    };
  }

  // Optimistic profile update with performance monitoring
  async updateProfileOptimistically(userId, updateData, auditContext = {}) {
    const startTime = Date.now();
    try {
      // Rate limiting check
      const rateCheck = this.checkRateLimit(userId);
      if (!rateCheck.allowed) {
        throw new Error(`Rate limit exceeded. Try again in ${rateCheck.retryAfter} seconds.`);
      }

      // Get current user for rollback if needed
      const currentUser = await User.findById(userId).lean();
      if (!currentUser) {
        throw new Error('User not found');
      }

      // Validate email uniqueness if email is being changed
      if (updateData.email && updateData.email !== currentUser.email) {
        const existingUser = await User.findOne({
          email: updateData.email,
          _id: {
            $ne: userId
          }
        }).lean();
        if (existingUser) {
          throw new Error('Email already in use');
        }
      }

      // Perform optimistic update
      const updatedUser = await User.findByIdAndUpdate(userId, {
        ...updateData,
        updatedAt: new Date()
      }, {
        new: true,
        runValidators: true,
        lean: true
      });
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Audit logging for sensitive changes
      if (updateData.email || updateData.phone) {
        this.logSensitiveChange(userId, updateData, auditContext);
      }

      // Emit profile update event
      this.emit('profileUpdated', {
        userId,
        changes: updateData,
        timestamp: new Date(),
        performance: {
          duration
        }
      });

      // Performance monitoring (target: 200ms)
      if (duration > 200) {
        console.warn(`Profile update took ${duration}ms - exceeds 200ms target`);
      }
      return {
        user: updatedUser,
        duration,
        performance: duration <= 200 ? 'good' : 'needs_optimization',
        success: true
      };
    } catch (error) {
      const endTime = Date.now();
      const duration = endTime - startTime;
      console.error('Profile update error:', error);
      return {
        success: false,
        error: error.message,
        duration
      };
    }
  }

  // Enhanced address management without authentication loss
  async manageAddressOptimistically(userId, operation, addressData = {}, addressId = null) {
    const startTime = Date.now();
    try {
      const user = await User.findById(userId);
      if (!user) {
        throw new Error('User not found');
      }
      let result;
      switch (operation) {
        case 'add':
          result = await user.addAddress(addressData);
          break;
        case 'update':
          result = await user.updateAddress(addressId, addressData);
          break;
        case 'delete':
          result = await user.removeAddress(addressId);
          break;
        case 'setDefault':
          result = await user.setDefaultAddress(addressId);
          break;
        default:
          throw new Error(`Unknown address operation: ${operation}`);
      }
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Emit address update event
      this.emit('addressUpdated', {
        userId,
        operation,
        addressId,
        timestamp: new Date(),
        performance: {
          duration
        }
      });
      return {
        user: result,
        duration,
        performance: duration <= 200 ? 'good' : 'needs_optimization',
        success: true
      };
    } catch (error) {
      console.error('Address management error:', error);
      return {
        success: false,
        error: error.message,
        duration: Date.now() - startTime
      };
    }
  }

  // Audit logging for sensitive operations
  logSensitiveChange(userId, changes, context) {
    const auditEntry = {
      userId,
      timestamp: new Date(),
      changes: Object.keys(changes).filter(key => ['email', 'phone'].includes(key)),
      ip: context.ip,
      userAgent: context.userAgent,
      sessionId: context.sessionId
    };
    this.auditLog.push(auditEntry);

    // Keep only last 1000 entries in memory
    if (this.auditLog.length > 1000) {
      this.auditLog = this.auditLog.slice(-1000);
    }
    console.log('Sensitive profile change:', auditEntry);
  }

  // Validate token without requiring re-authentication
  async validateTokenSafely(token) {
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      const user = await User.findById(decoded.userId).select('-password');
      if (!user || !user.isActive) {
        return {
          valid: false,
          reason: 'user_not_found'
        };
      }
      return {
        valid: true,
        user,
        decoded
      };
    } catch (error) {
      return {
        valid: false,
        reason: 'invalid_token',
        error: error.message
      };
    }
  }

  // Enhanced token refresh mechanism
  async refreshTokenIfNeeded(token) {
    try {
      const decoded = jwt.decode(token);
      if (!decoded) {
        return {
          success: false,
          reason: 'invalid_token'
        };
      }

      // Check if token expires within next hour
      const expiresAt = decoded.exp * 1000;
      const oneHourFromNow = Date.now() + 60 * 60 * 1000;
      if (expiresAt > oneHourFromNow) {
        return {
          success: true,
          refreshed: false,
          token
        };
      }

      // Generate new token
      const newToken = jwt.sign({
        userId: decoded.userId
      }, process.env.JWT_SECRET, {
        expiresIn: '7d'
      });
      return {
        success: true,
        refreshed: true,
        token: newToken,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
      };
    } catch (error) {
      return {
        success: false,
        reason: 'refresh_failed',
        error: error.message
      };
    }
  }

  // Email notification for sensitive changes
  async notifyUserOfSensitiveChange(userId, changeType, context = {}) {
    try {
      const user = await User.findById(userId).lean();
      if (!user || !user.preferences?.emailPreferences?.orderConfirmations) {
        return; // User doesn't want notifications
      }

      // This would integrate with your email service
      console.log(`Email notification sent to ${user.email}: ${changeType} changed`);

      // Emit notification event
      this.emit('sensitiveChangeNotification', {
        userId,
        email: user.email,
        changeType,
        timestamp: new Date(),
        context
      });
    } catch (error) {
      console.error('Failed to send sensitive change notification:', error);
    }
  }

  // Optimistic user data synchronization
  async synchronizeUserData(userId, eventType = 'manual') {
    try {
      const user = await User.findById(userId).lean();
      if (!user) {
        throw new Error('User not found');
      }

      // Emit synchronization event for real-time updates
      this.emit('userDataSync', {
        userId,
        user,
        eventType,
        timestamp: new Date()
      });
      return {
        success: true,
        user
      };
    } catch (error) {
      console.error('User data synchronization error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // Get audit log for user (for admin or debugging)
  getUserAuditLog(userId, limit = 50) {
    return this.auditLog.filter(entry => entry.userId.toString() === userId.toString()).slice(-limit).reverse();
  }

  // Clean up rate limit store periodically
  cleanupRateLimitStore() {
    const now = Date.now();
    const windowMs = 60 * 1000; // 1 minute

    for (const [userId, requests] of this.rateLimitStore.entries()) {
      const validRequests = requests.filter(timestamp => now - timestamp < windowMs);
      if (validRequests.length === 0) {
        this.rateLimitStore.delete(userId);
      } else {
        this.rateLimitStore.set(userId, validRequests);
      }
    }
  }

  // Connection pooling awareness
  async withConnectionOptimization(operation) {
    const startTime = Date.now();
    try {
      const result = await operation();
      const duration = Date.now() - startTime;
      if (duration > 100) {
        console.warn(`Database operation took ${duration}ms - consider connection pooling optimization`);
      }
      return result;
    } catch (error) {
      console.error('Database operation failed:', error);
      throw error;
    }
  }
}

// Cleanup rate limit store every 5 minutes
const authService = new AuthService();
setInterval(() => {
  authService.cleanupRateLimitStore();
}, 5 * 60 * 1000);
module.exports = authService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVc2VyIiwicmVxdWlyZSIsImp3dCIsIkV2ZW50RW1pdHRlciIsIkF1dGhTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJhdWRpdExvZyIsInJhdGVMaW1pdFN0b3JlIiwiTWFwIiwiY2hlY2tSYXRlTGltaXQiLCJ1c2VySWQiLCJub3ciLCJEYXRlIiwid2luZG93TXMiLCJtYXhSZXF1ZXN0cyIsInVzZXJSZXF1ZXN0cyIsImdldCIsInZhbGlkUmVxdWVzdHMiLCJmaWx0ZXIiLCJ0aW1lc3RhbXAiLCJsZW5ndGgiLCJhbGxvd2VkIiwicmV0cnlBZnRlciIsIk1hdGgiLCJjZWlsIiwicHVzaCIsInNldCIsInVwZGF0ZVByb2ZpbGVPcHRpbWlzdGljYWxseSIsInVwZGF0ZURhdGEiLCJhdWRpdENvbnRleHQiLCJzdGFydFRpbWUiLCJyYXRlQ2hlY2siLCJFcnJvciIsImN1cnJlbnRVc2VyIiwiZmluZEJ5SWQiLCJsZWFuIiwiZW1haWwiLCJleGlzdGluZ1VzZXIiLCJmaW5kT25lIiwiX2lkIiwiJG5lIiwidXBkYXRlZFVzZXIiLCJmaW5kQnlJZEFuZFVwZGF0ZSIsInVwZGF0ZWRBdCIsIm5ldyIsInJ1blZhbGlkYXRvcnMiLCJlbmRUaW1lIiwiZHVyYXRpb24iLCJwaG9uZSIsImxvZ1NlbnNpdGl2ZUNoYW5nZSIsImVtaXQiLCJjaGFuZ2VzIiwicGVyZm9ybWFuY2UiLCJjb25zb2xlIiwid2FybiIsInVzZXIiLCJzdWNjZXNzIiwiZXJyb3IiLCJtZXNzYWdlIiwibWFuYWdlQWRkcmVzc09wdGltaXN0aWNhbGx5Iiwib3BlcmF0aW9uIiwiYWRkcmVzc0RhdGEiLCJhZGRyZXNzSWQiLCJyZXN1bHQiLCJhZGRBZGRyZXNzIiwidXBkYXRlQWRkcmVzcyIsInJlbW92ZUFkZHJlc3MiLCJzZXREZWZhdWx0QWRkcmVzcyIsImNvbnRleHQiLCJhdWRpdEVudHJ5IiwiT2JqZWN0Iiwia2V5cyIsImtleSIsImluY2x1ZGVzIiwiaXAiLCJ1c2VyQWdlbnQiLCJzZXNzaW9uSWQiLCJzbGljZSIsImxvZyIsInZhbGlkYXRlVG9rZW5TYWZlbHkiLCJ0b2tlbiIsImRlY29kZWQiLCJ2ZXJpZnkiLCJwcm9jZXNzIiwiZW52IiwiSldUX1NFQ1JFVCIsInNlbGVjdCIsImlzQWN0aXZlIiwidmFsaWQiLCJyZWFzb24iLCJyZWZyZXNoVG9rZW5JZk5lZWRlZCIsImRlY29kZSIsImV4cGlyZXNBdCIsImV4cCIsIm9uZUhvdXJGcm9tTm93IiwicmVmcmVzaGVkIiwibmV3VG9rZW4iLCJzaWduIiwiZXhwaXJlc0luIiwibm90aWZ5VXNlck9mU2Vuc2l0aXZlQ2hhbmdlIiwiY2hhbmdlVHlwZSIsInByZWZlcmVuY2VzIiwiZW1haWxQcmVmZXJlbmNlcyIsIm9yZGVyQ29uZmlybWF0aW9ucyIsInN5bmNocm9uaXplVXNlckRhdGEiLCJldmVudFR5cGUiLCJnZXRVc2VyQXVkaXRMb2ciLCJsaW1pdCIsImVudHJ5IiwidG9TdHJpbmciLCJyZXZlcnNlIiwiY2xlYW51cFJhdGVMaW1pdFN0b3JlIiwicmVxdWVzdHMiLCJlbnRyaWVzIiwiZGVsZXRlIiwid2l0aENvbm5lY3Rpb25PcHRpbWl6YXRpb24iLCJhdXRoU2VydmljZSIsInNldEludGVydmFsIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImF1dGhTZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFVzZXIgPSByZXF1aXJlKCcuLi9tb2RlbHMvVXNlcicpO1xuY29uc3Qgand0ID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcblxuY2xhc3MgQXV0aFNlcnZpY2UgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXVkaXRMb2cgPSBbXTtcbiAgICB0aGlzLnJhdGVMaW1pdFN0b3JlID0gbmV3IE1hcCgpOyAvLyBTaW1wbGUgaW4tbWVtb3J5IHJhdGUgbGltaXRpbmdcbiAgfVxuXG4gIC8vIFJhdGUgbGltaXRpbmcgZm9yIHByb2ZpbGUgdXBkYXRlcyAobWF4IDEwIHBlciBtaW51dGUpXG4gIGNoZWNrUmF0ZUxpbWl0KHVzZXJJZCkge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3Qgd2luZG93TXMgPSA2MCAqIDEwMDA7IC8vIDEgbWludXRlXG4gICAgY29uc3QgbWF4UmVxdWVzdHMgPSAxMDtcblxuICAgIGNvbnN0IHVzZXJSZXF1ZXN0cyA9IHRoaXMucmF0ZUxpbWl0U3RvcmUuZ2V0KHVzZXJJZCkgfHwgW107XG4gICAgXG4gICAgLy8gUmVtb3ZlIG9sZCByZXF1ZXN0cyBvdXRzaWRlIHRoZSB3aW5kb3dcbiAgICBjb25zdCB2YWxpZFJlcXVlc3RzID0gdXNlclJlcXVlc3RzLmZpbHRlcih0aW1lc3RhbXAgPT4gbm93IC0gdGltZXN0YW1wIDwgd2luZG93TXMpO1xuICAgIFxuICAgIGlmICh2YWxpZFJlcXVlc3RzLmxlbmd0aCA+PSBtYXhSZXF1ZXN0cykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWxsb3dlZDogZmFsc2UsXG4gICAgICAgIHJldHJ5QWZ0ZXI6IE1hdGguY2VpbCgodmFsaWRSZXF1ZXN0c1swXSArIHdpbmRvd01zIC0gbm93KSAvIDEwMDApXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEFkZCBjdXJyZW50IHJlcXVlc3RcbiAgICB2YWxpZFJlcXVlc3RzLnB1c2gobm93KTtcbiAgICB0aGlzLnJhdGVMaW1pdFN0b3JlLnNldCh1c2VySWQsIHZhbGlkUmVxdWVzdHMpO1xuXG4gICAgcmV0dXJuIHsgYWxsb3dlZDogdHJ1ZSB9O1xuICB9XG5cbiAgLy8gT3B0aW1pc3RpYyBwcm9maWxlIHVwZGF0ZSB3aXRoIHBlcmZvcm1hbmNlIG1vbml0b3JpbmdcbiAgYXN5bmMgdXBkYXRlUHJvZmlsZU9wdGltaXN0aWNhbGx5KHVzZXJJZCwgdXBkYXRlRGF0YSwgYXVkaXRDb250ZXh0ID0ge30pIHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyBSYXRlIGxpbWl0aW5nIGNoZWNrXG4gICAgICBjb25zdCByYXRlQ2hlY2sgPSB0aGlzLmNoZWNrUmF0ZUxpbWl0KHVzZXJJZCk7XG4gICAgICBpZiAoIXJhdGVDaGVjay5hbGxvd2VkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUmF0ZSBsaW1pdCBleGNlZWRlZC4gVHJ5IGFnYWluIGluICR7cmF0ZUNoZWNrLnJldHJ5QWZ0ZXJ9IHNlY29uZHMuYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBjdXJyZW50IHVzZXIgZm9yIHJvbGxiYWNrIGlmIG5lZWRlZFxuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCkubGVhbigpO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIGVtYWlsIHVuaXF1ZW5lc3MgaWYgZW1haWwgaXMgYmVpbmcgY2hhbmdlZFxuICAgICAgaWYgKHVwZGF0ZURhdGEuZW1haWwgJiYgdXBkYXRlRGF0YS5lbWFpbCAhPT0gY3VycmVudFVzZXIuZW1haWwpIHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgVXNlci5maW5kT25lKHsgXG4gICAgICAgICAgZW1haWw6IHVwZGF0ZURhdGEuZW1haWwsXG4gICAgICAgICAgX2lkOiB7ICRuZTogdXNlcklkIH1cbiAgICAgICAgfSkubGVhbigpO1xuICAgICAgICBcbiAgICAgICAgaWYgKGV4aXN0aW5nVXNlcikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRW1haWwgYWxyZWFkeSBpbiB1c2UnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBQZXJmb3JtIG9wdGltaXN0aWMgdXBkYXRlXG4gICAgICBjb25zdCB1cGRhdGVkVXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWRBbmRVcGRhdGUoXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgeyBcbiAgICAgICAgICAuLi51cGRhdGVEYXRhLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKVxuICAgICAgICB9LFxuICAgICAgICB7IFxuICAgICAgICAgIG5ldzogdHJ1ZSwgXG4gICAgICAgICAgcnVuVmFsaWRhdG9yczogdHJ1ZSxcbiAgICAgICAgICBsZWFuOiB0cnVlXG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuXG4gICAgICAvLyBBdWRpdCBsb2dnaW5nIGZvciBzZW5zaXRpdmUgY2hhbmdlc1xuICAgICAgaWYgKHVwZGF0ZURhdGEuZW1haWwgfHwgdXBkYXRlRGF0YS5waG9uZSkge1xuICAgICAgICB0aGlzLmxvZ1NlbnNpdGl2ZUNoYW5nZSh1c2VySWQsIHVwZGF0ZURhdGEsIGF1ZGl0Q29udGV4dCk7XG4gICAgICB9XG5cbiAgICAgIC8vIEVtaXQgcHJvZmlsZSB1cGRhdGUgZXZlbnRcbiAgICAgIHRoaXMuZW1pdCgncHJvZmlsZVVwZGF0ZWQnLCB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgY2hhbmdlczogdXBkYXRlRGF0YSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBwZXJmb3JtYW5jZTogeyBkdXJhdGlvbiB9XG4gICAgICB9KTtcblxuICAgICAgLy8gUGVyZm9ybWFuY2UgbW9uaXRvcmluZyAodGFyZ2V0OiAyMDBtcylcbiAgICAgIGlmIChkdXJhdGlvbiA+IDIwMCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYFByb2ZpbGUgdXBkYXRlIHRvb2sgJHtkdXJhdGlvbn1tcyAtIGV4Y2VlZHMgMjAwbXMgdGFyZ2V0YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVzZXI6IHVwZGF0ZWRVc2VyLFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgcGVyZm9ybWFuY2U6IGR1cmF0aW9uIDw9IDIwMCA/ICdnb29kJyA6ICduZWVkc19vcHRpbWl6YXRpb24nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuICAgICAgXG4gICAgICBjb25zb2xlLmVycm9yKCdQcm9maWxlIHVwZGF0ZSBlcnJvcjonLCBlcnJvcik7XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgZHVyYXRpb25cbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLy8gRW5oYW5jZWQgYWRkcmVzcyBtYW5hZ2VtZW50IHdpdGhvdXQgYXV0aGVudGljYXRpb24gbG9zc1xuICBhc3luYyBtYW5hZ2VBZGRyZXNzT3B0aW1pc3RpY2FsbHkodXNlcklkLCBvcGVyYXRpb24sIGFkZHJlc3NEYXRhID0ge30sIGFkZHJlc3NJZCA9IG51bGwpIHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZCh1c2VySWQpO1xuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHJlc3VsdDtcbiAgICAgIHN3aXRjaCAob3BlcmF0aW9uKSB7XG4gICAgICAgIGNhc2UgJ2FkZCc6XG4gICAgICAgICAgcmVzdWx0ID0gYXdhaXQgdXNlci5hZGRBZGRyZXNzKGFkZHJlc3NEYXRhKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgICAgICByZXN1bHQgPSBhd2FpdCB1c2VyLnVwZGF0ZUFkZHJlc3MoYWRkcmVzc0lkLCBhZGRyZXNzRGF0YSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2RlbGV0ZSc6XG4gICAgICAgICAgcmVzdWx0ID0gYXdhaXQgdXNlci5yZW1vdmVBZGRyZXNzKGFkZHJlc3NJZCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3NldERlZmF1bHQnOlxuICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHVzZXIuc2V0RGVmYXVsdEFkZHJlc3MoYWRkcmVzc0lkKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gYWRkcmVzcyBvcGVyYXRpb246ICR7b3BlcmF0aW9ufWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcblxuICAgICAgLy8gRW1pdCBhZGRyZXNzIHVwZGF0ZSBldmVudFxuICAgICAgdGhpcy5lbWl0KCdhZGRyZXNzVXBkYXRlZCcsIHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBvcGVyYXRpb24sXG4gICAgICAgIGFkZHJlc3NJZCxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBwZXJmb3JtYW5jZTogeyBkdXJhdGlvbiB9XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdXNlcjogcmVzdWx0LFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgcGVyZm9ybWFuY2U6IGR1cmF0aW9uIDw9IDIwMCA/ICdnb29kJyA6ICduZWVkc19vcHRpbWl6YXRpb24nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0FkZHJlc3MgbWFuYWdlbWVudCBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8vIEF1ZGl0IGxvZ2dpbmcgZm9yIHNlbnNpdGl2ZSBvcGVyYXRpb25zXG4gIGxvZ1NlbnNpdGl2ZUNoYW5nZSh1c2VySWQsIGNoYW5nZXMsIGNvbnRleHQpIHtcbiAgICBjb25zdCBhdWRpdEVudHJ5ID0ge1xuICAgICAgdXNlcklkLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgY2hhbmdlczogT2JqZWN0LmtleXMoY2hhbmdlcykuZmlsdGVyKGtleSA9PiBbJ2VtYWlsJywgJ3Bob25lJ10uaW5jbHVkZXMoa2V5KSksXG4gICAgICBpcDogY29udGV4dC5pcCxcbiAgICAgIHVzZXJBZ2VudDogY29udGV4dC51c2VyQWdlbnQsXG4gICAgICBzZXNzaW9uSWQ6IGNvbnRleHQuc2Vzc2lvbklkXG4gICAgfTtcbiAgICBcbiAgICB0aGlzLmF1ZGl0TG9nLnB1c2goYXVkaXRFbnRyeSk7XG4gICAgXG4gICAgLy8gS2VlcCBvbmx5IGxhc3QgMTAwMCBlbnRyaWVzIGluIG1lbW9yeVxuICAgIGlmICh0aGlzLmF1ZGl0TG9nLmxlbmd0aCA+IDEwMDApIHtcbiAgICAgIHRoaXMuYXVkaXRMb2cgPSB0aGlzLmF1ZGl0TG9nLnNsaWNlKC0xMDAwKTtcbiAgICB9XG4gICAgXG4gICAgY29uc29sZS5sb2coJ1NlbnNpdGl2ZSBwcm9maWxlIGNoYW5nZTonLCBhdWRpdEVudHJ5KTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIHRva2VuIHdpdGhvdXQgcmVxdWlyaW5nIHJlLWF1dGhlbnRpY2F0aW9uXG4gIGFzeW5jIHZhbGlkYXRlVG9rZW5TYWZlbHkodG9rZW4pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQpO1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoZGVjb2RlZC51c2VySWQpLnNlbGVjdCgnLXBhc3N3b3JkJyk7XG4gICAgICBcbiAgICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJlYXNvbjogJ3VzZXJfbm90X2ZvdW5kJyB9O1xuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgdXNlciwgZGVjb2RlZCB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJlYXNvbjogJ2ludmFsaWRfdG9rZW4nLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xuICAgIH1cbiAgfVxuXG4gIC8vIEVuaGFuY2VkIHRva2VuIHJlZnJlc2ggbWVjaGFuaXNtXG4gIGFzeW5jIHJlZnJlc2hUb2tlbklmTmVlZGVkKHRva2VuKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRlY29kZWQgPSBqd3QuZGVjb2RlKHRva2VuKTtcbiAgICAgIGlmICghZGVjb2RlZCkge1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiAnaW52YWxpZF90b2tlbicgfTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgdG9rZW4gZXhwaXJlcyB3aXRoaW4gbmV4dCBob3VyXG4gICAgICBjb25zdCBleHBpcmVzQXQgPSBkZWNvZGVkLmV4cCAqIDEwMDA7XG4gICAgICBjb25zdCBvbmVIb3VyRnJvbU5vdyA9IERhdGUubm93KCkgKyAoNjAgKiA2MCAqIDEwMDApO1xuICAgICAgXG4gICAgICBpZiAoZXhwaXJlc0F0ID4gb25lSG91ckZyb21Ob3cpIHtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgcmVmcmVzaGVkOiBmYWxzZSwgdG9rZW4gfTtcbiAgICAgIH1cblxuICAgICAgLy8gR2VuZXJhdGUgbmV3IHRva2VuXG4gICAgICBjb25zdCBuZXdUb2tlbiA9IGp3dC5zaWduKFxuICAgICAgICB7IHVzZXJJZDogZGVjb2RlZC51c2VySWQgfSxcbiAgICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCxcbiAgICAgICAgeyBleHBpcmVzSW46ICc3ZCcgfVxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgcmVmcmVzaGVkOiB0cnVlLFxuICAgICAgICB0b2tlbjogbmV3VG9rZW4sXG4gICAgICAgIGV4cGlyZXNBdDogbmV3IERhdGUoRGF0ZS5ub3coKSArICg3ICogMjQgKiA2MCAqIDYwICogMTAwMCkpXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246ICdyZWZyZXNoX2ZhaWxlZCcsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XG4gICAgfVxuICB9XG5cbiAgLy8gRW1haWwgbm90aWZpY2F0aW9uIGZvciBzZW5zaXRpdmUgY2hhbmdlc1xuICBhc3luYyBub3RpZnlVc2VyT2ZTZW5zaXRpdmVDaGFuZ2UodXNlcklkLCBjaGFuZ2VUeXBlLCBjb250ZXh0ID0ge30pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKS5sZWFuKCk7XG4gICAgICBpZiAoIXVzZXIgfHwgIXVzZXIucHJlZmVyZW5jZXM/LmVtYWlsUHJlZmVyZW5jZXM/Lm9yZGVyQ29uZmlybWF0aW9ucykge1xuICAgICAgICByZXR1cm47IC8vIFVzZXIgZG9lc24ndCB3YW50IG5vdGlmaWNhdGlvbnNcbiAgICAgIH1cblxuICAgICAgLy8gVGhpcyB3b3VsZCBpbnRlZ3JhdGUgd2l0aCB5b3VyIGVtYWlsIHNlcnZpY2VcbiAgICAgIGNvbnNvbGUubG9nKGBFbWFpbCBub3RpZmljYXRpb24gc2VudCB0byAke3VzZXIuZW1haWx9OiAke2NoYW5nZVR5cGV9IGNoYW5nZWRgKTtcbiAgICAgIFxuICAgICAgLy8gRW1pdCBub3RpZmljYXRpb24gZXZlbnRcbiAgICAgIHRoaXMuZW1pdCgnc2Vuc2l0aXZlQ2hhbmdlTm90aWZpY2F0aW9uJywge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICBjaGFuZ2VUeXBlLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIGNvbnRleHRcbiAgICAgIH0pO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIHNlbnNpdGl2ZSBjaGFuZ2Ugbm90aWZpY2F0aW9uOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyBPcHRpbWlzdGljIHVzZXIgZGF0YSBzeW5jaHJvbml6YXRpb25cbiAgYXN5bmMgc3luY2hyb25pemVVc2VyRGF0YSh1c2VySWQsIGV2ZW50VHlwZSA9ICdtYW51YWwnKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCkubGVhbigpO1xuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gRW1pdCBzeW5jaHJvbml6YXRpb24gZXZlbnQgZm9yIHJlYWwtdGltZSB1cGRhdGVzXG4gICAgICB0aGlzLmVtaXQoJ3VzZXJEYXRhU3luYycsIHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB1c2VyLFxuICAgICAgICBldmVudFR5cGUsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVzZXIgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignVXNlciBkYXRhIHN5bmNocm9uaXphdGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfTtcbiAgICB9XG4gIH1cblxuICAvLyBHZXQgYXVkaXQgbG9nIGZvciB1c2VyIChmb3IgYWRtaW4gb3IgZGVidWdnaW5nKVxuICBnZXRVc2VyQXVkaXRMb2codXNlcklkLCBsaW1pdCA9IDUwKSB7XG4gICAgcmV0dXJuIHRoaXMuYXVkaXRMb2dcbiAgICAgIC5maWx0ZXIoZW50cnkgPT4gZW50cnkudXNlcklkLnRvU3RyaW5nKCkgPT09IHVzZXJJZC50b1N0cmluZygpKVxuICAgICAgLnNsaWNlKC1saW1pdClcbiAgICAgIC5yZXZlcnNlKCk7XG4gIH1cblxuICAvLyBDbGVhbiB1cCByYXRlIGxpbWl0IHN0b3JlIHBlcmlvZGljYWxseVxuICBjbGVhbnVwUmF0ZUxpbWl0U3RvcmUoKSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB3aW5kb3dNcyA9IDYwICogMTAwMDsgLy8gMSBtaW51dGVcblxuICAgIGZvciAoY29uc3QgW3VzZXJJZCwgcmVxdWVzdHNdIG9mIHRoaXMucmF0ZUxpbWl0U3RvcmUuZW50cmllcygpKSB7XG4gICAgICBjb25zdCB2YWxpZFJlcXVlc3RzID0gcmVxdWVzdHMuZmlsdGVyKHRpbWVzdGFtcCA9PiBub3cgLSB0aW1lc3RhbXAgPCB3aW5kb3dNcyk7XG4gICAgICBcbiAgICAgIGlmICh2YWxpZFJlcXVlc3RzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnJhdGVMaW1pdFN0b3JlLmRlbGV0ZSh1c2VySWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yYXRlTGltaXRTdG9yZS5zZXQodXNlcklkLCB2YWxpZFJlcXVlc3RzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBDb25uZWN0aW9uIHBvb2xpbmcgYXdhcmVuZXNzXG4gIGFzeW5jIHdpdGhDb25uZWN0aW9uT3B0aW1pemF0aW9uKG9wZXJhdGlvbikge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9wZXJhdGlvbigpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgXG4gICAgICBpZiAoZHVyYXRpb24gPiAxMDApIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBEYXRhYmFzZSBvcGVyYXRpb24gdG9vayAke2R1cmF0aW9ufW1zIC0gY29uc2lkZXIgY29ubmVjdGlvbiBwb29saW5nIG9wdGltaXphdGlvbmApO1xuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdEYXRhYmFzZSBvcGVyYXRpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuXG4vLyBDbGVhbnVwIHJhdGUgbGltaXQgc3RvcmUgZXZlcnkgNSBtaW51dGVzXG5jb25zdCBhdXRoU2VydmljZSA9IG5ldyBBdXRoU2VydmljZSgpO1xuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICBhdXRoU2VydmljZS5jbGVhbnVwUmF0ZUxpbWl0U3RvcmUoKTtcbn0sIDUgKiA2MCAqIDEwMDApO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGF1dGhTZXJ2aWNlOyJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7QUFDdEMsTUFBTUMsR0FBRyxHQUFHRCxPQUFPLENBQUMsY0FBYyxDQUFDO0FBQ25DLE1BQU1FLFlBQVksR0FBR0YsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUV0QyxNQUFNRyxXQUFXLFNBQVNELFlBQVksQ0FBQztF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