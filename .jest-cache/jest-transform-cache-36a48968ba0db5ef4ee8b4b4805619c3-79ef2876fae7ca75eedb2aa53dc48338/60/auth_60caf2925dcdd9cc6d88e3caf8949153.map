{"version":3,"names":["jwt","require","User","authenticateToken","req","res","next","cookieToken","cookies","token","authHeader","headers","headerToken","split","user","decoded","verify","process","env","JWT_SECRET","findById","userId","select","isActive","error","console","message","requireAuth","status","json","success","code","name","requireAdmin","isAdmin","module","exports"],"sources":["auth.js"],"sourcesContent":["const jwt = require('jsonwebtoken');\nconst User = require('../models/User');\n\n// Middleware to authenticate JWT tokens\nconst authenticateToken = async (req, res, next) => {\n  try {\n    // Check for token in cookie first (more secure), then fall back to header\n    const cookieToken = req.cookies?.token;\n    const authHeader = req.headers['authorization'];\n    const headerToken = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN\n    \n    // Prefer cookie token over header token for security\n    const token = cookieToken || headerToken;\n    \n    if (!token) {\n      req.user = null;\n      return next(); // Continue without authentication for optional auth routes\n    }\n    \n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    const user = await User.findById(decoded.userId).select('-password');\n    \n    if (!user || !user.isActive) {\n      req.user = null;\n      return next();\n    }\n    \n    req.user = user;\n    next();\n  } catch (error) {\n    // Log the error for debugging but don't expose details to client\n    console.error('JWT verification error:', error.message);\n    req.user = null;\n    next(); // Continue without authentication for optional auth routes\n  }\n};\n\n// Middleware to require authentication\nconst requireAuth = async (req, res, next) => {\n  try {\n    // Check for token in cookie first (more secure), then fall back to header\n    const cookieToken = req.cookies?.token;\n    const authHeader = req.headers['authorization'];\n    const headerToken = authHeader && authHeader.split(' ')[1];\n    \n    // Prefer cookie token over header token for security\n    const token = cookieToken || headerToken;\n    \n    if (!token) {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'NO_TOKEN',\n          message: 'Access token is required'\n        }\n      });\n    }\n    \n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    const user = await User.findById(decoded.userId).select('-password');\n    \n    if (!user || !user.isActive) {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'INVALID_TOKEN',\n          message: 'Invalid or expired token'\n        }\n      });\n    }\n    \n    req.user = user;\n    next();\n  } catch (error) {\n    if (error.name === 'JsonWebTokenError') {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'INVALID_TOKEN',\n          message: 'Invalid token format'\n        }\n      });\n    }\n    \n    if (error.name === 'TokenExpiredError') {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'TOKEN_EXPIRED',\n          message: 'Token has expired'\n        }\n      });\n    }\n    \n    console.error('Authentication error:', error);\n    res.status(500).json({\n      success: false,\n      error: {\n        code: 'AUTH_ERROR',\n        message: 'Authentication failed'\n      }\n    });\n  }\n};\n\n// Middleware to require admin role\nconst requireAdmin = async (req, res, next) => {\n  try {\n    const authHeader = req.headers['authorization'];\n    const token = authHeader && authHeader.split(' ')[1];\n    \n    if (!token) {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'NO_TOKEN',\n          message: 'Access token is required'\n        }\n      });\n    }\n    \n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    const user = await User.findById(decoded.userId).select('-password');\n    \n    if (!user || !user.isActive) {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'INVALID_TOKEN',\n          message: 'Invalid or expired token'\n        }\n      });\n    }\n    \n    // Check if user has admin role\n    if (!user.isAdmin) {\n      return res.status(403).json({\n        success: false,\n        error: {\n          code: 'INSUFFICIENT_PERMISSIONS',\n          message: 'Admin access required'\n        }\n      });\n    }\n    \n    req.user = user;\n    next();\n  } catch (error) {\n    if (error.name === 'JsonWebTokenError') {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'INVALID_TOKEN',\n          message: 'Invalid token format'\n        }\n      });\n    }\n    \n    if (error.name === 'TokenExpiredError') {\n      return res.status(401).json({\n        success: false,\n        error: {\n          code: 'TOKEN_EXPIRED',\n          message: 'Token has expired'\n        }\n      });\n    }\n    \n    console.error('Admin auth error:', error);\n    res.status(500).json({\n      success: false,\n      error: {\n        code: 'AUTH_ERROR',\n        message: 'Authorization failed'\n      }\n    });\n  }\n};\n\nmodule.exports = {\n  authenticateToken,\n  requireAuth,\n  requireAdmin\n};"],"mappings":"AAAA,MAAMA,GAAG,GAAGC,OAAO,CAAC,cAAc,CAAC;AACnC,MAAMC,IAAI,GAAGD,OAAO,CAAC,gBAAgB,CAAC;;AAEtC;AACA,MAAME,iBAAiB,GAAG,MAAAA,CAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;EAClD,IAAI;IACF;IACA,MAAMC,WAAW,GAAGH,GAAG,CAACI,OAAO,EAAEC,KAAK;IACtC,MAAMC,UAAU,GAAGN,GAAG,CAACO,OAAO,CAAC,eAAe,CAAC;IAC/C,MAAMC,WAAW,GAAGF,UAAU,IAAIA,UAAU,CAACG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;;IAE5D;IACA,MAAMJ,KAAK,GAAGF,WAAW,IAAIK,WAAW;IAExC,IAAI,CAACH,KAAK,EAAE;MACVL,GAAG,CAACU,IAAI,GAAG,IAAI;MACf,OAAOR,IAAI,CAAC,CAAC,CAAC,CAAC;IACjB;IAEA,MAAMS,OAAO,GAAGf,GAAG,CAACgB,MAAM,CAACP,KAAK,EAAEQ,OAAO,CAACC,GAAG,CAACC,UAAU,CAAC;IACzD,MAAML,IAAI,GAAG,MAAMZ,IAAI,CAACkB,QAAQ,CAACL,OAAO,CAACM,MAAM,CAAC,CAACC,MAAM,CAAC,WAAW,CAAC;IAEpE,IAAI,CAACR,IAAI,IAAI,CAACA,IAAI,CAACS,QAAQ,EAAE;MAC3BnB,GAAG,CAACU,IAAI,GAAG,IAAI;MACf,OAAOR,IAAI,CAAC,CAAC;IACf;IAEAF,GAAG,CAACU,IAAI,GAAGA,IAAI;IACfR,IAAI,CAAC,CAAC;EACR,CAAC,CAAC,OAAOkB,KAAK,EAAE;IACd;IACAC,OAAO,CAACD,KAAK,CAAC,yBAAyB,EAAEA,KAAK,CAACE,OAAO,CAAC;IACvDtB,GAAG,CAACU,IAAI,GAAG,IAAI;IACfR,IAAI,CAAC,CAAC,CAAC,CAAC;EACV;AACF,CAAC;;AAED;AACA,MAAMqB,WAAW,GAAG,MAAAA,CAAOvB,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;EAC5C,IAAI;IACF;IACA,MAAMC,WAAW,GAAGH,GAAG,CAACI,OAAO,EAAEC,KAAK;IACtC,MAAMC,UAAU,GAAGN,GAAG,CAACO,OAAO,CAAC,eAAe,CAAC;IAC/C,MAAMC,WAAW,GAAGF,UAAU,IAAIA,UAAU,CAACG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;;IAE1D;IACA,MAAMJ,KAAK,GAAGF,WAAW,IAAIK,WAAW;IAExC,IAAI,CAACH,KAAK,EAAE;MACV,OAAOJ,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,UAAU;UAChBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEA,MAAMX,OAAO,GAAGf,GAAG,CAACgB,MAAM,CAACP,KAAK,EAAEQ,OAAO,CAACC,GAAG,CAACC,UAAU,CAAC;IACzD,MAAML,IAAI,GAAG,MAAMZ,IAAI,CAACkB,QAAQ,CAACL,OAAO,CAACM,MAAM,CAAC,CAACC,MAAM,CAAC,WAAW,CAAC;IAEpE,IAAI,CAACR,IAAI,IAAI,CAACA,IAAI,CAACS,QAAQ,EAAE;MAC3B,OAAOlB,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,eAAe;UACrBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEAtB,GAAG,CAACU,IAAI,GAAGA,IAAI;IACfR,IAAI,CAAC,CAAC;EACR,CAAC,CAAC,OAAOkB,KAAK,EAAE;IACd,IAAIA,KAAK,CAACQ,IAAI,KAAK,mBAAmB,EAAE;MACtC,OAAO3B,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,eAAe;UACrBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEA,IAAIF,KAAK,CAACQ,IAAI,KAAK,mBAAmB,EAAE;MACtC,OAAO3B,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,eAAe;UACrBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEAD,OAAO,CAACD,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;IAC7CnB,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdN,KAAK,EAAE;QACLO,IAAI,EAAE,YAAY;QAClBL,OAAO,EAAE;MACX;IACF,CAAC,CAAC;EACJ;AACF,CAAC;;AAED;AACA,MAAMO,YAAY,GAAG,MAAAA,CAAO7B,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;EAC7C,IAAI;IACF,MAAMI,UAAU,GAAGN,GAAG,CAACO,OAAO,CAAC,eAAe,CAAC;IAC/C,MAAMF,KAAK,GAAGC,UAAU,IAAIA,UAAU,CAACG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;IAEpD,IAAI,CAACJ,KAAK,EAAE;MACV,OAAOJ,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,UAAU;UAChBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEA,MAAMX,OAAO,GAAGf,GAAG,CAACgB,MAAM,CAACP,KAAK,EAAEQ,OAAO,CAACC,GAAG,CAACC,UAAU,CAAC;IACzD,MAAML,IAAI,GAAG,MAAMZ,IAAI,CAACkB,QAAQ,CAACL,OAAO,CAACM,MAAM,CAAC,CAACC,MAAM,CAAC,WAAW,CAAC;IAEpE,IAAI,CAACR,IAAI,IAAI,CAACA,IAAI,CAACS,QAAQ,EAAE;MAC3B,OAAOlB,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,eAAe;UACrBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;;IAEA;IACA,IAAI,CAACZ,IAAI,CAACoB,OAAO,EAAE;MACjB,OAAO7B,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,0BAA0B;UAChCL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEAtB,GAAG,CAACU,IAAI,GAAGA,IAAI;IACfR,IAAI,CAAC,CAAC;EACR,CAAC,CAAC,OAAOkB,KAAK,EAAE;IACd,IAAIA,KAAK,CAACQ,IAAI,KAAK,mBAAmB,EAAE;MACtC,OAAO3B,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,eAAe;UACrBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEA,IAAIF,KAAK,CAACQ,IAAI,KAAK,mBAAmB,EAAE;MACtC,OAAO3B,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QAC1BC,OAAO,EAAE,KAAK;QACdN,KAAK,EAAE;UACLO,IAAI,EAAE,eAAe;UACrBL,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;IAEAD,OAAO,CAACD,KAAK,CAAC,mBAAmB,EAAEA,KAAK,CAAC;IACzCnB,GAAG,CAACuB,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdN,KAAK,EAAE;QACLO,IAAI,EAAE,YAAY;QAClBL,OAAO,EAAE;MACX;IACF,CAAC,CAAC;EACJ;AACF,CAAC;AAEDS,MAAM,CAACC,OAAO,GAAG;EACfjC,iBAAiB;EACjBwB,WAAW;EACXM;AACF,CAAC","ignoreList":[]}