{"version":3,"names":["mongoose","require","orderSchema","Schema","orderNumber","type","String","unique","customer","Types","ObjectId","ref","required","guestInfo","email","lowercase","trim","firstName","lastName","phone","items","product","quantity","Number","min","price","wholesaler","name","productCode","notified","Boolean","default","notifiedAt","Date","notificationAttempts","lastNotificationError","shippingAddress","street","city","state","zipCode","country","billingAddress","subtotal","tax","shipping","total","payment","method","enum","status","molliePaymentId","transactionId","paidAt","trackingNumber","notes","referralSource","currency","exchangeRate","timestamps","index","createdAt","pre","next","now","Math","random","toString","substr","toUpperCase","methods","getCustomerEmail","populated","getCustomerName","allWholesalersNotified","every","item","getPendingNotifications","filter","updateWholesalerNotification","itemId","success","error","id","save","statics","findPendingNotifications","find","toPublicJSON","order","toObject","map","publicItem","module","exports","model"],"sources":["Order.js"],"sourcesContent":["const mongoose = require('mongoose');\n\nconst orderSchema = new mongoose.Schema({\n  orderNumber: {\n    type: String,\n    unique: true\n  },\n  customer: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: false // Allow guest checkout\n  },\n  guestInfo: {\n    email: {\n      type: String,\n      required: function() { return !this.customer; },\n      lowercase: true,\n      trim: true\n    },\n    firstName: {\n      type: String,\n      required: function() { return !this.customer; },\n      trim: true\n    },\n    lastName: {\n      type: String,\n      required: function() { return !this.customer; },\n      trim: true\n    },\n    phone: {\n      type: String,\n      trim: true\n    }\n  },\n  items: [{\n    product: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'Product',\n      required: true\n    },\n    quantity: {\n      type: Number,\n      required: true,\n      min: 1\n    },\n    price: {\n      type: Number,\n      required: true\n    },\n    wholesaler: {\n      name: String,\n      email: String,\n      productCode: String,\n      notified: { type: Boolean, default: false },\n      notifiedAt: Date,\n      notificationAttempts: { type: Number, default: 0 },\n      lastNotificationError: String\n    }\n  }],\n  shippingAddress: {\n    firstName: { type: String, required: true },\n    lastName: { type: String, required: true },\n    street: { type: String, required: true },\n    city: { type: String, required: true },\n    state: { type: String, required: true },\n    zipCode: { type: String, required: true },\n    country: { type: String, required: true, default: 'US' },\n    phone: String\n  },\n  billingAddress: {\n    firstName: { type: String, required: true },\n    lastName: { type: String, required: true },\n    street: { type: String, required: true },\n    city: { type: String, required: true },\n    state: { type: String, required: true },\n    zipCode: { type: String, required: true },\n    country: { type: String, required: true, default: 'US' }\n  },\n  subtotal: {\n    type: Number,\n    required: true\n  },\n  tax: {\n    type: Number,\n    default: 0\n  },\n  shipping: {\n    type: Number,\n    default: 0\n  },\n  total: {\n    type: Number,\n    required: true\n  },\n  payment: {\n    method: {\n      type: String,\n      enum: ['card', 'crypto', 'other'],\n      required: true\n    },\n    status: {\n      type: String,\n      enum: ['pending', 'paid', 'failed', 'refunded'],\n      default: 'pending'\n    },\n    molliePaymentId: String,\n    transactionId: String,\n    paidAt: Date\n  },\n  status: {\n    type: String,\n    enum: ['pending', 'processing', 'shipped', 'delivered', 'cancelled'],\n    default: 'pending'\n  },\n  trackingNumber: String,\n  notes: String,\n  referralSource: String, // Track which sister site referred this order\n  // Multi-currency support\n  currency: {\n    type: String,\n    required: true,\n    default: 'USD',\n    enum: ['USD', 'EUR', 'CNY', 'JPY', 'SAR', 'GBP', 'CAD']\n  },\n  exchangeRate: {\n    type: Number,\n    required: true,\n    default: 1\n  }\n}, {\n  timestamps: true\n});\n\n// Indexes for performance\norderSchema.index({ orderNumber: 1 });\norderSchema.index({ customer: 1, createdAt: -1 });\norderSchema.index({ 'guestInfo.email': 1 });\norderSchema.index({ status: 1 });\norderSchema.index({ 'payment.status': 1 });\norderSchema.index({ referralSource: 1 });\norderSchema.index({ createdAt: -1 });\norderSchema.index({ 'items.wholesaler.notified': 1 });\n\n// Pre-save middleware\norderSchema.pre('save', function(next) {\n  if (!this.orderNumber) {\n    this.orderNumber = 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();\n  }\n  next();\n});\n\n// Method to get customer email (works for both guest and registered users)\norderSchema.methods.getCustomerEmail = function() {\n  if (this.customer && this.populated('customer')) {\n    return this.customer.email;\n  }\n  return this.guestInfo.email;\n};\n\n// Method to get customer name\norderSchema.methods.getCustomerName = function() {\n  if (this.customer && this.populated('customer')) {\n    return `${this.customer.firstName} ${this.customer.lastName}`;\n  }\n  return `${this.guestInfo.firstName} ${this.guestInfo.lastName}`;\n};\n\n// Method to check if all wholesalers have been notified\norderSchema.methods.allWholesalersNotified = function() {\n  return this.items.every(item => item.wholesaler.notified);\n};\n\n// Method to get pending wholesaler notifications\norderSchema.methods.getPendingNotifications = function() {\n  return this.items.filter(item => !item.wholesaler.notified);\n};\n\n// Method to update wholesaler notification status\norderSchema.methods.updateWholesalerNotification = function(itemId, success, error = null) {\n  const item = this.items.id(itemId);\n  if (item) {\n    item.wholesaler.notificationAttempts += 1;\n    if (success) {\n      item.wholesaler.notified = true;\n      item.wholesaler.notifiedAt = new Date();\n      item.wholesaler.lastNotificationError = null;\n    } else {\n      item.wholesaler.lastNotificationError = error;\n    }\n  }\n  return this.save();\n};\n\n// Static method to find orders needing wholesaler notification\norderSchema.statics.findPendingNotifications = function() {\n  return this.find({\n    'payment.status': 'paid',\n    'items.wholesaler.notified': false\n  });\n};\n\n// Method to get public order data (excludes sensitive wholesaler info)\norderSchema.methods.toPublicJSON = function() {\n  const order = this.toObject();\n  \n  // Remove sensitive wholesaler information from items\n  if (order.items) {\n    order.items = order.items.map(item => {\n      const publicItem = { ...item };\n      if (publicItem.wholesaler) {\n        // Keep only notification status, remove sensitive details\n        publicItem.wholesaler = {\n          notified: item.wholesaler.notified,\n          notifiedAt: item.wholesaler.notifiedAt\n        };\n      }\n      return publicItem;\n    });\n  }\n  \n  return order;\n};\n\n// Hook trigger comment - wholesaler notification check\n// Referral tracking hook test\n\nmodule.exports = mongoose.model('Order', orderSchema);"],"mappings":"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","ignoreList":[]}