c8d6f4e479b2192b8303a0a5667747bf
const User = require('../models/User');
const jwt = require('jsonwebtoken');
const EventEmitter = require('events');
class AuthService extends EventEmitter {
  constructor() {
    super();
    this.auditLog = [];
    this.rateLimitStore = new Map(); // Simple in-memory rate limiting
  }

  // Rate limiting for profile updates (max 10 per minute)
  checkRateLimit(userId) {
    const now = Date.now();
    const windowMs = 60 * 1000; // 1 minute
    const maxRequests = 10;
    const userRequests = this.rateLimitStore.get(userId) || [];

    // Remove old requests outside the window
    const validRequests = userRequests.filter(timestamp => now - timestamp < windowMs);
    if (validRequests.length >= maxRequests) {
      return {
        allowed: false,
        retryAfter: Math.ceil((validRequests[0] + windowMs - now) / 1000)
      };
    }

    // Add current request
    validRequests.push(now);
    this.rateLimitStore.set(userId, validRequests);
    return {
      allowed: true
    };
  }

  // Optimistic profile update with performance monitoring
  async updateProfileOptimistically(userId, updateData, auditContext = {}) {
    const startTime = Date.now();
    try {
      // Rate limiting check
      const rateCheck = this.checkRateLimit(userId);
      if (!rateCheck.allowed) {
        throw new Error(`Rate limit exceeded. Try again in ${rateCheck.retryAfter} seconds.`);
      }

      // Get current user for rollback if needed
      const currentUser = await User.findById(userId).lean();
      if (!currentUser) {
        throw new Error('User not found');
      }

      // Validate email uniqueness if email is being changed
      if (updateData.email && updateData.email !== currentUser.email) {
        const existingUser = await User.findOne({
          email: updateData.email,
          _id: {
            $ne: userId
          }
        }).lean();
        if (existingUser) {
          throw new Error('Email already in use');
        }
      }

      // Perform optimistic update
      const updatedUser = await User.findByIdAndUpdate(userId, {
        ...updateData,
        updatedAt: new Date()
      }, {
        new: true,
        runValidators: true,
        lean: true
      });
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Audit logging for sensitive changes
      if (updateData.email || updateData.phone) {
        this.logSensitiveChange(userId, updateData, auditContext);
      }

      // Emit profile update event
      this.emit('profileUpdated', {
        userId,
        changes: updateData,
        timestamp: new Date(),
        performance: {
          duration
        }
      });

      // Performance monitoring (target: 200ms)
      if (duration > 200) {
        console.warn(`Profile update took ${duration}ms - exceeds 200ms target`);
      }
      return {
        user: updatedUser,
        duration,
        performance: duration <= 200 ? 'good' : 'needs_optimization',
        success: true
      };
    } catch (error) {
      const endTime = Date.now();
      const duration = endTime - startTime;
      console.error('Profile update error:', error);
      return {
        success: false,
        error: error.message,
        duration
      };
    }
  }

  // Enhanced address management without authentication loss
  async manageAddressOptimistically(userId, operation, addressData = {}, addressId = null) {
    const startTime = Date.now();
    try {
      const user = await User.findById(userId);
      if (!user) {
        throw new Error('User not found');
      }
      let result;
      switch (operation) {
        case 'add':
          result = await user.addAddress(addressData);
          break;
        case 'update':
          result = await user.updateAddress(addressId, addressData);
          break;
        case 'delete':
          result = await user.removeAddress(addressId);
          break;
        case 'setDefault':
          result = await user.setDefaultAddress(addressId);
          break;
        default:
          throw new Error(`Unknown address operation: ${operation}`);
      }
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Emit address update event
      this.emit('addressUpdated', {
        userId,
        operation,
        addressId,
        timestamp: new Date(),
        performance: {
          duration
        }
      });
      return {
        user: result,
        duration,
        performance: duration <= 200 ? 'good' : 'needs_optimization',
        success: true
      };
    } catch (error) {
      console.error('Address management error:', error);
      return {
        success: false,
        error: error.message,
        duration: Date.now() - startTime
      };
    }
  }

  // Audit logging for sensitive operations
  logSensitiveChange(userId, changes, context) {
    const auditEntry = {
      userId,
      timestamp: new Date(),
      changes: Object.keys(changes).filter(key => ['email', 'phone'].includes(key)),
      ip: context.ip,
      userAgent: context.userAgent,
      sessionId: context.sessionId
    };
    this.auditLog.push(auditEntry);

    // Keep only last 1000 entries in memory
    if (this.auditLog.length > 1000) {
      this.auditLog = this.auditLog.slice(-1000);
    }
    console.log('Sensitive profile change:', auditEntry);
  }

  // Validate token without requiring re-authentication
  async validateTokenSafely(token) {
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      const user = await User.findById(decoded.userId).lean();
      if (!user || !user.isActive) {
        return {
          valid: false,
          reason: 'user_not_found'
        };
      }
      return {
        valid: true,
        user,
        decoded
      };
    } catch (error) {
      return {
        valid: false,
        reason: 'invalid_token',
        error: error.message
      };
    }
  }

  // Enhanced token refresh mechanism
  async refreshTokenIfNeeded(token) {
    try {
      const decoded = jwt.decode(token);
      if (!decoded) {
        return {
          success: false,
          reason: 'invalid_token'
        };
      }

      // Check if token expires within next hour
      const expiresAt = decoded.exp * 1000;
      const oneHourFromNow = Date.now() + 60 * 60 * 1000;
      if (expiresAt > oneHourFromNow) {
        return {
          success: true,
          refreshed: false,
          token
        };
      }

      // Generate new token
      const newToken = jwt.sign({
        userId: decoded.userId
      }, process.env.JWT_SECRET, {
        expiresIn: '7d'
      });
      return {
        success: true,
        refreshed: true,
        token: newToken,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
      };
    } catch (error) {
      return {
        success: false,
        reason: 'refresh_failed',
        error: error.message
      };
    }
  }

  // Email notification for sensitive changes
  async notifyUserOfSensitiveChange(userId, changeType, context = {}) {
    try {
      const user = await User.findById(userId).lean();
      if (!user || !user.preferences?.emailPreferences?.orderConfirmations) {
        return; // User doesn't want notifications
      }

      // This would integrate with your email service
      console.log(`Email notification sent to ${user.email}: ${changeType} changed`);

      // Emit notification event
      this.emit('sensitiveChangeNotification', {
        userId,
        email: user.email,
        changeType,
        timestamp: new Date(),
        context
      });
    } catch (error) {
      console.error('Failed to send sensitive change notification:', error);
    }
  }

  // Optimistic user data synchronization
  async synchronizeUserData(userId, eventType = 'manual') {
    try {
      const user = await User.findById(userId).lean();
      if (!user) {
        throw new Error('User not found');
      }

      // Emit synchronization event for real-time updates
      this.emit('userDataSync', {
        userId,
        user,
        eventType,
        timestamp: new Date()
      });
      return {
        success: true,
        user
      };
    } catch (error) {
      console.error('User data synchronization error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // Get audit log for user (for admin or debugging)
  getUserAuditLog(userId, limit = 50) {
    return this.auditLog.filter(entry => entry.userId.toString() === userId.toString()).slice(-limit).reverse();
  }

  // Clean up rate limit store periodically
  cleanupRateLimitStore() {
    const now = Date.now();
    const windowMs = 60 * 1000; // 1 minute

    for (const [userId, requests] of this.rateLimitStore.entries()) {
      const validRequests = requests.filter(timestamp => now - timestamp < windowMs);
      if (validRequests.length === 0) {
        this.rateLimitStore.delete(userId);
      } else {
        this.rateLimitStore.set(userId, validRequests);
      }
    }
  }

  // Connection pooling awareness
  async withConnectionOptimization(operation) {
    const startTime = Date.now();
    try {
      const result = await operation();
      const duration = Date.now() - startTime;
      if (duration > 100) {
        console.warn(`Database operation took ${duration}ms - consider connection pooling optimization`);
      }
      return result;
    } catch (error) {
      console.error('Database operation failed:', error);
      throw error;
    }
  }
}

// Cleanup rate limit store every 5 minutes
const authService = new AuthService();
setInterval(() => {
  authService.cleanupRateLimitStore();
}, 5 * 60 * 1000);
module.exports = authService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVc2VyIiwicmVxdWlyZSIsImp3dCIsIkV2ZW50RW1pdHRlciIsIkF1dGhTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJhdWRpdExvZyIsInJhdGVMaW1pdFN0b3JlIiwiTWFwIiwiY2hlY2tSYXRlTGltaXQiLCJ1c2VySWQiLCJub3ciLCJEYXRlIiwid2luZG93TXMiLCJtYXhSZXF1ZXN0cyIsInVzZXJSZXF1ZXN0cyIsImdldCIsInZhbGlkUmVxdWVzdHMiLCJmaWx0ZXIiLCJ0aW1lc3RhbXAiLCJsZW5ndGgiLCJhbGxvd2VkIiwicmV0cnlBZnRlciIsIk1hdGgiLCJjZWlsIiwicHVzaCIsInNldCIsInVwZGF0ZVByb2ZpbGVPcHRpbWlzdGljYWxseSIsInVwZGF0ZURhdGEiLCJhdWRpdENvbnRleHQiLCJzdGFydFRpbWUiLCJyYXRlQ2hlY2siLCJFcnJvciIsImN1cnJlbnRVc2VyIiwiZmluZEJ5SWQiLCJsZWFuIiwiZW1haWwiLCJleGlzdGluZ1VzZXIiLCJmaW5kT25lIiwiX2lkIiwiJG5lIiwidXBkYXRlZFVzZXIiLCJmaW5kQnlJZEFuZFVwZGF0ZSIsInVwZGF0ZWRBdCIsIm5ldyIsInJ1blZhbGlkYXRvcnMiLCJlbmRUaW1lIiwiZHVyYXRpb24iLCJwaG9uZSIsImxvZ1NlbnNpdGl2ZUNoYW5nZSIsImVtaXQiLCJjaGFuZ2VzIiwicGVyZm9ybWFuY2UiLCJjb25zb2xlIiwid2FybiIsInVzZXIiLCJzdWNjZXNzIiwiZXJyb3IiLCJtZXNzYWdlIiwibWFuYWdlQWRkcmVzc09wdGltaXN0aWNhbGx5Iiwib3BlcmF0aW9uIiwiYWRkcmVzc0RhdGEiLCJhZGRyZXNzSWQiLCJyZXN1bHQiLCJhZGRBZGRyZXNzIiwidXBkYXRlQWRkcmVzcyIsInJlbW92ZUFkZHJlc3MiLCJzZXREZWZhdWx0QWRkcmVzcyIsImNvbnRleHQiLCJhdWRpdEVudHJ5IiwiT2JqZWN0Iiwia2V5cyIsImtleSIsImluY2x1ZGVzIiwiaXAiLCJ1c2VyQWdlbnQiLCJzZXNzaW9uSWQiLCJzbGljZSIsImxvZyIsInZhbGlkYXRlVG9rZW5TYWZlbHkiLCJ0b2tlbiIsImRlY29kZWQiLCJ2ZXJpZnkiLCJwcm9jZXNzIiwiZW52IiwiSldUX1NFQ1JFVCIsImlzQWN0aXZlIiwidmFsaWQiLCJyZWFzb24iLCJyZWZyZXNoVG9rZW5JZk5lZWRlZCIsImRlY29kZSIsImV4cGlyZXNBdCIsImV4cCIsIm9uZUhvdXJGcm9tTm93IiwicmVmcmVzaGVkIiwibmV3VG9rZW4iLCJzaWduIiwiZXhwaXJlc0luIiwibm90aWZ5VXNlck9mU2Vuc2l0aXZlQ2hhbmdlIiwiY2hhbmdlVHlwZSIsInByZWZlcmVuY2VzIiwiZW1haWxQcmVmZXJlbmNlcyIsIm9yZGVyQ29uZmlybWF0aW9ucyIsInN5bmNocm9uaXplVXNlckRhdGEiLCJldmVudFR5cGUiLCJnZXRVc2VyQXVkaXRMb2ciLCJsaW1pdCIsImVudHJ5IiwidG9TdHJpbmciLCJyZXZlcnNlIiwiY2xlYW51cFJhdGVMaW1pdFN0b3JlIiwicmVxdWVzdHMiLCJlbnRyaWVzIiwiZGVsZXRlIiwid2l0aENvbm5lY3Rpb25PcHRpbWl6YXRpb24iLCJhdXRoU2VydmljZSIsInNldEludGVydmFsIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImF1dGhTZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFVzZXIgPSByZXF1aXJlKCcuLi9tb2RlbHMvVXNlcicpO1xuY29uc3Qgand0ID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcblxuY2xhc3MgQXV0aFNlcnZpY2UgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXVkaXRMb2cgPSBbXTtcbiAgICB0aGlzLnJhdGVMaW1pdFN0b3JlID0gbmV3IE1hcCgpOyAvLyBTaW1wbGUgaW4tbWVtb3J5IHJhdGUgbGltaXRpbmdcbiAgfVxuXG4gIC8vIFJhdGUgbGltaXRpbmcgZm9yIHByb2ZpbGUgdXBkYXRlcyAobWF4IDEwIHBlciBtaW51dGUpXG4gIGNoZWNrUmF0ZUxpbWl0KHVzZXJJZCkge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3Qgd2luZG93TXMgPSA2MCAqIDEwMDA7IC8vIDEgbWludXRlXG4gICAgY29uc3QgbWF4UmVxdWVzdHMgPSAxMDtcblxuICAgIGNvbnN0IHVzZXJSZXF1ZXN0cyA9IHRoaXMucmF0ZUxpbWl0U3RvcmUuZ2V0KHVzZXJJZCkgfHwgW107XG4gICAgXG4gICAgLy8gUmVtb3ZlIG9sZCByZXF1ZXN0cyBvdXRzaWRlIHRoZSB3aW5kb3dcbiAgICBjb25zdCB2YWxpZFJlcXVlc3RzID0gdXNlclJlcXVlc3RzLmZpbHRlcih0aW1lc3RhbXAgPT4gbm93IC0gdGltZXN0YW1wIDwgd2luZG93TXMpO1xuICAgIFxuICAgIGlmICh2YWxpZFJlcXVlc3RzLmxlbmd0aCA+PSBtYXhSZXF1ZXN0cykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWxsb3dlZDogZmFsc2UsXG4gICAgICAgIHJldHJ5QWZ0ZXI6IE1hdGguY2VpbCgodmFsaWRSZXF1ZXN0c1swXSArIHdpbmRvd01zIC0gbm93KSAvIDEwMDApXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEFkZCBjdXJyZW50IHJlcXVlc3RcbiAgICB2YWxpZFJlcXVlc3RzLnB1c2gobm93KTtcbiAgICB0aGlzLnJhdGVMaW1pdFN0b3JlLnNldCh1c2VySWQsIHZhbGlkUmVxdWVzdHMpO1xuXG4gICAgcmV0dXJuIHsgYWxsb3dlZDogdHJ1ZSB9O1xuICB9XG5cbiAgLy8gT3B0aW1pc3RpYyBwcm9maWxlIHVwZGF0ZSB3aXRoIHBlcmZvcm1hbmNlIG1vbml0b3JpbmdcbiAgYXN5bmMgdXBkYXRlUHJvZmlsZU9wdGltaXN0aWNhbGx5KHVzZXJJZCwgdXBkYXRlRGF0YSwgYXVkaXRDb250ZXh0ID0ge30pIHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyBSYXRlIGxpbWl0aW5nIGNoZWNrXG4gICAgICBjb25zdCByYXRlQ2hlY2sgPSB0aGlzLmNoZWNrUmF0ZUxpbWl0KHVzZXJJZCk7XG4gICAgICBpZiAoIXJhdGVDaGVjay5hbGxvd2VkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUmF0ZSBsaW1pdCBleGNlZWRlZC4gVHJ5IGFnYWluIGluICR7cmF0ZUNoZWNrLnJldHJ5QWZ0ZXJ9IHNlY29uZHMuYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBjdXJyZW50IHVzZXIgZm9yIHJvbGxiYWNrIGlmIG5lZWRlZFxuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCkubGVhbigpO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIGVtYWlsIHVuaXF1ZW5lc3MgaWYgZW1haWwgaXMgYmVpbmcgY2hhbmdlZFxuICAgICAgaWYgKHVwZGF0ZURhdGEuZW1haWwgJiYgdXBkYXRlRGF0YS5lbWFpbCAhPT0gY3VycmVudFVzZXIuZW1haWwpIHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgVXNlci5maW5kT25lKHsgXG4gICAgICAgICAgZW1haWw6IHVwZGF0ZURhdGEuZW1haWwsXG4gICAgICAgICAgX2lkOiB7ICRuZTogdXNlcklkIH1cbiAgICAgICAgfSkubGVhbigpO1xuICAgICAgICBcbiAgICAgICAgaWYgKGV4aXN0aW5nVXNlcikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRW1haWwgYWxyZWFkeSBpbiB1c2UnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBQZXJmb3JtIG9wdGltaXN0aWMgdXBkYXRlXG4gICAgICBjb25zdCB1cGRhdGVkVXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWRBbmRVcGRhdGUoXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgeyBcbiAgICAgICAgICAuLi51cGRhdGVEYXRhLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKVxuICAgICAgICB9LFxuICAgICAgICB7IFxuICAgICAgICAgIG5ldzogdHJ1ZSwgXG4gICAgICAgICAgcnVuVmFsaWRhdG9yczogdHJ1ZSxcbiAgICAgICAgICBsZWFuOiB0cnVlXG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuXG4gICAgICAvLyBBdWRpdCBsb2dnaW5nIGZvciBzZW5zaXRpdmUgY2hhbmdlc1xuICAgICAgaWYgKHVwZGF0ZURhdGEuZW1haWwgfHwgdXBkYXRlRGF0YS5waG9uZSkge1xuICAgICAgICB0aGlzLmxvZ1NlbnNpdGl2ZUNoYW5nZSh1c2VySWQsIHVwZGF0ZURhdGEsIGF1ZGl0Q29udGV4dCk7XG4gICAgICB9XG5cbiAgICAgIC8vIEVtaXQgcHJvZmlsZSB1cGRhdGUgZXZlbnRcbiAgICAgIHRoaXMuZW1pdCgncHJvZmlsZVVwZGF0ZWQnLCB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgY2hhbmdlczogdXBkYXRlRGF0YSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBwZXJmb3JtYW5jZTogeyBkdXJhdGlvbiB9XG4gICAgICB9KTtcblxuICAgICAgLy8gUGVyZm9ybWFuY2UgbW9uaXRvcmluZyAodGFyZ2V0OiAyMDBtcylcbiAgICAgIGlmIChkdXJhdGlvbiA+IDIwMCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYFByb2ZpbGUgdXBkYXRlIHRvb2sgJHtkdXJhdGlvbn1tcyAtIGV4Y2VlZHMgMjAwbXMgdGFyZ2V0YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVzZXI6IHVwZGF0ZWRVc2VyLFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgcGVyZm9ybWFuY2U6IGR1cmF0aW9uIDw9IDIwMCA/ICdnb29kJyA6ICduZWVkc19vcHRpbWl6YXRpb24nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuICAgICAgXG4gICAgICBjb25zb2xlLmVycm9yKCdQcm9maWxlIHVwZGF0ZSBlcnJvcjonLCBlcnJvcik7XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgZHVyYXRpb25cbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLy8gRW5oYW5jZWQgYWRkcmVzcyBtYW5hZ2VtZW50IHdpdGhvdXQgYXV0aGVudGljYXRpb24gbG9zc1xuICBhc3luYyBtYW5hZ2VBZGRyZXNzT3B0aW1pc3RpY2FsbHkodXNlcklkLCBvcGVyYXRpb24sIGFkZHJlc3NEYXRhID0ge30sIGFkZHJlc3NJZCA9IG51bGwpIHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZCh1c2VySWQpO1xuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHJlc3VsdDtcbiAgICAgIHN3aXRjaCAob3BlcmF0aW9uKSB7XG4gICAgICAgIGNhc2UgJ2FkZCc6XG4gICAgICAgICAgcmVzdWx0ID0gYXdhaXQgdXNlci5hZGRBZGRyZXNzKGFkZHJlc3NEYXRhKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgICAgICByZXN1bHQgPSBhd2FpdCB1c2VyLnVwZGF0ZUFkZHJlc3MoYWRkcmVzc0lkLCBhZGRyZXNzRGF0YSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2RlbGV0ZSc6XG4gICAgICAgICAgcmVzdWx0ID0gYXdhaXQgdXNlci5yZW1vdmVBZGRyZXNzKGFkZHJlc3NJZCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3NldERlZmF1bHQnOlxuICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHVzZXIuc2V0RGVmYXVsdEFkZHJlc3MoYWRkcmVzc0lkKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gYWRkcmVzcyBvcGVyYXRpb246ICR7b3BlcmF0aW9ufWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcblxuICAgICAgLy8gRW1pdCBhZGRyZXNzIHVwZGF0ZSBldmVudFxuICAgICAgdGhpcy5lbWl0KCdhZGRyZXNzVXBkYXRlZCcsIHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBvcGVyYXRpb24sXG4gICAgICAgIGFkZHJlc3NJZCxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBwZXJmb3JtYW5jZTogeyBkdXJhdGlvbiB9XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdXNlcjogcmVzdWx0LFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgcGVyZm9ybWFuY2U6IGR1cmF0aW9uIDw9IDIwMCA/ICdnb29kJyA6ICduZWVkc19vcHRpbWl6YXRpb24nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0FkZHJlc3MgbWFuYWdlbWVudCBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8vIEF1ZGl0IGxvZ2dpbmcgZm9yIHNlbnNpdGl2ZSBvcGVyYXRpb25zXG4gIGxvZ1NlbnNpdGl2ZUNoYW5nZSh1c2VySWQsIGNoYW5nZXMsIGNvbnRleHQpIHtcbiAgICBjb25zdCBhdWRpdEVudHJ5ID0ge1xuICAgICAgdXNlcklkLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgY2hhbmdlczogT2JqZWN0LmtleXMoY2hhbmdlcykuZmlsdGVyKGtleSA9PiBbJ2VtYWlsJywgJ3Bob25lJ10uaW5jbHVkZXMoa2V5KSksXG4gICAgICBpcDogY29udGV4dC5pcCxcbiAgICAgIHVzZXJBZ2VudDogY29udGV4dC51c2VyQWdlbnQsXG4gICAgICBzZXNzaW9uSWQ6IGNvbnRleHQuc2Vzc2lvbklkXG4gICAgfTtcbiAgICBcbiAgICB0aGlzLmF1ZGl0TG9nLnB1c2goYXVkaXRFbnRyeSk7XG4gICAgXG4gICAgLy8gS2VlcCBvbmx5IGxhc3QgMTAwMCBlbnRyaWVzIGluIG1lbW9yeVxuICAgIGlmICh0aGlzLmF1ZGl0TG9nLmxlbmd0aCA+IDEwMDApIHtcbiAgICAgIHRoaXMuYXVkaXRMb2cgPSB0aGlzLmF1ZGl0TG9nLnNsaWNlKC0xMDAwKTtcbiAgICB9XG4gICAgXG4gICAgY29uc29sZS5sb2coJ1NlbnNpdGl2ZSBwcm9maWxlIGNoYW5nZTonLCBhdWRpdEVudHJ5KTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIHRva2VuIHdpdGhvdXQgcmVxdWlyaW5nIHJlLWF1dGhlbnRpY2F0aW9uXG4gIGFzeW5jIHZhbGlkYXRlVG9rZW5TYWZlbHkodG9rZW4pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQpO1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoZGVjb2RlZC51c2VySWQpLmxlYW4oKTtcbiAgICAgIFxuICAgICAgaWYgKCF1c2VyIHx8ICF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcmVhc29uOiAndXNlcl9ub3RfZm91bmQnIH07XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiB7IHZhbGlkOiB0cnVlLCB1c2VyLCBkZWNvZGVkIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcmVhc29uOiAnaW52YWxpZF90b2tlbicsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XG4gICAgfVxuICB9XG5cbiAgLy8gRW5oYW5jZWQgdG9rZW4gcmVmcmVzaCBtZWNoYW5pc21cbiAgYXN5bmMgcmVmcmVzaFRva2VuSWZOZWVkZWQodG9rZW4pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC5kZWNvZGUodG9rZW4pO1xuICAgICAgaWYgKCFkZWNvZGVkKSB7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246ICdpbnZhbGlkX3Rva2VuJyB9O1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB0b2tlbiBleHBpcmVzIHdpdGhpbiBuZXh0IGhvdXJcbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IGRlY29kZWQuZXhwICogMTAwMDtcbiAgICAgIGNvbnN0IG9uZUhvdXJGcm9tTm93ID0gRGF0ZS5ub3coKSArICg2MCAqIDYwICogMTAwMCk7XG4gICAgICBcbiAgICAgIGlmIChleHBpcmVzQXQgPiBvbmVIb3VyRnJvbU5vdykge1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCByZWZyZXNoZWQ6IGZhbHNlLCB0b2tlbiB9O1xuICAgICAgfVxuXG4gICAgICAvLyBHZW5lcmF0ZSBuZXcgdG9rZW5cbiAgICAgIGNvbnN0IG5ld1Rva2VuID0gand0LnNpZ24oXG4gICAgICAgIHsgdXNlcklkOiBkZWNvZGVkLnVzZXJJZCB9LFxuICAgICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVULFxuICAgICAgICB7IGV4cGlyZXNJbjogJzdkJyB9XG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICByZWZyZXNoZWQ6IHRydWUsXG4gICAgICAgIHRva2VuOiBuZXdUb2tlbixcbiAgICAgICAgZXhwaXJlc0F0OiBuZXcgRGF0ZShEYXRlLm5vdygpICsgKDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKSlcbiAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogJ3JlZnJlc2hfZmFpbGVkJywgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfTtcbiAgICB9XG4gIH1cblxuICAvLyBFbWFpbCBub3RpZmljYXRpb24gZm9yIHNlbnNpdGl2ZSBjaGFuZ2VzXG4gIGFzeW5jIG5vdGlmeVVzZXJPZlNlbnNpdGl2ZUNoYW5nZSh1c2VySWQsIGNoYW5nZVR5cGUsIGNvbnRleHQgPSB7fSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZCh1c2VySWQpLmxlYW4oKTtcbiAgICAgIGlmICghdXNlciB8fCAhdXNlci5wcmVmZXJlbmNlcz8uZW1haWxQcmVmZXJlbmNlcz8ub3JkZXJDb25maXJtYXRpb25zKSB7XG4gICAgICAgIHJldHVybjsgLy8gVXNlciBkb2Vzbid0IHdhbnQgbm90aWZpY2F0aW9uc1xuICAgICAgfVxuXG4gICAgICAvLyBUaGlzIHdvdWxkIGludGVncmF0ZSB3aXRoIHlvdXIgZW1haWwgc2VydmljZVxuICAgICAgY29uc29sZS5sb2coYEVtYWlsIG5vdGlmaWNhdGlvbiBzZW50IHRvICR7dXNlci5lbWFpbH06ICR7Y2hhbmdlVHlwZX0gY2hhbmdlZGApO1xuICAgICAgXG4gICAgICAvLyBFbWl0IG5vdGlmaWNhdGlvbiBldmVudFxuICAgICAgdGhpcy5lbWl0KCdzZW5zaXRpdmVDaGFuZ2VOb3RpZmljYXRpb24nLCB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgIGNoYW5nZVR5cGUsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgY29udGV4dFxuICAgICAgfSk7XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgc2Vuc2l0aXZlIGNoYW5nZSBub3RpZmljYXRpb246JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8vIE9wdGltaXN0aWMgdXNlciBkYXRhIHN5bmNocm9uaXphdGlvblxuICBhc3luYyBzeW5jaHJvbml6ZVVzZXJEYXRhKHVzZXJJZCwgZXZlbnRUeXBlID0gJ21hbnVhbCcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKS5sZWFuKCk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBFbWl0IHN5bmNocm9uaXphdGlvbiBldmVudCBmb3IgcmVhbC10aW1lIHVwZGF0ZXNcbiAgICAgIHRoaXMuZW1pdCgndXNlckRhdGFTeW5jJywge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHVzZXIsXG4gICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXNlciB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdVc2VyIGRhdGEgc3luY2hyb25pemF0aW9uIGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBhdWRpdCBsb2cgZm9yIHVzZXIgKGZvciBhZG1pbiBvciBkZWJ1Z2dpbmcpXG4gIGdldFVzZXJBdWRpdExvZyh1c2VySWQsIGxpbWl0ID0gNTApIHtcbiAgICByZXR1cm4gdGhpcy5hdWRpdExvZ1xuICAgICAgLmZpbHRlcihlbnRyeSA9PiBlbnRyeS51c2VySWQudG9TdHJpbmcoKSA9PT0gdXNlcklkLnRvU3RyaW5nKCkpXG4gICAgICAuc2xpY2UoLWxpbWl0KVxuICAgICAgLnJldmVyc2UoKTtcbiAgfVxuXG4gIC8vIENsZWFuIHVwIHJhdGUgbGltaXQgc3RvcmUgcGVyaW9kaWNhbGx5XG4gIGNsZWFudXBSYXRlTGltaXRTdG9yZSgpIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHdpbmRvd01zID0gNjAgKiAxMDAwOyAvLyAxIG1pbnV0ZVxuXG4gICAgZm9yIChjb25zdCBbdXNlcklkLCByZXF1ZXN0c10gb2YgdGhpcy5yYXRlTGltaXRTdG9yZS5lbnRyaWVzKCkpIHtcbiAgICAgIGNvbnN0IHZhbGlkUmVxdWVzdHMgPSByZXF1ZXN0cy5maWx0ZXIodGltZXN0YW1wID0+IG5vdyAtIHRpbWVzdGFtcCA8IHdpbmRvd01zKTtcbiAgICAgIFxuICAgICAgaWYgKHZhbGlkUmVxdWVzdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMucmF0ZUxpbWl0U3RvcmUuZGVsZXRlKHVzZXJJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJhdGVMaW1pdFN0b3JlLnNldCh1c2VySWQsIHZhbGlkUmVxdWVzdHMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIENvbm5lY3Rpb24gcG9vbGluZyBhd2FyZW5lc3NcbiAgYXN5bmMgd2l0aENvbm5lY3Rpb25PcHRpbWl6YXRpb24ob3BlcmF0aW9uKSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgb3BlcmF0aW9uKCk7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICBcbiAgICAgIGlmIChkdXJhdGlvbiA+IDEwMCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYERhdGFiYXNlIG9wZXJhdGlvbiB0b29rICR7ZHVyYXRpb259bXMgLSBjb25zaWRlciBjb25uZWN0aW9uIHBvb2xpbmcgb3B0aW1pemF0aW9uYCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0RhdGFiYXNlIG9wZXJhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59XG5cbi8vIENsZWFudXAgcmF0ZSBsaW1pdCBzdG9yZSBldmVyeSA1IG1pbnV0ZXNcbmNvbnN0IGF1dGhTZXJ2aWNlID0gbmV3IEF1dGhTZXJ2aWNlKCk7XG5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gIGF1dGhTZXJ2aWNlLmNsZWFudXBSYXRlTGltaXRTdG9yZSgpO1xufSwgNSAqIDYwICogMTAwMCk7XG5cbm1vZHVsZS5leHBvcnRzID0gYXV0aFNlcnZpY2U7Il0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQztBQUN0QyxNQUFNQyxHQUFHLEdBQUdELE9BQU8sQ0FBQyxjQUFjLENBQUM7QUFDbkMsTUFBTUUsWUFBWSxHQUFHRixPQUFPLENBQUMsUUFBUSxDQUFDO0FBRXRDLE1BQU1HLFdBQVcsU0FBU0QsWUFBWSxDQUFDO0VBQ3JDRSxXQUFXQSxDQUFBLEVBQUc7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