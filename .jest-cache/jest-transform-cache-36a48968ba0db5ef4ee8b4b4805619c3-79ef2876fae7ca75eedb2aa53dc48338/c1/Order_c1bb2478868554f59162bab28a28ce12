8e405d783b248951fc1ff292aa99a76e
const mongoose = require('mongoose');
const orderSchema = new mongoose.Schema({
  orderNumber: {
    type: String,
    unique: true
  },
  customer: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: false // Allow guest checkout
  },
  guestInfo: {
    email: {
      type: String,
      required: function () {
        return !this.customer;
      },
      lowercase: true,
      trim: true
    },
    firstName: {
      type: String,
      required: function () {
        return !this.customer;
      },
      trim: true
    },
    lastName: {
      type: String,
      required: function () {
        return !this.customer;
      },
      trim: true
    },
    phone: {
      type: String,
      trim: true
    }
  },
  items: [{
    product: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'Product',
      required: true
    },
    quantity: {
      type: Number,
      required: true,
      min: 1
    },
    price: {
      type: Number,
      required: true
    },
    wholesaler: {
      name: String,
      email: String,
      productCode: String,
      notified: {
        type: Boolean,
        default: false
      },
      notifiedAt: Date,
      notificationAttempts: {
        type: Number,
        default: 0
      },
      lastNotificationError: String
    }
  }],
  shippingAddress: {
    firstName: {
      type: String,
      required: true
    },
    lastName: {
      type: String,
      required: true
    },
    street: {
      type: String,
      required: true
    },
    city: {
      type: String,
      required: true
    },
    state: {
      type: String,
      required: true
    },
    zipCode: {
      type: String,
      required: true
    },
    country: {
      type: String,
      required: true,
      default: 'US'
    },
    phone: String
  },
  billingAddress: {
    firstName: {
      type: String,
      required: true
    },
    lastName: {
      type: String,
      required: true
    },
    street: {
      type: String,
      required: true
    },
    city: {
      type: String,
      required: true
    },
    state: {
      type: String,
      required: true
    },
    zipCode: {
      type: String,
      required: true
    },
    country: {
      type: String,
      required: true,
      default: 'US'
    }
  },
  subtotal: {
    type: Number,
    required: true
  },
  tax: {
    type: Number,
    default: 0
  },
  shipping: {
    type: Number,
    default: 0
  },
  total: {
    type: Number,
    required: true
  },
  payment: {
    method: {
      type: String,
      enum: ['card', 'crypto', 'other'],
      required: true
    },
    status: {
      type: String,
      enum: ['pending', 'paid', 'failed', 'refunded'],
      default: 'pending'
    },
    molliePaymentId: String,
    transactionId: String,
    paidAt: Date
  },
  status: {
    type: String,
    enum: ['pending', 'processing', 'shipped', 'delivered', 'cancelled'],
    default: 'pending'
  },
  trackingNumber: String,
  notes: String,
  referralSource: String // Track which sister site referred this order
}, {
  timestamps: true
});

// Indexes for performance
orderSchema.index({
  orderNumber: 1
});
orderSchema.index({
  customer: 1,
  createdAt: -1
});
orderSchema.index({
  'guestInfo.email': 1
});
orderSchema.index({
  status: 1
});
orderSchema.index({
  'payment.status': 1
});
orderSchema.index({
  referralSource: 1
});
orderSchema.index({
  createdAt: -1
});
orderSchema.index({
  'items.wholesaler.notified': 1
});

// Pre-save middleware
orderSchema.pre('save', function (next) {
  if (!this.orderNumber) {
    this.orderNumber = 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
  }
  next();
});

// Method to get customer email (works for both guest and registered users)
orderSchema.methods.getCustomerEmail = function () {
  if (this.customer && this.populated('customer')) {
    return this.customer.email;
  }
  return this.guestInfo.email;
};

// Method to get customer name
orderSchema.methods.getCustomerName = function () {
  if (this.customer && this.populated('customer')) {
    return `${this.customer.firstName} ${this.customer.lastName}`;
  }
  return `${this.guestInfo.firstName} ${this.guestInfo.lastName}`;
};

// Method to check if all wholesalers have been notified
orderSchema.methods.allWholesalersNotified = function () {
  return this.items.every(item => item.wholesaler.notified);
};

// Method to get pending wholesaler notifications
orderSchema.methods.getPendingNotifications = function () {
  return this.items.filter(item => !item.wholesaler.notified);
};

// Method to update wholesaler notification status
orderSchema.methods.updateWholesalerNotification = function (itemId, success, error = null) {
  const item = this.items.id(itemId);
  if (item) {
    item.wholesaler.notificationAttempts += 1;
    if (success) {
      item.wholesaler.notified = true;
      item.wholesaler.notifiedAt = new Date();
      item.wholesaler.lastNotificationError = null;
    } else {
      item.wholesaler.lastNotificationError = error;
    }
  }
  return this.save();
};

// Static method to find orders needing wholesaler notification
orderSchema.statics.findPendingNotifications = function () {
  return this.find({
    'payment.status': 'paid',
    'items.wholesaler.notified': false
  });
};

// Method to get public order data (excludes sensitive wholesaler info)
orderSchema.methods.toPublicJSON = function () {
  const order = this.toObject();

  // Remove sensitive wholesaler information from items
  if (order.items) {
    order.items = order.items.map(item => {
      const publicItem = {
        ...item
      };
      if (publicItem.wholesaler) {
        // Keep only notification status, remove sensitive details
        publicItem.wholesaler = {
          notified: item.wholesaler.notified,
          notifiedAt: item.wholesaler.notifiedAt
        };
      }
      return publicItem;
    });
  }
  return order;
};

// Hook trigger comment - wholesaler notification check
// Referral tracking hook test

module.exports = mongoose.model('Order', orderSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJvcmRlclNjaGVtYSIsIlNjaGVtYSIsIm9yZGVyTnVtYmVyIiwidHlwZSIsIlN0cmluZyIsInVuaXF1ZSIsImN1c3RvbWVyIiwiVHlwZXMiLCJPYmplY3RJZCIsInJlZiIsInJlcXVpcmVkIiwiZ3Vlc3RJbmZvIiwiZW1haWwiLCJsb3dlcmNhc2UiLCJ0cmltIiwiZmlyc3ROYW1lIiwibGFzdE5hbWUiLCJwaG9uZSIsIml0ZW1zIiwicHJvZHVjdCIsInF1YW50aXR5IiwiTnVtYmVyIiwibWluIiwicHJpY2UiLCJ3aG9sZXNhbGVyIiwibmFtZSIsInByb2R1Y3RDb2RlIiwibm90aWZpZWQiLCJCb29sZWFuIiwiZGVmYXVsdCIsIm5vdGlmaWVkQXQiLCJEYXRlIiwibm90aWZpY2F0aW9uQXR0ZW1wdHMiLCJsYXN0Tm90aWZpY2F0aW9uRXJyb3IiLCJzaGlwcGluZ0FkZHJlc3MiLCJzdHJlZXQiLCJjaXR5Iiwic3RhdGUiLCJ6aXBDb2RlIiwiY291bnRyeSIsImJpbGxpbmdBZGRyZXNzIiwic3VidG90YWwiLCJ0YXgiLCJzaGlwcGluZyIsInRvdGFsIiwicGF5bWVudCIsIm1ldGhvZCIsImVudW0iLCJzdGF0dXMiLCJtb2xsaWVQYXltZW50SWQiLCJ0cmFuc2FjdGlvbklkIiwicGFpZEF0IiwidHJhY2tpbmdOdW1iZXIiLCJub3RlcyIsInJlZmVycmFsU291cmNlIiwidGltZXN0YW1wcyIsImluZGV4IiwiY3JlYXRlZEF0IiwicHJlIiwibmV4dCIsIm5vdyIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0ciIsInRvVXBwZXJDYXNlIiwibWV0aG9kcyIsImdldEN1c3RvbWVyRW1haWwiLCJwb3B1bGF0ZWQiLCJnZXRDdXN0b21lck5hbWUiLCJhbGxXaG9sZXNhbGVyc05vdGlmaWVkIiwiZXZlcnkiLCJpdGVtIiwiZ2V0UGVuZGluZ05vdGlmaWNhdGlvbnMiLCJmaWx0ZXIiLCJ1cGRhdGVXaG9sZXNhbGVyTm90aWZpY2F0aW9uIiwiaXRlbUlkIiwic3VjY2VzcyIsImVycm9yIiwiaWQiLCJzYXZlIiwic3RhdGljcyIsImZpbmRQZW5kaW5nTm90aWZpY2F0aW9ucyIsImZpbmQiLCJ0b1B1YmxpY0pTT04iLCJvcmRlciIsInRvT2JqZWN0IiwibWFwIiwicHVibGljSXRlbSIsIm1vZHVsZSIsImV4cG9ydHMiLCJtb2RlbCJdLCJzb3VyY2VzIjpbIk9yZGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG1vbmdvb3NlID0gcmVxdWlyZSgnbW9uZ29vc2UnKTtcblxuY29uc3Qgb3JkZXJTY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcbiAgb3JkZXJOdW1iZXI6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgdW5pcXVlOiB0cnVlXG4gIH0sXG4gIGN1c3RvbWVyOiB7XG4gICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLFxuICAgIHJlZjogJ1VzZXInLFxuICAgIHJlcXVpcmVkOiBmYWxzZSAvLyBBbGxvdyBndWVzdCBjaGVja291dFxuICB9LFxuICBndWVzdEluZm86IHtcbiAgICBlbWFpbDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuY3VzdG9tZXI7IH0sXG4gICAgICBsb3dlcmNhc2U6IHRydWUsXG4gICAgICB0cmltOiB0cnVlXG4gICAgfSxcbiAgICBmaXJzdE5hbWU6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHJlcXVpcmVkOiBmdW5jdGlvbigpIHsgcmV0dXJuICF0aGlzLmN1c3RvbWVyOyB9LFxuICAgICAgdHJpbTogdHJ1ZVxuICAgIH0sXG4gICAgbGFzdE5hbWU6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHJlcXVpcmVkOiBmdW5jdGlvbigpIHsgcmV0dXJuICF0aGlzLmN1c3RvbWVyOyB9LFxuICAgICAgdHJpbTogdHJ1ZVxuICAgIH0sXG4gICAgcGhvbmU6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHRyaW06IHRydWVcbiAgICB9XG4gIH0sXG4gIGl0ZW1zOiBbe1xuICAgIHByb2R1Y3Q6IHtcbiAgICAgIHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCxcbiAgICAgIHJlZjogJ1Byb2R1Y3QnLFxuICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICB9LFxuICAgIHF1YW50aXR5OiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgIG1pbjogMVxuICAgIH0sXG4gICAgcHJpY2U6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgfSxcbiAgICB3aG9sZXNhbGVyOiB7XG4gICAgICBuYW1lOiBTdHJpbmcsXG4gICAgICBlbWFpbDogU3RyaW5nLFxuICAgICAgcHJvZHVjdENvZGU6IFN0cmluZyxcbiAgICAgIG5vdGlmaWVkOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH0sXG4gICAgICBub3RpZmllZEF0OiBEYXRlLFxuICAgICAgbm90aWZpY2F0aW9uQXR0ZW1wdHM6IHsgdHlwZTogTnVtYmVyLCBkZWZhdWx0OiAwIH0sXG4gICAgICBsYXN0Tm90aWZpY2F0aW9uRXJyb3I6IFN0cmluZ1xuICAgIH1cbiAgfV0sXG4gIHNoaXBwaW5nQWRkcmVzczoge1xuICAgIGZpcnN0TmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgbGFzdE5hbWU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIHN0cmVldDogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgY2l0eTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgc3RhdGU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIHppcENvZGU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIGNvdW50cnk6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSwgZGVmYXVsdDogJ1VTJyB9LFxuICAgIHBob25lOiBTdHJpbmdcbiAgfSxcbiAgYmlsbGluZ0FkZHJlc3M6IHtcbiAgICBmaXJzdE5hbWU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIGxhc3ROYW1lOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBzdHJlZXQ6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIGNpdHk6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIHN0YXRlOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICB6aXBDb2RlOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBjb3VudHJ5OiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUsIGRlZmF1bHQ6ICdVUycgfVxuICB9LFxuICBzdWJ0b3RhbDoge1xuICAgIHR5cGU6IE51bWJlcixcbiAgICByZXF1aXJlZDogdHJ1ZVxuICB9LFxuICB0YXg6IHtcbiAgICB0eXBlOiBOdW1iZXIsXG4gICAgZGVmYXVsdDogMFxuICB9LFxuICBzaGlwcGluZzoge1xuICAgIHR5cGU6IE51bWJlcixcbiAgICBkZWZhdWx0OiAwXG4gIH0sXG4gIHRvdGFsOiB7XG4gICAgdHlwZTogTnVtYmVyLFxuICAgIHJlcXVpcmVkOiB0cnVlXG4gIH0sXG4gIHBheW1lbnQ6IHtcbiAgICBtZXRob2Q6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGVudW06IFsnY2FyZCcsICdjcnlwdG8nLCAnb3RoZXInXSxcbiAgICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgfSxcbiAgICBzdGF0dXM6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGVudW06IFsncGVuZGluZycsICdwYWlkJywgJ2ZhaWxlZCcsICdyZWZ1bmRlZCddLFxuICAgICAgZGVmYXVsdDogJ3BlbmRpbmcnXG4gICAgfSxcbiAgICBtb2xsaWVQYXltZW50SWQ6IFN0cmluZyxcbiAgICB0cmFuc2FjdGlvbklkOiBTdHJpbmcsXG4gICAgcGFpZEF0OiBEYXRlXG4gIH0sXG4gIHN0YXR1czoge1xuICAgIHR5cGU6IFN0cmluZyxcbiAgICBlbnVtOiBbJ3BlbmRpbmcnLCAncHJvY2Vzc2luZycsICdzaGlwcGVkJywgJ2RlbGl2ZXJlZCcsICdjYW5jZWxsZWQnXSxcbiAgICBkZWZhdWx0OiAncGVuZGluZydcbiAgfSxcbiAgdHJhY2tpbmdOdW1iZXI6IFN0cmluZyxcbiAgbm90ZXM6IFN0cmluZyxcbiAgcmVmZXJyYWxTb3VyY2U6IFN0cmluZyAvLyBUcmFjayB3aGljaCBzaXN0ZXIgc2l0ZSByZWZlcnJlZCB0aGlzIG9yZGVyXG59LCB7XG4gIHRpbWVzdGFtcHM6IHRydWVcbn0pO1xuXG4vLyBJbmRleGVzIGZvciBwZXJmb3JtYW5jZVxub3JkZXJTY2hlbWEuaW5kZXgoeyBvcmRlck51bWJlcjogMSB9KTtcbm9yZGVyU2NoZW1hLmluZGV4KHsgY3VzdG9tZXI6IDEsIGNyZWF0ZWRBdDogLTEgfSk7XG5vcmRlclNjaGVtYS5pbmRleCh7ICdndWVzdEluZm8uZW1haWwnOiAxIH0pO1xub3JkZXJTY2hlbWEuaW5kZXgoeyBzdGF0dXM6IDEgfSk7XG5vcmRlclNjaGVtYS5pbmRleCh7ICdwYXltZW50LnN0YXR1cyc6IDEgfSk7XG5vcmRlclNjaGVtYS5pbmRleCh7IHJlZmVycmFsU291cmNlOiAxIH0pO1xub3JkZXJTY2hlbWEuaW5kZXgoeyBjcmVhdGVkQXQ6IC0xIH0pO1xub3JkZXJTY2hlbWEuaW5kZXgoeyAnaXRlbXMud2hvbGVzYWxlci5ub3RpZmllZCc6IDEgfSk7XG5cbi8vIFByZS1zYXZlIG1pZGRsZXdhcmVcbm9yZGVyU2NoZW1hLnByZSgnc2F2ZScsIGZ1bmN0aW9uKG5leHQpIHtcbiAgaWYgKCF0aGlzLm9yZGVyTnVtYmVyKSB7XG4gICAgdGhpcy5vcmRlck51bWJlciA9ICdPUkQtJyArIERhdGUubm93KCkgKyAnLScgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgNSkudG9VcHBlckNhc2UoKTtcbiAgfVxuICBuZXh0KCk7XG59KTtcblxuLy8gTWV0aG9kIHRvIGdldCBjdXN0b21lciBlbWFpbCAod29ya3MgZm9yIGJvdGggZ3Vlc3QgYW5kIHJlZ2lzdGVyZWQgdXNlcnMpXG5vcmRlclNjaGVtYS5tZXRob2RzLmdldEN1c3RvbWVyRW1haWwgPSBmdW5jdGlvbigpIHtcbiAgaWYgKHRoaXMuY3VzdG9tZXIgJiYgdGhpcy5wb3B1bGF0ZWQoJ2N1c3RvbWVyJykpIHtcbiAgICByZXR1cm4gdGhpcy5jdXN0b21lci5lbWFpbDtcbiAgfVxuICByZXR1cm4gdGhpcy5ndWVzdEluZm8uZW1haWw7XG59O1xuXG4vLyBNZXRob2QgdG8gZ2V0IGN1c3RvbWVyIG5hbWVcbm9yZGVyU2NoZW1hLm1ldGhvZHMuZ2V0Q3VzdG9tZXJOYW1lID0gZnVuY3Rpb24oKSB7XG4gIGlmICh0aGlzLmN1c3RvbWVyICYmIHRoaXMucG9wdWxhdGVkKCdjdXN0b21lcicpKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuY3VzdG9tZXIuZmlyc3ROYW1lfSAke3RoaXMuY3VzdG9tZXIubGFzdE5hbWV9YDtcbiAgfVxuICByZXR1cm4gYCR7dGhpcy5ndWVzdEluZm8uZmlyc3ROYW1lfSAke3RoaXMuZ3Vlc3RJbmZvLmxhc3ROYW1lfWA7XG59O1xuXG4vLyBNZXRob2QgdG8gY2hlY2sgaWYgYWxsIHdob2xlc2FsZXJzIGhhdmUgYmVlbiBub3RpZmllZFxub3JkZXJTY2hlbWEubWV0aG9kcy5hbGxXaG9sZXNhbGVyc05vdGlmaWVkID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiB0aGlzLml0ZW1zLmV2ZXJ5KGl0ZW0gPT4gaXRlbS53aG9sZXNhbGVyLm5vdGlmaWVkKTtcbn07XG5cbi8vIE1ldGhvZCB0byBnZXQgcGVuZGluZyB3aG9sZXNhbGVyIG5vdGlmaWNhdGlvbnNcbm9yZGVyU2NoZW1hLm1ldGhvZHMuZ2V0UGVuZGluZ05vdGlmaWNhdGlvbnMgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuaXRlbXMuZmlsdGVyKGl0ZW0gPT4gIWl0ZW0ud2hvbGVzYWxlci5ub3RpZmllZCk7XG59O1xuXG4vLyBNZXRob2QgdG8gdXBkYXRlIHdob2xlc2FsZXIgbm90aWZpY2F0aW9uIHN0YXR1c1xub3JkZXJTY2hlbWEubWV0aG9kcy51cGRhdGVXaG9sZXNhbGVyTm90aWZpY2F0aW9uID0gZnVuY3Rpb24oaXRlbUlkLCBzdWNjZXNzLCBlcnJvciA9IG51bGwpIHtcbiAgY29uc3QgaXRlbSA9IHRoaXMuaXRlbXMuaWQoaXRlbUlkKTtcbiAgaWYgKGl0ZW0pIHtcbiAgICBpdGVtLndob2xlc2FsZXIubm90aWZpY2F0aW9uQXR0ZW1wdHMgKz0gMTtcbiAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgaXRlbS53aG9sZXNhbGVyLm5vdGlmaWVkID0gdHJ1ZTtcbiAgICAgIGl0ZW0ud2hvbGVzYWxlci5ub3RpZmllZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgIGl0ZW0ud2hvbGVzYWxlci5sYXN0Tm90aWZpY2F0aW9uRXJyb3IgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpdGVtLndob2xlc2FsZXIubGFzdE5vdGlmaWNhdGlvbkVycm9yID0gZXJyb3I7XG4gICAgfVxuICB9XG4gIHJldHVybiB0aGlzLnNhdmUoKTtcbn07XG5cbi8vIFN0YXRpYyBtZXRob2QgdG8gZmluZCBvcmRlcnMgbmVlZGluZyB3aG9sZXNhbGVyIG5vdGlmaWNhdGlvblxub3JkZXJTY2hlbWEuc3RhdGljcy5maW5kUGVuZGluZ05vdGlmaWNhdGlvbnMgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuZmluZCh7XG4gICAgJ3BheW1lbnQuc3RhdHVzJzogJ3BhaWQnLFxuICAgICdpdGVtcy53aG9sZXNhbGVyLm5vdGlmaWVkJzogZmFsc2VcbiAgfSk7XG59O1xuXG4vLyBNZXRob2QgdG8gZ2V0IHB1YmxpYyBvcmRlciBkYXRhIChleGNsdWRlcyBzZW5zaXRpdmUgd2hvbGVzYWxlciBpbmZvKVxub3JkZXJTY2hlbWEubWV0aG9kcy50b1B1YmxpY0pTT04gPSBmdW5jdGlvbigpIHtcbiAgY29uc3Qgb3JkZXIgPSB0aGlzLnRvT2JqZWN0KCk7XG4gIFxuICAvLyBSZW1vdmUgc2Vuc2l0aXZlIHdob2xlc2FsZXIgaW5mb3JtYXRpb24gZnJvbSBpdGVtc1xuICBpZiAob3JkZXIuaXRlbXMpIHtcbiAgICBvcmRlci5pdGVtcyA9IG9yZGVyLml0ZW1zLm1hcChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHB1YmxpY0l0ZW0gPSB7IC4uLml0ZW0gfTtcbiAgICAgIGlmIChwdWJsaWNJdGVtLndob2xlc2FsZXIpIHtcbiAgICAgICAgLy8gS2VlcCBvbmx5IG5vdGlmaWNhdGlvbiBzdGF0dXMsIHJlbW92ZSBzZW5zaXRpdmUgZGV0YWlsc1xuICAgICAgICBwdWJsaWNJdGVtLndob2xlc2FsZXIgPSB7XG4gICAgICAgICAgbm90aWZpZWQ6IGl0ZW0ud2hvbGVzYWxlci5ub3RpZmllZCxcbiAgICAgICAgICBub3RpZmllZEF0OiBpdGVtLndob2xlc2FsZXIubm90aWZpZWRBdFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHB1YmxpY0l0ZW07XG4gICAgfSk7XG4gIH1cbiAgXG4gIHJldHVybiBvcmRlcjtcbn07XG5cbi8vIEhvb2sgdHJpZ2dlciBjb21tZW50IC0gd2hvbGVzYWxlciBub3RpZmljYXRpb24gY2hlY2tcbi8vIFJlZmVycmFsIHRyYWNraW5nIGhvb2sgdGVzdFxuXG5tb2R1bGUuZXhwb3J0cyA9IG1vbmdvb3NlLm1vZGVsKCdPcmRlcicsIG9yZGVyU2NoZW1hKTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUVwQyxNQUFNQyxXQUFXLEdBQUcsSUFBSUYsUUFBUSxDQUFDRyxNQUFNLENBQUM7RUFDdENDLFdBQVcsRUFBRTtJ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