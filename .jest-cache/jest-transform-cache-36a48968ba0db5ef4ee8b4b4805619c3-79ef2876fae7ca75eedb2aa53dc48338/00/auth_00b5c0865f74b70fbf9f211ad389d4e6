86da48da12a7f7b95a4e809e4268b0da
const jwt = require('jsonwebtoken');
const User = require('../models/User');
const authService = require('../services/authService');

// Middleware to authenticate JWT tokens
const authenticateToken = async (req, res, next) => {
  try {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

    if (!token) {
      req.user = null;
      return next(); // Continue without authentication for optional auth routes
    }

    // Use auth service for token validation with fallback
    let decoded, user;
    try {
      const validation = await authService.validateTokenSafely(token);
      if (validation.valid) {
        decoded = validation.decoded;
        user = validation.user;
      } else {
        req.user = null;
        return next();
      }
    } catch (serviceError) {
      // Fallback to direct JWT verification
      console.warn('Auth service failed, using fallback:', serviceError.message);
      decoded = jwt.verify(token, process.env.JWT_SECRET);
      user = await User.findById(decoded.userId).select('-password');
    }
    if (!user || !user.isActive) {
      req.user = null;
      return next();
    }
    req.user = user;
    next();
  } catch (error) {
    req.user = null;
    next(); // Continue without authentication for optional auth routes
  }
};

// Middleware to require authentication
const requireAuth = async (req, res, next) => {
  try {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    if (!token) {
      return res.status(401).json({
        success: false,
        error: {
          code: 'NO_TOKEN',
          message: 'Access token is required'
        }
      });
    }

    // Use auth service for token validation with automatic refresh
    let decoded, user;
    try {
      const validation = await authService.validateTokenSafely(token);
      if (validation.valid) {
        decoded = validation.decoded;
        user = validation.user;

        // Check if token needs refresh
        const refreshResult = await authService.refreshTokenIfNeeded(token);
        if (refreshResult.refreshed) {
          // Add new token to response headers for client to update
          res.setHeader('X-New-Token', refreshResult.token);
        }
      } else {
        return res.status(401).json({
          success: false,
          error: {
            code: 'INVALID_TOKEN',
            message: validation.reason === 'user_not_found' ? 'User not found' : 'Invalid or expired token'
          }
        });
      }
    } catch (serviceError) {
      // Fallback to direct JWT verification
      console.warn('Auth service failed in requireAuth, using fallback:', serviceError.message);
      decoded = jwt.verify(token, process.env.JWT_SECRET);
      user = await User.findById(decoded.userId).select('-password');
      if (!user || !user.isActive) {
        return res.status(401).json({
          success: false,
          error: {
            code: 'INVALID_TOKEN',
            message: 'Invalid or expired token'
          }
        });
      }
    }
    req.user = user;
    next();
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: 'Invalid token format'
        }
      });
    }
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        success: false,
        error: {
          code: 'TOKEN_EXPIRED',
          message: 'Token has expired'
        }
      });
    }
    console.error('Authentication error:', error);
    res.status(500).json({
      success: false,
      error: {
        code: 'AUTH_ERROR',
        message: 'Authentication failed'
      }
    });
  }
};

// Middleware to require admin role
const requireAdmin = async (req, res, next) => {
  try {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    if (!token) {
      return res.status(401).json({
        success: false,
        error: {
          code: 'NO_TOKEN',
          message: 'Access token is required'
        }
      });
    }
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId).select('-password');
    if (!user || !user.isActive) {
      return res.status(401).json({
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: 'Invalid or expired token'
        }
      });
    }

    // Check if user has admin role
    if (!user.isAdmin) {
      return res.status(403).json({
        success: false,
        error: {
          code: 'INSUFFICIENT_PERMISSIONS',
          message: 'Admin access required'
        }
      });
    }
    req.user = user;
    next();
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: 'Invalid token format'
        }
      });
    }
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        success: false,
        error: {
          code: 'TOKEN_EXPIRED',
          message: 'Token has expired'
        }
      });
    }
    console.error('Admin auth error:', error);
    res.status(500).json({
      success: false,
      error: {
        code: 'AUTH_ERROR',
        message: 'Authorization failed'
      }
    });
  }
};
module.exports = {
  authenticateToken,
  requireAuth,
  requireAdmin
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqd3QiLCJyZXF1aXJlIiwiVXNlciIsImF1dGhTZXJ2aWNlIiwiYXV0aGVudGljYXRlVG9rZW4iLCJyZXEiLCJyZXMiLCJuZXh0IiwiYXV0aEhlYWRlciIsImhlYWRlcnMiLCJ0b2tlbiIsInNwbGl0IiwidXNlciIsImRlY29kZWQiLCJ2YWxpZGF0aW9uIiwidmFsaWRhdGVUb2tlblNhZmVseSIsInZhbGlkIiwic2VydmljZUVycm9yIiwiY29uc29sZSIsIndhcm4iLCJtZXNzYWdlIiwidmVyaWZ5IiwicHJvY2VzcyIsImVudiIsIkpXVF9TRUNSRVQiLCJmaW5kQnlJZCIsInVzZXJJZCIsInNlbGVjdCIsImlzQWN0aXZlIiwiZXJyb3IiLCJyZXF1aXJlQXV0aCIsInN0YXR1cyIsImpzb24iLCJzdWNjZXNzIiwiY29kZSIsInJlZnJlc2hSZXN1bHQiLCJyZWZyZXNoVG9rZW5JZk5lZWRlZCIsInJlZnJlc2hlZCIsInNldEhlYWRlciIsInJlYXNvbiIsIm5hbWUiLCJyZXF1aXJlQWRtaW4iLCJpc0FkbWluIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImF1dGguanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgand0ID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG5jb25zdCBVc2VyID0gcmVxdWlyZSgnLi4vbW9kZWxzL1VzZXInKTtcbmNvbnN0IGF1dGhTZXJ2aWNlID0gcmVxdWlyZSgnLi4vc2VydmljZXMvYXV0aFNlcnZpY2UnKTtcblxuLy8gTWlkZGxld2FyZSB0byBhdXRoZW50aWNhdGUgSldUIHRva2Vuc1xuY29uc3QgYXV0aGVudGljYXRlVG9rZW4gPSBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTtcbiAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdOyAvLyBCZWFyZXIgVE9LRU5cbiAgICBcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXEudXNlciA9IG51bGw7XG4gICAgICByZXR1cm4gbmV4dCgpOyAvLyBDb250aW51ZSB3aXRob3V0IGF1dGhlbnRpY2F0aW9uIGZvciBvcHRpb25hbCBhdXRoIHJvdXRlc1xuICAgIH1cbiAgICBcbiAgICAvLyBVc2UgYXV0aCBzZXJ2aWNlIGZvciB0b2tlbiB2YWxpZGF0aW9uIHdpdGggZmFsbGJhY2tcbiAgICBsZXQgZGVjb2RlZCwgdXNlcjtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGF3YWl0IGF1dGhTZXJ2aWNlLnZhbGlkYXRlVG9rZW5TYWZlbHkodG9rZW4pO1xuICAgICAgaWYgKHZhbGlkYXRpb24udmFsaWQpIHtcbiAgICAgICAgZGVjb2RlZCA9IHZhbGlkYXRpb24uZGVjb2RlZDtcbiAgICAgICAgdXNlciA9IHZhbGlkYXRpb24udXNlcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcS51c2VyID0gbnVsbDtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChzZXJ2aWNlRXJyb3IpIHtcbiAgICAgIC8vIEZhbGxiYWNrIHRvIGRpcmVjdCBKV1QgdmVyaWZpY2F0aW9uXG4gICAgICBjb25zb2xlLndhcm4oJ0F1dGggc2VydmljZSBmYWlsZWQsIHVzaW5nIGZhbGxiYWNrOicsIHNlcnZpY2VFcnJvci5tZXNzYWdlKTtcbiAgICAgIGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCBwcm9jZXNzLmVudi5KV1RfU0VDUkVUKTtcbiAgICAgIHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKGRlY29kZWQudXNlcklkKS5zZWxlY3QoJy1wYXNzd29yZCcpO1xuICAgIH1cbiAgICBcbiAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgIHJlcS51c2VyID0gbnVsbDtcbiAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgfVxuICAgIFxuICAgIHJlcS51c2VyID0gdXNlcjtcbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmVxLnVzZXIgPSBudWxsO1xuICAgIG5leHQoKTsgLy8gQ29udGludWUgd2l0aG91dCBhdXRoZW50aWNhdGlvbiBmb3Igb3B0aW9uYWwgYXV0aCByb3V0ZXNcbiAgfVxufTtcblxuLy8gTWlkZGxld2FyZSB0byByZXF1aXJlIGF1dGhlbnRpY2F0aW9uXG5jb25zdCByZXF1aXJlQXV0aCA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVyc1snYXV0aG9yaXphdGlvbiddO1xuICAgIGNvbnN0IHRva2VuID0gYXV0aEhlYWRlciAmJiBhdXRoSGVhZGVyLnNwbGl0KCcgJylbMV07XG4gICAgXG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogJ05PX1RPS0VOJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQWNjZXNzIHRva2VuIGlzIHJlcXVpcmVkJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgLy8gVXNlIGF1dGggc2VydmljZSBmb3IgdG9rZW4gdmFsaWRhdGlvbiB3aXRoIGF1dG9tYXRpYyByZWZyZXNoXG4gICAgbGV0IGRlY29kZWQsIHVzZXI7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCBhdXRoU2VydmljZS52YWxpZGF0ZVRva2VuU2FmZWx5KHRva2VuKTtcbiAgICAgIGlmICh2YWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICAgIGRlY29kZWQgPSB2YWxpZGF0aW9uLmRlY29kZWQ7XG4gICAgICAgIHVzZXIgPSB2YWxpZGF0aW9uLnVzZXI7XG4gICAgICAgIFxuICAgICAgICAvLyBDaGVjayBpZiB0b2tlbiBuZWVkcyByZWZyZXNoXG4gICAgICAgIGNvbnN0IHJlZnJlc2hSZXN1bHQgPSBhd2FpdCBhdXRoU2VydmljZS5yZWZyZXNoVG9rZW5JZk5lZWRlZCh0b2tlbik7XG4gICAgICAgIGlmIChyZWZyZXNoUmVzdWx0LnJlZnJlc2hlZCkge1xuICAgICAgICAgIC8vIEFkZCBuZXcgdG9rZW4gdG8gcmVzcG9uc2UgaGVhZGVycyBmb3IgY2xpZW50IHRvIHVwZGF0ZVxuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtTmV3LVRva2VuJywgcmVmcmVzaFJlc3VsdC50b2tlbik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgIGNvZGU6ICdJTlZBTElEX1RPS0VOJyxcbiAgICAgICAgICAgIG1lc3NhZ2U6IHZhbGlkYXRpb24ucmVhc29uID09PSAndXNlcl9ub3RfZm91bmQnID8gJ1VzZXIgbm90IGZvdW5kJyA6ICdJbnZhbGlkIG9yIGV4cGlyZWQgdG9rZW4nXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChzZXJ2aWNlRXJyb3IpIHtcbiAgICAgIC8vIEZhbGxiYWNrIHRvIGRpcmVjdCBKV1QgdmVyaWZpY2F0aW9uXG4gICAgICBjb25zb2xlLndhcm4oJ0F1dGggc2VydmljZSBmYWlsZWQgaW4gcmVxdWlyZUF1dGgsIHVzaW5nIGZhbGxiYWNrOicsIHNlcnZpY2VFcnJvci5tZXNzYWdlKTtcbiAgICAgIGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCBwcm9jZXNzLmVudi5KV1RfU0VDUkVUKTtcbiAgICAgIHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKGRlY29kZWQudXNlcklkKS5zZWxlY3QoJy1wYXNzd29yZCcpO1xuICAgICAgXG4gICAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgY29kZTogJ0lOVkFMSURfVE9LRU4nLFxuICAgICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgb3IgZXhwaXJlZCB0b2tlbidcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXEudXNlciA9IHVzZXI7XG4gICAgbmV4dCgpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvci5uYW1lID09PSAnSnNvbldlYlRva2VuRXJyb3InKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiAnSU5WQUxJRF9UT0tFTicsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgdG9rZW4gZm9ybWF0J1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdUb2tlbkV4cGlyZWRFcnJvcicpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdUT0tFTl9FWFBJUkVEJyxcbiAgICAgICAgICBtZXNzYWdlOiAnVG9rZW4gaGFzIGV4cGlyZWQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zb2xlLmVycm9yKCdBdXRoZW50aWNhdGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjoge1xuICAgICAgICBjb2RlOiAnQVVUSF9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBmYWlsZWQnXG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIE1pZGRsZXdhcmUgdG8gcmVxdWlyZSBhZG1pbiByb2xlXG5jb25zdCByZXF1aXJlQWRtaW4gPSBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTtcbiAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdO1xuICAgIFxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdOT19UT0tFTicsXG4gICAgICAgICAgbWVzc2FnZTogJ0FjY2VzcyB0b2tlbiBpcyByZXF1aXJlZCdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCBwcm9jZXNzLmVudi5KV1RfU0VDUkVUKTtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZChkZWNvZGVkLnVzZXJJZCkuc2VsZWN0KCctcGFzc3dvcmQnKTtcbiAgICBcbiAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6ICdJTlZBTElEX1RPS0VOJyxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBvciBleHBpcmVkIHRva2VuJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgYWRtaW4gcm9sZVxuICAgIGlmICghdXNlci5pc0FkbWluKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiAnSU5TVUZGSUNJRU5UX1BFUk1JU1NJT05TJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQWRtaW4gYWNjZXNzIHJlcXVpcmVkJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgIG5leHQoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ0pzb25XZWJUb2tlbkVycm9yJykge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfVE9LRU4nLFxuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIHRva2VuIGZvcm1hdCdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIGlmIChlcnJvci5uYW1lID09PSAnVG9rZW5FeHBpcmVkRXJyb3InKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiAnVE9LRU5fRVhQSVJFRCcsXG4gICAgICAgICAgbWVzc2FnZTogJ1Rva2VuIGhhcyBleHBpcmVkJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgY29uc29sZS5lcnJvcignQWRtaW4gYXV0aCBlcnJvcjonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjoge1xuICAgICAgICBjb2RlOiAnQVVUSF9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6ICdBdXRob3JpemF0aW9uIGZhaWxlZCdcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGF1dGhlbnRpY2F0ZVRva2VuLFxuICByZXF1aXJlQXV0aCxcbiAgcmVxdWlyZUFkbWluXG59OyJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsR0FBRyxHQUFHQyxPQUFPLENBQUMsY0FBYyxDQUFDO0FBQ25DLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQ3RDLE1BQU1FLFdBQVcsR0FBR0YsT0FBTyxDQUFDLHlCQUF5QixDQUFDOztBQUV0RDtBQUNBLE1BQU1HLGlCQUFpQixHQUFHLE1BQUFBLENBQU9DLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEtBQUs7RUFDbEQsSUFBSTtJQUNGLE1BQU1DLFVBQVUsR0FBR0gsR0FBRyxDQUFDSSxPQUFPLENBQUMsZUFBZSxDQUFDO0lBQy9DLE1BQU1DLEtBQUssR0FBR0YsVUFBVSxJQUFJQSxVQUFVLENBQUNHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOztJQUV0RCxJQUFJLENBQUNELEtBQUssRUFBRTtNQUNWTCxHQUFHLENBQUNPLElBQUksR0FBRyxJQUFJO01BQ2YsT0FBT0wsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCOztJQUVBO0lBQ0EsSUFBSU0sT0FBTyxFQUFFRCxJQUFJO0lBQ2pCLElBQUk7TUFDRixNQUFNRSxVQUFVLEdBQUcsTUFBTVgsV0FBVyxDQUFDWSxtQkFBbUIsQ0FBQ0wsS0FBSyxDQUFDO01BQy9ELElBQUlJLFVBQVUsQ0FBQ0UsS0FBSyxFQUFFO1FBQ3BCSCxPQUFPLEdBQUdDLFVBQVUsQ0FBQ0QsT0FBTztRQUM1QkQsSUFBSSxHQUFHRSxVQUFVLENBQUNGLElBQUk7TUFDeEIsQ0FBQyxNQUFNO1FBQ0xQLEdBQUcsQ0FBQ08sSUFBSSxHQUFHLElBQUk7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