{"version":3,"names":["mongoose","require","cartSchema","Schema","sessionId","type","String","required","unique","index","sparse","items","product","Types","ObjectId","ref","quantity","Number","min","max","price","addedAt","Date","default","now","expiresAt","expires","timestamps","updatedAt","methods","calculateTotals","subtotal","reduce","total","item","itemCount","Math","round","addItem","productId","existingItemIndex","findIndex","toString","push","getTime","updateItem","itemIndex","splice","removeItem","clearCart","module","exports","model"],"sources":["Cart.js"],"sourcesContent":["const mongoose = require('mongoose');\n\nconst cartSchema = new mongoose.Schema({\n  sessionId: {\n    type: String,\n    required: true,\n    unique: true,\n    index: true,\n    sparse: true // Allow for better handling of duplicates during cleanup\n  },\n  items: [{\n    product: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'Product',\n      required: true\n    },\n    quantity: {\n      type: Number,\n      required: true,\n      min: 1,\n      max: 99\n    },\n    price: {\n      type: Number,\n      required: true\n    },\n    addedAt: {\n      type: Date,\n      default: Date.now\n    }\n  }],\n  expiresAt: {\n    type: Date,\n    default: Date.now,\n    expires: 2592000 // 30 days in seconds\n  }\n}, {\n  timestamps: true\n});\n\n// Indexes for performance\ncartSchema.index({ sessionId: 1 }, { unique: true });\ncartSchema.index({ expiresAt: 1 });\ncartSchema.index({ updatedAt: 1 }); // For cleanup queries\n\n// Method to calculate cart totals\ncartSchema.methods.calculateTotals = function() {\n  const subtotal = this.items.reduce((total, item) => total + (item.price * item.quantity), 0);\n  return {\n    itemCount: this.items.reduce((total, item) => total + item.quantity, 0),\n    subtotal: Math.round(subtotal * 100) / 100,\n    total: Math.round(subtotal * 100) / 100 // Can add tax/shipping later\n  };\n};\n\n// Method to add item to cart\ncartSchema.methods.addItem = function(productId, quantity, price) {\n  const existingItemIndex = this.items.findIndex(item => \n    item.product.toString() === productId.toString()\n  );\n\n  if (existingItemIndex >= 0) {\n    // Update existing item\n    this.items[existingItemIndex].quantity += quantity;\n    this.items[existingItemIndex].addedAt = new Date();\n  } else {\n    // Add new item\n    this.items.push({\n      product: productId,\n      quantity,\n      price,\n      addedAt: new Date()\n    });\n  }\n  \n  this.updatedAt = new Date();\n  // Only extend expiry if cart is not already expired and hasn't been extended recently\n  const now = new Date();\n  if (!this.expiresAt || this.expiresAt < now) {\n    this.expiresAt = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days from now\n  }\n};\n\n// Method to update item quantity\ncartSchema.methods.updateItem = function(productId, quantity) {\n  const itemIndex = this.items.findIndex(item => \n    item.product.toString() === productId.toString()\n  );\n\n  if (itemIndex >= 0) {\n    if (quantity <= 0) {\n      this.items.splice(itemIndex, 1);\n    } else {\n      this.items[itemIndex].quantity = quantity;\n      this.items[itemIndex].addedAt = new Date();\n    }\n    this.updatedAt = new Date();\n    return true;\n  }\n  return false;\n};\n\n// Method to remove item\ncartSchema.methods.removeItem = function(productId) {\n  const itemIndex = this.items.findIndex(item => \n    item.product.toString() === productId.toString()\n  );\n\n  if (itemIndex >= 0) {\n    this.items.splice(itemIndex, 1);\n    this.updatedAt = new Date();\n    return true;\n  }\n  return false;\n};\n\n// Method to clear cart\ncartSchema.methods.clearCart = function() {\n  this.items = [];\n  this.updatedAt = new Date();\n};\n\nmodule.exports = mongoose.model('Cart', cartSchema);"],"mappings":"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","ignoreList":[]}