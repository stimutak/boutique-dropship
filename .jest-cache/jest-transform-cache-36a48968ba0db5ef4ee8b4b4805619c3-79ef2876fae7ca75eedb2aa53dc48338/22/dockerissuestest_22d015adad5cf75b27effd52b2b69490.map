{"version":3,"names":["request","require","app","describe","beforeAll","Promise","resolve","setTimeout","afterAll","test","response","get","expect","body","success","toBe","data","products","toBeInstanceOf","Array","length","toBeGreaterThan","toHaveProperty","set","headers","testUser","email","password","firstName","lastName","post","send","user","cookies","toBeDefined","tokenCookie","find","cookie","startsWith","toContain","loginResponse","profileResponse","options","endpoints","endpoint","res","status"],"sources":["docker-issues.test.js"],"sourcesContent":["const request = require('supertest');\nconst app = require('../server');\n\ndescribe('Docker Environment Issues - Bug Reproduction', () => {\n  // These tests focus on API communication issues, not database operations\n  \n  beforeAll(async () => {\n    // Wait for server to be ready\n    await new Promise(resolve => setTimeout(resolve, 1000));\n  });\n\n  afterAll(async () => {\n    // Clean up without closing mongoose (handled by test setup)\n  });\n\n  describe('Issue #1: Products not displaying on frontend', () => {\n    test('GET /api/products should return products list', async () => {\n      const response = await request(app)\n        .get('/api/products')\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data.products).toBeInstanceOf(Array);\n      expect(response.body.data.products.length).toBeGreaterThan(0);\n      expect(response.body.data.products[0]).toHaveProperty('name');\n      expect(response.body.data.products[0]).toHaveProperty('price');\n    });\n\n    test('Frontend API calls should work with proxy configuration', async () => {\n      // This test simulates the frontend making an API call\n      // In Docker, the frontend nginx needs to proxy /api calls to backend\n      const response = await request(app)\n        .get('/api/products')\n        .set('Origin', 'http://localhost:3001')\n        .set('Referer', 'http://localhost:3001/products')\n        .expect(200);\n\n      // Check CORS headers are set correctly\n      expect(response.headers['access-control-allow-origin']).toBe('http://localhost:3001');\n      expect(response.headers['access-control-allow-credentials']).toBe('true');\n    });\n  });\n\n  describe('Issue #2: User login not working', () => {\n    const testUser = {\n      email: 'docker-test@example.com',\n      password: 'Password123!',\n      firstName: 'Docker',\n      lastName: 'Test'\n    };\n\n    test('POST /api/auth/register should create user and set httpOnly cookie', async () => {\n      const response = await request(app)\n        .post('/api/auth/register')\n        .send(testUser)\n        .expect(201);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data.user).toHaveProperty('email', testUser.email);\n      \n      // Check for httpOnly cookie\n      const cookies = response.headers['set-cookie'];\n      expect(cookies).toBeDefined();\n      const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));\n      expect(tokenCookie).toBeDefined();\n      expect(tokenCookie).toContain('HttpOnly');\n      expect(tokenCookie).toContain('Path=/');\n    });\n\n    test('POST /api/auth/login should authenticate user and set httpOnly cookie', async () => {\n      // First register the user\n      await request(app)\n        .post('/api/auth/register')\n        .send(testUser);\n\n      const response = await request(app)\n        .post('/api/auth/login')\n        .send({\n          email: testUser.email,\n          password: testUser.password\n        })\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data.user).toHaveProperty('email', testUser.email);\n      \n      // Check for httpOnly cookie\n      const cookies = response.headers['set-cookie'];\n      expect(cookies).toBeDefined();\n      const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));\n      expect(tokenCookie).toBeDefined();\n      expect(tokenCookie).toContain('HttpOnly');\n    });\n\n    test('Protected routes should work with httpOnly cookie authentication', async () => {\n      // Register and login to get cookie\n      const loginResponse = await request(app)\n        .post('/api/auth/register')\n        .send(testUser);\n\n      const cookies = loginResponse.headers['set-cookie'];\n      \n      // Try to access protected route with cookie\n      const profileResponse = await request(app)\n        .get('/api/auth/profile')\n        .set('Cookie', cookies)\n        .expect(200);\n\n      expect(profileResponse.body.success).toBe(true);\n      expect(profileResponse.body.data.user.email).toBe(testUser.email);\n    });\n  });\n\n  describe('Issue #3: Frontend-Backend communication in Docker', () => {\n    test('CORS should allow frontend origin', async () => {\n      const response = await request(app)\n        .options('/api/products')\n        .set('Origin', 'http://localhost:3001')\n        .set('Access-Control-Request-Method', 'GET')\n        .expect(204);\n\n      expect(response.headers['access-control-allow-origin']).toBe('http://localhost:3001');\n      expect(response.headers['access-control-allow-credentials']).toBe('true');\n    });\n\n    test('API should handle requests without VITE_API_URL', async () => {\n      // When frontend uses relative URLs, they should work\n      const response = await request(app)\n        .get('/api/products')\n        .set('Host', 'localhost:5001')\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n    });\n\n    test('CSRF token endpoint should work', async () => {\n      const response = await request(app)\n        .get('/api/csrf-token')\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body).toHaveProperty('csrfToken');\n    });\n  });\n\n  describe('Docker nginx proxy configuration issues', () => {\n    test('API endpoints should be accessible through correct paths', async () => {\n      const endpoints = [\n        '/api/products',\n        '/api/csrf-token',\n        '/health'\n      ];\n\n      for (const endpoint of endpoints) {\n        const response = await request(app)\n          .get(endpoint)\n          .expect(200);\n\n        expect(response.body).toBeDefined();\n      }\n    });\n\n    test('Static image paths should be configured correctly', async () => {\n      // In Docker, /images should be served by backend\n      const response = await request(app)\n        .get('/images/test.jpg')\n        .expect((res) => {\n          // Should either return 200 (if exists) or 404 (if not exists)\n          // but not 500 or other errors\n          expect([200, 404]).toContain(res.status);\n        });\n    });\n  });\n});"],"mappings":"AAAA,MAAMA,OAAO,GAAGC,OAAO,CAAC,WAAW,CAAC;AACpC,MAAMC,GAAG,GAAGD,OAAO,CAAC,WAAW,CAAC;AAEhCE,QAAQ,CAAC,8CAA8C,EAAE,MAAM;EAC7D;;EAEAC,SAAS,CAAC,YAAY;IACpB;IACA,MAAM,IAAIC,OAAO,CAACC,OAAO,IAAIC,UAAU,CAACD,OAAO,EAAE,IAAI,CAAC,CAAC;EACzD,CAAC,CAAC;EAEFE,QAAQ,CAAC,YAAY;IACnB;EAAA,CACD,CAAC;EAEFL,QAAQ,CAAC,+CAA+C,EAAE,MAAM;IAC9DM,IAAI,CAAC,+CAA+C,EAAE,YAAY;MAChE,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCS,GAAG,CAAC,eAAe,CAAC,CACpBC,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MACxCH,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACG,IAAI,CAACC,QAAQ,CAAC,CAACC,cAAc,CAACC,KAAK,CAAC;MACzDP,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACG,IAAI,CAACC,QAAQ,CAACG,MAAM,CAAC,CAACC,eAAe,CAAC,CAAC,CAAC;MAC7DT,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACG,IAAI,CAACC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAACK,cAAc,CAAC,MAAM,CAAC;MAC7DV,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACG,IAAI,CAACC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAACK,cAAc,CAAC,OAAO,CAAC;IAChE,CAAC,CAAC;IAEFb,IAAI,CAAC,yDAAyD,EAAE,YAAY;MAC1E;MACA;MACA,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCS,GAAG,CAAC,eAAe,CAAC,CACpBY,GAAG,CAAC,QAAQ,EAAE,uBAAuB,CAAC,CACtCA,GAAG,CAAC,SAAS,EAAE,gCAAgC,CAAC,CAChDX,MAAM,CAAC,GAAG,CAAC;;MAEd;MACAA,MAAM,CAACF,QAAQ,CAACc,OAAO,CAAC,6BAA6B,CAAC,CAAC,CAACT,IAAI,CAAC,uBAAuB,CAAC;MACrFH,MAAM,CAACF,QAAQ,CAACc,OAAO,CAAC,kCAAkC,CAAC,CAAC,CAACT,IAAI,CAAC,MAAM,CAAC;IAC3E,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFZ,QAAQ,CAAC,kCAAkC,EAAE,MAAM;IACjD,MAAMsB,QAAQ,GAAG;MACfC,KAAK,EAAE,yBAAyB;MAChCC,QAAQ,EAAE,cAAc;MACxBC,SAAS,EAAE,QAAQ;MACnBC,QAAQ,EAAE;IACZ,CAAC;IAEDpB,IAAI,CAAC,oEAAoE,EAAE,YAAY;MACrF,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChC4B,IAAI,CAAC,oBAAoB,CAAC,CAC1BC,IAAI,CAACN,QAAQ,CAAC,CACdb,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MACxCH,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACG,IAAI,CAACgB,IAAI,CAAC,CAACV,cAAc,CAAC,OAAO,EAAEG,QAAQ,CAACC,KAAK,CAAC;;MAEvE;MACA,MAAMO,OAAO,GAAGvB,QAAQ,CAACc,OAAO,CAAC,YAAY,CAAC;MAC9CZ,MAAM,CAACqB,OAAO,CAAC,CAACC,WAAW,CAAC,CAAC;MAC7B,MAAMC,WAAW,GAAGF,OAAO,CAACG,IAAI,CAACC,MAAM,IAAIA,MAAM,CAACC,UAAU,CAAC,QAAQ,CAAC,CAAC;MACvE1B,MAAM,CAACuB,WAAW,CAAC,CAACD,WAAW,CAAC,CAAC;MACjCtB,MAAM,CAACuB,WAAW,CAAC,CAACI,SAAS,CAAC,UAAU,CAAC;MACzC3B,MAAM,CAACuB,WAAW,CAAC,CAACI,SAAS,CAAC,QAAQ,CAAC;IACzC,CAAC,CAAC;IAEF9B,IAAI,CAAC,uEAAuE,EAAE,YAAY;MACxF;MACA,MAAMT,OAAO,CAACE,GAAG,CAAC,CACf4B,IAAI,CAAC,oBAAoB,CAAC,CAC1BC,IAAI,CAACN,QAAQ,CAAC;MAEjB,MAAMf,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChC4B,IAAI,CAAC,iBAAiB,CAAC,CACvBC,IAAI,CAAC;QACJL,KAAK,EAAED,QAAQ,CAACC,KAAK;QACrBC,QAAQ,EAAEF,QAAQ,CAACE;MACrB,CAAC,CAAC,CACDf,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MACxCH,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACG,IAAI,CAACgB,IAAI,CAAC,CAACV,cAAc,CAAC,OAAO,EAAEG,QAAQ,CAACC,KAAK,CAAC;;MAEvE;MACA,MAAMO,OAAO,GAAGvB,QAAQ,CAACc,OAAO,CAAC,YAAY,CAAC;MAC9CZ,MAAM,CAACqB,OAAO,CAAC,CAACC,WAAW,CAAC,CAAC;MAC7B,MAAMC,WAAW,GAAGF,OAAO,CAACG,IAAI,CAACC,MAAM,IAAIA,MAAM,CAACC,UAAU,CAAC,QAAQ,CAAC,CAAC;MACvE1B,MAAM,CAACuB,WAAW,CAAC,CAACD,WAAW,CAAC,CAAC;MACjCtB,MAAM,CAACuB,WAAW,CAAC,CAACI,SAAS,CAAC,UAAU,CAAC;IAC3C,CAAC,CAAC;IAEF9B,IAAI,CAAC,kEAAkE,EAAE,YAAY;MACnF;MACA,MAAM+B,aAAa,GAAG,MAAMxC,OAAO,CAACE,GAAG,CAAC,CACrC4B,IAAI,CAAC,oBAAoB,CAAC,CAC1BC,IAAI,CAACN,QAAQ,CAAC;MAEjB,MAAMQ,OAAO,GAAGO,aAAa,CAAChB,OAAO,CAAC,YAAY,CAAC;;MAEnD;MACA,MAAMiB,eAAe,GAAG,MAAMzC,OAAO,CAACE,GAAG,CAAC,CACvCS,GAAG,CAAC,mBAAmB,CAAC,CACxBY,GAAG,CAAC,QAAQ,EAAEU,OAAO,CAAC,CACtBrB,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAAC6B,eAAe,CAAC5B,IAAI,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MAC/CH,MAAM,CAAC6B,eAAe,CAAC5B,IAAI,CAACG,IAAI,CAACgB,IAAI,CAACN,KAAK,CAAC,CAACX,IAAI,CAACU,QAAQ,CAACC,KAAK,CAAC;IACnE,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFvB,QAAQ,CAAC,oDAAoD,EAAE,MAAM;IACnEM,IAAI,CAAC,mCAAmC,EAAE,YAAY;MACpD,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCwC,OAAO,CAAC,eAAe,CAAC,CACxBnB,GAAG,CAAC,QAAQ,EAAE,uBAAuB,CAAC,CACtCA,GAAG,CAAC,+BAA+B,EAAE,KAAK,CAAC,CAC3CX,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAACF,QAAQ,CAACc,OAAO,CAAC,6BAA6B,CAAC,CAAC,CAACT,IAAI,CAAC,uBAAuB,CAAC;MACrFH,MAAM,CAACF,QAAQ,CAACc,OAAO,CAAC,kCAAkC,CAAC,CAAC,CAACT,IAAI,CAAC,MAAM,CAAC;IAC3E,CAAC,CAAC;IAEFN,IAAI,CAAC,iDAAiD,EAAE,YAAY;MAClE;MACA,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCS,GAAG,CAAC,eAAe,CAAC,CACpBY,GAAG,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAC7BX,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;IAC1C,CAAC,CAAC;IAEFN,IAAI,CAAC,iCAAiC,EAAE,YAAY;MAClD,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCS,GAAG,CAAC,iBAAiB,CAAC,CACtBC,MAAM,CAAC,GAAG,CAAC;MAEdA,MAAM,CAACF,QAAQ,CAACG,IAAI,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MACxCH,MAAM,CAACF,QAAQ,CAACG,IAAI,CAAC,CAACS,cAAc,CAAC,WAAW,CAAC;IACnD,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFnB,QAAQ,CAAC,yCAAyC,EAAE,MAAM;IACxDM,IAAI,CAAC,0DAA0D,EAAE,YAAY;MAC3E,MAAMkC,SAAS,GAAG,CAChB,eAAe,EACf,iBAAiB,EACjB,SAAS,CACV;MAED,KAAK,MAAMC,QAAQ,IAAID,SAAS,EAAE;QAChC,MAAMjC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCS,GAAG,CAACiC,QAAQ,CAAC,CACbhC,MAAM,CAAC,GAAG,CAAC;QAEdA,MAAM,CAACF,QAAQ,CAACG,IAAI,CAAC,CAACqB,WAAW,CAAC,CAAC;MACrC;IACF,CAAC,CAAC;IAEFzB,IAAI,CAAC,mDAAmD,EAAE,YAAY;MACpE;MACA,MAAMC,QAAQ,GAAG,MAAMV,OAAO,CAACE,GAAG,CAAC,CAChCS,GAAG,CAAC,kBAAkB,CAAC,CACvBC,MAAM,CAAEiC,GAAG,IAAK;QACf;QACA;QACAjC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC2B,SAAS,CAACM,GAAG,CAACC,MAAM,CAAC;MAC1C,CAAC,CAAC;IACN,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}