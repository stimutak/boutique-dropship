{"version":3,"names":["express","require","mongoose","cors","helmet","rateLimit","session","MongoStore","cookieParser","path","config","console","log","process","env","NODE_ENV","PORT","JWT_SECRET","length","error","exit","logger","globalErrorHandler","i18nMiddleware","errorResponse","rateLimits","speedLimiter","sanitizeInput","securityHeaders","app","use","corsOptions","origin","callback","allowedOrigins","ALLOWED_ORIGINS","split","indexOf","warn","Error","credentials","methods","allowedHeaders","exposedHeaders","general","createSessionConfig","generateCSRFToken","validateCSRFToken","enhanceGuestSession","cleanupGuestSession","mongoUrl","MONGODB_URI","json","limit","urlencoded","extended","static","connect","useNewUrlParser","useUnifiedTopology","then","catch","message","connection","on","auth","payment","integration","admin","get","req","res","status","timestamp","Date","toISOString","success","csrfToken","sessionInfo","isGuest","user","guestId","hasCart","cart","items","version","endpoints","health","products","orders","payments","frontend","FRONTEND_URL","sendFile","join","__dirname","listen","info","module","exports"],"sources":["server.js"],"sourcesContent":["const express = require('express');\nconst mongoose = require('mongoose');\nconst cors = require('cors');\nconst helmet = require('helmet');\nconst rateLimit = require('express-rate-limit');\nconst session = require('express-session');\nconst MongoStore = require('connect-mongo');\nconst cookieParser = require('cookie-parser');\nconst path = require('path');\nrequire('dotenv').config();\n\n// Debug: Log environment variables\nconsole.log('Environment variables loaded:');\nconsole.log('NODE_ENV:', process.env.NODE_ENV);\nconsole.log('PORT:', process.env.PORT);\nconsole.log('JWT_SECRET exists:', !!process.env.JWT_SECRET);\nconsole.log('JWT_SECRET length:', process.env.JWT_SECRET ? process.env.JWT_SECRET.length : 0);\n\n// Validate critical environment variables at startup\nif (!process.env.JWT_SECRET && process.env.NODE_ENV !== 'test') {\n  console.error('FATAL ERROR: JWT_SECRET environment variable is not set. This is required for secure token generation.');\n  process.exit(1);\n}\n\nif (!process.env.JWT_SECRET || process.env.JWT_SECRET.length < 32) {\n  if (process.env.NODE_ENV !== 'test') {\n    console.error('FATAL ERROR: JWT_SECRET must be at least 32 characters long for security.');\n    console.error('Current JWT_SECRET length:', process.env.JWT_SECRET ? process.env.JWT_SECRET.length : 0);\n    process.exit(1);\n  }\n}\n\n// Import logging and error handling\nconst { logger } = require('./utils/logger');\nconst { globalErrorHandler } = require('./middleware/errorHandler');\nconst { i18nMiddleware } = require('./utils/i18n');\nconst { errorResponse } = require('./utils/errorHandler');\nconst { \n  rateLimits, \n  speedLimiter, \n  sanitizeInput, \n  securityHeaders \n} = require('./middleware/security');\n\nconst app = express();\n\n// Security middleware\napp.use(helmet());\napp.use(securityHeaders);\n// Configure CORS with explicit settings for Docker environment\nconst corsOptions = {\n  origin: function (origin, callback) {\n    const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [\n      'http://localhost:3000',\n      'http://localhost:3001', \n      'http://localhost:3003',\n      'http://localhost:5173'\n    ];\n    \n    // Allow requests with no origin (like mobile apps or Postman)\n    if (!origin) return callback(null, true);\n    \n    // Check if the origin is allowed\n    if (allowedOrigins.indexOf(origin) !== -1) {\n      callback(null, true);\n    } else {\n      console.warn('CORS blocked origin:', origin);\n      callback(new Error('Not allowed by CORS'));\n    }\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization', 'x-csrf-token', 'x-guest-session-id', 'x-locale', 'x-currency', 'Cookie'],\n  exposedHeaders: ['set-cookie']\n};\n\napp.use(cors(corsOptions));\n\n// Input sanitization\napp.use(sanitizeInput);\n\n// General rate limiting\napp.use(rateLimits.general);\n\n// Speed limiting for brute force protection\napp.use(speedLimiter);\n\n// Import unified session/CSRF management\nconst { \n  createSessionConfig, \n  generateCSRFToken,\n  validateCSRFToken,\n  enhanceGuestSession,\n  cleanupGuestSession \n} = require('./middleware/sessionCSRF');\n\n// Session middleware with unified config\nconst mongoUrl = process.env.MONGODB_URI || 'mongodb://localhost:27017/holistic-store';\napp.use(session(createSessionConfig(mongoUrl)));\n\n// Session enhancement middleware\napp.use(generateCSRFToken);\napp.use(enhanceGuestSession);\napp.use(cleanupGuestSession);\n\n// Body parsing middleware\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true }));\n\n// Cookie parser middleware\napp.use(cookieParser());\n\n// i18n middleware for error messages\napp.use(i18nMiddleware);\n\n// Error response helper middleware\napp.use(errorResponse);\n\n// Static files\napp.use('/uploads', express.static('uploads'));\napp.use(express.static('public'));\n\n// Database connection\nmongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/holistic-store', {\n  useNewUrlParser: true,\n  useUnifiedTopology: true,\n}).then(() => {\n  console.log('Connected to MongoDB');\n}).catch((error) => {\n  console.warn('MongoDB connection failed:', error.message);\n  console.warn('Running in development mode without database');\n});\n\n// Handle MongoDB connection events\nmongoose.connection.on('error', (error) => {\n  console.warn('MongoDB connection error:', error.message);\n});\n\nmongoose.connection.on('disconnected', () => {\n  console.warn('MongoDB disconnected');\n});\n\n// Routes with specific rate limiting\napp.use('/api/auth', rateLimits.auth, require('./routes/auth'));\napp.use('/api/products', require('./routes/products'));\napp.use('/api/cart', require('./routes/cart'));\napp.use('/api/orders', require('./routes/orders'));\napp.use('/api/payments', rateLimits.payment, require('./routes/payments'));\napp.use('/api/wholesalers', require('./routes/wholesalers'));\napp.use('/api/integration', rateLimits.integration, require('./routes/integration'));\napp.use('/api/admin', rateLimits.admin, require('./routes/admin'));\napp.use('/api/monitoring', require('./routes/monitoring'));\n\n// Health check\napp.get('/health', (req, res) => {\n  res.json({ status: 'OK', timestamp: new Date().toISOString() });\n});\n\n// CSRF token endpoint\napp.get('/api/csrf-token', (req, res) => {\n  res.json({ \n    success: true,\n    csrfToken: req.session.csrfToken,\n    sessionInfo: {\n      isGuest: !req.user && !!req.session.guestId,\n      hasCart: !!req.session.cart && !!req.session.cart.items && req.session.cart.items.length > 0\n    }\n  });\n});\n\n// Root route for API info\napp.get('/', (req, res) => {\n  res.json({\n    message: 'Holistic Dropship Store API',\n    version: '1.0.0',\n    endpoints: {\n      health: '/health',\n      auth: '/api/auth',\n      products: '/api/products',\n      cart: '/api/cart',\n      orders: '/api/orders',\n      payments: '/api/payments'\n    },\n    frontend: process.env.FRONTEND_URL || 'http://localhost:3000'\n  });\n});\n\n// Global error handling middleware (must be last)\napp.use(globalErrorHandler);\n\n// Serve React app in production\nif (process.env.NODE_ENV === 'production') {\n  app.get('*', (req, res) => {\n    res.sendFile(path.join(__dirname, 'build', 'index.html'));\n  });\n}\n\nconst PORT = process.env.PORT || 5001;\n\n// Only start server if not in test mode\nif (process.env.NODE_ENV !== 'test') {\n  app.listen(PORT, () => {\n    logger.info(`Server running on port ${PORT}`);\n  });\n}\n\n// Export app for testing\nmodule.exports = app;"],"mappings":"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","ignoreList":[]}