3601c1284fefaf8fdf0be49a2c4f2634
const mongoose = require('mongoose');
const orderSchema = new mongoose.Schema({
  orderNumber: {
    type: String,
    unique: true
  },
  customer: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: false // Allow guest checkout
  },
  guestInfo: {
    email: {
      type: String,
      required: function () {
        return !this.customer;
      },
      lowercase: true,
      trim: true
    },
    firstName: {
      type: String,
      required: function () {
        return !this.customer;
      },
      trim: true
    },
    lastName: {
      type: String,
      required: function () {
        return !this.customer;
      },
      trim: true
    },
    phone: {
      type: String,
      trim: true
    }
  },
  items: [{
    product: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'Product',
      required: true
    },
    quantity: {
      type: Number,
      required: true,
      min: 1
    },
    price: {
      type: Number,
      required: true
    },
    wholesaler: {
      name: String,
      email: String,
      productCode: String,
      notified: {
        type: Boolean,
        default: false
      },
      notifiedAt: Date,
      notificationAttempts: {
        type: Number,
        default: 0
      },
      lastNotificationError: String
    }
  }],
  shippingAddress: {
    firstName: {
      type: String,
      required: true
    },
    lastName: {
      type: String,
      required: true
    },
    street: {
      type: String,
      required: true
    },
    city: {
      type: String,
      required: true
    },
    state: {
      type: String,
      required: true
    },
    zipCode: {
      type: String,
      required: true
    },
    country: {
      type: String,
      required: true,
      default: 'US'
    },
    phone: String
  },
  billingAddress: {
    firstName: {
      type: String,
      required: true
    },
    lastName: {
      type: String,
      required: true
    },
    street: {
      type: String,
      required: true
    },
    city: {
      type: String,
      required: true
    },
    state: {
      type: String,
      required: true
    },
    zipCode: {
      type: String,
      required: true
    },
    country: {
      type: String,
      required: true,
      default: 'US'
    }
  },
  subtotal: {
    type: Number,
    required: true
  },
  tax: {
    type: Number,
    default: 0
  },
  shipping: {
    type: Number,
    default: 0
  },
  total: {
    type: Number,
    required: true
  },
  payment: {
    method: {
      type: String,
      enum: ['card', 'crypto', 'other'],
      required: true
    },
    status: {
      type: String,
      enum: ['pending', 'paid', 'failed', 'refunded'],
      default: 'pending'
    },
    molliePaymentId: String,
    transactionId: String,
    paidAt: Date
  },
  status: {
    type: String,
    enum: ['pending', 'processing', 'shipped', 'delivered', 'cancelled'],
    default: 'pending'
  },
  trackingNumber: String,
  notes: String,
  referralSource: String,
  // Track which sister site referred this order
  // Multi-currency support
  currency: {
    type: String,
    required: true,
    default: 'USD',
    enum: ['USD', 'EUR', 'CNY', 'JPY', 'SAR', 'GBP', 'CAD']
  },
  exchangeRate: {
    type: Number,
    required: true,
    default: 1
  }
}, {
  timestamps: true
});

// Indexes for performance
orderSchema.index({
  orderNumber: 1
});
orderSchema.index({
  customer: 1,
  createdAt: -1
});
orderSchema.index({
  'guestInfo.email': 1
});
orderSchema.index({
  status: 1
});
orderSchema.index({
  'payment.status': 1
});
orderSchema.index({
  referralSource: 1
});
orderSchema.index({
  createdAt: -1
});
orderSchema.index({
  'items.wholesaler.notified': 1
});

// Pre-save middleware
orderSchema.pre('save', function (next) {
  if (!this.orderNumber) {
    this.orderNumber = 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
  }
  next();
});

// Method to get customer email (works for both guest and registered users)
orderSchema.methods.getCustomerEmail = function () {
  if (this.customer && this.populated('customer')) {
    return this.customer.email;
  }
  return this.guestInfo.email;
};

// Method to get customer name
orderSchema.methods.getCustomerName = function () {
  if (this.customer && this.populated('customer')) {
    return `${this.customer.firstName} ${this.customer.lastName}`;
  }
  return `${this.guestInfo.firstName} ${this.guestInfo.lastName}`;
};

// Method to check if all wholesalers have been notified
orderSchema.methods.allWholesalersNotified = function () {
  return this.items.every(item => item.wholesaler.notified);
};

// Method to get pending wholesaler notifications
orderSchema.methods.getPendingNotifications = function () {
  return this.items.filter(item => !item.wholesaler.notified);
};

// Method to update wholesaler notification status
orderSchema.methods.updateWholesalerNotification = function (itemId, success, error = null) {
  const item = this.items.id(itemId);
  if (item) {
    item.wholesaler.notificationAttempts += 1;
    if (success) {
      item.wholesaler.notified = true;
      item.wholesaler.notifiedAt = new Date();
      item.wholesaler.lastNotificationError = null;
    } else {
      item.wholesaler.lastNotificationError = error;
    }
  }
  return this.save();
};

// Static method to find orders needing wholesaler notification
orderSchema.statics.findPendingNotifications = function () {
  return this.find({
    'payment.status': 'paid',
    'items.wholesaler.notified': false
  });
};

// Method to get public order data (excludes sensitive wholesaler info)
orderSchema.methods.toPublicJSON = function () {
  const order = this.toObject();

  // Remove sensitive wholesaler information from items
  if (order.items) {
    order.items = order.items.map(item => {
      const publicItem = {
        ...item
      };
      if (publicItem.wholesaler) {
        // Keep only notification status, remove sensitive details
        publicItem.wholesaler = {
          notified: item.wholesaler.notified,
          notifiedAt: item.wholesaler.notifiedAt
        };
      }
      return publicItem;
    });
  }
  return order;
};

// Hook trigger comment - wholesaler notification check
// Referral tracking hook test

module.exports = mongoose.model('Order', orderSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJvcmRlclNjaGVtYSIsIlNjaGVtYSIsIm9yZGVyTnVtYmVyIiwidHlwZSIsIlN0cmluZyIsInVuaXF1ZSIsImN1c3RvbWVyIiwiVHlwZXMiLCJPYmplY3RJZCIsInJlZiIsInJlcXVpcmVkIiwiZ3Vlc3RJbmZvIiwiZW1haWwiLCJsb3dlcmNhc2UiLCJ0cmltIiwiZmlyc3ROYW1lIiwibGFzdE5hbWUiLCJwaG9uZSIsIml0ZW1zIiwicHJvZHVjdCIsInF1YW50aXR5IiwiTnVtYmVyIiwibWluIiwicHJpY2UiLCJ3aG9sZXNhbGVyIiwibmFtZSIsInByb2R1Y3RDb2RlIiwibm90aWZpZWQiLCJCb29sZWFuIiwiZGVmYXVsdCIsIm5vdGlmaWVkQXQiLCJEYXRlIiwibm90aWZpY2F0aW9uQXR0ZW1wdHMiLCJsYXN0Tm90aWZpY2F0aW9uRXJyb3IiLCJzaGlwcGluZ0FkZHJlc3MiLCJzdHJlZXQiLCJjaXR5Iiwic3RhdGUiLCJ6aXBDb2RlIiwiY291bnRyeSIsImJpbGxpbmdBZGRyZXNzIiwic3VidG90YWwiLCJ0YXgiLCJzaGlwcGluZyIsInRvdGFsIiwicGF5bWVudCIsIm1ldGhvZCIsImVudW0iLCJzdGF0dXMiLCJtb2xsaWVQYXltZW50SWQiLCJ0cmFuc2FjdGlvbklkIiwicGFpZEF0IiwidHJhY2tpbmdOdW1iZXIiLCJub3RlcyIsInJlZmVycmFsU291cmNlIiwiY3VycmVuY3kiLCJleGNoYW5nZVJhdGUiLCJ0aW1lc3RhbXBzIiwiaW5kZXgiLCJjcmVhdGVkQXQiLCJwcmUiLCJuZXh0Iiwibm93IiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic3Vic3RyIiwidG9VcHBlckNhc2UiLCJtZXRob2RzIiwiZ2V0Q3VzdG9tZXJFbWFpbCIsInBvcHVsYXRlZCIsImdldEN1c3RvbWVyTmFtZSIsImFsbFdob2xlc2FsZXJzTm90aWZpZWQiLCJldmVyeSIsIml0ZW0iLCJnZXRQZW5kaW5nTm90aWZpY2F0aW9ucyIsImZpbHRlciIsInVwZGF0ZVdob2xlc2FsZXJOb3RpZmljYXRpb24iLCJpdGVtSWQiLCJzdWNjZXNzIiwiZXJyb3IiLCJpZCIsInNhdmUiLCJzdGF0aWNzIiwiZmluZFBlbmRpbmdOb3RpZmljYXRpb25zIiwiZmluZCIsInRvUHVibGljSlNPTiIsIm9yZGVyIiwidG9PYmplY3QiLCJtYXAiLCJwdWJsaWNJdGVtIiwibW9kdWxlIiwiZXhwb3J0cyIsIm1vZGVsIl0sInNvdXJjZXMiOlsiT3JkZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbW9uZ29vc2UgPSByZXF1aXJlKCdtb25nb29zZScpO1xuXG5jb25zdCBvcmRlclNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xuICBvcmRlck51bWJlcjoge1xuICAgIHR5cGU6IFN0cmluZyxcbiAgICB1bmlxdWU6IHRydWVcbiAgfSxcbiAgY3VzdG9tZXI6IHtcbiAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgcmVmOiAnVXNlcicsXG4gICAgcmVxdWlyZWQ6IGZhbHNlIC8vIEFsbG93IGd1ZXN0IGNoZWNrb3V0XG4gIH0sXG4gIGd1ZXN0SW5mbzoge1xuICAgIGVtYWlsOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICByZXF1aXJlZDogZnVuY3Rpb24oKSB7IHJldHVybiAhdGhpcy5jdXN0b21lcjsgfSxcbiAgICAgIGxvd2VyY2FzZTogdHJ1ZSxcbiAgICAgIHRyaW06IHRydWVcbiAgICB9LFxuICAgIGZpcnN0TmFtZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuY3VzdG9tZXI7IH0sXG4gICAgICB0cmltOiB0cnVlXG4gICAgfSxcbiAgICBsYXN0TmFtZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuY3VzdG9tZXI7IH0sXG4gICAgICB0cmltOiB0cnVlXG4gICAgfSxcbiAgICBwaG9uZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgdHJpbTogdHJ1ZVxuICAgIH1cbiAgfSxcbiAgaXRlbXM6IFt7XG4gICAgcHJvZHVjdDoge1xuICAgICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLFxuICAgICAgcmVmOiAnUHJvZHVjdCcsXG4gICAgICByZXF1aXJlZDogdHJ1ZVxuICAgIH0sXG4gICAgcXVhbnRpdHk6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgbWluOiAxXG4gICAgfSxcbiAgICBwcmljZToge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICB9LFxuICAgIHdob2xlc2FsZXI6IHtcbiAgICAgIG5hbWU6IFN0cmluZyxcbiAgICAgIGVtYWlsOiBTdHJpbmcsXG4gICAgICBwcm9kdWN0Q29kZTogU3RyaW5nLFxuICAgICAgbm90aWZpZWQ6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfSxcbiAgICAgIG5vdGlmaWVkQXQ6IERhdGUsXG4gICAgICBub3RpZmljYXRpb25BdHRlbXB0czogeyB0eXBlOiBOdW1iZXIsIGRlZmF1bHQ6IDAgfSxcbiAgICAgIGxhc3ROb3RpZmljYXRpb25FcnJvcjogU3RyaW5nXG4gICAgfVxuICB9XSxcbiAgc2hpcHBpbmdBZGRyZXNzOiB7XG4gICAgZmlyc3ROYW1lOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBsYXN0TmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgc3RyZWV0OiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBjaXR5OiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICBzdGF0ZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgemlwQ29kZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgY291bnRyeTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlLCBkZWZhdWx0OiAnVVMnIH0sXG4gICAgcGhvbmU6IFN0cmluZ1xuICB9LFxuICBiaWxsaW5nQWRkcmVzczoge1xuICAgIGZpcnN0TmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgbGFzdE5hbWU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIHN0cmVldDogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgY2l0eTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgc3RhdGU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIHppcENvZGU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgIGNvdW50cnk6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSwgZGVmYXVsdDogJ1VTJyB9XG4gIH0sXG4gIHN1YnRvdGFsOiB7XG4gICAgdHlwZTogTnVtYmVyLFxuICAgIHJlcXVpcmVkOiB0cnVlXG4gIH0sXG4gIHRheDoge1xuICAgIHR5cGU6IE51bWJlcixcbiAgICBkZWZhdWx0OiAwXG4gIH0sXG4gIHNoaXBwaW5nOiB7XG4gICAgdHlwZTogTnVtYmVyLFxuICAgIGRlZmF1bHQ6IDBcbiAgfSxcbiAgdG90YWw6IHtcbiAgICB0eXBlOiBOdW1iZXIsXG4gICAgcmVxdWlyZWQ6IHRydWVcbiAgfSxcbiAgcGF5bWVudDoge1xuICAgIG1ldGhvZDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZW51bTogWydjYXJkJywgJ2NyeXB0bycsICdvdGhlciddLFxuICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICB9LFxuICAgIHN0YXR1czoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZW51bTogWydwZW5kaW5nJywgJ3BhaWQnLCAnZmFpbGVkJywgJ3JlZnVuZGVkJ10sXG4gICAgICBkZWZhdWx0OiAncGVuZGluZydcbiAgICB9LFxuICAgIG1vbGxpZVBheW1lbnRJZDogU3RyaW5nLFxuICAgIHRyYW5zYWN0aW9uSWQ6IFN0cmluZyxcbiAgICBwYWlkQXQ6IERhdGVcbiAgfSxcbiAgc3RhdHVzOiB7XG4gICAgdHlwZTogU3RyaW5nLFxuICAgIGVudW06IFsncGVuZGluZycsICdwcm9jZXNzaW5nJywgJ3NoaXBwZWQnLCAnZGVsaXZlcmVkJywgJ2NhbmNlbGxlZCddLFxuICAgIGRlZmF1bHQ6ICdwZW5kaW5nJ1xuICB9LFxuICB0cmFja2luZ051bWJlcjogU3RyaW5nLFxuICBub3RlczogU3RyaW5nLFxuICByZWZlcnJhbFNvdXJjZTogU3RyaW5nLCAvLyBUcmFjayB3aGljaCBzaXN0ZXIgc2l0ZSByZWZlcnJlZCB0aGlzIG9yZGVyXG4gIC8vIE11bHRpLWN1cnJlbmN5IHN1cHBvcnRcbiAgY3VycmVuY3k6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgZGVmYXVsdDogJ1VTRCcsXG4gICAgZW51bTogWydVU0QnLCAnRVVSJywgJ0NOWScsICdKUFknLCAnU0FSJywgJ0dCUCcsICdDQUQnXVxuICB9LFxuICBleGNoYW5nZVJhdGU6IHtcbiAgICB0eXBlOiBOdW1iZXIsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgZGVmYXVsdDogMVxuICB9XG59LCB7XG4gIHRpbWVzdGFtcHM6IHRydWVcbn0pO1xuXG4vLyBJbmRleGVzIGZvciBwZXJmb3JtYW5jZVxub3JkZXJTY2hlbWEuaW5kZXgoeyBvcmRlck51bWJlcjogMSB9KTtcbm9yZGVyU2NoZW1hLmluZGV4KHsgY3VzdG9tZXI6IDEsIGNyZWF0ZWRBdDogLTEgfSk7XG5vcmRlclNjaGVtYS5pbmRleCh7ICdndWVzdEluZm8uZW1haWwnOiAxIH0pO1xub3JkZXJTY2hlbWEuaW5kZXgoeyBzdGF0dXM6IDEgfSk7XG5vcmRlclNjaGVtYS5pbmRleCh7ICdwYXltZW50LnN0YXR1cyc6IDEgfSk7XG5vcmRlclNjaGVtYS5pbmRleCh7IHJlZmVycmFsU291cmNlOiAxIH0pO1xub3JkZXJTY2hlbWEuaW5kZXgoeyBjcmVhdGVkQXQ6IC0xIH0pO1xub3JkZXJTY2hlbWEuaW5kZXgoeyAnaXRlbXMud2hvbGVzYWxlci5ub3RpZmllZCc6IDEgfSk7XG5cbi8vIFByZS1zYXZlIG1pZGRsZXdhcmVcbm9yZGVyU2NoZW1hLnByZSgnc2F2ZScsIGZ1bmN0aW9uKG5leHQpIHtcbiAgaWYgKCF0aGlzLm9yZGVyTnVtYmVyKSB7XG4gICAgdGhpcy5vcmRlck51bWJlciA9ICdPUkQtJyArIERhdGUubm93KCkgKyAnLScgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgNSkudG9VcHBlckNhc2UoKTtcbiAgfVxuICBuZXh0KCk7XG59KTtcblxuLy8gTWV0aG9kIHRvIGdldCBjdXN0b21lciBlbWFpbCAod29ya3MgZm9yIGJvdGggZ3Vlc3QgYW5kIHJlZ2lzdGVyZWQgdXNlcnMpXG5vcmRlclNjaGVtYS5tZXRob2RzLmdldEN1c3RvbWVyRW1haWwgPSBmdW5jdGlvbigpIHtcbiAgaWYgKHRoaXMuY3VzdG9tZXIgJiYgdGhpcy5wb3B1bGF0ZWQoJ2N1c3RvbWVyJykpIHtcbiAgICByZXR1cm4gdGhpcy5jdXN0b21lci5lbWFpbDtcbiAgfVxuICByZXR1cm4gdGhpcy5ndWVzdEluZm8uZW1haWw7XG59O1xuXG4vLyBNZXRob2QgdG8gZ2V0IGN1c3RvbWVyIG5hbWVcbm9yZGVyU2NoZW1hLm1ldGhvZHMuZ2V0Q3VzdG9tZXJOYW1lID0gZnVuY3Rpb24oKSB7XG4gIGlmICh0aGlzLmN1c3RvbWVyICYmIHRoaXMucG9wdWxhdGVkKCdjdXN0b21lcicpKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuY3VzdG9tZXIuZmlyc3ROYW1lfSAke3RoaXMuY3VzdG9tZXIubGFzdE5hbWV9YDtcbiAgfVxuICByZXR1cm4gYCR7dGhpcy5ndWVzdEluZm8uZmlyc3ROYW1lfSAke3RoaXMuZ3Vlc3RJbmZvLmxhc3ROYW1lfWA7XG59O1xuXG4vLyBNZXRob2QgdG8gY2hlY2sgaWYgYWxsIHdob2xlc2FsZXJzIGhhdmUgYmVlbiBub3RpZmllZFxub3JkZXJTY2hlbWEubWV0aG9kcy5hbGxXaG9sZXNhbGVyc05vdGlmaWVkID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiB0aGlzLml0ZW1zLmV2ZXJ5KGl0ZW0gPT4gaXRlbS53aG9sZXNhbGVyLm5vdGlmaWVkKTtcbn07XG5cbi8vIE1ldGhvZCB0byBnZXQgcGVuZGluZyB3aG9sZXNhbGVyIG5vdGlmaWNhdGlvbnNcbm9yZGVyU2NoZW1hLm1ldGhvZHMuZ2V0UGVuZGluZ05vdGlmaWNhdGlvbnMgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuaXRlbXMuZmlsdGVyKGl0ZW0gPT4gIWl0ZW0ud2hvbGVzYWxlci5ub3RpZmllZCk7XG59O1xuXG4vLyBNZXRob2QgdG8gdXBkYXRlIHdob2xlc2FsZXIgbm90aWZpY2F0aW9uIHN0YXR1c1xub3JkZXJTY2hlbWEubWV0aG9kcy51cGRhdGVXaG9sZXNhbGVyTm90aWZpY2F0aW9uID0gZnVuY3Rpb24oaXRlbUlkLCBzdWNjZXNzLCBlcnJvciA9IG51bGwpIHtcbiAgY29uc3QgaXRlbSA9IHRoaXMuaXRlbXMuaWQoaXRlbUlkKTtcbiAgaWYgKGl0ZW0pIHtcbiAgICBpdGVtLndob2xlc2FsZXIubm90aWZpY2F0aW9uQXR0ZW1wdHMgKz0gMTtcbiAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgaXRlbS53aG9sZXNhbGVyLm5vdGlmaWVkID0gdHJ1ZTtcbiAgICAgIGl0ZW0ud2hvbGVzYWxlci5ub3RpZmllZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgIGl0ZW0ud2hvbGVzYWxlci5sYXN0Tm90aWZpY2F0aW9uRXJyb3IgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpdGVtLndob2xlc2FsZXIubGFzdE5vdGlmaWNhdGlvbkVycm9yID0gZXJyb3I7XG4gICAgfVxuICB9XG4gIHJldHVybiB0aGlzLnNhdmUoKTtcbn07XG5cbi8vIFN0YXRpYyBtZXRob2QgdG8gZmluZCBvcmRlcnMgbmVlZGluZyB3aG9sZXNhbGVyIG5vdGlmaWNhdGlvblxub3JkZXJTY2hlbWEuc3RhdGljcy5maW5kUGVuZGluZ05vdGlmaWNhdGlvbnMgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuZmluZCh7XG4gICAgJ3BheW1lbnQuc3RhdHVzJzogJ3BhaWQnLFxuICAgICdpdGVtcy53aG9sZXNhbGVyLm5vdGlmaWVkJzogZmFsc2VcbiAgfSk7XG59O1xuXG4vLyBNZXRob2QgdG8gZ2V0IHB1YmxpYyBvcmRlciBkYXRhIChleGNsdWRlcyBzZW5zaXRpdmUgd2hvbGVzYWxlciBpbmZvKVxub3JkZXJTY2hlbWEubWV0aG9kcy50b1B1YmxpY0pTT04gPSBmdW5jdGlvbigpIHtcbiAgY29uc3Qgb3JkZXIgPSB0aGlzLnRvT2JqZWN0KCk7XG4gIFxuICAvLyBSZW1vdmUgc2Vuc2l0aXZlIHdob2xlc2FsZXIgaW5mb3JtYXRpb24gZnJvbSBpdGVtc1xuICBpZiAob3JkZXIuaXRlbXMpIHtcbiAgICBvcmRlci5pdGVtcyA9IG9yZGVyLml0ZW1zLm1hcChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHB1YmxpY0l0ZW0gPSB7IC4uLml0ZW0gfTtcbiAgICAgIGlmIChwdWJsaWNJdGVtLndob2xlc2FsZXIpIHtcbiAgICAgICAgLy8gS2VlcCBvbmx5IG5vdGlmaWNhdGlvbiBzdGF0dXMsIHJlbW92ZSBzZW5zaXRpdmUgZGV0YWlsc1xuICAgICAgICBwdWJsaWNJdGVtLndob2xlc2FsZXIgPSB7XG4gICAgICAgICAgbm90aWZpZWQ6IGl0ZW0ud2hvbGVzYWxlci5ub3RpZmllZCxcbiAgICAgICAgICBub3RpZmllZEF0OiBpdGVtLndob2xlc2FsZXIubm90aWZpZWRBdFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHB1YmxpY0l0ZW07XG4gICAgfSk7XG4gIH1cbiAgXG4gIHJldHVybiBvcmRlcjtcbn07XG5cbi8vIEhvb2sgdHJpZ2dlciBjb21tZW50IC0gd2hvbGVzYWxlciBub3RpZmljYXRpb24gY2hlY2tcbi8vIFJlZmVycmFsIHRyYWNraW5nIGhvb2sgdGVzdFxuXG5tb2R1bGUuZXhwb3J0cyA9IG1vbmdvb3NlLm1vZGVsKCdPcmRlcicsIG9yZGVyU2NoZW1hKTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUVwQyxNQUFNQyxXQUFXLEdBQUcsSUFBSUYsUUFBUSxDQUFDRyxNQUFNLENBQUM7RUFDdENDLFdBQVcsRUFBRTtJQUNYQyxJQUFJLEVBQUVDLE1BQU07SUFDWkMsTUFBTSxFQUFFO0VBQ1YsQ0FBQztFQUNEQyxRQUFRLEVBQUU7SUFDUkgsSUFBSSxFQUFFTCxRQUFRLENBQUNHLE1BQU0sQ0FBQ00sS0FBSyxDQUFDQyxRQUFRO0lBQ3BDQyxHQUFHLEVBQUUsTUFBTTtJQUNYQyxRQUFRLEVBQUUsS0FBSyxDQUFDO0VBQ2xCLENBQUM7RUFDREMsU0FBUyxFQUFFO0lBQ1RDLEtBQUssRUFBRTtNQUNMVCxJQUFJLEVBQUVDLE1BQU07TUFDWk0sUUFBUSxFQUFFLFNBQUFBLENBQUEsRUFBVztRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUNKLFFBQVE7TUFBRSxDQUFDO01BQy9DTyxTQUFTLEVBQUUsSUFBSTtNQUNmQyxJQUFJLEVBQUU7SUFDUixDQUFDO0lBQ0RDLFNBQVMsRUFBRTtNQUNUWixJQUFJLEVBQUVDLE1BQU07TUFDWk0sUUFBUSxFQUFFLFNBQUFBLENBQUEsRUFBVztRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUNKLFFBQVE7TUFBRSxDQUFDO01BQy9DUSxJQUFJLEVBQUU7SUFDUixDQUFDO0lBQ0RFLFFBQVEsRUFBRTtNQUNSYixJQUFJLEVBQUVDLE1BQU07TUFDWk0sUUFBUSxFQUFFLFNBQUFBLENBQUEsRUFBVztRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUNKLFFBQVE7TUFBRSxDQUFDO01BQy9DUSxJQUFJLEVBQUU7SUFD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