{"version":3,"names":["logger","require","AppError","Error","constructor","message","statusCode","code","isOperational","status","startsWith","captureStackTrace","handleCastErrorDB","err","path","value","handleDuplicateFieldsDB","errmsg","match","handleValidationErrorDB","errors","Object","values","map","el","join","handleJWTError","handleJWTExpiredError","sendErrorDev","req","res","error","stack","url","originalUrl","method","ip","userAgent","get","json","success","details","sendErrorProd","globalErrorHandler","next","process","env","NODE_ENV","name","catchAsync","fn","catch","on","promise","exit","module","exports"],"sources":["errorHandler.js"],"sourcesContent":["const { logger } = require('../utils/logger');\n\n// Custom error class for application errors\nclass AppError extends Error {\n  constructor(message, statusCode, code = null, isOperational = true) {\n    super(message);\n    this.statusCode = statusCode;\n    this.code = code;\n    this.isOperational = isOperational;\n    this.status = `${statusCode}`.startsWith('4') ? 'fail' : 'error';\n\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n// Error handling for different error types\nconst handleCastErrorDB = (err) => {\n  const message = `Invalid ${err.path}: ${err.value}`;\n  return new AppError(message, 400, 'INVALID_ID');\n};\n\nconst handleDuplicateFieldsDB = (err) => {\n  const value = err.errmsg.match(/([\"'])(\\\\?.)*?\\1/)[0];\n  const message = `Duplicate field value: ${value}. Please use another value!`;\n  return new AppError(message, 400, 'DUPLICATE_FIELD');\n};\n\nconst handleValidationErrorDB = (err) => {\n  const errors = Object.values(err.errors).map(el => el.message);\n  const message = `Invalid input data. ${errors.join('. ')}`;\n  return new AppError(message, 400, 'VALIDATION_ERROR');\n};\n\nconst handleJWTError = () =>\n  new AppError('Invalid token. Please log in again!', 401, 'INVALID_TOKEN');\n\nconst handleJWTExpiredError = () =>\n  new AppError('Your token has expired! Please log in again.', 401, 'TOKEN_EXPIRED');\n\n// Send error response in development\nconst sendErrorDev = (err, req, res) => {\n  // Log error details\n  logger.error('Error in development:', {\n    error: err.message,\n    stack: err.stack,\n    url: req.originalUrl,\n    method: req.method,\n    ip: req.ip,\n    userAgent: req.get('User-Agent')\n  });\n\n  return res.status(err.statusCode).json({\n    success: false,\n    error: {\n      code: err.code,\n      message: err.message,\n      stack: err.stack,\n      details: err\n    }\n  });\n};\n\n// Send error response in production\nconst sendErrorProd = (err, req, res) => {\n  // Log error details\n  logger.error('Production error:', {\n    error: err.message,\n    code: err.code,\n    url: req.originalUrl,\n    method: req.method,\n    ip: req.ip,\n    statusCode: err.statusCode\n  });\n\n  // Operational, trusted error: send message to client\n  if (err.isOperational) {\n    return res.status(err.statusCode).json({\n      success: false,\n      error: {\n        code: err.code,\n        message: err.message\n      }\n    });\n  }\n\n  // Programming or other unknown error: don't leak error details\n  logger.error('Unknown error:', {\n    error: err,\n    stack: err.stack\n  });\n\n  return res.status(500).json({\n    success: false,\n    error: {\n      code: 'INTERNAL_ERROR',\n      message: 'Something went wrong!'\n    }\n  });\n};\n\n// Global error handling middleware\nconst globalErrorHandler = (err, req, res, next) => {\n  err.statusCode = err.statusCode || 500;\n  err.status = err.status || 'error';\n\n  if (process.env.NODE_ENV === 'development') {\n    sendErrorDev(err, req, res);\n  } else {\n    let error = { ...err };\n    error.message = err.message;\n\n    // Handle specific error types\n    if (error.name === 'CastError') {error = handleCastErrorDB(error);}\n    if (error.code === 11000) {error = handleDuplicateFieldsDB(error);}\n    if (error.name === 'ValidationError') {error = handleValidationErrorDB(error);}\n    if (error.name === 'JsonWebTokenError') {error = handleJWTError();}\n    if (error.name === 'TokenExpiredError') {error = handleJWTExpiredError();}\n\n    sendErrorProd(error, req, res);\n  }\n};\n\n// Async error wrapper\nconst catchAsync = (fn) => {\n  return (req, res, next) => {\n    fn(req, res, next).catch(next);\n  };\n};\n\n// Handle unhandled promise rejections\nprocess.on('unhandledRejection', (err, promise) => {\n  logger.error('Unhandled Promise Rejection:', {\n    error: err.message,\n    stack: err.stack,\n    promise: promise\n  });\n  \n  // Close server gracefully\n  process.exit(1);\n});\n\n// Handle uncaught exceptions\nprocess.on('uncaughtException', (err) => {\n  logger.error('Uncaught Exception:', {\n    error: err.message,\n    stack: err.stack\n  });\n  \n  // Close server gracefully\n  process.exit(1);\n});\n\nmodule.exports = {\n  AppError,\n  globalErrorHandler,\n  catchAsync\n};"],"mappings":"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","ignoreList":[]}