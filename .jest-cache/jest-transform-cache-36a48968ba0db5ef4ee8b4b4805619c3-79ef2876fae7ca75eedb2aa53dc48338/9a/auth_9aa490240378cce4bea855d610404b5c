754cb19e8557f9360f72ebcc06aa45c8
const jwt = require('jsonwebtoken');
const User = require('../models/User');
const {
  ErrorCodes
} = require('../utils/errorHandler');

// Middleware to authenticate JWT tokens
const authenticateToken = async (req, res, next) => {
  try {
    // Check for token in cookie first (more secure), then fall back to header
    const cookieToken = req.cookies?.token;
    const authHeader = req.headers['authorization'];
    const headerToken = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

    // Prefer cookie token over header token for security
    const token = cookieToken || headerToken;
    if (!token) {
      req.user = null;
      return next(); // Continue without authentication for optional auth routes
    }
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId).select('-password');
    if (!user || !user.isActive) {
      req.user = null;
      return next();
    }
    req.user = user;
    next();
  } catch (error) {
    // Log the error for debugging but don't expose details to client
    console.error('JWT verification error:', error.message);
    req.user = null;
    next(); // Continue without authentication for optional auth routes
  }
};

// Middleware to require authentication
const requireAuth = async (req, res, next) => {
  try {
    // Check for token in cookie first (more secure), then fall back to header
    const cookieToken = req.cookies?.token;
    const authHeader = req.headers['authorization'];
    const headerToken = authHeader && authHeader.split(' ')[1];

    // Prefer cookie token over header token for security
    const token = cookieToken || headerToken;
    if (!token) {
      return res.error ? res.error(401, ErrorCodes.AUTHENTICATION_REQUIRED, 'Access token is required') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.AUTHENTICATION_REQUIRED,
          message: 'Access token is required'
        }
      });
    }
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId).select('-password');
    if (!user || !user.isActive) {
      return res.error ? res.error(401, ErrorCodes.TOKEN_INVALID, 'Invalid or expired token') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.TOKEN_INVALID,
          message: 'Invalid or expired token'
        }
      });
    }
    req.user = user;
    next();
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.error ? res.error(401, ErrorCodes.TOKEN_INVALID, 'Invalid token format') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.TOKEN_INVALID,
          message: 'Invalid token format'
        }
      });
    }
    if (error.name === 'TokenExpiredError') {
      return res.error ? res.error(401, ErrorCodes.TOKEN_EXPIRED, 'Token has expired') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.TOKEN_EXPIRED,
          message: 'Token has expired'
        }
      });
    }
    console.error('Authentication error:', error);
    if (res.error) {
      res.error(500, ErrorCodes.INTERNAL_ERROR, 'Authentication failed');
    } else {
      res.status(500).json({
        success: false,
        error: {
          code: ErrorCodes.INTERNAL_ERROR,
          message: 'Authentication failed'
        }
      });
    }
  }
};

// Middleware to require admin role
const requireAdmin = async (req, res, next) => {
  try {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    if (!token) {
      return res.error ? res.error(401, ErrorCodes.AUTHENTICATION_REQUIRED, 'Access token is required') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.AUTHENTICATION_REQUIRED,
          message: 'Access token is required'
        }
      });
    }
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId).select('-password');
    if (!user || !user.isActive) {
      return res.error ? res.error(401, ErrorCodes.TOKEN_INVALID, 'Invalid or expired token') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.TOKEN_INVALID,
          message: 'Invalid or expired token'
        }
      });
    }

    // Check if user has admin role
    if (!user.isAdmin) {
      return res.error ? res.error(403, ErrorCodes.INSUFFICIENT_PERMISSIONS, 'Admin access required') : res.status(403).json({
        success: false,
        error: {
          code: ErrorCodes.INSUFFICIENT_PERMISSIONS,
          message: 'Admin access required'
        }
      });
    }
    req.user = user;
    next();
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.error ? res.error(401, ErrorCodes.TOKEN_INVALID, 'Invalid token format') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.TOKEN_INVALID,
          message: 'Invalid token format'
        }
      });
    }
    if (error.name === 'TokenExpiredError') {
      return res.error ? res.error(401, ErrorCodes.TOKEN_EXPIRED, 'Token has expired') : res.status(401).json({
        success: false,
        error: {
          code: ErrorCodes.TOKEN_EXPIRED,
          message: 'Token has expired'
        }
      });
    }
    console.error('Admin auth error:', error);
    if (res.error) {
      res.error(500, ErrorCodes.INTERNAL_ERROR, 'Authorization failed');
    } else {
      res.status(500).json({
        success: false,
        error: {
          code: ErrorCodes.INTERNAL_ERROR,
          message: 'Authorization failed'
        }
      });
    }
  }
};
module.exports = {
  authenticateToken,
  requireAuth,
  requireAdmin
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqd3QiLCJyZXF1aXJlIiwiVXNlciIsIkVycm9yQ29kZXMiLCJhdXRoZW50aWNhdGVUb2tlbiIsInJlcSIsInJlcyIsIm5leHQiLCJjb29raWVUb2tlbiIsImNvb2tpZXMiLCJ0b2tlbiIsImF1dGhIZWFkZXIiLCJoZWFkZXJzIiwiaGVhZGVyVG9rZW4iLCJzcGxpdCIsInVzZXIiLCJkZWNvZGVkIiwidmVyaWZ5IiwicHJvY2VzcyIsImVudiIsIkpXVF9TRUNSRVQiLCJmaW5kQnlJZCIsInVzZXJJZCIsInNlbGVjdCIsImlzQWN0aXZlIiwiZXJyb3IiLCJjb25zb2xlIiwibWVzc2FnZSIsInJlcXVpcmVBdXRoIiwiQVVUSEVOVElDQVRJT05fUkVRVUlSRUQiLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImNvZGUiLCJUT0tFTl9JTlZBTElEIiwibmFtZSIsIlRPS0VOX0VYUElSRUQiLCJJTlRFUk5BTF9FUlJPUiIsInJlcXVpcmVBZG1pbiIsImlzQWRtaW4iLCJJTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiYXV0aC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcbmNvbnN0IFVzZXIgPSByZXF1aXJlKCcuLi9tb2RlbHMvVXNlcicpO1xuY29uc3QgeyBFcnJvckNvZGVzIH0gPSByZXF1aXJlKCcuLi91dGlscy9lcnJvckhhbmRsZXInKTtcblxuLy8gTWlkZGxld2FyZSB0byBhdXRoZW50aWNhdGUgSldUIHRva2Vuc1xuY29uc3QgYXV0aGVudGljYXRlVG9rZW4gPSBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBDaGVjayBmb3IgdG9rZW4gaW4gY29va2llIGZpcnN0IChtb3JlIHNlY3VyZSksIHRoZW4gZmFsbCBiYWNrIHRvIGhlYWRlclxuICAgIGNvbnN0IGNvb2tpZVRva2VuID0gcmVxLmNvb2tpZXM/LnRva2VuO1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVyc1snYXV0aG9yaXphdGlvbiddO1xuICAgIGNvbnN0IGhlYWRlclRva2VuID0gYXV0aEhlYWRlciAmJiBhdXRoSGVhZGVyLnNwbGl0KCcgJylbMV07IC8vIEJlYXJlciBUT0tFTlxuICAgIFxuICAgIC8vIFByZWZlciBjb29raWUgdG9rZW4gb3ZlciBoZWFkZXIgdG9rZW4gZm9yIHNlY3VyaXR5XG4gICAgY29uc3QgdG9rZW4gPSBjb29raWVUb2tlbiB8fCBoZWFkZXJUb2tlbjtcbiAgICBcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXEudXNlciA9IG51bGw7XG4gICAgICByZXR1cm4gbmV4dCgpOyAvLyBDb250aW51ZSB3aXRob3V0IGF1dGhlbnRpY2F0aW9uIGZvciBvcHRpb25hbCBhdXRoIHJvdXRlc1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCk7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoZGVjb2RlZC51c2VySWQpLnNlbGVjdCgnLXBhc3N3b3JkJyk7XG4gICAgXG4gICAgaWYgKCF1c2VyIHx8ICF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICByZXEudXNlciA9IG51bGw7XG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cbiAgICBcbiAgICByZXEudXNlciA9IHVzZXI7XG4gICAgbmV4dCgpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIC8vIExvZyB0aGUgZXJyb3IgZm9yIGRlYnVnZ2luZyBidXQgZG9uJ3QgZXhwb3NlIGRldGFpbHMgdG8gY2xpZW50XG4gICAgY29uc29sZS5lcnJvcignSldUIHZlcmlmaWNhdGlvbiBlcnJvcjonLCBlcnJvci5tZXNzYWdlKTtcbiAgICByZXEudXNlciA9IG51bGw7XG4gICAgbmV4dCgpOyAvLyBDb250aW51ZSB3aXRob3V0IGF1dGhlbnRpY2F0aW9uIGZvciBvcHRpb25hbCBhdXRoIHJvdXRlc1xuICB9XG59O1xuXG4vLyBNaWRkbGV3YXJlIHRvIHJlcXVpcmUgYXV0aGVudGljYXRpb25cbmNvbnN0IHJlcXVpcmVBdXRoID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgLy8gQ2hlY2sgZm9yIHRva2VuIGluIGNvb2tpZSBmaXJzdCAobW9yZSBzZWN1cmUpLCB0aGVuIGZhbGwgYmFjayB0byBoZWFkZXJcbiAgICBjb25zdCBjb29raWVUb2tlbiA9IHJlcS5jb29raWVzPy50b2tlbjtcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTtcbiAgICBjb25zdCBoZWFkZXJUb2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdO1xuICAgIFxuICAgIC8vIFByZWZlciBjb29raWUgdG9rZW4gb3ZlciBoZWFkZXIgdG9rZW4gZm9yIHNlY3VyaXR5XG4gICAgY29uc3QgdG9rZW4gPSBjb29raWVUb2tlbiB8fCBoZWFkZXJUb2tlbjtcbiAgICBcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm4gcmVzLmVycm9yID8gcmVzLmVycm9yKDQwMSwgRXJyb3JDb2Rlcy5BVVRIRU5USUNBVElPTl9SRVFVSVJFRCwgJ0FjY2VzcyB0b2tlbiBpcyByZXF1aXJlZCcpIDogcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhFTlRJQ0FUSU9OX1JFUVVJUkVELFxuICAgICAgICAgIG1lc3NhZ2U6ICdBY2Nlc3MgdG9rZW4gaXMgcmVxdWlyZWQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCk7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoZGVjb2RlZC51c2VySWQpLnNlbGVjdCgnLXBhc3N3b3JkJyk7XG4gICAgXG4gICAgaWYgKCF1c2VyIHx8ICF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICByZXR1cm4gcmVzLmVycm9yID8gcmVzLmVycm9yKDQwMSwgRXJyb3JDb2Rlcy5UT0tFTl9JTlZBTElELCAnSW52YWxpZCBvciBleHBpcmVkIHRva2VuJykgOiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVE9LRU5fSU5WQUxJRCxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBvciBleHBpcmVkIHRva2VuJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcmVxLnVzZXIgPSB1c2VyO1xuICAgIG5leHQoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ0pzb25XZWJUb2tlbkVycm9yJykge1xuICAgICAgcmV0dXJuIHJlcy5lcnJvciA/IHJlcy5lcnJvcig0MDEsIEVycm9yQ29kZXMuVE9LRU5fSU5WQUxJRCwgJ0ludmFsaWQgdG9rZW4gZm9ybWF0JykgOiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVE9LRU5fSU5WQUxJRCxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCB0b2tlbiBmb3JtYXQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ1Rva2VuRXhwaXJlZEVycm9yJykge1xuICAgICAgcmV0dXJuIHJlcy5lcnJvciA/IHJlcy5lcnJvcig0MDEsIEVycm9yQ29kZXMuVE9LRU5fRVhQSVJFRCwgJ1Rva2VuIGhhcyBleHBpcmVkJykgOiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVE9LRU5fRVhQSVJFRCxcbiAgICAgICAgICBtZXNzYWdlOiAnVG9rZW4gaGFzIGV4cGlyZWQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zb2xlLmVycm9yKCdBdXRoZW50aWNhdGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgaWYgKHJlcy5lcnJvcikge1xuICAgICAgcmVzLmVycm9yKDUwMCwgRXJyb3JDb2Rlcy5JTlRFUk5BTF9FUlJPUiwgJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuSU5URVJOQUxfRVJST1IsXG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG59O1xuXG4vLyBNaWRkbGV3YXJlIHRvIHJlcXVpcmUgYWRtaW4gcm9sZVxuY29uc3QgcmVxdWlyZUFkbWluID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzWydhdXRob3JpemF0aW9uJ107XG4gICAgY29uc3QgdG9rZW4gPSBhdXRoSGVhZGVyICYmIGF1dGhIZWFkZXIuc3BsaXQoJyAnKVsxXTtcbiAgICBcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm4gcmVzLmVycm9yID8gcmVzLmVycm9yKDQwMSwgRXJyb3JDb2Rlcy5BVVRIRU5USUNBVElPTl9SRVFVSVJFRCwgJ0FjY2VzcyB0b2tlbiBpcyByZXF1aXJlZCcpIDogcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhFTlRJQ0FUSU9OX1JFUVVJUkVELFxuICAgICAgICAgIG1lc3NhZ2U6ICdBY2Nlc3MgdG9rZW4gaXMgcmVxdWlyZWQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCk7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoZGVjb2RlZC51c2VySWQpLnNlbGVjdCgnLXBhc3N3b3JkJyk7XG4gICAgXG4gICAgaWYgKCF1c2VyIHx8ICF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICByZXR1cm4gcmVzLmVycm9yID8gcmVzLmVycm9yKDQwMSwgRXJyb3JDb2Rlcy5UT0tFTl9JTlZBTElELCAnSW52YWxpZCBvciBleHBpcmVkIHRva2VuJykgOiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVE9LRU5fSU5WQUxJRCxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBvciBleHBpcmVkIHRva2VuJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgYWRtaW4gcm9sZVxuICAgIGlmICghdXNlci5pc0FkbWluKSB7XG4gICAgICByZXR1cm4gcmVzLmVycm9yID8gcmVzLmVycm9yKDQwMywgRXJyb3JDb2Rlcy5JTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMsICdBZG1pbiBhY2Nlc3MgcmVxdWlyZWQnKSA6IHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5JTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMsXG4gICAgICAgICAgbWVzc2FnZTogJ0FkbWluIGFjY2VzcyByZXF1aXJlZCdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIHJlcS51c2VyID0gdXNlcjtcbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdKc29uV2ViVG9rZW5FcnJvcicpIHtcbiAgICAgIHJldHVybiByZXMuZXJyb3IgPyByZXMuZXJyb3IoNDAxLCBFcnJvckNvZGVzLlRPS0VOX0lOVkFMSUQsICdJbnZhbGlkIHRva2VuIGZvcm1hdCcpIDogcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLlRPS0VOX0lOVkFMSUQsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgdG9rZW4gZm9ybWF0J1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdUb2tlbkV4cGlyZWRFcnJvcicpIHtcbiAgICAgIHJldHVybiByZXMuZXJyb3IgPyByZXMuZXJyb3IoNDAxLCBFcnJvckNvZGVzLlRPS0VOX0VYUElSRUQsICdUb2tlbiBoYXMgZXhwaXJlZCcpIDogcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLlRPS0VOX0VYUElSRUQsXG4gICAgICAgICAgbWVzc2FnZTogJ1Rva2VuIGhhcyBleHBpcmVkJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgY29uc29sZS5lcnJvcignQWRtaW4gYXV0aCBlcnJvcjonLCBlcnJvcik7XG4gICAgaWYgKHJlcy5lcnJvcikge1xuICAgICAgcmVzLmVycm9yKDUwMCwgRXJyb3JDb2Rlcy5JTlRFUk5BTF9FUlJPUiwgJ0F1dGhvcml6YXRpb24gZmFpbGVkJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5JTlRFUk5BTF9FUlJPUixcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aG9yaXphdGlvbiBmYWlsZWQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGF1dGhlbnRpY2F0ZVRva2VuLFxuICByZXF1aXJlQXV0aCxcbiAgcmVxdWlyZUFkbWluXG59OyJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsR0FBRyxHQUFHQyxPQUFPLENBQUMsY0FBYyxDQUFDO0FBQ25DLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQ3RDLE1BQU07RUFBRUU7QUFBVyxDQUFDLEdBQUdGLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQzs7QUFFdkQ7QUFDQSxNQUFNRyxpQkFBaUIsR0FBRyxNQUFBQSxDQUFPQyxHQUFHLEVBQUVDLEdBQUcsRUFBRUMsSUFBSSxLQUFLO0VBQ2xELElBQUk7SUFDRjtJQUNBLE1BQU1DLFdBQVcsR0FBR0gsR0FBRyxDQUFDSSxPQUFPLEVBQUVDLEtBQUs7SUFDdEMsTUFBTUMsVUFBVSxHQUFHTixHQUFHLENBQUNPLE9BQU8sQ0FBQyxlQUFlLENBQUM7SUFDL0MsTUFBTUMsV0FBVyxHQUFHRixVQUFVLElBQUlBLFVBQVUsQ0FBQ0csS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7O0lBRTVEO0lBQ0EsTUFBTUosS0FBSyxHQUFHRixXQUFXLElBQUlLLFdBQVc7SUFFeEMsSUFBSSxDQUFDSCxLQUFLLEVBQUU7TUFDVkwsR0FBRyxDQUFDVSxJQUFJLEdBQUcsSUFBSTtNQUNmLE9BQU9SLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQjtJQUVBLE1BQU1TLE9BQU8sR0FBR2hCLEdBQUcsQ0FBQ2lCLE1BQU0sQ0FBQ1AsS0FBSyxFQUFFUSxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsVUFBVSxDQUFDO0lBQ3pELE1BQU1MLElBQUksR0FBRyxNQUFNYixJQUFJLENBQUNtQixRQUFRLENBQUNMLE9BQU8sQ0FBQ00sTUFBTSxDQUFDLENBQUNDLE1BQU0sQ0FBQyxXQUFXLENBQUM7SUFFcEUsSUFBSSxDQUFDUixJQUFJLElBQUksQ0FBQ0EsSUFBSSxDQUFDUyxRQUFRLEVBQUU7TUFDM0JuQixHQUFHLENBQUNVLElBQUksR0FBRyxJQUFJO01BQ2YsT0FBT1IsSUFBSSxDQUFDLENBQUM7SUFDZjtJQUVBRixHQUFHLENBQUNVLElBQUksR0FBR0EsSUFBSTtJQUNmUixJQUFJLENBQUMsQ0FBQztFQUNSLENBQUMsQ0FBQyxPQUFPa0IsS0FBSyxFQUFFO0lBQ2Q7SUFDQUMsT0FBTyxDQUFDRCxLQUFLLENBQUMseUJBQXlCLEVBQUVBLEtBQUssQ0FBQ0UsT0FBTyxDQUFDO0lBQ3ZEdEIsR0FBRyxDQUFDVSxJQUFJLEdBQUcsSUFBSTtJQUNmUixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7RUFDVjtBQUNGLENBQUM7O0FBRUQ7QUFDQSxNQUFNcUIsV0FBVyxHQUFHLE1BQUFBLENBQU92QixHQUFHLEVBQUVDLEdBQUcsRUFBRUMsSUFBSSxLQUFLO0VBQzVDLElBQUk7SUFDRjtJQUNBLE1BQU1DLFdBQVcsR0FBR0gsR0FBRyxDQUFDSSxPQUFPLEVBQUVDLEtBQUs7SUFDdEMsTUFBTUMsVUFBVSxHQUFHTixHQUFHLENBQUNPLE9BQU8sQ0FBQyxlQUFlLENBQUM7SUFDL0MsTUFBTUMsV0FBVyxHQUFHRixVQUFVLElBQUlBLFVBQVUsQ0FBQ0csS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7SUFFMUQ7SUFDQSxNQUFNSixLQUFLLEdBQUdGLFdBQVcsSUFBSUssV0FBVztJQUV4QyxJQUFJLENBQUNILEtBQUssRUFBRTtNQUNWLE9BQU9KLEdBQUcsQ0FBQ21CLEtBQUssR0FBR25CLEdBQUcsQ0FBQ21CLEtBQUssQ0FBQyxHQUFHLEVBQUV0QixVQUFVLENBQUMwQix1QkFBdUIsRUFBRSwwQkFBMEIsQ0FBQyxHQUFHdkIsR0FBRyxDQUFDd0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDQyxJQUFJLENBQUM7UUFDdkhDLE9BQU8sRUFBRSxLQUFLO1FBQ2RQLEtBQUssRUFBRTtVQUNMUSxJQUFJLEVBQUU5QixVQUFVLENBQUMwQix1QkFBdUI7VUFDeENGLE9BQU8sRUFBRTtRQUNYO01BQ0YsQ0FBQyxDQUFDO0lBQ0o7SUFFQSxNQUFNWCxPQUFPLEdBQUdoQixHQUFHLENBQUNpQixNQUFNLENBQUNQLEtBQUssRUFBRVEsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFVBQVUsQ0FBQztJQUN6RCxNQUFNTCxJQUFJLEdBQUcsTUFBTWIsSUFBSSxDQUFDbUIsUUFBUSxDQUFDTCxPQUFPLENBQUNNLE1BQU0sQ0FBQyxDQUFDQyxNQUFNLENBQUMsV0FBVyxDQUFDO0lBRXBFLElBQUksQ0FBQ1IsSUFBSSxJQUFJLENBQUNBLElBQUksQ0FBQ1MsUUFBUSxFQUFFO01BQzNCLE9BQU9sQixHQUFHLENBQUNtQixLQUFLLEdBQUduQixHQUFHLENBQUNtQixLQUFLLENBQUMsR0FBRyxFQUFFdEIsVUFBVSxDQUFDK0IsYUFBYSxFQUFFLDBCQUEwQixDQUFDLEdBQUc1QixHQUFHLENBQUN3QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQztRQUM3R0MsT0FBTyxFQUFFLEtBQUs7UUFDZFAsS0FBSyxFQUFFO1VBQ0xRLElBQUksRUFBRTlCLFVBQVUsQ0FBQytCLGFBQWE7VUFDOUJQLE9BQU8sRUFBRTtRQUNYO01BQ0YsQ0FBQyxDQUFDO0lBQ0o7SUFFQXRCLEdBQUcsQ0FBQ1UsSUFBSSxHQUFHQSxJQUFJO0lBQ2ZSLElBQUksQ0FBQyxDQUFDO0VBQ1IsQ0FBQyxDQUFDLE9BQU9rQixLQUFLLEVBQUU7SUFDZCxJQUFJQSxLQUFLLENBQUNVLElBQUksS0FBSyxtQkFBbUIsRUFBRTtNQUN0QyxPQUFPN0IsR0FBRyxDQUFDbUIsS0FBSyxHQUFHbkIsR0FBRyxDQUFDbUIsS0FBSyxDQUFDLEdBQUcsRUFBRXRCLFVBQVUsQ0FBQytCLGFBQWEsRUFBRSxzQkFBc0IsQ0FBQyxHQUFHNUIsR0FBRyxDQUFDd0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDQyxJQUFJLENBQUM7UUFDekdDLE9BQU8sRUFBRSxLQUFLO1FBQ2RQLEtBQUssRUFBRTtVQUNMUSxJQUFJLEVBQUU5QixVQUFVLENBQUMrQixhQUFhO1VBQzlCUCxPQUFPLEVBQUU7UUFDWDtNQUNGLENBQUMsQ0FBQztJQUNKO0lBRUEsSUFBSUYsS0FBSyxDQUFDVSxJQUFJLEtBQUssbUJBQW1CLEVBQUU7TUFDdEMsT0FBTzdCLEdBQUcsQ0FBQ21CLEtBQUssR0FBR25CLEdBQUcsQ0FBQ21CLEtBQUssQ0FBQyxHQUFHLEVBQUV0QixVQUFVLENBQUNpQyxhQUFhLEVBQUUsbUJBQW1CLENBQUMsR0FBRzlCLEdBQUcsQ0FBQ3dCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQ0MsSUFBSSxDQUFDO1FBQ3RHQyxPQUFPLEVBQUUsS0FBSztRQUNkUCxLQUFLLEVBQUU7VUFDTFEsSUFBSSxFQUFFOUIsVUFBVSxDQUFDaUMsYUFBYTtVQUM5QlQsT0FBTyxFQUFFO1FBQ1g7TUFDRixDQUFDLENBQUM7SUFDSjtJQUVBRCxPQUFPLENBQUNELEtBQUssQ0FBQyx1QkFBdUIsRUFBRUEsS0FBSyxDQUFDO0lBQzdDLElBQUluQixHQUFHLENBQUNtQixLQUFLLEVBQUU7TUFDYm5CLEdBQUcsQ0FBQ21CLEtBQUssQ0FBQyxHQUFHLEVBQUV0QixVQUFVLENBQUNrQyxjQUFjLEVBQUUsdUJBQXVCLENBQUM7SUFDcEUsQ0FBQyxNQUFNO01BQ0wvQixHQUFHLENBQUN3QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQztRQUNuQkMsT0FBTyxFQUFFLEtBQUs7UUFDZFAsS0FBSyxFQUFFO1VBQ0xRLElBQUksRUFBRTlCLFVBQVUsQ0FBQ2tDLGNBQWM7VUFDL0JWLE9BQU8sRUFBRTtRQUNYO01BQ0YsQ0FBQyxDQUFDO0lBQ0o7RUFDRjtBQUNGLENBQUM7O0FBRUQ7QUFDQSxNQUFNVyxZQUFZLEdBQUcsTUFBQUEsQ0FBT2pDLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEtBQUs7RUFDN0MsSUFBSTtJQUNGLE1BQU1JLFVBQVUsR0FBR04sR0FBRyxDQUFDTyxPQUFPLENBQUMsZUFBZSxDQUFDO0lBQy9DLE1BQU1GLEtBQUssR0FBR0MsVUFBVSxJQUFJQSxVQUFVLENBQUNHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFcEQsSUFBSSxDQUFDSixLQUFLLEVBQUU7TUFDVixPQUFPSixHQUFHLENBQUNtQixLQUFLLEdBQUduQixHQUFHLENBQUNtQixLQUFLLENBQUMsR0FBRyxFQUFFdEIsVUFBVSxDQUFDMEIsdUJBQXVCLEVBQUUsMEJBQTBCLENBQUMsR0FBR3ZCLEdBQUcsQ0FBQ3dCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQ0MsSUFBSSxDQUFDO1FBQ3ZIQyxPQUFPLEVBQUUsS0FBSztRQUNkUCxLQUFLLEVBQUU7VUFDTFEsSUFBSSxFQUFFOUIsVUFBVSxDQUFDMEIsdUJBQXVCO1VBQ3hDRixPQUFPLEVBQUU7UUFDWDtNQUNGLENBQUMsQ0FBQztJQUNKO0lBRUEsTUFBTVgsT0FBTyxHQUFHaEIsR0FBRyxDQUFDaUIsTUFBTSxDQUFDUCxLQUFLLEVBQUVRLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDQyxVQUFVLENBQUM7SUFDekQsTUFBTUwsSUFBSSxHQUFHLE1BQU1iLElBQUksQ0FBQ21CLFFBQVEsQ0FBQ0wsT0FBTyxDQUFDTSxNQUFNLENBQUMsQ0FBQ0MsTUFBTSxDQUFDLFdBQVcsQ0FBQztJQUVwRSxJQUFJLENBQUNSLElBQUksSUFBSSxDQUFDQSxJQUFJLENBQUNTLFFBQVEsRUFBRTtNQUMzQixPQUFPbEIsR0FBRyxDQUFDbUIsS0FBSyxHQUFHbkIsR0FBRyxDQUFDbUIsS0FBSyxDQUFDLEdBQUcsRUFBRXRCLFVBQVUsQ0FBQytCLGFBQWEsRUFBRSwwQkFBMEIsQ0FBQyxHQUFHNUIsR0FBRyxDQUFDd0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDQyxJQUFJLENBQUM7UUFDN0dDLE9BQU8sRUFBRSxLQUFLO1FBQ2RQLEtBQUssRUFBRTtVQUNMUSxJQUFJLEVBQUU5QixVQUFVLENBQUMrQixhQUFhO1VBQzlCUCxPQUFPLEVBQUU7UUFDWDtNQUNGLENBQUMsQ0FBQztJQUNKOztJQUVBO0lBQ0EsSUFBSSxDQUFDWixJQUFJLENBQUN3QixPQUFPLEVBQUU7TUFDakIsT0FBT2pDLEdBQUcsQ0FBQ21CLEtBQUssR0FBR25CLEdBQUcsQ0FBQ21CLEtBQUssQ0FBQyxHQUFHLEVBQUV0QixVQUFVLENBQUNxQyx3QkFBd0IsRUFBRSx1QkFBdUIsQ0FBQyxHQUFHbEMsR0FBRyxDQUFDd0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDQyxJQUFJLENBQUM7UUFDckhDLE9BQU8sRUFBRSxLQUFLO1FBQ2RQLEtBQUssRUFBRTtVQUNMUSxJQUFJLEVBQUU5QixVQUFVLENBQUNxQyx3QkFBd0I7VUFDekNiLE9BQU8sRUFBRTtRQUNYO01BQ0YsQ0FBQyxDQUFDO0lBQ0o7SUFFQXRCLEdBQUcsQ0FBQ1UsSUFBSSxHQUFHQSxJQUFJO0lBQ2ZSLElBQUksQ0FBQyxDQUFDO0VBQ1IsQ0FBQyxDQUFDLE9BQU9rQixLQUFLLEVBQUU7SUFDZCxJQUFJQSxLQUFLLENBQUNVLElBQUksS0FBSyxtQkFBbUIsRUFBRTtNQUN0QyxPQUFPN0IsR0FBRyxDQUFDbUIsS0FBSyxHQUFHbkIsR0FBRyxDQUFDbUIsS0FBSyxDQUFDLEdBQUcsRUFBRXRCLFVBQVUsQ0FBQytCLGFBQWEsRUFBRSxzQkFBc0IsQ0FBQyxHQUFHNUIsR0FBRyxDQUFDd0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDQyxJQUFJLENBQUM7UUFDekdDLE9BQU8sRUFBRSxLQUFLO1FBQ2RQLEtBQUssRUFBRTtVQUNMUSxJQUFJLEVBQUU5QixVQUFVLENBQUMrQixhQUFhO1VBQzlCUCxPQUFPLEVBQUU7UUFDWDtNQUNGLENBQUMsQ0FBQztJQUNKO0lBRUEsSUFBSUYsS0FBSyxDQUFDVSxJQUFJLEtBQUssbUJBQW1CLEVBQUU7TUFDdEMsT0FBTzdCLEdBQUcsQ0FBQ21CLEtBQUssR0FBR25CLEdBQUcsQ0FBQ21CLEtBQUssQ0FBQyxHQUFHLEVBQUV0QixVQUFVLENBQUNpQyxhQUFhLEVBQUUsbUJBQW1CLENBQUMsR0FBRzlCLEdBQUcsQ0FBQ3dCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQ0MsSUFBSSxDQUFDO1FBQ3RHQyxPQUFPLEVBQUUsS0FBSztRQUNkUCxLQUFLLEVBQUU7VUFDTFEsSUFBSSxFQUFFOUIsVUFBVSxDQUFDaUMsYUFBYTtVQUM5QlQsT0FBTyxFQUFFO1FBQ1g7TUFDRixDQUFDLENBQUM7SUFDSjtJQUVBRCxPQUFPLENBQUNELEtBQUssQ0FBQyxtQkFBbUIsRUFBRUEsS0FBSyxDQUFDO0lBQ3pDLElBQUluQixHQUFHLENBQUNtQixLQUFLLEVBQUU7TUFDYm5CLEdBQUcsQ0FBQ21CLEtBQUssQ0FBQyxHQUFHLEVBQUV0QixVQUFVLENBQUNrQyxjQUFjLEVBQUUsc0JBQXNCLENBQUM7SUFDbkUsQ0FBQyxNQUFNO01BQ0wvQixHQUFHLENBQUN3QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQztRQUNuQkMsT0FBTyxFQUFFLEtBQUs7UUFDZFAsS0FBSyxFQUFFO1VBQ0xRLElBQUksRUFBRTlCLFVBQVUsQ0FBQ2tDLGNBQWM7VUFDL0JWLE9BQU8sRUFBRTtRQUNYO01BQ0YsQ0FBQyxDQUFDO0lBQ0o7RUFDRjtBQUNGLENBQUM7QUFFRGMsTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDZnRDLGlCQUFpQjtFQUNqQndCLFdBQVc7RUFDWFU7QUFDRixDQUFDIiwiaWdub3JlTGlzdCI6W119