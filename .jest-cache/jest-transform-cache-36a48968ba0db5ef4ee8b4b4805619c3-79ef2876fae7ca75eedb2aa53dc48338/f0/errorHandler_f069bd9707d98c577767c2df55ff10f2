5894754d1c645bee21c9cb5aec68eeb8
/**
 * Standardized error handling utilities for the Holistic Boutique API
 * Following CLAUDE.md constraints:
 * - Keep it simple - no event emitters or complex patterns
 * - Support internationalization for all error messages
 * - Use existing patterns from the codebase
 */

// Standard error codes used across the application
const ErrorCodes = {
  // Common errors
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  NOT_FOUND: 'NOT_FOUND',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  BAD_REQUEST: 'BAD_REQUEST',
  // Authentication errors
  INVALID_CREDENTIALS: 'INVALID_CREDENTIALS',
  USER_EXISTS: 'USER_EXISTS',
  USER_NOT_FOUND: 'USER_NOT_FOUND',
  TOKEN_INVALID: 'TOKEN_INVALID',
  TOKEN_EXPIRED: 'TOKEN_EXPIRED',
  AUTHENTICATION_REQUIRED: 'AUTHENTICATION_REQUIRED',
  REGISTRATION_ERROR: 'REGISTRATION_ERROR',
  ACCOUNT_DISABLED: 'ACCOUNT_DISABLED',
  LOGIN_ERROR: 'LOGIN_ERROR',
  FORGOT_PASSWORD_ERROR: 'FORGOT_PASSWORD_ERROR',
  RESET_PASSWORD_ERROR: 'RESET_PASSWORD_ERROR',
  VERIFICATION_ERROR: 'VERIFICATION_ERROR',
  PROFILE_FETCH_ERROR: 'PROFILE_FETCH_ERROR',
  PROFILE_UPDATE_ERROR: 'PROFILE_UPDATE_ERROR',
  EMAIL_EXISTS: 'EMAIL_EXISTS',
  DUPLICATE_EMAIL: 'DUPLICATE_EMAIL',
  INVALID_PASSWORD: 'INVALID_PASSWORD',
  PASSWORD_CHANGE_ERROR: 'PASSWORD_CHANGE_ERROR',
  LOGOUT_ERROR: 'LOGOUT_ERROR',
  ADDRESS_ADD_ERROR: 'ADDRESS_ADD_ERROR',
  ADDRESS_UPDATE_ERROR: 'ADDRESS_UPDATE_ERROR',
  ADDRESS_DELETE_ERROR: 'ADDRESS_DELETE_ERROR',
  ADDRESS_NOT_FOUND: 'ADDRESS_NOT_FOUND',
  ADDRESS_DEFAULT_ERROR: 'ADDRESS_DEFAULT_ERROR',
  MISSING_TOKEN: 'MISSING_TOKEN',
  TOKEN_REFRESH_ERROR: 'TOKEN_REFRESH_ERROR',
  // Product errors
  PRODUCT_NOT_FOUND: 'PRODUCT_NOT_FOUND',
  INVALID_PRODUCT_ID: 'INVALID_PRODUCT_ID',
  PRODUCTS_FETCH_ERROR: 'PRODUCTS_FETCH_ERROR',
  PRODUCT_CREATION_ERROR: 'PRODUCT_CREATION_ERROR',
  PRODUCT_UPDATE_ERROR: 'PRODUCT_UPDATE_ERROR',
  PRODUCT_DELETE_ERROR: 'PRODUCT_DELETE_ERROR',
  SEARCH_ERROR: 'SEARCH_ERROR',
  CATEGORIES_ERROR: 'CATEGORIES_ERROR',
  FILTERS_ERROR: 'FILTERS_ERROR',
  RECOMMENDATIONS_ERROR: 'RECOMMENDATIONS_ERROR',
  MISSING_QUERY: 'MISSING_QUERY',
  // Cart errors
  CART_ADD_ERROR: 'CART_ADD_ERROR',
  CART_UPDATE_ERROR: 'CART_UPDATE_ERROR',
  CART_REMOVE_ERROR: 'CART_REMOVE_ERROR',
  CART_CLEAR_ERROR: 'CART_CLEAR_ERROR',
  CART_MERGE_ERROR: 'CART_MERGE_ERROR',
  CART_FETCH_ERROR: 'CART_FETCH_ERROR',
  ITEM_NOT_FOUND: 'ITEM_NOT_FOUND',
  MAX_QUANTITY_EXCEEDED: 'MAX_QUANTITY_EXCEEDED',
  INVALID_QUANTITY: 'INVALID_QUANTITY',
  MISSING_PRODUCT_ID: 'MISSING_PRODUCT_ID',
  // Order errors
  ORDER_NOT_FOUND: 'ORDER_NOT_FOUND',
  ORDER_CREATE_ERROR: 'ORDER_CREATE_ERROR',
  ORDER_UPDATE_ERROR: 'ORDER_UPDATE_ERROR',
  ORDER_CANCEL_ERROR: 'ORDER_CANCEL_ERROR',
  INVALID_ORDER_STATUS: 'INVALID_ORDER_STATUS',
  EMPTY_CART: 'EMPTY_CART',
  // Payment errors
  PAYMENT_FAILED: 'PAYMENT_FAILED',
  PAYMENT_METHOD_INVALID: 'PAYMENT_METHOD_INVALID',
  INSUFFICIENT_FUNDS: 'INSUFFICIENT_FUNDS',
  PAYMENT_REQUIRED: 'PAYMENT_REQUIRED',
  PAYMENT_CREATE_ERROR: 'PAYMENT_CREATE_ERROR',
  PAYMENT_STATUS_ERROR: 'PAYMENT_STATUS_ERROR',
  // Integration errors
  MOLLIE_ERROR: 'MOLLIE_ERROR',
  WHOLESALER_ERROR: 'WHOLESALER_ERROR',
  EMAIL_ERROR: 'EMAIL_ERROR'
};

/**
 * Format error response in standardized format
 * @param {string} code - Error code from ErrorCodes
 * @param {string} message - Default error message (used if i18n key not found)
 * @param {string} field - Optional field name for validation errors
 * @param {object} additionalData - Additional data to include in error
 * @param {function} i18n - Optional i18n function for translation
 * @returns {object} Formatted error response
 */
function formatError(code, message, field = null, additionalData = null, i18n = null) {
  const error = {
    code,
    message
  };

  // Try to use i18n if available
  if (i18n && typeof i18n === 'function') {
    // The i18n function already handles the error code lookup
    const translatedMessage = i18n(code, message);
    error.message = translatedMessage;
  }
  if (field) {
    error.field = field;
  }
  if (additionalData) {
    Object.assign(error, additionalData);
  }
  return {
    success: false,
    error
  };
}

/**
 * Create validation error from express-validator result
 * @param {object} validationResult - Express validator result object
 * @returns {object} Formatted validation error
 */
function createValidationError(validationResult) {
  const errors = validationResult.array();
  return {
    success: false,
    error: {
      code: ErrorCodes.VALIDATION_ERROR,
      message: 'Invalid input data',
      details: errors.map(err => ({
        field: err.param || err.path,
        message: err.msg,
        location: err.location
      }))
    }
  };
}

/**
 * Express middleware to add error response helpers
 * Adds methods to res object for consistent error responses
 */
function errorResponse(req, res, next) {
  // Get i18n function if available (will be added when we implement backend i18n)
  const i18n = req.i18n || null;

  /**
   * Send standardized error response
   * @param {number} statusCode - HTTP status code
   * @param {string} errorCode - Error code from ErrorCodes
   * @param {string} message - Error message
   * @param {string} field - Optional field name
   * @param {object} additionalData - Additional error data
   */
  res.error = function (statusCode, errorCode, message, field = null, additionalData = null) {
    const errorData = formatError(errorCode, message, field, additionalData, req.i18n);
    return this.status(statusCode).json(errorData);
  };

  /**
   * Send validation error response
   * @param {object} validationErrors - Express validator errors
   */
  res.validationError = function (validationErrors) {
    const errorData = createValidationError(validationErrors);
    return this.status(400).json(errorData);
  };
  next();
}

/**
 * Special handler for webhook endpoints that need plain text responses
 * @param {object} res - Express response object
 * @param {number} statusCode - HTTP status code
 * @param {string} message - Error message
 */
function webhookError(res, statusCode, message) {
  return res.status(statusCode).send(message);
}
module.exports = {
  ErrorCodes,
  formatError,
  createValidationError,
  errorResponse,
  webhookError
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFcnJvckNvZGVzIiwiVkFMSURBVElPTl9FUlJPUiIsIk5PVF9GT1VORCIsIlVOQVVUSE9SSVpFRCIsIkZPUkJJRERFTiIsIklOVEVSTkFMX0VSUk9SIiwiQkFEX1JFUVVFU1QiLCJJTlZBTElEX0NSRURFTlRJQUxTIiwiVVNFUl9FWElTVFMiLCJVU0VSX05PVF9GT1VORCIsIlRPS0VOX0lOVkFMSUQiLCJUT0tFTl9FWFBJUkVEIiwiQVVUSEVOVElDQVRJT05fUkVRVUlSRUQiLCJSRUdJU1RSQVRJT05fRVJST1IiLCJBQ0NPVU5UX0RJU0FCTEVEIiwiTE9HSU5fRVJST1IiLCJGT1JHT1RfUEFTU1dPUkRfRVJST1IiLCJSRVNFVF9QQVNTV09SRF9FUlJPUiIsIlZFUklGSUNBVElPTl9FUlJPUiIsIlBST0ZJTEVfRkVUQ0hfRVJST1IiLCJQUk9GSUxFX1VQREFURV9FUlJPUiIsIkVNQUlMX0VYSVNUUyIsIkRVUExJQ0FURV9FTUFJTCIsIklOVkFMSURfUEFTU1dPUkQiLCJQQVNTV09SRF9DSEFOR0VfRVJST1IiLCJMT0dPVVRfRVJST1IiLCJBRERSRVNTX0FERF9FUlJPUiIsIkFERFJFU1NfVVBEQVRFX0VSUk9SIiwiQUREUkVTU19ERUxFVEVfRVJST1IiLCJBRERSRVNTX05PVF9GT1VORCIsIkFERFJFU1NfREVGQVVMVF9FUlJPUiIsIk1JU1NJTkdfVE9LRU4iLCJUT0tFTl9SRUZSRVNIX0VSUk9SIiwiUFJPRFVDVF9OT1RfRk9VTkQiLCJJTlZBTElEX1BST0RVQ1RfSUQiLCJQUk9EVUNUU19GRVRDSF9FUlJPUiIsIlBST0RVQ1RfQ1JFQVRJT05fRVJST1IiLCJQUk9EVUNUX1VQREFURV9FUlJPUiIsIlBST0RVQ1RfREVMRVRFX0VSUk9SIiwiU0VBUkNIX0VSUk9SIiwiQ0FURUdPUklFU19FUlJPUiIsIkZJTFRFUlNfRVJST1IiLCJSRUNPTU1FTkRBVElPTlNfRVJST1IiLCJNSVNTSU5HX1FVRVJZIiwiQ0FSVF9BRERfRVJST1IiLCJDQVJUX1VQREFURV9FUlJPUiIsIkNBUlRfUkVNT1ZFX0VSUk9SIiwiQ0FSVF9DTEVBUl9FUlJPUiIsIkNBUlRfTUVSR0VfRVJST1IiLCJDQVJUX0ZFVENIX0VSUk9SIiwiSVRFTV9OT1RfRk9VTkQiLCJNQVhfUVVBTlRJVFlfRVhDRUVERUQiLCJJTlZBTElEX1FVQU5USVRZIiwiTUlTU0lOR19QUk9EVUNUX0lEIiwiT1JERVJfTk9UX0ZPVU5EIiwiT1JERVJfQ1JFQVRFX0VSUk9SIiwiT1JERVJfVVBEQVRFX0VSUk9SIiwiT1JERVJfQ0FOQ0VMX0VSUk9SIiwiSU5WQUxJRF9PUkRFUl9TVEFUVVMiLCJFTVBUWV9DQVJUIiwiUEFZTUVOVF9GQUlMRUQiLCJQQVlNRU5UX01FVEhPRF9JTlZBTElEIiwiSU5TVUZGSUNJRU5UX0ZVTkRTIiwiUEFZTUVOVF9SRVFVSVJFRCIsIlBBWU1FTlRfQ1JFQVRFX0VSUk9SIiwiUEFZTUVOVF9TVEFUVVNfRVJST1IiLCJNT0xMSUVfRVJST1IiLCJXSE9MRVNBTEVSX0VSUk9SIiwiRU1BSUxfRVJST1IiLCJmb3JtYXRFcnJvciIsImNvZGUiLCJtZXNzYWdlIiwiZmllbGQiLCJhZGRpdGlvbmFsRGF0YSIsImkxOG4iLCJlcnJvciIsInRyYW5zbGF0ZWRNZXNzYWdlIiwiT2JqZWN0IiwiYXNzaWduIiwic3VjY2VzcyIsImNyZWF0ZVZhbGlkYXRpb25FcnJvciIsInZhbGlkYXRpb25SZXN1bHQiLCJlcnJvcnMiLCJhcnJheSIsImRldGFpbHMiLCJtYXAiLCJlcnIiLCJwYXJhbSIsInBhdGgiLCJtc2ciLCJsb2NhdGlvbiIsImVycm9yUmVzcG9uc2UiLCJyZXEiLCJyZXMiLCJuZXh0Iiwic3RhdHVzQ29kZSIsImVycm9yQ29kZSIsImVycm9yRGF0YSIsInN0YXR1cyIsImpzb24iLCJ2YWxpZGF0aW9uRXJyb3IiLCJ2YWxpZGF0aW9uRXJyb3JzIiwid2ViaG9va0Vycm9yIiwic2VuZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJlcnJvckhhbmRsZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTdGFuZGFyZGl6ZWQgZXJyb3IgaGFuZGxpbmcgdXRpbGl0aWVzIGZvciB0aGUgSG9saXN0aWMgQm91dGlxdWUgQVBJXG4gKiBGb2xsb3dpbmcgQ0xBVURFLm1kIGNvbnN0cmFpbnRzOlxuICogLSBLZWVwIGl0IHNpbXBsZSAtIG5vIGV2ZW50IGVtaXR0ZXJzIG9yIGNvbXBsZXggcGF0dGVybnNcbiAqIC0gU3VwcG9ydCBpbnRlcm5hdGlvbmFsaXphdGlvbiBmb3IgYWxsIGVycm9yIG1lc3NhZ2VzXG4gKiAtIFVzZSBleGlzdGluZyBwYXR0ZXJucyBmcm9tIHRoZSBjb2RlYmFzZVxuICovXG5cbi8vIFN0YW5kYXJkIGVycm9yIGNvZGVzIHVzZWQgYWNyb3NzIHRoZSBhcHBsaWNhdGlvblxuY29uc3QgRXJyb3JDb2RlcyA9IHtcbiAgLy8gQ29tbW9uIGVycm9yc1xuICBWQUxJREFUSU9OX0VSUk9SOiAnVkFMSURBVElPTl9FUlJPUicsXG4gIE5PVF9GT1VORDogJ05PVF9GT1VORCcsXG4gIFVOQVVUSE9SSVpFRDogJ1VOQVVUSE9SSVpFRCcsXG4gIEZPUkJJRERFTjogJ0ZPUkJJRERFTicsXG4gIElOVEVSTkFMX0VSUk9SOiAnSU5URVJOQUxfRVJST1InLFxuICBCQURfUkVRVUVTVDogJ0JBRF9SRVFVRVNUJyxcbiAgXG4gIC8vIEF1dGhlbnRpY2F0aW9uIGVycm9yc1xuICBJTlZBTElEX0NSRURFTlRJQUxTOiAnSU5WQUxJRF9DUkVERU5USUFMUycsXG4gIFVTRVJfRVhJU1RTOiAnVVNFUl9FWElTVFMnLFxuICBVU0VSX05PVF9GT1VORDogJ1VTRVJfTk9UX0ZPVU5EJyxcbiAgVE9LRU5fSU5WQUxJRDogJ1RPS0VOX0lOVkFMSUQnLFxuICBUT0tFTl9FWFBJUkVEOiAnVE9LRU5fRVhQSVJFRCcsXG4gIEFVVEhFTlRJQ0FUSU9OX1JFUVVJUkVEOiAnQVVUSEVOVElDQVRJT05fUkVRVUlSRUQnLFxuICBSRUdJU1RSQVRJT05fRVJST1I6ICdSRUdJU1RSQVRJT05fRVJST1InLFxuICBBQ0NPVU5UX0RJU0FCTEVEOiAnQUNDT1VOVF9ESVNBQkxFRCcsXG4gIExPR0lOX0VSUk9SOiAnTE9HSU5fRVJST1InLFxuICBGT1JHT1RfUEFTU1dPUkRfRVJST1I6ICdGT1JHT1RfUEFTU1dPUkRfRVJST1InLFxuICBSRVNFVF9QQVNTV09SRF9FUlJPUjogJ1JFU0VUX1BBU1NXT1JEX0VSUk9SJyxcbiAgVkVSSUZJQ0FUSU9OX0VSUk9SOiAnVkVSSUZJQ0FUSU9OX0VSUk9SJyxcbiAgUFJPRklMRV9GRVRDSF9FUlJPUjogJ1BST0ZJTEVfRkVUQ0hfRVJST1InLFxuICBQUk9GSUxFX1VQREFURV9FUlJPUjogJ1BST0ZJTEVfVVBEQVRFX0VSUk9SJyxcbiAgRU1BSUxfRVhJU1RTOiAnRU1BSUxfRVhJU1RTJyxcbiAgRFVQTElDQVRFX0VNQUlMOiAnRFVQTElDQVRFX0VNQUlMJyxcbiAgSU5WQUxJRF9QQVNTV09SRDogJ0lOVkFMSURfUEFTU1dPUkQnLFxuICBQQVNTV09SRF9DSEFOR0VfRVJST1I6ICdQQVNTV09SRF9DSEFOR0VfRVJST1InLFxuICBMT0dPVVRfRVJST1I6ICdMT0dPVVRfRVJST1InLFxuICBBRERSRVNTX0FERF9FUlJPUjogJ0FERFJFU1NfQUREX0VSUk9SJyxcbiAgQUREUkVTU19VUERBVEVfRVJST1I6ICdBRERSRVNTX1VQREFURV9FUlJPUicsXG4gIEFERFJFU1NfREVMRVRFX0VSUk9SOiAnQUREUkVTU19ERUxFVEVfRVJST1InLFxuICBBRERSRVNTX05PVF9GT1VORDogJ0FERFJFU1NfTk9UX0ZPVU5EJyxcbiAgQUREUkVTU19ERUZBVUxUX0VSUk9SOiAnQUREUkVTU19ERUZBVUxUX0VSUk9SJyxcbiAgTUlTU0lOR19UT0tFTjogJ01JU1NJTkdfVE9LRU4nLFxuICBUT0tFTl9SRUZSRVNIX0VSUk9SOiAnVE9LRU5fUkVGUkVTSF9FUlJPUicsXG4gIFxuICAvLyBQcm9kdWN0IGVycm9yc1xuICBQUk9EVUNUX05PVF9GT1VORDogJ1BST0RVQ1RfTk9UX0ZPVU5EJyxcbiAgSU5WQUxJRF9QUk9EVUNUX0lEOiAnSU5WQUxJRF9QUk9EVUNUX0lEJyxcbiAgUFJPRFVDVFNfRkVUQ0hfRVJST1I6ICdQUk9EVUNUU19GRVRDSF9FUlJPUicsXG4gIFBST0RVQ1RfQ1JFQVRJT05fRVJST1I6ICdQUk9EVUNUX0NSRUFUSU9OX0VSUk9SJyxcbiAgUFJPRFVDVF9VUERBVEVfRVJST1I6ICdQUk9EVUNUX1VQREFURV9FUlJPUicsXG4gIFBST0RVQ1RfREVMRVRFX0VSUk9SOiAnUFJPRFVDVF9ERUxFVEVfRVJST1InLFxuICBTRUFSQ0hfRVJST1I6ICdTRUFSQ0hfRVJST1InLFxuICBDQVRFR09SSUVTX0VSUk9SOiAnQ0FURUdPUklFU19FUlJPUicsXG4gIEZJTFRFUlNfRVJST1I6ICdGSUxURVJTX0VSUk9SJyxcbiAgUkVDT01NRU5EQVRJT05TX0VSUk9SOiAnUkVDT01NRU5EQVRJT05TX0VSUk9SJyxcbiAgTUlTU0lOR19RVUVSWTogJ01JU1NJTkdfUVVFUlknLFxuICBcbiAgLy8gQ2FydCBlcnJvcnNcbiAgQ0FSVF9BRERfRVJST1I6ICdDQVJUX0FERF9FUlJPUicsXG4gIENBUlRfVVBEQVRFX0VSUk9SOiAnQ0FSVF9VUERBVEVfRVJST1InLFxuICBDQVJUX1JFTU9WRV9FUlJPUjogJ0NBUlRfUkVNT1ZFX0VSUk9SJyxcbiAgQ0FSVF9DTEVBUl9FUlJPUjogJ0NBUlRfQ0xFQVJfRVJST1InLFxuICBDQVJUX01FUkdFX0VSUk9SOiAnQ0FSVF9NRVJHRV9FUlJPUicsXG4gIENBUlRfRkVUQ0hfRVJST1I6ICdDQVJUX0ZFVENIX0VSUk9SJyxcbiAgSVRFTV9OT1RfRk9VTkQ6ICdJVEVNX05PVF9GT1VORCcsXG4gIE1BWF9RVUFOVElUWV9FWENFRURFRDogJ01BWF9RVUFOVElUWV9FWENFRURFRCcsXG4gIElOVkFMSURfUVVBTlRJVFk6ICdJTlZBTElEX1FVQU5USVRZJyxcbiAgTUlTU0lOR19QUk9EVUNUX0lEOiAnTUlTU0lOR19QUk9EVUNUX0lEJyxcbiAgXG4gIC8vIE9yZGVyIGVycm9yc1xuICBPUkRFUl9OT1RfRk9VTkQ6ICdPUkRFUl9OT1RfRk9VTkQnLFxuICBPUkRFUl9DUkVBVEVfRVJST1I6ICdPUkRFUl9DUkVBVEVfRVJST1InLFxuICBPUkRFUl9VUERBVEVfRVJST1I6ICdPUkRFUl9VUERBVEVfRVJST1InLFxuICBPUkRFUl9DQU5DRUxfRVJST1I6ICdPUkRFUl9DQU5DRUxfRVJST1InLFxuICBJTlZBTElEX09SREVSX1NUQVRVUzogJ0lOVkFMSURfT1JERVJfU1RBVFVTJyxcbiAgRU1QVFlfQ0FSVDogJ0VNUFRZX0NBUlQnLFxuICBcbiAgLy8gUGF5bWVudCBlcnJvcnNcbiAgUEFZTUVOVF9GQUlMRUQ6ICdQQVlNRU5UX0ZBSUxFRCcsXG4gIFBBWU1FTlRfTUVUSE9EX0lOVkFMSUQ6ICdQQVlNRU5UX01FVEhPRF9JTlZBTElEJyxcbiAgSU5TVUZGSUNJRU5UX0ZVTkRTOiAnSU5TVUZGSUNJRU5UX0ZVTkRTJyxcbiAgUEFZTUVOVF9SRVFVSVJFRDogJ1BBWU1FTlRfUkVRVUlSRUQnLFxuICBQQVlNRU5UX0NSRUFURV9FUlJPUjogJ1BBWU1FTlRfQ1JFQVRFX0VSUk9SJyxcbiAgUEFZTUVOVF9TVEFUVVNfRVJST1I6ICdQQVlNRU5UX1NUQVRVU19FUlJPUicsXG4gIFxuICAvLyBJbnRlZ3JhdGlvbiBlcnJvcnNcbiAgTU9MTElFX0VSUk9SOiAnTU9MTElFX0VSUk9SJyxcbiAgV0hPTEVTQUxFUl9FUlJPUjogJ1dIT0xFU0FMRVJfRVJST1InLFxuICBFTUFJTF9FUlJPUjogJ0VNQUlMX0VSUk9SJ1xufTtcblxuLyoqXG4gKiBGb3JtYXQgZXJyb3IgcmVzcG9uc2UgaW4gc3RhbmRhcmRpemVkIGZvcm1hdFxuICogQHBhcmFtIHtzdHJpbmd9IGNvZGUgLSBFcnJvciBjb2RlIGZyb20gRXJyb3JDb2Rlc1xuICogQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2UgLSBEZWZhdWx0IGVycm9yIG1lc3NhZ2UgKHVzZWQgaWYgaTE4biBrZXkgbm90IGZvdW5kKVxuICogQHBhcmFtIHtzdHJpbmd9IGZpZWxkIC0gT3B0aW9uYWwgZmllbGQgbmFtZSBmb3IgdmFsaWRhdGlvbiBlcnJvcnNcbiAqIEBwYXJhbSB7b2JqZWN0fSBhZGRpdGlvbmFsRGF0YSAtIEFkZGl0aW9uYWwgZGF0YSB0byBpbmNsdWRlIGluIGVycm9yXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBpMThuIC0gT3B0aW9uYWwgaTE4biBmdW5jdGlvbiBmb3IgdHJhbnNsYXRpb25cbiAqIEByZXR1cm5zIHtvYmplY3R9IEZvcm1hdHRlZCBlcnJvciByZXNwb25zZVxuICovXG5mdW5jdGlvbiBmb3JtYXRFcnJvcihjb2RlLCBtZXNzYWdlLCBmaWVsZCA9IG51bGwsIGFkZGl0aW9uYWxEYXRhID0gbnVsbCwgaTE4biA9IG51bGwpIHtcbiAgY29uc3QgZXJyb3IgPSB7XG4gICAgY29kZSxcbiAgICBtZXNzYWdlXG4gIH07XG5cbiAgLy8gVHJ5IHRvIHVzZSBpMThuIGlmIGF2YWlsYWJsZVxuICBpZiAoaTE4biAmJiB0eXBlb2YgaTE4biA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIC8vIFRoZSBpMThuIGZ1bmN0aW9uIGFscmVhZHkgaGFuZGxlcyB0aGUgZXJyb3IgY29kZSBsb29rdXBcbiAgICBjb25zdCB0cmFuc2xhdGVkTWVzc2FnZSA9IGkxOG4oY29kZSwgbWVzc2FnZSk7XG4gICAgZXJyb3IubWVzc2FnZSA9IHRyYW5zbGF0ZWRNZXNzYWdlO1xuICB9XG5cbiAgaWYgKGZpZWxkKSB7XG4gICAgZXJyb3IuZmllbGQgPSBmaWVsZDtcbiAgfVxuXG4gIGlmIChhZGRpdGlvbmFsRGF0YSkge1xuICAgIE9iamVjdC5hc3NpZ24oZXJyb3IsIGFkZGl0aW9uYWxEYXRhKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3VjY2VzczogZmFsc2UsXG4gICAgZXJyb3JcbiAgfTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgdmFsaWRhdGlvbiBlcnJvciBmcm9tIGV4cHJlc3MtdmFsaWRhdG9yIHJlc3VsdFxuICogQHBhcmFtIHtvYmplY3R9IHZhbGlkYXRpb25SZXN1bHQgLSBFeHByZXNzIHZhbGlkYXRvciByZXN1bHQgb2JqZWN0XG4gKiBAcmV0dXJucyB7b2JqZWN0fSBGb3JtYXR0ZWQgdmFsaWRhdGlvbiBlcnJvclxuICovXG5mdW5jdGlvbiBjcmVhdGVWYWxpZGF0aW9uRXJyb3IodmFsaWRhdGlvblJlc3VsdCkge1xuICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0LmFycmF5KCk7XG4gIFxuICByZXR1cm4ge1xuICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgIGVycm9yOiB7XG4gICAgICBjb2RlOiBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXG4gICAgICBtZXNzYWdlOiAnSW52YWxpZCBpbnB1dCBkYXRhJyxcbiAgICAgIGRldGFpbHM6IGVycm9ycy5tYXAoZXJyID0+ICh7XG4gICAgICAgIGZpZWxkOiBlcnIucGFyYW0gfHwgZXJyLnBhdGgsXG4gICAgICAgIG1lc3NhZ2U6IGVyci5tc2csXG4gICAgICAgIGxvY2F0aW9uOiBlcnIubG9jYXRpb25cbiAgICAgIH0pKVxuICAgIH1cbiAgfTtcbn1cblxuLyoqXG4gKiBFeHByZXNzIG1pZGRsZXdhcmUgdG8gYWRkIGVycm9yIHJlc3BvbnNlIGhlbHBlcnNcbiAqIEFkZHMgbWV0aG9kcyB0byByZXMgb2JqZWN0IGZvciBjb25zaXN0ZW50IGVycm9yIHJlc3BvbnNlc1xuICovXG5mdW5jdGlvbiBlcnJvclJlc3BvbnNlKHJlcSwgcmVzLCBuZXh0KSB7XG4gIC8vIEdldCBpMThuIGZ1bmN0aW9uIGlmIGF2YWlsYWJsZSAod2lsbCBiZSBhZGRlZCB3aGVuIHdlIGltcGxlbWVudCBiYWNrZW5kIGkxOG4pXG4gIGNvbnN0IGkxOG4gPSByZXEuaTE4biB8fCBudWxsO1xuXG4gIC8qKlxuICAgKiBTZW5kIHN0YW5kYXJkaXplZCBlcnJvciByZXNwb25zZVxuICAgKiBAcGFyYW0ge251bWJlcn0gc3RhdHVzQ29kZSAtIEhUVFAgc3RhdHVzIGNvZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGVycm9yQ29kZSAtIEVycm9yIGNvZGUgZnJvbSBFcnJvckNvZGVzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlIC0gRXJyb3IgbWVzc2FnZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZmllbGQgLSBPcHRpb25hbCBmaWVsZCBuYW1lXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBhZGRpdGlvbmFsRGF0YSAtIEFkZGl0aW9uYWwgZXJyb3IgZGF0YVxuICAgKi9cbiAgcmVzLmVycm9yID0gZnVuY3Rpb24oc3RhdHVzQ29kZSwgZXJyb3JDb2RlLCBtZXNzYWdlLCBmaWVsZCA9IG51bGwsIGFkZGl0aW9uYWxEYXRhID0gbnVsbCkge1xuICAgIGNvbnN0IGVycm9yRGF0YSA9IGZvcm1hdEVycm9yKGVycm9yQ29kZSwgbWVzc2FnZSwgZmllbGQsIGFkZGl0aW9uYWxEYXRhLCByZXEuaTE4bik7XG4gICAgcmV0dXJuIHRoaXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24oZXJyb3JEYXRhKTtcbiAgfTtcblxuICAvKipcbiAgICogU2VuZCB2YWxpZGF0aW9uIGVycm9yIHJlc3BvbnNlXG4gICAqIEBwYXJhbSB7b2JqZWN0fSB2YWxpZGF0aW9uRXJyb3JzIC0gRXhwcmVzcyB2YWxpZGF0b3IgZXJyb3JzXG4gICAqL1xuICByZXMudmFsaWRhdGlvbkVycm9yID0gZnVuY3Rpb24odmFsaWRhdGlvbkVycm9ycykge1xuICAgIGNvbnN0IGVycm9yRGF0YSA9IGNyZWF0ZVZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uRXJyb3JzKTtcbiAgICByZXR1cm4gdGhpcy5zdGF0dXMoNDAwKS5qc29uKGVycm9yRGF0YSk7XG4gIH07XG5cbiAgbmV4dCgpO1xufVxuXG4vKipcbiAqIFNwZWNpYWwgaGFuZGxlciBmb3Igd2ViaG9vayBlbmRwb2ludHMgdGhhdCBuZWVkIHBsYWluIHRleHQgcmVzcG9uc2VzXG4gKiBAcGFyYW0ge29iamVjdH0gcmVzIC0gRXhwcmVzcyByZXNwb25zZSBvYmplY3RcbiAqIEBwYXJhbSB7bnVtYmVyfSBzdGF0dXNDb2RlIC0gSFRUUCBzdGF0dXMgY29kZVxuICogQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2UgLSBFcnJvciBtZXNzYWdlXG4gKi9cbmZ1bmN0aW9uIHdlYmhvb2tFcnJvcihyZXMsIHN0YXR1c0NvZGUsIG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuc2VuZChtZXNzYWdlKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIEVycm9yQ29kZXMsXG4gIGZvcm1hdEVycm9yLFxuICBjcmVhdGVWYWxpZGF0aW9uRXJyb3IsXG4gIGVycm9yUmVzcG9uc2UsXG4gIHdlYmhvb2tFcnJvclxufTsiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsTUFBTUEsVUFBVSxHQUFHO0VBQ2pCO0VBQ0FDLGdCQUFnQixFQUFFLGtCQUFrQjtFQUNwQ0MsU0FBUyxFQUFFLFdBQVc7RUFDdEJDLFlBQVksRUFBRSxjQUFjO0VBQzVCQyxTQUFTLEVBQUUsV0FBVztFQUN0QkMsY0FBYyxFQUFFLGdCQUFnQjtFQUNoQ0MsV0FBVyxFQUFFLGFBQWE7RUFFMUI7RUFDQUMsbUJBQW1CLEVBQUUscUJBQXFCO0VBQzFDQyxXQUFXLEVBQUUsYUFBYTtFQUMxQkMsY0FBYyxFQUFFLGdCQUFnQjtFQUNoQ0MsYUFBYSxFQUFFLGVBQWU7RUFDOUJDLGFBQWEsRUFBRSxlQUFlO0VBQzlCQyx1QkFBdUIsRUFBRSx5QkFBeUI7RUFDbERDLGtCQUFrQixFQUFFLG9CQUFvQjtFQUN4Q0MsZ0JBQWdCLEVBQUUsa0JBQWtCO0VBQ3BDQyxXQUFXLEVBQUUsYUFBYTtFQUMxQkMscUJBQXFCLEVBQUUsdUJBQXVCO0VBQzlDQyxvQkFBb0IsRUFBRSxzQkFBc0I7RUFDNUNDLGtCQUFrQixFQUFFLG9CQUFvQjtFQUN4Q0MsbUJBQW1CLEVBQUUscUJBQXFCO0VBQzFDQyxvQkFBb0IsRUFBRSxzQkFBc0I7RUFDNUNDLFlBQVksRUFBRSxjQUFjO0VBQzVCQyxlQUFlLEVBQUUsaUJBQWlC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